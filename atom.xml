<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>CloudSheep&#39;s Blog</title>
  
  <subtitle>Sheep</subtitle>
  <link href="http://cloudsheep.xyz/atom.xml" rel="self"/>
  
  <link href="http://cloudsheep.xyz/"/>
  <updated>2024-06-14T08:25:20.649Z</updated>
  <id>http://cloudsheep.xyz/</id>
  
  <author>
    <name>sheep</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>“架构”</title>
    <link href="http://cloudsheep.xyz/2024/06/14/%E6%9E%B6%E6%9E%84/"/>
    <id>http://cloudsheep.xyz/2024/06/14/%E6%9E%B6%E6%9E%84/</id>
    <published>2024-06-14T08:25:20.000Z</published>
    <updated>2024-06-14T08:25:20.649Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>“Nginx部署”</title>
    <link href="http://cloudsheep.xyz/2024/06/14/Nginx%E9%83%A8%E7%BD%B2/"/>
    <id>http://cloudsheep.xyz/2024/06/14/Nginx%E9%83%A8%E7%BD%B2/</id>
    <published>2024-06-14T08:24:58.000Z</published>
    <updated>2024-06-14T08:29:15.094Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安装nginx第三方库"><a href="#安装nginx第三方库" class="headerlink" title="安装nginx第三方库"></a>安装nginx第三方库</h1><p><strong>执行以下命令进行安装</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ automake pcre pcre-devel zlib zlib-devel openssl openssl-develyum -y install gcc gcc-c++ automake</span><br></pre></td></tr></table></figure><h1 id="下载Nginx解压包并解压"><a href="#下载Nginx解压包并解压" class="headerlink" title="下载Nginx解压包并解压"></a>下载Nginx解压包并解压</h1><ul><li>在官网上直接下载   网址：<a href="http://nginx.org/en/download.html" title="http://nginx.org/en/doload.html">http://nginx.org/en/doload.html</a></li><li>在Linux服务器上下载  <code>wget http://nginx.org/download/nginx-1.26.1.tar.gz</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建nginx目录</span> </span><br><span class="line">mkdir /opt/nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入nginx目录</span></span><br><span class="line">cd /opt/nginx </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载nginx解压包</span>  </span><br><span class="line">wget http://nginx.org/download/nginx-1.26.1.tar.gz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压文件</span></span><br><span class="line">tar -xvf nginx-1.26.1.tar.gz</span><br></pre></td></tr></table></figure><p><img src="C:\Users\32625\OneDrive\桌面\架构\前端\image\Nginx部署\1718097294696.png" alt="1718097294696"></p><h1 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">opt/nginx文件夹下创建新文件夹Nginx-1.26.1_install</span></span><br><span class="line">cd /opt/nginx</span><br><span class="line">mkdir nginx-1.26.1_install</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入之前解压后得到的文件夹nginx-1.26.1</span></span><br><span class="line">cd nginx-1.26.1</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">运行configure脚本程序，可以直接运行./configure,也可以通过--prefix=path 指定nginx的安装目录</span></span><br><span class="line">./configure --prefix=/opt/nginx/nginx-1.26.1_install</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行完成后,该文件夹下多出一个文件---Makefile，此时执行make指令进行源代码编译，编译过程中屏幕会有编译全过程</span></span><br><span class="line">make</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译完成后，执行make的install命令安装Nginx服务器</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p><img src="C:\Users\32625\OneDrive\桌面\架构\前端\image\Nginx部署\1718098976187.png" alt="1718098976187"></p><blockquote><p>conf：该目录存放了Nginx的所有配置文件，该文件夹下包含nginx.conf文件，它是Nginx服务器的住配置文件，其他文件则是用    来配置Nginx的相关功能。</p><p>html：该目录存放了Nginx服务器在运行过程中调用的一些html文件。</p><p>logs：该目录存放了Nginx服务器的日志。</p><p>sbin：该目录中只包含了一个文件-nginx，它就是Nginx服务器的主程序。</p></blockquote><h1 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改nginx.conf文件中的端口，改为81</span></span><br><span class="line">cd /opt/nginx/nginx-1.26.1_install/conf/</span><br><span class="line">vi nginx.conf</span><br></pre></td></tr></table></figure><p><img src="C:\Users\32625\OneDrive\桌面\架构\前端\image\Nginx部署\1718099504595.png" alt="1718099504595"></p><h1 id="启动Nginx服务器"><a href="#启动Nginx服务器" class="headerlink" title="启动Nginx服务器"></a>启动Nginx服务器</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#在启动服务器之前，我们可以通过如下指令来查看Nginx服务器配置文件是否有语法错误：</span><br><span class="line">/opt/nginx/nginx-1.26.1_install/sbin/nginx -t</span><br><span class="line"></span><br><span class="line">#绝对路径</span><br><span class="line">/opt/nginx/nginx-1.26.1_install/sbin/nginx</span><br><span class="line"> </span><br><span class="line">#在nginx-1.26.1_install文件夹中时的相对路径</span><br><span class="line">./sbin/nginx -t</span><br><span class="line"> </span><br><span class="line">#通过如下指令可以查看Nginx服务器版本</span><br><span class="line">./sbin/nginx -v</span><br><span class="line"> </span><br><span class="line">#使用默认配置启动Nginx</span><br><span class="line">./sbin/nginx</span><br><span class="line"> </span><br><span class="line">#查看nginx进程状态</span><br><span class="line">ps -ef|grep nginx</span><br><span class="line"> </span><br><span class="line">#停止Nginx服务器</span><br><span class="line">#绝对路径</span><br><span class="line">/opt/nginx/Nginx-1.26.1_install/sbin/nginx -s stop</span><br><span class="line"> </span><br><span class="line">#Nginx-1.26.1_install文件夹下相对路径</span><br><span class="line">./sbin/nginx -s stop</span><br><span class="line"> </span><br><span class="line">#重启Nginx服务器</span><br><span class="line">/opt/nginx/Nginx-1.26.1_install/sbin/nginx -s reopen</span><br><span class="line"> </span><br><span class="line">#重新载入配置文件</span><br><span class="line">/opt/nginx/Nginx-1.26.1_install/sbin/nginx -s reload</span><br></pre></td></tr></table></figure><h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#需要关闭Linux服务器的防火墙</span><br><span class="line">systemctl stop firewall &amp;&amp;systemctl disbale firewalld</span><br><span class="line">http:192.168.10.100:81</span><br></pre></td></tr></table></figure><p><img src="/image/Nginx%E9%83%A8%E7%BD%B2/1718100327425.png" alt="1718100327425"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;安装nginx第三方库&quot;&gt;&lt;a href=&quot;#安装nginx第三方库&quot; class=&quot;headerlink&quot; title=&quot;安装nginx第三方库&quot;&gt;&lt;/a&gt;安装nginx第三方库&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;执行以下命令进行安装&lt;/strong&gt;&lt;/p&gt;
&lt;f</summary>
      
    
    
    
    <category term="实战" scheme="http://cloudsheep.xyz/category/%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="nginx" scheme="http://cloudsheep.xyz/tag/nginx/"/>
    
    <category term="前端" scheme="http://cloudsheep.xyz/tag/%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>ceph</title>
    <link href="http://cloudsheep.xyz/2024/03/11/ceph/"/>
    <id>http://cloudsheep.xyz/2024/03/11/ceph/</id>
    <published>2024-03-11T01:39:09.000Z</published>
    <updated>2024-06-14T08:29:12.711Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Ceph版本来源介绍"><a href="#Ceph版本来源介绍" class="headerlink" title="Ceph版本来源介绍"></a>Ceph版本来源介绍</h1><p><strong>第一个 Ceph 版本是 0.1 ，要回溯到 2008 年 1 月。多年来，版本号方案一直没变，直到 2015 年 4 月 0.94.1 （ Hammer 的第一个修正版）发布后，为了避免 0.99 （以及 0.100 或 1.00 ？），制定了新策略。</strong></p><p><strong>x.0.z - 开发版（给早期测试者和勇士们）</strong></p><p><strong>x.1.z - 候选版（用于测试集群、高手们）</strong></p><p><strong>x.2.z - 稳定、修正版（给用户们）</strong></p><p><strong>x 将从 9 算起，它代表 Infernalis （ I 是第九个字母），这样第九个发布周期的第一个开发版就是 9.0.0 ；后续的开发版依次是 9.0.1 、 9.0.2 等等。</strong></p><table><thead><tr><th>版本名称</th><th>版本号</th><th>发布时间</th></tr></thead><tbody><tr><td>Argonaut</td><td>0.48版本(LTS)</td><td>2012年6月3日</td></tr><tr><td>Bobtail</td><td>0.56版本(LTS)</td><td>2013年5月7日</td></tr><tr><td>Cuttlefish</td><td>0.61版本</td><td>2013年1月1日</td></tr><tr><td>Dumpling</td><td>0.67版本(LTS)</td><td>2013年8月14日</td></tr><tr><td>Emperor</td><td>0.72版本</td><td>2013年11月9</td></tr><tr><td>Firefly</td><td>0.80版本(LTS)</td><td>2014年5月</td></tr><tr><td>Giant</td><td>Giant</td><td>October 2014 - April 2015</td></tr><tr><td>Hammer</td><td>Hammer</td><td>April 2015 - November 2016</td></tr><tr><td>Infernalis</td><td>Infernalis</td><td>November 2015 - June 2016</td></tr><tr><td>Jewel</td><td>10.2.9</td><td>2016年4月</td></tr><tr><td>Kraken</td><td>11.2.1</td><td>2017年10月</td></tr><tr><td>Luminous</td><td>12.2.12</td><td>2017年10月</td></tr><tr><td>mimic</td><td>13.2.7</td><td>2018年5月</td></tr><tr><td>nautilus</td><td>14.2.5</td><td>2019年2月</td></tr><tr><td>Octopus</td><td>15.2.17</td><td>2020-03-23</td></tr><tr><td>Pacific</td><td>16.2.15</td><td>2021-03-31</td></tr><tr><td>Quincy</td><td>17.2.7</td><td>2022-04-19</td></tr><tr><td>Reef</td><td>18.2.1</td><td>2023-08-07</td></tr></tbody></table><p><strong>根据<a href="https://docs.ceph.com/en/latest/releases/">官网</a>给出的消息目前从O版开始(包括O版)之前的版本都不会再进行维护更新</strong></p><h1 id="安装方式介绍"><a href="#安装方式介绍" class="headerlink" title="安装方式介绍"></a>安装方式介绍</h1><p> <strong><a href="https://docs.ceph.com/ceph-ansible/">ceph-ansible</a> : 部署和管理 使用 Ansible 的 Ceph 集群。</strong></p><ul><li><strong>ceph-ansible 被广泛部署。</strong></li><li><strong>ceph-ansible 未与 在 Nautilus 和 Octopus 中引入，这意味着管理功能 而 Nautilus 和 Octopus 中引入的仪表板集成则不是 在通过 ceph-ansible 部署的 Ceph 集群中可用。</strong></li></ul><p> <strong><a href="https://docs.ceph.com/projects/ceph-deploy/en/latest/">ceph-deploy</a> : 是一个 可用于快速部署集群的工具。</strong></p><p> <strong><a href="https://docs.ceph.com/en/latest/cephadm/install/#cephadm-deploying-new-cluster">Cephadm</a> : 是一种可用于 安装和管理 Ceph 集群。(它不支持 RHEL8、CentOS 8 或更高版本的操作 系统。)</strong></p><ul><li><strong>cephadm 只支持 Octopus 及更新版本。</strong></li><li><strong>cephadm 与编排 API 完全集成，并完全支持 用于管理集群部署的 CLI 和仪表板功能。</strong></li><li><strong>cephadm 需要容器支持（以 Podman 或 Docker 的形式）和 Python 3.</strong></li><li><strong>cephadm 需要 systemd。</strong></li></ul><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="准备四台台虚拟机"><a href="#准备四台台虚拟机" class="headerlink" title="准备四台台虚拟机"></a><strong>准备四台台虚拟机</strong></h2><table><thead><tr><th>主机名</th><th>IP地址</th><th>配置</th></tr></thead><tbody><tr><td>center</td><td>192.168.10.100</td><td>2核2G +20g</td></tr><tr><td>ceph-node1</td><td>192.168.10.11</td><td>2核2G +20g+30g+30g+30g(临时)</td></tr><tr><td>ceph-node2</td><td>192.168.10.12</td><td>2核2G +20g+30g+30g+30g(临时)</td></tr><tr><td>ceph-noded3</td><td>192.168.10.13</td><td>2核2G +20g+30g+30g+30g(临时)</td></tr></tbody></table><h3 id="关闭防火墙，seliunx"><a href="#关闭防火墙，seliunx" class="headerlink" title="关闭防火墙，seliunx"></a>关闭防火墙，seliunx</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld &amp;&amp; systemctl disable firewalld &amp;&amp; setenforce 0</span><br><span class="line">sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure><h3 id="修改主机名，主机映射"><a href="#修改主机名，主机映射" class="headerlink" title="修改主机名，主机映射"></a>修改主机名，主机映射</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">四台虚拟机分别执行</span></span><br><span class="line">hostnamectl set-hostname center</span><br><span class="line">hostnamectl set-hostname ceph-1</span><br><span class="line">hostnamectl set-hostname ceph-2</span><br><span class="line">hostnamectl set-hostname ceph-3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">主机映射</span></span><br><span class="line">cat &gt;&gt;/etc/hosts &lt;&lt;EOF</span><br><span class="line">192.168.10.100 center</span><br><span class="line">192.168.10.11 ceph-1</span><br><span class="line">192.168.10.12 ceph-2</span><br><span class="line">192.168.10.13 ceph-3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="配置ntp服务器同步时间"><a href="#配置ntp服务器同步时间" class="headerlink" title="配置ntp服务器同步时间"></a>配置ntp服务器同步时间</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ntp       #安装ntp</span><br><span class="line"></span><br><span class="line">vi /etc/ntp.conf         #编辑配置文件(ceph-1 ceph-2 ceph-3 节点)</span><br><span class="line">server center iburst     #添加的内容(将原来的注释掉)</span><br><span class="line"></span><br><span class="line">systemctl restart ntpd   #重启</span><br><span class="line">systemctl status ntpd    #查看状态</span><br><span class="line">systemctl enable ntpd    #设置为开机自启动</span><br><span class="line"></span><br><span class="line">ntpdate -q &lt;主机IP&gt;       #输入主机IP验证各主机时间是否同步成功</span><br></pre></td></tr></table></figure><h3 id="配置免密登录"><a href="#配置免密登录" class="headerlink" title="配置免密登录"></a>配置免密登录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id ceph-1</span><br><span class="line">ssh-copy-id ceph-2</span><br><span class="line">ssh-copy-id ceph-3</span><br></pre></td></tr></table></figure><h3 id="配置yum源"><a href="#配置yum源" class="headerlink" title="配置yum源"></a>配置yum源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">清除以前的yum源</span></span><br><span class="line">rm -rf /etc/yum.repos.d/* </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置阿里云镜像源</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">centos7</span></span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">epel</span></span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建配置文件/etc/yum.repos.d/ceph-repo,并添加以下内容</span></span><br><span class="line">cat &lt;&lt; EOF | tee /etc/yum.repos.d/ceph.repo </span><br><span class="line">[ceph-norch]</span><br><span class="line">name=ceph-norch</span><br><span class="line">baseurl=https://mirrors.aliyun.com/ceph/rpm-nautilus/el7/noarch/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">[ceph-x86_64]</span><br><span class="line">name=ceph-x86_64</span><br><span class="line">baseurl=https://mirrors.aliyun.com/ceph/rpm-nautilus/el7/x86_64/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">清除yum配置重新生成缓存</span></span><br><span class="line">yum clean all &amp;&amp; yum makecache</span><br></pre></td></tr></table></figure><h1 id="ceph集群搭建"><a href="#ceph集群搭建" class="headerlink" title="ceph集群搭建"></a>ceph集群搭建</h1><h2 id="安装部署工具"><a href="#安装部署工具" class="headerlink" title="安装部署工具"></a>安装部署工具</h2><h3 id="center节点"><a href="#center节点" class="headerlink" title="center节点"></a>center节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python-setuptools</span><br><span class="line">yum -y install ceph-deploy</span><br><span class="line"></span><br><span class="line">ceph-deploy --version            #验证版本是否为2.0.1</span><br></pre></td></tr></table></figure><h3 id="ceph-1-ceph-2-ceph-3-节点"><a href="#ceph-1-ceph-2-ceph-3-节点" class="headerlink" title="ceph-1 ceph-2 ceph-3 节点"></a>ceph-1 ceph-2 ceph-3 节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装所需要的包</span></span><br><span class="line">yum -y install ceph ceph-mon ceph-osd ceph-mds ceph-radosgw ceph-mgr</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证(共十二个)</span></span><br><span class="line">rpm -qa | grep ceph</span><br></pre></td></tr></table></figure><p><img src="https://www.z4a.net/images/2024/03/07/-2024-03-07-145843.png" alt="-2024-03-07-145843.png"></p><h2 id="部署monitor"><a href="#部署monitor" class="headerlink" title="部署monitor"></a>部署monitor</h2><p><strong>将ceph-1节点作为monitor，在center节点进行部署</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建一个目录 /ceph-mon 存放部署时产生的文件</span></span><br><span class="line">mkdir /ceph-demo</span><br><span class="line">cd /ceph-mdemo/</span><br><span class="line">ceph-deploy new ceph-1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化monitor</span></span><br><span class="line">ceph-deploy mon create-initial</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将配置文件拷贝到其他节点上</span></span><br><span class="line">ceph-deploy admin ceph-1 ceph-2 ceph-3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注：如果想要部署高可用monitor，可以将多个节点添加进去，例如：</span></span><br><span class="line">ceph-deploy mon add ceph-2</span><br><span class="line">ceph-deploy mon add ceph-3</span><br></pre></td></tr></table></figure><h2 id="部署manager"><a href="#部署manager" class="headerlink" title="部署manager"></a>部署manager</h2><p><strong>将ceph-1节点作为mgr，在center节点进行部署</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入/ceph-demo目录，方便后续操作</span></span><br><span class="line">cd /ceph-demo</span><br><span class="line">ceph-ceploy mgr create ceph-1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">高可用</span></span><br><span class="line">ceph-deploy mgr create ceph-2 ceph-3</span><br></pre></td></tr></table></figure><h2 id="OSD"><a href="#OSD" class="headerlink" title="OSD"></a>OSD</h2><h3 id="存储方式"><a href="#存储方式" class="headerlink" title="存储方式"></a>存储方式</h3><p>*<em>OSD 可以通过两种方式管理其存储的数据。截至 Luminous 12.2.z 版本，默认（也是推荐的）后端是 <em>BlueStore</em>。事先 在 Luminous 版本中，默认（也是唯一）后端是 <em>Filestore</em>。</em>*</p><p><strong>BlueStore：</strong></p><ul><li><p><strong>BlueStore直接管理裸设备或分区，绕过传统的文件系统层，将数据和元数据直接存储在物理介质上，从而减少IO路径上的开销。</strong></p></li><li><p><strong>效率更高，适合高性能应用场景，如云存储、大规模数据分析和高并发访问的场景。</strong></p></li><li><p><strong>不依赖文件系统，因此不受文件系统限制，例如inode数量等。</strong></p></li></ul><p><strong>FileStore(文件存储)：</strong></p><ul><li><p><strong>Filestore 已在 Reef 版本中弃用，不再受支持。</strong></p></li><li><p><strong>FileStore使用传统的文件系统（通常是XFS）来组织存储空间，每个Ceph对象作为一个文件存储在文件系统内。</strong></p></li><li><p><strong>由于存在文件系统层，对于大规模并发的随机读写场景，性能相对BlueStore较低。</strong></p></li><li><p><strong>写前日志机制会引入额外的写放大数据，可能影响性能，尤其是当日志和OSD数据位于同一硬盘时。</strong></p></li><li><p><strong>便于管理，文件系统的使用使得FileStore在一定程度上更易于管理和维护，比如可以通过标准文件系统工具进行检查和修复。</strong></p></li></ul><p><strong>在目前的版本中传统的文件存储方式（FileStore）已经逐渐被 BlueStore 这种方式所替代</strong></p><h3 id="部署OSD"><a href="#部署OSD" class="headerlink" title="部署OSD"></a>部署OSD</h3><p><strong>选用 FileStore 作为存储引擎，选用每个节点上的 &#x2F;dev&#x2F;sdb 作为数据盘，&#x2F;dev&#x2F;sdc作为日志盘，在center节点上进行操作部署</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">确认每个节点上的磁盘状况</span></span><br><span class="line">ceph-deploy disk list ceph-1 ceph-2 ceph-3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">清理每个节点上的磁盘和系统文件</span></span><br><span class="line">ceph-deploy disk zap ceph-1 /dev/sdb</span><br><span class="line">ceph-deploy disk zap ceph-2 /dev/sdb</span><br><span class="line">ceph-deploy disk zap ceph-3 /dev/sdb</span><br><span class="line">ceph-deploy disk zap ceph-1 /dev/sdc</span><br><span class="line">ceph-deploy disk zap ceph-2 /dev/sdc</span><br><span class="line">ceph-deploy disk zap ceph-3 /dev/sdc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加osd</span></span><br><span class="line">ceph-deploy osd create --data /dev/sdb --journal /dev/sdc --filestore ceph-1</span><br><span class="line">ceph-deploy osd create --data /dev/sdb --journal /dev/sdc --filestore ceph-2</span><br><span class="line">ceph-deploy osd create --data /dev/sdb --journal /dev/sdc --filestore ceph-3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在center节点上验证</span></span><br><span class="line">yum -y isntall ceph</span><br><span class="line">cp ceph.conf /etc/ceph/</span><br><span class="line">cp ceph.client.admin.keyring /etc/ceph/</span><br><span class="line">ceph -s        #访问ceph集群</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Ceph版本来源介绍&quot;&gt;&lt;a href=&quot;#Ceph版本来源介绍&quot; class=&quot;headerlink&quot; title=&quot;Ceph版本来源介绍&quot;&gt;&lt;/a&gt;Ceph版本来源介绍&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;第一个 Ceph 版本是 0.1 ，要回溯到 2008 年 </summary>
      
    
    
    
    <category term="教程" scheme="http://cloudsheep.xyz/category/%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="ceph" scheme="http://cloudsheep.xyz/tag/ceph/"/>
    
    <category term="存储" scheme="http://cloudsheep.xyz/tag/%E5%AD%98%E5%82%A8/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://cloudsheep.xyz/2023/12/14/hello-world/"/>
    <id>http://cloudsheep.xyz/2023/12/14/hello-world/</id>
    <published>2023-12-14T03:20:05.489Z</published>
    <updated>2023-12-10T06:48:56.102Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">hexo</span> <span class="string">new</span> <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">hexo</span> <span class="string">server</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">hexo</span> <span class="string">generate</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">hexo</span> <span class="string">deploy</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Hexo</summary>
    
    
    
    <category term="其他" scheme="http://cloudsheep.xyz/category/%E5%85%B6%E4%BB%96/"/>
    
    
    <category term="hello-world" scheme="http://cloudsheep.xyz/tag/hello-world/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack搭建</title>
    <link href="http://cloudsheep.xyz/2023/12/13/OpenStack%E6%90%AD%E5%BB%BA/"/>
    <id>http://cloudsheep.xyz/2023/12/13/OpenStack%E6%90%AD%E5%BB%BA/</id>
    <published>2023-12-13T06:22:33.000Z</published>
    <updated>2024-03-12T09:33:00.215Z</updated>
    
    <content type="html"><![CDATA[<h1 id="主机规划"><a href="#主机规划" class="headerlink" title="主机规划"></a>主机规划</h1><table><thead><tr><th>主机名(hostname)</th><th>IP地址(双网卡(NAT,仅主机)）</th><th>规格</th></tr></thead><tbody><tr><td>controller(控制节点)</td><td>192.168.10.10</td><td>4核4g，硬盘100g</td></tr><tr><td>compute(计算节点)</td><td>192.168.10.20</td><td>4核4g，硬盘100g+100g</td></tr></tbody></table><p><em>注：为了不影响后续操作，两台主机默认密码都是“000000”</em></p><p>​        <em>OpenStack的配置文件中不能有中文(注释也不行)</em></p><h2 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h2><p><strong>controller节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname controller</span><br><span class="line">bash          </span><br></pre></td></tr></table></figure><p><strong>compute节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname compute</span><br><span class="line">bash</span><br></pre></td></tr></table></figure><h2 id="主机映射"><a href="#主机映射" class="headerlink" title="主机映射"></a>主机映射</h2><p><strong>双节点(两个节点都需要执行)</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;/etc/hosts &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">192.168.10.10 controller</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">192.168.10.20 compute</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">EOF</span></span><br></pre></td></tr></table></figure><h2 id="关闭防火墙配置免密登录"><a href="#关闭防火墙配置免密登录" class="headerlink" title="关闭防火墙配置免密登录"></a>关闭防火墙配置免密登录</h2><p><strong>双节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld &amp;&amp; setenforce 0  #暂时关闭防火墙和seliunx(重启后会自启动)</span><br><span class="line">systemctl disable firewalld               #永久关闭防火墙(关闭开机自启动，需要手动开启)</span><br><span class="line"> </span><br><span class="line">sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config #使用命令修改文件永久关闭seliunx</span><br><span class="line"></span><br><span class="line">ssh-keygen -t rsa         #按三次回车</span><br><span class="line">ssh-copy-id controller    #第一次输入yes,第二次输入主机密码</span><br><span class="line">ssh-copy-id compute       #第一次输入yes,第二次输入主机密码</span><br></pre></td></tr></table></figure><h1 id="时间同步"><a href="#时间同步" class="headerlink" title="时间同步"></a>时间同步</h1><p><strong>双节点</strong></p><p><strong>安装 Chrony(推荐) 或 NTP 来实现（选择其中一个安装即可(Chrony更适合虚拟化))</strong></p><h2 id="Chrony"><a href="#Chrony" class="headerlink" title="Chrony"></a>Chrony</h2><p><strong>双节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install chrony   #安装Chrony服务</span><br></pre></td></tr></table></figure><p><strong>controller节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/chrony.conf     #修改配置文件</span><br><span class="line">server 0.centos.pool.ntp.org iburst 改为 server ntp3.aliyun.com iburst</span><br><span class="line">server 1.centos.pool.ntp.org iburst #删除</span><br><span class="line">server 2.centos.pool.ntp.org iburst #删除</span><br><span class="line">server 3.centos.pool.ntp.org iburst #删除</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">allow 192.168.0.0/16 改为 allow all并去掉注释</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">local</span> stratum 10   <span class="comment">#去掉注释</span></span></span><br></pre></td></tr></table></figure><p><strong>compute</strong>节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/chrony.conf     #修改配置文件</span><br><span class="line">server 0.centos.pool.ntp.org iburst 改为 server controller iburst</span><br><span class="line">server 1.centos.pool.ntp.org iburst #删除</span><br><span class="line">server 2.centos.pool.ntp.org iburst #删除</span><br><span class="line">server 3.centos.pool.ntp.org iburst #删除</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">allow 192.168.0.0/16 改为 allow all并去掉注释</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">local</span> stratum 10   <span class="comment">#去掉注释</span></span></span><br></pre></td></tr></table></figure><p><strong>修改后的配置文件：</strong></p><p><img src="https://www.z4a.net/images/2023/12/15/2023-12-15-110620.png" alt="2023-12-15-110620.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart chronyd   #重启chrony服务</span><br><span class="line">systemctl enable chronyd    #设置为开机自启动</span><br><span class="line">systemctl status chronyd    #查看状态</span><br><span class="line">chronyc sources             #验证</span><br><span class="line">210 Number of sources = 1</span><br><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample               </span><br><span class="line">===============================================================================</span><br><span class="line">^* 203.107.6.88                  2   6    37    47    -63us[ -319us] +/-   41ms</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">左下角显示*号说明配置成功</span></span><br></pre></td></tr></table></figure><h2 id="NTP"><a href="#NTP" class="headerlink" title="NTP"></a>NTP</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ntp       #安装ntp服务</span><br><span class="line"></span><br><span class="line">vi /etc/ntp.conf         #编辑配置文件</span><br><span class="line">server &lt;NTP服务器IP&gt;      #添加的内容(与chrony服务器的方法相同)</span><br><span class="line"></span><br><span class="line">systemctl restart ntpd   #重启</span><br><span class="line">systemctl status ntpd    #查看状态</span><br><span class="line">systemctl enable ntpd    #设置为开机自启动</span><br><span class="line"></span><br><span class="line">ntpdate -q &lt;主机IP&gt;       #输入主机IP验证两台主机时间是否同步成功</span><br></pre></td></tr></table></figure><p><em>注：公共的ntp服务器</em></p><ul><li><em><a href="http://cn.pool.ntp.org/">cn.pool.ntp.org</a>（中国公共NTP服务器）</em></li><li><em><a href="http://pool.ntp.org/">pool.ntp.org</a>（全球公共NTP服务器）</em></li></ul><h1 id="安装软件包、数据库、消息队列、缓存"><a href="#安装软件包、数据库、消息队列、缓存" class="headerlink" title="安装软件包、数据库、消息队列、缓存"></a>安装软件包、数据库、消息队列、缓存</h1><h2 id="安装OpenStack软件包"><a href="#安装OpenStack软件包" class="headerlink" title="安装OpenStack软件包"></a>安装OpenStack软件包</h2><p><strong>双节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install centos-release-openstack-train    #启用OpenStack存储库</span><br><span class="line">yum upgrade                                      #升级内核(CentOS7以上版本可以不用)</span><br><span class="line">yum -y install python-openstackclient            #安装OpenStack客户端</span><br><span class="line">yum -y install openstack-selinux                 #服务策略</span><br></pre></td></tr></table></figure><h2 id="安装SQL数据库"><a href="#安装SQL数据库" class="headerlink" title="安装SQL数据库"></a>安装SQL数据库</h2><p><strong>controller节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mariadb mariadb-server python2-PyMySQL      #安装组件</span><br><span class="line"></span><br><span class="line">vi /etc/my.cnf.d/openstack.cnf                             #编辑配置文件</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加以下内容</span></span><br><span class="line">[mysqld]</span><br><span class="line">bind-address = 192.168.10.10                               #改为自己的主机IP</span><br><span class="line"></span><br><span class="line">default-storage-engine = innodb</span><br><span class="line">innodb_file_per_table = on</span><br><span class="line">max_connections = 4096</span><br><span class="line">collation-server = utf8_general_ci</span><br><span class="line">character-set-server = utf8</span><br><span class="line"></span><br><span class="line">systemctl start mariadb.service                            #启动数据库</span><br><span class="line">systemctl enable mariadb.service                           #设置为为开机自启动</span><br><span class="line">mysql_secure_installation                                  #初始化</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第一次按回车</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第二次按Y设置初始密码000000</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第三次按Y</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第四次按n</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第五次按Y</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第六次按Y</span></span><br></pre></td></tr></table></figure><h2 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h2><p><strong>controller节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum -y install rabbitmq-server                         #安装软件包</span><br><span class="line">systemctl start rabbitmq-server.service                #启动服务</span><br><span class="line">systemctl enable rabbitmq-server.service               #设置为开机自启动</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建用户,密码<span class="string">&#x27;openstack123&#x27;</span></span></span><br><span class="line">rabbitmqctl -n rabbit@controller add_user openstack openstack123</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加权限允许用户进行配置、写入和读取访问</span></span><br><span class="line">rabbitmqctl  -n rabbit@controller set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br></pre></td></tr></table></figure><h2 id="安装缓存"><a href="#安装缓存" class="headerlink" title="安装缓存"></a>安装缓存</h2><p><strong>controller节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install memcached python-memcached -y         #安装软件包</span><br><span class="line"></span><br><span class="line">vi /etc/sysconfig/memcached                       #编辑配置文件</span><br><span class="line">OPTIONS=&quot;-l 127.0.0.1,::1,controller&quot;               #更改现有行&quot;OPTIONS=&quot;-l 127.0.0.1,::1&quot;</span><br><span class="line"></span><br><span class="line">systemctl start memcached.service                #启动服务</span><br><span class="line">systemctl enable memcached.service                #设置为开机自启动</span><br></pre></td></tr></table></figure><h2 id="安装etcd"><a href="#安装etcd" class="headerlink" title="安装etcd"></a>安装etcd</h2><p><em>从S版开始有，详情请参考<a href="https://docs.openstack.org/2023.2/">官网</a>(无特殊需求可以不装)</em></p><p><strong>controller节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">yum -y install etcd             #安装软件包</span><br><span class="line"></span><br><span class="line">vi /etc/etcd/etcd.conf          #编辑配置文件(根据对应的选项进行修改)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[Member]</span></span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;http://&lt;controller节点IP&gt;:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;http://&lt;controller节点IP&gt;:2379,http://127.0.0.1:2379&quot;</span><br><span class="line">ETCD_NAME=&quot;controller&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;http://&lt;controller节点IP&gt;:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;http://&lt;controller节点IP&gt;:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;controller=http://&lt;controller节点IP&gt;&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster-01&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line"></span><br><span class="line">systemctl start etcd            #启动服务</span><br><span class="line">systemctl enable etcd           #设置为开机自启动</span><br><span class="line">etcdctl cluster-health          #验证(输出以下结果表示配置成功)</span><br><span class="line">member 4a1ad6ae1797e6ea is healthy: got healthy result from http://&lt;controller节点IP&gt;:2379</span><br></pre></td></tr></table></figure><h1 id="Keystone服务"><a href="#Keystone服务" class="headerlink" title="Keystone服务"></a>Keystone服务</h1><h2 id="controller节点"><a href="#controller节点" class="headerlink" title="controller节点"></a>controller节点</h2><h3 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h3><p><strong>创建数据库</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入数据库</span></span><br><span class="line">mysql -uroot -p000000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建数据库keystone</span></span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE keystone;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">赋予权限(keystone123为密码)</span></span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO &#x27;keystone&#x27;@&#x27;localhost&#x27; \</span><br><span class="line">IDENTIFIED BY &#x27;keystone123&#x27;;</span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO &#x27;keystone&#x27;@&#x27;%&#x27; \</span><br><span class="line">IDENTIFIED BY &#x27;keystone123&#x27;;</span><br></pre></td></tr></table></figure><p><em>sql语句一定要有  ;  号结尾</em></p><h3 id="安装配置组件"><a href="#安装配置组件" class="headerlink" title="安装配置组件"></a>安装配置组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum install openstack-keystone httpd mod_wsgi -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑配置文件</span></span><br><span class="line">vi /etc/keystone/keystone.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">找到需要修改的部分添加内容,查找方法(:/\查找的内容)</span></span><br><span class="line">[database]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">connection = mysql+pymysql://keystone:keystone123@controller/keystone   #直接添加</span><br><span class="line">[token]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">provider = fernet   #直接添加</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">同步数据库</span></span><br><span class="line">su -s /bin/sh -c &quot;keystone-manage db_sync&quot; keystone</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化 Fernet 密钥存储库</span></span><br><span class="line">keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone</span><br><span class="line">keystone-manage credential_setup --keystone-user keystone --keystone-group keystone</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化 Keystone 系统，并创建第一个管理员用户</span></span><br><span class="line">keystone-manage  bootstrap --bootstrap-password admin --bootstrap-admin-url http://controller:5000/v3/ --bootstrap-internal-url http://controller:5000/v3/ --bootstrap-public-url http://controller:5000/v3/ --bootstrap-region-id RegionOne </span><br></pre></td></tr></table></figure><h3 id="配置HTTP服务器"><a href="#配置HTTP服务器" class="headerlink" title="配置HTTP服务器"></a>配置HTTP服务器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑配置文件</span></span><br><span class="line">vi /etc/httpd/conf/httpd.conf</span><br><span class="line">ServerName controller   #添加这一行</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建指向文件的链接</span></span><br><span class="line">ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动服务</span></span><br><span class="line">systemctl start httpd.service</span><br><span class="line">systemctl enable httpd.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建环境变量脚本添加以下内容</span></span><br><span class="line">vi admin.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">export OS_USERNAME=admin  #设置管理员用户的用户名为&quot;admin&quot;</span><br><span class="line">export OS_PASSWORD=admin  #设置管理员用户的密码为&quot;admin&quot;</span><br><span class="line">export OS_PROJECT_NAME=admin  #设置管理员用户所在的项目为&quot;admin&quot;</span><br><span class="line">export OS_USER_DOMAIN_NAME=Default  #设置管理员用户所在域的名称为&quot;Default&quot;</span><br><span class="line">export OS_PROJECT_DOMAIN_NAME=Default  #设置管理员用户所在项目的域的名称为&quot;Default&quot;</span><br><span class="line">export OS_AUTH_URL=http://controller:5000/v3  #设置OpenStack的认证URL为&quot;http://controller:5000/v3&quot;</span><br><span class="line">export OS_IDENTITY_API_VERSION=3  #设置OpenStack的身份认证API版本为&quot;3&quot;</span><br><span class="line">export OS_IMAGE_API_VERSION=2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动脚本</span></span><br><span class="line">source admin.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证</span></span><br><span class="line">openstack endpoint list</span><br><span class="line">+----------------------------------+-----------+--------------+--------------+---------+-----------+----------------------------+</span><br><span class="line">| ID                               | Region    | Service Name | Service Type | Enabled | Interface | URL                        |</span><br><span class="line">+----------------------------------+-----------+--------------+--------------+---------+-----------+----------------------------+</span><br><span class="line">| 5c4d1897030749209c3a6f22975ec618 | RegionOne | keystone     | identity     | True    | admin     | http://controller:5000/v3/ |</span><br><span class="line">| 67e3604466c14e698b0efd7f94e66288 | RegionOne | keystone     | identity     | True    | public    | http://controller:5000/v3/ |</span><br><span class="line">| 70ac89874ddf4a238699d73d05d8bb15 | RegionOne | keystone     | identity     | True    | internal  | http://controller:5000/v3/ |</span><br><span class="line">+----------------------------------+-----------+--------------+--------------+---------+-----------+----------------------------+</span><br></pre></td></tr></table></figure><h3 id="创建域、项目、用户和角色"><a href="#创建域、项目、用户和角色" class="headerlink" title="创建域、项目、用户和角色"></a>创建域、项目、用户和角色</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建一个名为<span class="string">&quot;Example&quot;</span>的域</span></span><br><span class="line">openstack domain create --description &quot;An Example Domain&quot; example</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在名为 default 的域下创建名为 service 的项目</span></span><br><span class="line">openstack project create --domain default --description &quot;Service Project&quot; service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在 default 域下创建项目 myproject (创建其他用户时,不需要重复该步骤)</span></span><br><span class="line">openstack project create --domain default --description &quot;Demo Project&quot; myproject</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建用户 myuser (需要设置密码,统一为myuser)</span></span><br><span class="line">openstack user create --domain default --password-prompt myuser</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建角色 myrole</span></span><br><span class="line">openstack role create myrole</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将角色添加到项目和用户 myrolemyprojectmyuser</span></span><br><span class="line">openstack role add --project myproject --user myuser myrole</span><br></pre></td></tr></table></figure><p><em>注：重复以上步骤可创建多个项目和用户</em></p><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">取消设置临时变量和环境变量 OS_AUTH_URLOS_PASSWORD</span></span><br><span class="line">unset OS_AUTH_URL OS_PASSWORD</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">需要输入admin密码(需要输入两次)</span></span><br><span class="line">openstack --os-auth-url http://controller:5000/v3 \</span><br><span class="line">  --os-project-domain-name Default --os-user-domain-name Default \</span><br><span class="line">  --os-project-name admin --os-username admin token issue</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">需要输入myuser密码(需要输入两次)</span></span><br><span class="line">openstack --os-auth-url http://controller:5000/v3 \</span><br><span class="line">  --os-project-domain-name Default --os-user-domain-name Default \</span><br><span class="line">  --os-project-name myproject --os-username myuser token issue</span><br></pre></td></tr></table></figure><h3 id="创建-OpenStack-客户端环境脚本"><a href="#创建-OpenStack-客户端环境脚本" class="headerlink" title="创建 OpenStack 客户端环境脚本"></a>创建 OpenStack 客户端环境脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建编辑脚本 admin-openrc</span></span><br><span class="line">mkdir -p /etc/openstack/keystone</span><br><span class="line">vi /etc/openstack/keystone/admin-openrc.sh</span><br><span class="line">export OS_PROJECT_DOMAIN_NAME=Default</span><br><span class="line">export OS_USER_DOMAIN_NAME=Default</span><br><span class="line">export OS_PROJECT_NAME=admin</span><br><span class="line">export OS_USERNAME=admin</span><br><span class="line">export OS_PASSWORD=admin</span><br><span class="line">export OS_AUTH_URL=http://controller:5000/v3</span><br><span class="line">export OS_IDENTITY_API_VERSION=3</span><br><span class="line">export OS_IMAGE_API_VERSION=2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用脚本</span></span><br><span class="line">source /etc/openstack/keystone/admin-openrc.sh</span><br><span class="line">openstack token issue</span><br></pre></td></tr></table></figure><h1 id="Glance服务"><a href="#Glance服务" class="headerlink" title="Glance服务"></a>Glance服务</h1><h2 id="controller节点-1"><a href="#controller节点-1" class="headerlink" title="controller节点"></a>controller节点</h2><h3 id="先决条件-1"><a href="#先决条件-1" class="headerlink" title="先决条件"></a>先决条件</h3><p><strong>创建数据库</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入数据库</span></span><br><span class="line">mysql -uroot -p000000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建数据库glance</span></span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE glance;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">授予对 glance 库的适当访问权限</span></span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO &#x27;glance&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;glance123&#x27;;</span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO &#x27;glance&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;glance123&#x27;;</span><br></pre></td></tr></table></figure><p><strong>创建服务凭据</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">获取要访问的凭据</span></span><br><span class="line">source /etc/openstack/keystone/admin-openrc.sh </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在名为 default 的域下创建名为 glance 的用户,需要设置密码,密码统一为glance</span></span><br><span class="line">openstack user create --domain default --password-prompt glance </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将 glance 用户添加到 service 项目的 admin 角色中</span></span><br><span class="line">openstack role add --project service --user glance admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建一个名为glance的镜像服务</span></span><br><span class="line">openstack service create --name glance --description &#x27;Openstack Image&#x27; image</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证(查看服务<span class="built_in">id</span>列表)</span></span><br><span class="line">openstack service list</span><br><span class="line">+----------------------------------+----------+----------+</span><br><span class="line">| ID                               | Name     | Type     |</span><br><span class="line">+----------------------------------+----------+----------+</span><br><span class="line">| 97ebf2fe63a2402fbfaa36237a2101e1 | glance   | image    |</span><br><span class="line">| d14e27b4de294015912bcdd58d1fb449 | keystone | identity |</span><br><span class="line">+----------------------------------+----------+----------+ </span><br></pre></td></tr></table></figure><p><strong>创建API端点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为名为 glance 的镜像服务创建一个公共的终端，并指定 URL 地址为 http://controller:9292</span></span><br><span class="line">openstack endpoint create --region RegionOne image public http://controller:9292</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">为 glance 的镜像服务创建一个内部的终端，并指定 URL 地址为 http://controller:9292</span></span><br><span class="line">openstack endpoint create --region RegionOne image internal http://controller:9292 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为 glance 的镜像服务创建一个管理员的终端，并指定 URL 地址为 http://controller:9292</span></span><br><span class="line">openstack endpoint create --region RegionOne image admin http://controller:9292 </span><br></pre></td></tr></table></figure><h3 id="安装配置组件-1"><a href="#安装配置组件-1" class="headerlink" title="安装配置组件"></a>安装配置组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum -y install openstack-glance</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑配置文件(与配置keystone方法一样)</span></span><br><span class="line">vi /etc/glance/glance-api.conf</span><br><span class="line">[database]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">connection = mysql+pymysql://glance:glance123@controller/glance #连接数据库</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">www_authenticate_uri = http://controller:5000  #Keystone 的 HTTP 认证端点地址，用于与 Glance 进行认证和授权等操作</span><br><span class="line">auth_url = http://controller:5000  #Keystone 的认证端点地址</span><br><span class="line">memcached_servers = controller:11211  # Memcached 缓存服务器的地址和端口信息，用于缓存 Glance 服务的认证令牌和会话信息</span><br><span class="line">auth_type = password  #认证类型，一般为 password</span><br><span class="line">project_domain_name = Default  #项目域名，默认为 Default</span><br><span class="line">user_domain_name = Default  #用户域名，默认为 Default</span><br><span class="line">Project_name = service  #项目名称，用于指定访问 Keystone API 时使用的项目</span><br><span class="line">username = glance  #用户名，用于指定与 Keystone 进行身份验证时使用的用户名</span><br><span class="line">password = glance  #密码，用于与 Keystone 进行身份验证时使用的密码</span><br><span class="line"></span><br><span class="line">[paste_deploy]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">flavor = keystone  #flavor 参数指定了 Glance 服务所使用的应用程序类型，取值为 keystone。这表示 Glance 服务是以 Keystone 身份认证服务为基础构建的，因此需要与之进行交互，以实现认证和授权等功能</span><br><span class="line"></span><br><span class="line">[glance_store]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">stores = file,http  # Glance 所使用的存储后端类型，可以指定多个，用逗号进行分隔。常见的存储后端类型包括 file、http、https、rbd、swift、cinder 等</span><br><span class="line">default_store = file  #默认的存储后端类型，当一个新的镜像被创建时，将使用该存储后端来保存镜像数据</span><br><span class="line">filesystem_store_datadir = /var/lib/glance/images/  #文件系统存储类型的数据目录，用于指定文件系统存储后端保存镜像数据的路径</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">同步数据库</span></span><br><span class="line">su -s /bin/sh -c &quot;glance-manage db_sync&quot; glance</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动服务</span></span><br><span class="line">systemctl enable openstack-glance-api.service</span><br><span class="line">systemctl start openstack-glance-api.service</span><br></pre></td></tr></table></figure><h3 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h3><p>验证方式可参考官方文档：</p><p><a href="https://docs.openstack.org/glance/train/install/verify.html">OpenStack Docs：验证操作</a></p><h1 id="Placement服务"><a href="#Placement服务" class="headerlink" title="Placement服务"></a>Placement服务</h1><h2 id="controller节点-2"><a href="#controller节点-2" class="headerlink" title="controller节点"></a>controller节点</h2><h3 id="先决条件-2"><a href="#先决条件-2" class="headerlink" title="先决条件"></a>先决条件</h3><p><strong>创建数据库</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入数据库</span></span><br><span class="line">mysql -uroot -p000000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建palacement库</span></span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE placement;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">授权(placement123为密码)</span></span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON placement.* TO &#x27;placement&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;placement123&#x27;;</span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON placement.* TO &#x27;placement&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;placement123&#x27;;</span><br></pre></td></tr></table></figure><p><strong>配置用户和端点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">获取凭据(admin)</span></span><br><span class="line">source /etc/openstack/keystone/admin-openrc.sh </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建用户(密码为placement,需要输入两次)</span></span><br><span class="line">openstack user create --domain default --password-prompt placement</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将placement赋予admin权限</span></span><br><span class="line">openstack role add --project service --user placement admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建Placement API项目</span></span><br><span class="line">openstack service create --name placement --description &#x27;placement API&#x27; placement</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建外部端点</span></span><br><span class="line">openstack endpoint create --region RegionOne placement public http://controller:8778</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建内部端点</span></span><br><span class="line">openstack endpoint create --region RegionOne placement internal http://controller:8778</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建管理员端点</span></span><br><span class="line">openstack endpoint create --region RegionOne placement admin http://controller:8778 </span><br></pre></td></tr></table></figure><h3 id="安装和配置组件"><a href="#安装和配置组件" class="headerlink" title="安装和配置组件"></a>安装和配置组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum -y install openstack-placement-api</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑配置文件(和之前的方法一致)</span></span><br><span class="line">vi /etc/placement/placement.conf</span><br><span class="line">[placement_database]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">connection = mysql+pymysql://placement:placement123@controller/placement</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">auth_url = http://controller:5000/v3</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">username = placement</span><br><span class="line">password = placement</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">同步数据库 placement(忽略此输出中的任何弃用消息)</span></span><br><span class="line">su -s /bin/sh -c &quot;placement-manage db sync&quot; placement</span><br></pre></td></tr></table></figure><h3 id="验证-2"><a href="#验证-2" class="headerlink" title="验证"></a>验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">获取凭证(admin)</span></span><br><span class="line">source /etc/openstack/keystone/admin-openrc.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看状态</span></span><br><span class="line">placement-status upgrade check</span><br><span class="line">+----------------------------------+</span><br><span class="line">| Upgrade Check Results            |</span><br><span class="line">+----------------------------------+</span><br><span class="line">| Check: Missing Root Provider IDs |</span><br><span class="line">| Result: Success                  |</span><br><span class="line">| Details: None                    |</span><br><span class="line">+----------------------------------+</span><br><span class="line">| Check: Incomplete Consumers      |</span><br><span class="line">| Result: Success                  |</span><br><span class="line">| Details: None                    |</span><br><span class="line">+----------------------------------+</span><br></pre></td></tr></table></figure><h1 id="Nova服务"><a href="#Nova服务" class="headerlink" title="Nova服务"></a>Nova服务</h1><h2 id="controller节点-3"><a href="#controller节点-3" class="headerlink" title="controller节点"></a>controller节点</h2><h3 id="先决条件-3"><a href="#先决条件-3" class="headerlink" title="先决条件"></a>先决条件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入数据库</span></span><br><span class="line">mysql -uroot -p000000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建三个数据库</span></span><br><span class="line">create database nova_api;</span><br><span class="line">create database nova;</span><br><span class="line">create database nova_cell0;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对以创建的三个数据库赋予权限</span></span><br><span class="line">grant all privileges on nova_api.* to &#x27;nova&#x27;@&#x27;%&#x27; identified by &#x27;nova123&#x27;;</span><br><span class="line">grant all privileges on nova.* to &#x27;nova&#x27;@&#x27;%&#x27; identified by &#x27;nova123&#x27;;</span><br><span class="line">grant all privileges on nova_cell0.* to &#x27;nova&#x27;@&#x27;%&#x27; identified by &#x27;nova123&#x27;;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建 nova 用户(密码统一为 nova)</span></span><br><span class="line">openstack user create --domain default --password-prompt nova</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将 nova 用户添加到 service 项目中并分配 admin 角色</span></span><br><span class="line">openstack role add --project service --user nova admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建一个名为 nova 的计算服务</span></span><br><span class="line">openstack service create --name nova --description &quot;Openstack Compute&quot; compute</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建一个名为 compute 的计算服务公共 API 端点</span></span><br><span class="line">openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建一个名为 compute 的计算服务内部 API 端点</span></span><br><span class="line">openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建一个名为 compute 的计算服务管理员 API 端点</span></span><br><span class="line">openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1</span><br></pre></td></tr></table></figure><h3 id="安装和配置组件-1"><a href="#安装和配置组件-1" class="headerlink" title="安装和配置组件"></a>安装和配置组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum install openstack-nova-api openstack-nova-conductor openstack-nova-novncproxy openstack-nova-scheduler -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑配置文件 /etc/nova/nova.conf</span></span><br><span class="line">vi /etc/nova/nova.conf</span><br><span class="line"></span><br><span class="line">[DEFAULT]</span><br><span class="line">enabled_apis = osapi_compute,metadata  #指定启用 Nova 计算服务的 API 类型为 osapi_compute 和 metadata，分别对应计算服务和元数据服务接口</span><br><span class="line">transport_url = rabbit://openstack:openstack123@controller:5672/  # 指定 Nova 计算服务使用的消息队列传输协议的 URL 地址，其中 openstack 和 openstack123 分别为 RabbitMQ 服务所需要的用户名和密码，controller 表示 RabbitMQ 所在的节点地址，5672 为 RabbitMQ 的默认端口号</span><br><span class="line">use_neutron = true  #指定 Nova 计算服务使用 Neutron 网络服务连接虚拟机实例，默认为 false</span><br><span class="line">firewall_driver = nova.virt.firewall.NoopFirewallDriver #指定 Nova 计算服务使用的防火墙驱动程序，该行配置表示使用 NoopFirewallDriver 空白防火墙驱动程序，即不对虚拟机实例进行防火墙设置</span><br><span class="line">my_ip = 192.168.10.10</span><br><span class="line"></span><br><span class="line">[api_database]</span><br><span class="line">connection = mysql+pymysql://nova:nova123@controller/nova_api #连接数据库</span><br><span class="line"></span><br><span class="line">[database]</span><br><span class="line">connection = mysql+pymysql://nova:nova123@controller/nova #连接数据库</span><br><span class="line"></span><br><span class="line">[api]</span><br><span class="line">auth_strategy = keystone #指定 OpenStack API 服务使用 Keystone 身份认证服务进行身份验证和授权管理</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_url = http://controller:5000/ #指定 Keystone 身份认证服务的 HTTP 认证 URL 地址，用于向 Nova 计算服务提供身份认证和授权服务</span><br><span class="line">auth_url = http://controller:5000/ # 指定 Keystone 身份认证服务的默认 URL 地址，用于向 Nova 计算服务提供身份认证和授权服务</span><br><span class="line">memcached_servers = controller:11211 #指定 Keystone 使用的 memcached 服务器地址和端口号，用于缓存身份认证令牌信息，提高身份认证效。</span><br><span class="line">auth_type = password #指定身份认证类型为密码认证，即使用用户名和密码进行身份认证</span><br><span class="line">project_domain_name = Default #指定 Keystone 身份认证服务所使用的项目域名，默认为 Default</span><br><span class="line">user_domain_name = Default #指定 Keystone 身份认证服务所使用的项目域名，默认为 Default</span><br><span class="line">project_name = service  # 指定 Keystone 身份认证服务所用的项目名称，用于与 Nova 计算服务进行交互</span><br><span class="line">username = nova #指定 Keystone 身份认证服务所用的用户名，用于与 Nova 计算服务进行交互</span><br><span class="line">password = nova #指定 Keystone 身份认证服务所用的密码，用于与 Nova 计算服务进行交互</span><br><span class="line"></span><br><span class="line">[vnc]</span><br><span class="line">enabled = true #指定 VNC 控制台功能是否启用，该行配置表示启用 VNC 控制台功能</span><br><span class="line">server_listen = $my_ip #指定 VNC 服务所监听的 IP 地址，该行配置中的 $my_ip 表示使用本地主机的 IP 地址进行监听。需要注意的是，如果计算节点的网络配置存在多个网卡或网络接口，需要指定具体的 IP 地址进行监听，否则可能导致 VNC 服务无法正常工作</span><br><span class="line">server_proxyclient_address = $my_ip #指定 VNC 服务代理客户端所使用的 IP 地址，该行配置中的 $my_ip 表示使用本地主机的 IP 地址作为代理客户端 IP 地址。代理客户端通常是指浏览器等客户端应用程序，用于连接 VNC 服务，如果不生效，可能会导致 VNC 服务无法正常工作</span><br><span class="line"></span><br><span class="line">[glance]</span><br><span class="line">api_servers = http://controller:9292  #指定 Glance 镜像服务的 API 服务器地址和端口号，用于向 Nova 计算服务提供镜像服务</span><br><span class="line"></span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = /var/lab/nova/tmp  #指定锁文件的存放路径，用于实现并发控制和资源管理</span><br><span class="line"></span><br><span class="line">[placement]</span><br><span class="line">region_name = RegionOne #指定 OpenStack 环境中的区域名称，默认为 RegionOne</span><br><span class="line">project_domain_name = Default #指定项目领域的名称，默认为 Default</span><br><span class="line">project_name = service #指定所属项目的名称</span><br><span class="line">auth_type = password #指定认证方式为密码认证</span><br><span class="line">user_domain_name = Default #指定用户领域的名称，默认为 Default</span><br><span class="line">auth_url = http://controller:5000/v3 #指定认证服务的地址和版本号，用于向 Keystone 身份认证服务进行认证</span><br><span class="line">username = placement #指定用于认证的用户名</span><br><span class="line">password = placement #指定用于认证的密码</span><br></pre></td></tr></table></figure><h3 id="同步数据库"><a href="#同步数据库" class="headerlink" title="同步数据库"></a>同步数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">填充数据库 nova-api</span></span><br><span class="line">su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注册数据库 cell0</span></span><br><span class="line">su -s /bin/sh -c &quot;nova-manage cell_v2 map_cell0&quot; nova</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建单元格 cell1</span></span><br><span class="line">su -s /bin/sh -c &quot;nova-manage cell_v2 create_cell --name=cell1 --verbose&quot; nova</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">填充nova数据库</span></span><br><span class="line">su -s /bin/sh -c &quot;nova-manage db sync&quot; nova</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证是否正确注册</span></span><br><span class="line">su -s /bin/sh -c &quot;nova-manage cell_v2 list_cells&quot; nova</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动服务(配置为在系统启动时启动)</span></span><br><span class="line">systemctl enable openstack-nova-api --now</span><br><span class="line">systemctl enable openstack-nova-scheduler --now</span><br><span class="line">systemctl enable openstack-nova-conductor --now</span><br><span class="line">systemctl enable openstack-nova-novncproxy --now</span><br></pre></td></tr></table></figure><h2 id="compute节点"><a href="#compute节点" class="headerlink" title="compute节点"></a>compute节点</h2><h3 id="安装配置组件-2"><a href="#安装配置组件-2" class="headerlink" title="安装配置组件"></a>安装配置组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum -y install openstack-nova-compute</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑配置文件 /etc/nova/nova.conf</span></span><br><span class="line">vi /etc/nova/nova.conf</span><br><span class="line"></span><br><span class="line">[DEFAULT]</span><br><span class="line">enabled_apis = osapi_compute,metadata   #表示启用的API服务，包括计算服务（osapi_compute）和元数据服务（metadata）</span><br><span class="line">transport_url = rabbit://openstack:openstack123@controller  #表示消息队列RabbitMQ的连接地址，用户名为openstack，密码为openstack123，连接到服务器为controller</span><br><span class="line">my_ip = 192.168.10.20  #为当前节点的IP地址</span><br><span class="line">use_neutron = true  #表示是否使用Neutron网络服务</span><br><span class="line">firewall_driver = nova.virt.firewall.NoopFirewallDriver  #表示所使用的防火墙驱动。这里设置nova.virt.firewall.NoopFirewallDriver，#即不启用防火墙功能</span><br><span class="line"></span><br><span class="line">[api]</span><br><span class="line">auth_strategy = keystone  #表示认证策略，这里设为keystone</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_url = http://controller:5000/   #Keystone服务的认证地址</span><br><span class="line">auth_url = http://controller:5000/  #Keystone服务的管理地址</span><br><span class="line">memcached_servers = controller:11211 #为Memcached服务地址，用于缓存Keystone的token</span><br><span class="line">auth_type = password  #表示认证类型，这里为password</span><br><span class="line">project_domain_name = Default  #项目域名</span><br><span class="line">user_domain_name = Default  #用户域名</span><br><span class="line">project_name = service  #项目</span><br><span class="line">username = nova  #用户名</span><br><span class="line">password = nova  #密码</span><br><span class="line"></span><br><span class="line">[vnc]</span><br><span class="line">enabled = true  #enabled表示是否启用VNC</span><br><span class="line">server_listen = 0.0.0.0  #表示监听地址</span><br><span class="line">server_proxyclient_address = $my_ip  #表示代理客户端地址，这里为$my_ip</span><br><span class="line">novncproxy_base_url = http://controller:6080/vnc_auto.html  #为使用novnc协议时的URL地址</span><br><span class="line"></span><br><span class="line">[glance]</span><br><span class="line">api_servers = http://controller:9292  #表示Glance镜像服务的API地址</span><br><span class="line"></span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = /var/lab/nova/tmp  #表示锁文件的存储路径</span><br><span class="line"></span><br><span class="line">[placement]</span><br><span class="line">region_name = RegionOne #指定 OpenStack 环境中的区域名称，默认为 RegionOne</span><br><span class="line">project_domain_name = Default #指定项目领域的名称，默认为 Default</span><br><span class="line">project_name = service #指定所属项目的名称</span><br><span class="line">auth_type = password #指定认证方式为密码认证</span><br><span class="line">user_domain_name = Default #指定用户领域的名称，默认为 Default</span><br><span class="line">auth_url = http://controller:5000/v3 #指定认证服务的地址和版本号，用于向 Keystone 身份认证服务进行认证</span><br><span class="line">username = placement #指定用于认证的用户名</span><br><span class="line">password = placement #指定用于认证的密码</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">确定计算节点是否支持硬件加速</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">egrep -c <span class="string">&#x27;(vmx|svm)&#x27;</span> /proc/cpuinfo</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑配置文件 /etc/nova/nova.conf</span></span><br><span class="line">[libvirt]</span><br><span class="line">virt_type = qemu</span><br></pre></td></tr></table></figure><h3 id="启动服务并验证"><a href="#启动服务并验证" class="headerlink" title="启动服务并验证"></a>启动服务并验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动服务</span></span><br><span class="line">systemctl enable libvirtd --now</span><br><span class="line">systemctl enable openstack-nova-compute --now</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在controller节点上执行</span></span><br><span class="line">openstack compute service list --service nova-compute</span><br><span class="line">+----+--------------+---------+------+---------+-------+----------------------------+</span><br><span class="line">| ID | Binary       | Host    | Zone | Status  | State | Updated At                 |</span><br><span class="line">+----+--------------+---------+------+---------+-------+----------------------------+</span><br><span class="line">| 10 | nova-compute | compute | nova | enabled | up    | 2024-03-11T06:08:53.000000 |</span><br><span class="line">+----+--------------+---------+------+---------+-------+----------------------------+</span><br><span class="line">su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova</span><br><span class="line"></span><br><span class="line">Found 2 cell mappings.</span><br><span class="line">Skipping cell0 since it does not contain hosts.</span><br><span class="line">Getting computes from cell &#x27;cell1&#x27;: c3bce124-3708-41eb-8bc0-d00ad8c97174</span><br><span class="line">Checking host mapping for compute host &#x27;compute&#x27;: 485f806a-29ce-4440-ac6b-93d6173421da</span><br><span class="line">Creating host mapping for compute host &#x27;compute&#x27;: 485f806a-29ce-4440-ac6b-93d6173421da</span><br><span class="line">Found 1 unmapped computes in cell: c3bce124-3708-41eb-8bc0-d0</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑配置文件 /etc/nova/nova.conf</span></span><br><span class="line">vi /etc/nova/nova.conf</span><br><span class="line">[scheduler]</span><br><span class="line">discover_hosts_in_cells_interval = 300  #表示在Nova单元格（cell）架构中发现主机并将其映射到适当的单元格的频率</span><br></pre></td></tr></table></figure><h1 id="Neutron服务"><a href="#Neutron服务" class="headerlink" title="Neutron服务"></a>Neutron服务</h1><h2 id="controller节点-4"><a href="#controller节点-4" class="headerlink" title="controller节点"></a>controller节点</h2><h3 id="先决条件-4"><a href="#先决条件-4" class="headerlink" title="先决条件"></a>先决条件</h3><p><strong>创建数据库</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入数据库</span></span><br><span class="line">mysql -uroot -p000000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建数据库 neutron</span></span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE neutron;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">赋予权限</span></span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO &#x27;neutron&#x27;@&#x27;localhost&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;neutron123&#x27;;</span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO &#x27;neutron&#x27;@&#x27;%&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;neutron123&#x27;;</span><br></pre></td></tr></table></figure><p><strong>创建服务凭据</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建用户 neutron 密码为 neutron</span></span><br><span class="line">openstack user create --domain default --password-prompt neutron</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">为neutron用户赋予admin权限</span></span><br><span class="line">openstack role add --project service --user neutron admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建网络服务</span></span><br><span class="line">openstack service create --name neutron --description &quot;Openstack Networking&quot; network </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建外部端点</span></span><br><span class="line">openstack endpoint create --region RegionOne network public http://controller:9696 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建内部端点</span></span><br><span class="line">openstack endpoint create --region RegionOne network internal http://controller:9696  </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建管理员端点</span></span><br><span class="line">openstack endpoint create --region RegionOne network admin http://controller:9696</span><br></pre></td></tr></table></figure><h3 id="安装配置组件-3"><a href="#安装配置组件-3" class="headerlink" title="安装配置组件"></a>安装配置组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum install openstack-neutron openstack-neutron-ml2 openstack-neutron-linuxbridge ebtables -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑配置文件 /etc/neutron/neutron.conf</span></span><br><span class="line">vi /etc/neutron/neutron.conf</span><br><span class="line"></span><br><span class="line">[DEFAULT]</span><br><span class="line">core_plugin = ml2  #表示Neutron使用的核心插件，这里为ml2</span><br><span class="line">service_plugin =   #表示Neutron使用的服务插件，这里为空字符串（即未设置）</span><br><span class="line">transport_url = rabbit://openstack:openstack123@controller  #表示消息传输的URL，这里为使用RabbitMQ消息队列服务的地址</span><br><span class="line">auth_strategy = keystone  #表示认证策略，这里为keystone</span><br><span class="line">notify_nova_on_port_status_changes = true  #当某个port状态有变化时是否通知Nova，这里设置为true</span><br><span class="line">notify_nova_on_port_data_changes = true  #当某个port数据有变化时是否通知Nova，这里设置为true</span><br><span class="line"></span><br><span class="line">[database]</span><br><span class="line">connection = mysql+pymysql://neutron:neutron123@controller/neutron  #表示Neutron使用的数据库连接信息</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_url = http://controller:5000  #表示认证时使用的URL，这里为Keystone服务的URL</span><br><span class="line">auth_url = http://controller:5000  #表示认证时使用的URL，这里为Keystone服务的URL</span><br><span class="line">memcached_servers = controller:11211  #表示存储缓存信息的Memcached服务地址，这里为controller服务器的11211端口</span><br><span class="line">auth_type = password  #表示认证类型，这里为password</span><br><span class="line">project_domain_name = default  #表示Neutron使用的项目域名，这里为默认值default</span><br><span class="line">user_domain_name = default  #表示Neutron使用的用户域名，这里为默认值default</span><br><span class="line">project_name = service  #表示Neutron使用的项目名称，这里为service</span><br><span class="line">username = neutron  #表示Neutron使用的用户名，这里为neutron</span><br><span class="line">password = neutron  #表示Neutron使用的用户密码，这里为neutron</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">文件最下面新增</span></span><br><span class="line">[nova]</span><br><span class="line">auth_url = http://controller:5000  #表示Nova服务使用的Keystone认证URL，这里为controller服务器的5000端口</span><br><span class="line">auth_type = password  #表示认证类型，这里为password</span><br><span class="line">project_domain_name = default  #表示Nova服务使用的项目域名，这里为默认值default</span><br><span class="line">user_domain_name = default  #表示Nova服务使用的用户域名，这里为默认值default</span><br><span class="line">region_name = RegionOne  #表示Nova服务所在的区域名称，这里为RegionOne</span><br><span class="line">project_name = service  #表示Nova服务使用的项目名称，这里为service</span><br><span class="line">username = nova  #表示Nova服务使用的用户名，这里为nova</span><br><span class="line">password = nova  #表示Nova服务使用的用户密码，这里为nova</span><br><span class="line"></span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = /var/lib/neutron/tmp  #表示存储锁文件的路径，这里为/var/lib/neutron/tmp</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/neutron/plugins/ml2/ml2_conf.ini</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">文末新增</span></span><br><span class="line">[ml2]</span><br><span class="line">type_drivers = flat.vlan  #表示网络类型的驱动程序类型，这里有两种类型：flat和vlan</span><br><span class="line">tenant_network_types =  #表示拥有哪些网络类型的租户网络，这里为空，即租户无法使用任何网络类型</span><br><span class="line">mechanism_drivers = linuxbridge  #表示底层网络设备驱动程序类型，这里为linuxbridge</span><br><span class="line">extension_drivers = port_security  #表示支持的扩展驱动程序类型，这里为port_security，表示支持安全端口功能</span><br><span class="line">flat_networks = extnet  #表示该服务支持的平面网络名称列表，这里为extnet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[securitygroup]</span><br><span class="line">enable_ipset = true  #指定是否启用ipset安全组驱动程序，这里为true</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/neutron/plugins/ml2/linuxbridge_agent.ini</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">文件末新增</span></span><br><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = extnet:ens33  #指定Linux网桥的物理网络接口名称和虚拟网络名称之间的映射关系，这里为extnet:ens33，表示将虚拟网络extnet连接到物理网络接口ens33上</span><br><span class="line"></span><br><span class="line">[vxlan]</span><br><span class="line">enable_vxlan = false  #指定是否启用VXLAN网络，这里为false，表示不使用VXLAN网络</span><br><span class="line"> </span><br><span class="line">[securitygroup]</span><br><span class="line">enable_security_group = true  #指定是否启用安全组，这里为true，表示启用安全组功能</span><br><span class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver  #指定防火墙驱动程序类型，这里为neutron.agent.linux.iptables_firewall.IptablesFirewallDriver，表示使用iptables防火墙驱动程序</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置内核</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置内核</span></span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1  #表示当Linux网桥接收到网络数据包时，将会检查iptables过滤规则，并按照规则进行过滤。这个参数在使用Linux网桥作为虚拟网络设备时非常重要，因为它可以确保虚拟网络中的数据传输符合安全策略，提高网络的可靠性和安全性</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1  #表示当Linux网桥接收到IPv6网络数据包时，将会检查ip6tables过滤规则，并按照规则进行过滤。这个参数同样对于使用IPv6地址的虚拟网络设备非常重要。</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/neutron/dhcp_agent.ini</span><br><span class="line">[DEFAULT]</span><br><span class="line">interface_driver = linuxbridge  #指定DHCP代理的接口驱动程序类型为Linux桥接</span><br><span class="line">dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq  #指定DHCP代理的接口驱动程序类型为Linux桥接</span><br><span class="line">enable_isolated_metadata = true  #指定是否启用隔离元数据代理服务，这里为true，表示启用服务</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/neutron/metadata_agent.ini</span><br><span class="line">[DEFAULT]</span><br><span class="line">nova_metadata_host = controller  #指定OpenStack Nova API的元数据服务主机地址，这里为controller，表示元数据服务运行在OpenStack控制节点上</span><br><span class="line">metadata_proxy_shared_secret = xier123  #指定元数据代理与元数据服务之间共享的密钥，这里为xier123，需要确保元数据服务与元数据代理使用相同的密钥</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/nova/nova.conf</span><br><span class="line">[neutron]</span><br><span class="line">auth_url = http://controller:5000  #指定OpenStack Identity服务的URL地址</span><br><span class="line">auth_type = password  #指定认证类型为密码认证</span><br><span class="line">project_domain_name = default  #指定项目域名称为默认</span><br><span class="line">user_domain_name = default  #指定用户域名称为默认</span><br><span class="line">region_name = RegionOne  #指定OpenStack服务所在的区域/地区名称</span><br><span class="line">project_name = service  #指定Nova服务的项目名称</span><br><span class="line">username = neutron  #指定连接到Neutron服务时使用的用户名</span><br><span class="line">password = neutron  #指定连接到Neutron服务时使用的密码</span><br><span class="line">service_metadata_proxy = true  #表示Nova计算服务将启用元数据代理服务，并将元数据代理服务与Neutron服务集成</span><br><span class="line">metadata_proxy_shared_secret = xier123  #指定元数据代理与元数据服务之间共享的密钥，这里为xier123，需要确保元数据代理与元数据服务使用相同的密钥</span><br></pre></td></tr></table></figure><h3 id="同步数据库并启动服务"><a href="#同步数据库并启动服务" class="headerlink" title="同步数据库并启动服务"></a>同步数据库并启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建软连接</span></span><br><span class="line">ln -s /etc/neutron/plugins/ml2/ml2_conf.ini  /etc/neutron/plugin.ini</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">同步数据库</span></span><br><span class="line">su -s /bin/sh -c &quot;neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head&quot; neutron</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重启服务并设置开机自启</span></span><br><span class="line">systemctl restart neutron-server neutron-linuxbridge-agent neutron-dhcp-agent neutron-metadata-agent</span><br><span class="line"> systemctl enable neutron-server neutron-linuxbridge-agent neutron-dhcp-agent neutron-metadata-agent</span><br></pre></td></tr></table></figure><h2 id="compute节点-1"><a href="#compute节点-1" class="headerlink" title="compute节点"></a>compute节点</h2><h3 id="安装配置组件-4"><a href="#安装配置组件-4" class="headerlink" title="安装配置组件"></a>安装配置组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum install openstack-neutron-linuxbridge ebtables ipset -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改配置文件 /etc/neutron/neutron.conf</span></span><br><span class="line">vi /etc/neutron/neutron.conf</span><br><span class="line"></span><br><span class="line">[DEFAULT]</span><br><span class="line">transport_url = rabbit://openstack:openstack123@controller  #指定RabbitMQ的连接URL地址</span><br><span class="line">auth_strategy = keystone  #指定认证策略为Keystone认证</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_url = http://controller:5000  #指定用于向用户提供身份验证页面的URL地址</span><br><span class="line">auth_url = http://controller:5000  #指定Keystone服务的URL地址</span><br><span class="line">memcached_servers = controller:11211  #指定用于缓存令牌(token)的Memcached服务地址和端口号</span><br><span class="line">auth_type = password  #指定认证类型为密码认证</span><br><span class="line">project_domain_name = default  #指定项目域名称为默认(default)</span><br><span class="line">user_domain_name = default  #指定用户域名称为默认(default)</span><br><span class="line">project_name = service  #指定服务所在的项目名称</span><br><span class="line">username = neutron  #指定连接到Keystone服务时使用的用户名</span><br><span class="line">password = neutron  #指定连接到Keystone服务时使用的密码</span><br><span class="line"></span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = /var/lib/neutron/tmp  #指定保存锁文件的路径</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/neutron/plugins/ml2/linuxbridge_agent.ini</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">文件末新增</span></span><br><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = extnet:ens33  #指定了网桥与物理网络接口的映射关系</span><br><span class="line"></span><br><span class="line">[vxlan]</span><br><span class="line">enable_vxlan = false  #参数指定是否启用VXLAN虚拟化网络</span><br><span class="line"></span><br><span class="line">[securitygroup]</span><br><span class="line">enable_security_group = true  #参数指定是否启用安全组功能</span><br><span class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver  #参数指定使用哪个防火墙驱动程序，这里使用基于iptables的驱动程序IptablesFirewallDriver</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/nova/nova.conf</span><br><span class="line">[neutron]</span><br><span class="line">auth_url = http://controller:5000  #参数指定了认证服务的访问地址</span><br><span class="line">auth_type = password  #参数指定了认证方式</span><br><span class="line">project_domain_name = default  #参数指定了所使用的域名</span><br><span class="line">user_domain_name = default  #参数指定了所使用的域名</span><br><span class="line">region_name = RegionOne  #参数指定了Neutron服务所属的区域名称</span><br><span class="line">project_name = service  #参数指定了Neutron服务所属的项目名称</span><br><span class="line">username = neutron  #用户名</span><br><span class="line">password = neutron  #密码</span><br></pre></td></tr></table></figure><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openstack-nova-compute</span><br><span class="line">systemctl enable neutron-linuxbridge-agent --now</span><br></pre></td></tr></table></figure><h1 id="Dashboard服务"><a href="#Dashboard服务" class="headerlink" title="Dashboard服务"></a>Dashboard服务</h1><h2 id="controller节点-5"><a href="#controller节点-5" class="headerlink" title="controller节点"></a>controller节点</h2><h3 id="安装配置组件-5"><a href="#安装配置组件-5" class="headerlink" title="安装配置组件"></a>安装配置组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum install openstack-dashboard -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改配置文件 /etc/openstack-dashboard/local_settings</span></span><br><span class="line">vi /etc/openstack-dashboard/local_settings</span><br><span class="line"></span><br><span class="line">OPENSTACK_HOST = &quot;controller&quot;  #参数指定了OpenStack服务所在主机的名称或IP地址</span><br><span class="line">ALLOWED_HOSTS = [&#x27;*&#x27;]  #参数指定了OpenStack服务所在主机的名称或IP地址，这里表示允许所有</span><br><span class="line">SESSION_ENGINE = &#x27;django.contrib.sessions.backends.cache&#x27;  </span><br><span class="line">CACHES = &#123;</span><br><span class="line">    &#x27;default&#x27;: &#123;        </span><br><span class="line">        &#x27;BACKEND&#x27;: &#x27;django.core.cache.backends.memcached.MemcachedCache&#x27;,   #</span><br><span class="line">        &#x27;LOCATION&#x27;: &#x27;controller:11211&#x27;,</span><br><span class="line">    &#125;  #指定了使用缓存来存储用户会话信息的方式，这里使用的是Memcached</span><br><span class="line">&#125;</span><br><span class="line">OPENSTACK_KEYSTONE_URL = &quot;http://%s:5000/v3&quot; % OPENSTACK_HOST  #参数指定了Keystone认证服务的访问地址</span><br><span class="line">OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True  #新增,表示支持多域模式</span><br><span class="line">OPENSTACK_API_VERSIONS = &#123;</span><br><span class="line">    &quot;identity&quot;: 3,</span><br><span class="line">    &quot;image&quot;: 2,</span><br><span class="line">    &quot;volume&quot;: 2,</span><br><span class="line">&#125;  #新增，指定api版本信息</span><br><span class="line">OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = &#x27;Default&#x27; #新增，参数指定了默认域名</span><br><span class="line">OPENSTACK_KEYSTONE_DEFAULT_ROLE = &#x27;user&#x27; #新增 ，参数指定了默认角色，这里为user</span><br><span class="line">OPENSTACK_NEUTRON_NETWORK = &#123;</span><br><span class="line">    &#x27;enable_auto_allocated_network&#x27;: False,</span><br><span class="line">    &#x27;enable_distributed_router&#x27;: False,</span><br><span class="line">    &#x27;enable_fip_topology_check&#x27;: True,</span><br><span class="line">    &#x27;enable_ha_router&#x27;: False,</span><br><span class="line">    &#x27;enable_lb&#x27;: False,</span><br><span class="line">    &#x27;enable_firewall&#x27;: False,</span><br><span class="line">    &#x27;enable_vpn&#x27;: False,</span><br><span class="line">    &#x27;enable_ipv6&#x27;: True,</span><br><span class="line">    &#x27;enable_fip_topology_check&#x27;: False,</span><br><span class="line">    # TODO(amotoki): Drop OPENSTACK_NEUTRON_NETWORK completely from here.</span><br><span class="line">    # enable_quotas has the different default value here.</span><br><span class="line">    &#x27;enable_quotas&#x27;: False,</span><br><span class="line">    &#x27;enable_rbac_policy&#x27;: True,</span><br><span class="line">    &#x27;enable_router&#x27;: False,</span><br><span class="line">    &#x27;default_dns_nameservers&#x27;: [],</span><br><span class="line">    &#x27;supported_provider_types&#x27;: [&#x27;*&#x27;],</span><br><span class="line">    &#x27;segmentation_id_range&#x27;: &#123;&#125;,</span><br><span class="line">    &#x27;extra_provider_types&#x27;: &#123;&#125;,</span><br><span class="line">    &#x27;supported_vnic_types&#x27;: [&#x27;*&#x27;],</span><br><span class="line">    &#x27;physical_networks&#x27;: [],</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">TIME_ZONE = &quot;Asia/Shanghai&quot;  #新增，参数用于指定时区，这里设置为&quot;Asia/Shanghai&quot;，以符合中国标准时间</span><br><span class="line">WEBROOT = &#x27;/dashboard&#x27;  #新增，用于指定OpenStack仪表盘的访问路径，这里设置为/dashboard</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/httpd/conf.d/openstack-dashboard.conf </span><br><span class="line"></span><br><span class="line">WSGIApplicationGroup %&#123;GLOBAL&#125;  #新增</span><br></pre></td></tr></table></figure><h3 id="启动服务并验证-1"><a href="#启动服务并验证-1" class="headerlink" title="启动服务并验证"></a>启动服务并验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重启服务</span></span><br><span class="line">systemctl restart httpd memcached</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证</span></span><br><span class="line">访问: 192.168.10.10/dashboard</span><br><span class="line">域: default</span><br><span class="line">用户名: admin</span><br><span class="line">密码: admin</span><br></pre></td></tr></table></figure><ul><li><img src="https://img2.imgtp.com/2024/03/12/tIypOq4x.png" alt="屏幕截图 2024-03-12 160224.png"></li></ul><p><img src="https://img2.imgtp.com/2024/03/12/vJfRTGJz.png" alt="屏幕截图 2024-03-12 160211.png"></p><h1 id="Cinder服务"><a href="#Cinder服务" class="headerlink" title="Cinder服务"></a>Cinder服务</h1><h2 id="controller节点-6"><a href="#controller节点-6" class="headerlink" title="controller节点"></a>controller节点</h2><h3 id="先决条件-5"><a href="#先决条件-5" class="headerlink" title="先决条件"></a>先决条件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建数据库赋予权限</span></span><br><span class="line">mysql -uroot -p000000</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE cinder;</span><br><span class="line">MariaDB [(none)]&gt; grant all privileges on cinder.* to &#x27;cinder&#x27;@&#x27;%&#x27; identified by &#x27;cinder123&#x27;;</span><br></pre></td></tr></table></figure><h4 id="创建用户凭据"><a href="#创建用户凭据" class="headerlink" title="创建用户凭据"></a>创建用户凭据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建用户 密码为 cinder</span></span><br><span class="line">openstack user create --domain default --password-prompt cinder</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加到admin</span></span><br><span class="line">openstack role add --project service --user cinder admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建和服务实体</span> </span><br><span class="line">openstack service create --name cinderv2 --description &quot;OpenStack Block Storage&quot; volumev2</span><br><span class="line"></span><br><span class="line">openstack service create --name cinderv3 --description &quot;OpenStack Block Storage&quot; volumev3</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建块存储服务 API 端点</span></span><br><span class="line">openstack endpoint create --region RegionOne volumev2 public http://controller:8776/v2/%\(project_id\)s</span><br><span class="line"></span><br><span class="line">openstack endpoint create --region RegionOne volumev2 internal http://controller:8776/v2/%\(project_id\)s</span><br><span class="line"></span><br><span class="line">openstack endpoint create --region RegionOne volumev2 admin http://controller:8776/v2/%\(project_id\)s</span><br><span class="line"></span><br><span class="line">openstack endpoint create --region RegionOne volumev3 public http://controller:8776/v3/%\(project_id\)s</span><br><span class="line"></span><br><span class="line">openstack endpoint create --region RegionOne volumev3 internal http://controller:8776/v3/%\(project_id\)s</span><br><span class="line"></span><br><span class="line">openstack endpoint create --region RegionOne volumev3 admin http://controller:8776/v3/%\(project_id\)s</span><br><span class="line">  </span><br></pre></td></tr></table></figure><h3 id="安装配置组件-6"><a href="#安装配置组件-6" class="headerlink" title="安装配置组件"></a>安装配置组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum install openstack-cinder -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑配置文件 /etc/cinder/cinder.conf</span></span><br><span class="line">vi /etc/cinder/cinder.conf</span><br><span class="line"></span><br><span class="line">[DEFAULT]</span><br><span class="line">transport_url = rabbit://openstack:openstack123@controller</span><br><span class="line">auth_strategy = keystone</span><br><span class="line">my_ip = 192.168.10.10</span><br><span class="line"></span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = /var/lib/cinder/tmp</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:5000</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">project_name = service</span><br><span class="line">username = cinder</span><br><span class="line">password = cinder</span><br><span class="line"></span><br><span class="line">[database]</span><br><span class="line">connection = mysql+pymysql://cinder:cinder123@controller/cinder</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/nova/nova.conf</span><br><span class="line">[cinder]</span><br><span class="line">os_region_name = RegionOne</span><br></pre></td></tr></table></figure><h3 id="完成安装"><a href="#完成安装" class="headerlink" title="完成安装"></a>完成安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">同步数据库</span></span><br><span class="line">sudo su -s /bin/sh -c &quot;cinder-manage db sync&quot; cinder</span><br><span class="line"></span><br><span class="line">systemctl restart openstack-nova-api</span><br><span class="line">systemctl start openstack-cinder-api openstack-cinder-scheduler</span><br><span class="line">systemctl enable openstack-cinder-api openstack-cinder-scheduler</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证</span></span><br><span class="line">openstack volume service list</span><br><span class="line">+------------------+------------+------+---------+-------+----------------------------+</span><br><span class="line">| Binary           | Host       | Zone | Status  | State | Updated At                 |</span><br><span class="line">+------------------+------------+------+---------+-------+----------------------------+</span><br><span class="line">| cinder-scheduler | controller | nova | enabled | up    | 2024-03-12T08:29:34.000000 |</span><br><span class="line">+------------------+------------+------+---------+-------+----------------------------+</span><br></pre></td></tr></table></figure><h2 id="compute节点-2"><a href="#compute节点-2" class="headerlink" title="compute节点"></a>compute节点</h2><h3 id="先决条件-6"><a href="#先决条件-6" class="headerlink" title="先决条件"></a>先决条件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum install lvm2 device-mapper-persistent-data -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动服务并设置开机自启动</span></span><br><span class="line">systemctl enable lvm2-lvmetad.service</span><br><span class="line">systemctl start lvm2-lvmetad.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建物理卷</span></span><br><span class="line">pvcreate /dev/sdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建 LVM 卷组</span></span><br><span class="line">vgcreate cinder-volumes /dev/sdb</span><br><span class="line"></span><br><span class="line">vi /etc/lvm/lvm.conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在130行下插入</span></span><br><span class="line">filter = [ &quot;a/sda/&quot;, &quot;a/sdb/&quot;, &quot;r/.*/&quot;]   #filter过滤器中每个项目的开头都为&quot;a&quot;或&quot;r&quot;，用于接受或拒绝某个设备</span><br></pre></td></tr></table></figure><h3 id="安装配置组件-7"><a href="#安装配置组件-7" class="headerlink" title="安装配置组件"></a>安装配置组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum install openstack-cinder targetcli python-keystone -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑配置文件 /etc/cinder/cinder.conf</span></span><br><span class="line">vi /etc/cinder/cinder.conf</span><br><span class="line"></span><br><span class="line">[DEFAULT]</span><br><span class="line">transport_url = rabbit://openstack:openstack123@controller</span><br><span class="line">auth_strategy = keystone</span><br><span class="line">my_ip = 192.168.10.10</span><br><span class="line">enabled_backends = lvm</span><br><span class="line">glance_api_servers = http://controller:9292</span><br><span class="line"></span><br><span class="line">[database]</span><br><span class="line">connection = mysql+pymysql://cinder:cinder123@controller/cinder</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:5000</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">project_name = service</span><br><span class="line">username = cinder</span><br><span class="line">password = cinder</span><br><span class="line"></span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = /var/lib/cinder/tmp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">文末新增</span></span><br><span class="line">[lvm]</span><br><span class="line">volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver  #表示使用的卷驱动程序</span><br><span class="line">volume_group = cinder-volumes  #表示使用的卷驱动程序组名称</span><br><span class="line">iscsi_protocol = iscsi  #表示卷访问使用的 iSCSI 协议版本，这里是iSCSIv2(v1通常不在被使用)</span><br><span class="line">iscsi_helper = lioadm   #表示使用 Linux iSCSI Target 和 initiator 之间的 LIO 工具来管理 iSCSI 连接</span><br></pre></td></tr></table></figure><h3 id="启动服务并验证-2"><a href="#启动服务并验证-2" class="headerlink" title="启动服务并验证"></a>启动服务并验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动服务并设置为开机自启动</span></span><br><span class="line">systemctl start openstack-cinder-volume.service target.service</span><br><span class="line">systemctl enable openstack-cinder-volume.service target.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在控制节点验证</span></span><br><span class="line">openstack volume service list</span><br><span class="line">+------------------+-------------+------+---------+-------+----------------------------+</span><br><span class="line">| Binary           | Host        | Zone | Status  | State | Updated At                 |</span><br><span class="line">+------------------+-------------+------+---------+-------+----------------------------+</span><br><span class="line">| cinder-scheduler | controller  | nova | enabled | up    | 2024-03-12T08:47:44.000000 |</span><br><span class="line">| cinder-volume    | compute@lvm | nova | enabled | up    | 2024-03-12T08:47:38.000000 |</span><br><span class="line">+------------------+-------------+------+---------+-------+----------------------------+</span><br></pre></td></tr></table></figure><h1 id="Swift服务"><a href="#Swift服务" class="headerlink" title="Swift服务"></a>Swift服务</h1><h2 id="controller节点-7"><a href="#controller节点-7" class="headerlink" title="controller节点"></a>controller节点</h2><h3 id="先决条件-7"><a href="#先决条件-7" class="headerlink" title="先决条件"></a>先决条件</h3><p><strong>创建服务凭据</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建服务 密码为swift</span></span><br><span class="line">openstack user create --domain default --password-prompt swift</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加到admin中</span></span><br><span class="line">openstack role add --project service --user swift admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建服务实体</span></span><br><span class="line">openstack service create --name swift --description &quot;OpenStack Object Storage&quot; object-store</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建对象存储服务 API 端点</span></span><br><span class="line">openstack endpoint create --region RegionOne object-store public http://controller:8080/v1/AUTH_%\(project_id\)s</span><br><span class="line"></span><br><span class="line">openstack endpoint create --region RegionOne object-store internal http://controller:8080/v1/AUTH_%\(project_id\)s</span><br><span class="line"></span><br><span class="line">openstack endpoint create --region RegionOne object-store admin http://controller:8080/v1</span><br></pre></td></tr></table></figure><h3 id="安装配置组件-8"><a href="#安装配置组件-8" class="headerlink" title="安装配置组件"></a>安装配置组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum install openstack-swift-proxy python-swiftclient python-keystoneclient python-keystonemiddleware memcached -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">从对象存储中获取代理服务配置文件 源存储库</span></span><br><span class="line">curl -o /etc/swift/proxy-server.conf https://opendev.org/openstack/swift/raw/branch/master/etc/proxy-server.conf-sample</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑配置文件 /etc/swift/proxy-server.conf</span></span><br><span class="line">vi /etc/swift/proxy-server.conf</span><br><span class="line">[DEFAULT]</span><br><span class="line">bind_port = 8080</span><br><span class="line">user = swift</span><br><span class="line">swift_dir = /etc/swift</span><br><span class="line"></span><br><span class="line">[pipeline:main]</span><br><span class="line">pipeline = catch_errors gatekeeper healthcheck proxy-logging cache container_sync bulk ratelimit authtoken keystoneauth container-quotas account-quotas slo dlo versioned_writes proxy-logging proxy-server</span><br><span class="line"></span><br><span class="line">[app:proxy-server]</span><br><span class="line">use = egg:swift#proxy</span><br><span class="line">account_autocreate = True</span><br><span class="line"></span><br><span class="line">[filter:keystoneauth]</span><br><span class="line">use = egg:swift#keystoneauth</span><br><span class="line">operator_roles = admin,user</span><br><span class="line"></span><br><span class="line">[filter:authtoken]</span><br><span class="line">paste.filter_factory = keystonemiddleware.auth_token:filter_factory</span><br><span class="line">www_authenticate_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:5000</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_id = default</span><br><span class="line">user_domain_id = default</span><br><span class="line">project_name = service</span><br><span class="line">username = swift</span><br><span class="line">password = swift</span><br><span class="line">delay_auth_decision = True</span><br><span class="line"></span><br><span class="line">[filter:cache]</span><br><span class="line">use = egg:swift#memcache</span><br><span class="line">memcache_servers = controller:11211</span><br></pre></td></tr></table></figure><h2 id="compute节点-3"><a href="#compute节点-3" class="headerlink" title="compute节点"></a>compute节点</h2><h3 id="先决条件-8"><a href="#先决条件-8" class="headerlink" title="先决条件"></a>先决条件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装支持实用程序包</span></span><br><span class="line">yum install xfsprogs rsync</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将设备格式化</span></span><br><span class="line">mkfs.xfs /dev/sdb</span><br><span class="line">mkfs.xfs /dev/sdc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建挂载点目录</span></span><br><span class="line">mkdir -p /srv/node/sdb</span><br><span class="line">mkdir -p /srv/node/sdc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查找新分区</span></span><br><span class="line">blkid</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑文件并向其添加内容 /etc/fstab</span></span><br><span class="line">UUID=&quot;&lt;UUID-from-output-above&gt;&quot; /srv/node/sdb xfs noatime 0 2</span><br><span class="line">UUID=&quot;&lt;UUID-from-output-above&gt;&quot; /srv/node/sdc xfs noatime 0 2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">挂载设备</span></span><br><span class="line">mount /srv/node/sdb</span><br><span class="line">mount /srv/node/sdc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建或编辑文件以包含以下内容 /etc/rsyncd.conf</span></span><br><span class="line">vi /etc/rsyncd.conf</span><br><span class="line"></span><br><span class="line">uid = swift</span><br><span class="line">gid = swift</span><br><span class="line">log file = /var/log/rsyncd.log</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">address = 192.168.10.20</span><br><span class="line"></span><br><span class="line">[account]</span><br><span class="line">max connections = 2</span><br><span class="line">path = /srv/node/</span><br><span class="line">read only = False</span><br><span class="line">lock file = /var/lock/account.lock</span><br><span class="line"></span><br><span class="line">[container]</span><br><span class="line">max connections = 2</span><br><span class="line">path = /srv/node/</span><br><span class="line">read only = False</span><br><span class="line">lock file = /var/lock/container.lock</span><br><span class="line"></span><br><span class="line">[object]</span><br><span class="line">max connections = 2</span><br><span class="line">path = /srv/node/</span><br><span class="line">read only = False</span><br><span class="line">lock file = /var/lock/object.lock</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动服务并设置为开机自启动</span></span><br><span class="line">systemctl enable rsyncd.service</span><br><span class="line">systemctl start rsyncd.service</span><br></pre></td></tr></table></figure><h3 id="安装配置组件-9"><a href="#安装配置组件-9" class="headerlink" title="安装配置组件"></a>安装配置组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件包</span></span><br><span class="line">yum install openstack-swift-account openstack-swift-container openstack-swift-object -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">获取配置文件</span></span><br><span class="line">curl -o /etc/swift/account-server.conf https://opendev.org/openstack/swift/raw/branch/master/etc/account-server.conf-sample</span><br><span class="line">curl -o /etc/swift/container-server.conf https://opendev.org/openstack/swift/raw/branch/master/etc/container-server.conf-sample</span><br><span class="line">curl -o /etc/swift/object-server.conf https://opendev.org/openstack/swift/raw/branch/master/etc/object-server.conf-sample</span><br><span class="line"></span><br><span class="line">编辑配置文件 /etc/swift/account-server.conf</span><br><span class="line">vi /etc/swift/account-server.conf</span><br><span class="line"></span><br><span class="line">[DEFAULT]</span><br><span class="line">bind_ip = 192.168.10.20</span><br><span class="line">bind_port = 6202</span><br><span class="line">user = swift</span><br><span class="line">swift_dir = /etc/swift</span><br><span class="line">devices = /srv/node</span><br><span class="line">mount_check = True</span><br><span class="line"></span><br><span class="line">[pipeline:main]</span><br><span class="line">pipeline = healthcheck recon account-server</span><br><span class="line"></span><br><span class="line">[filter:recon]</span><br><span class="line">use = egg:swift#recon</span><br><span class="line">recon_cache_path = /var/cache/swift</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/swift/container-server.conf</span><br><span class="line"></span><br><span class="line">[DEFAULT]</span><br><span class="line">bind_ip = 192.168.10.20</span><br><span class="line">bind_port = 6201</span><br><span class="line">user = swift</span><br><span class="line">swift_dir = /etc/swift</span><br><span class="line">devices = /srv/node</span><br><span class="line">mount_check = True</span><br><span class="line"></span><br><span class="line">[pipeline:main]</span><br><span class="line">pipeline = healthcheck recon container-server</span><br><span class="line"></span><br><span class="line">[filter:recon]</span><br><span class="line">use = egg:swift#recon</span><br><span class="line">recon_cache_path = /var/cache/swift</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/swift/object-server.conf</span><br><span class="line"></span><br><span class="line">[DEFAULT]</span><br><span class="line">bind_ip = 192.168.10.20</span><br><span class="line">bind_port = 6200</span><br><span class="line">user = swift</span><br><span class="line">swift_dir = /etc/swift</span><br><span class="line">devices = /srv/node</span><br><span class="line">mount_check = True</span><br><span class="line"></span><br><span class="line">[pipeline:main]</span><br><span class="line">pipeline = healthcheck recon object-server</span><br><span class="line"></span><br><span class="line">[filter:recon]</span><br><span class="line">use = egg:swift#recon</span><br><span class="line">recon_cache_path = /var/cache/swift</span><br><span class="line">recon_lock_path = /var/lock</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建目录并赋予挂载目录权限</span></span><br><span class="line">chown -R swift:swift /srv/node</span><br><span class="line">mkdir -p /var/cache/swift</span><br><span class="line">chown -R root:swift /var/cache/swift</span><br><span class="line">chmod -R 775 /var/cache/swift</span><br></pre></td></tr></table></figure><h2 id="创建和分发initial-rings"><a href="#创建和分发initial-rings" class="headerlink" title="创建和分发initial rings"></a>创建和分发initial rings</h2><h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/swift/</span><br><span class="line">swift-ring-builder account.builder create 10 3 1</span><br><span class="line">swift-ring-builder account.builder add \</span><br><span class="line">  --region 1 --zone 1 --ip 192.168.10.10 --port 6202 --device sdc --weight 100</span><br><span class="line">swift-ring-builder account.builder add \</span><br><span class="line">  --region 1 --zone 1 --ip 192.168.10.10 --port 6202 --device sdd --weight 100</span><br><span class="line">swift-ring-builder account.builder add \</span><br><span class="line">  --region 1 --zone 1 --ip 192.168.10.20 --port 6202 --device sdc --weight 100 </span><br><span class="line">swift-ring-builder account.builder add \</span><br><span class="line">  --region 1 --zone 1 --ip 192.168.10.20 --port 6202 --device sdd --weight 100  </span><br><span class="line">swift-ring-builder account.builder</span><br><span class="line">swift-ring-builder account.builder rebalance</span><br><span class="line"></span><br><span class="line">swift-ring-builder container.builder create 10 3 1</span><br><span class="line">swift-ring-builder container.builder add \</span><br><span class="line">  --region 1 --zone 1 --ip 192.168.10.10 --port 6201 --device sdc --weight 100</span><br><span class="line">swift-ring-builder container.builder add \</span><br><span class="line">  --region 1 --zone 1 --ip 192.168.10.10 --port 6201 --device sdd --weight 100</span><br><span class="line">swift-ring-builder container.builder add \</span><br><span class="line">  --region 1 --zone 1 --ip 192.168.10.20 --port 6201 --device sdc --weight 100</span><br><span class="line">swift-ring-builder container.builder add \</span><br><span class="line">  --region 1 --zone 1 --ip 192.168.10.20 --port 6201 --device sdd --weight 100</span><br><span class="line">swift-ring-builder container.builder</span><br><span class="line">swift-ring-builder container.builder rebalance</span><br><span class="line"></span><br><span class="line">swift-ring-builder object.builder create 10 3 1</span><br><span class="line">swift-ring-builder object.builder add \</span><br><span class="line">  --region 1 --zone 1 --ip 192.168.10.10 --port 6200 --device sdc --weight 100</span><br><span class="line">swift-ring-builder object.builder add \</span><br><span class="line">  --region 1 --zone 1 --ip 192.168.10.10 --port 6200 --device sdd --weight 100 </span><br><span class="line">swift-ring-builder object.builder add \</span><br><span class="line">  --region 1 --zone 1 --ip 192.168.10.20 --port 6200 --device sdc --weight 100</span><br><span class="line">swift-ring-builder object.builder add \</span><br><span class="line">  --region 1 --zone 1 --ip 192.168.10.20 --port 6200 --device sdd --weight 100</span><br><span class="line">swift-ring-builder object.builder</span><br><span class="line">swift-ring-builder object.builder rebalance</span><br><span class="line">scp swift.conf compute:/etc/swift/swift.conf</span><br><span class="line">chown -R root:swift /etc/swift</span><br><span class="line">systemctl enable openstack-swift-proxy.service memcached.service</span><br><span class="line">systemctl start openstack-swift-proxy.service memcached.service</span><br></pre></td></tr></table></figure><h3 id="compute"><a href="#compute" class="headerlink" title="compute"></a>compute</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">chown -R root:swift /etc/swift</span><br><span class="line">systemctl enable openstack-swift-account.service openstack-swift-account-auditor.service \</span><br><span class="line">  openstack-swift-account-reaper.service openstack-swift-account-replicator.service</span><br><span class="line">systemctl start openstack-swift-account.service openstack-swift-account-auditor.service \</span><br><span class="line">  openstack-swift-account-reaper.service openstack-swift-account-replicator.service</span><br><span class="line">systemctl enable openstack-swift-container.service \</span><br><span class="line">  openstack-swift-container-auditor.service openstack-swift-container-replicator.service \</span><br><span class="line">  openstack-swift-container-updater.service</span><br><span class="line">systemctl start openstack-swift-container.service \</span><br><span class="line">  openstack-swift-container-auditor.service openstack-swift-container-replicator.service \</span><br><span class="line">  openstack-swift-container-updater.service</span><br><span class="line">systemctl enable openstack-swift-object.service openstack-swift-object-auditor.service \</span><br><span class="line">  openstack-swift-object-replicator.service openstack-swift-object-updater.service</span><br><span class="line">systemctl start openstack-swift-object.service openstack-swift-object-auditor.service \</span><br><span class="line">  openstack-swift-object-replicator.service openstack-swift-object-updater.service</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">OpenStack—T版</summary>
    
    
    
    <category term="教程" scheme="http://cloudsheep.xyz/category/%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="运维" scheme="http://cloudsheep.xyz/tag/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="OpenStack" scheme="http://cloudsheep.xyz/tag/OpenStack/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes流程图</title>
    <link href="http://cloudsheep.xyz/2023/12/12/Kubernetes%E6%B5%81%E7%A8%8B%E5%9B%BE/"/>
    <id>http://cloudsheep.xyz/2023/12/12/Kubernetes%E6%B5%81%E7%A8%8B%E5%9B%BE/</id>
    <published>2023-12-12T06:34:14.000Z</published>
    <updated>2023-12-13T07:09:45.222Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Kubernets流程图"><a href="#Kubernets流程图" class="headerlink" title="Kubernets流程图"></a>Kubernets流程图</h3><p><img src="https://www.z4a.net/images/2023/12/12/k8s-.jpg" alt="k8s-.jpg"></p>]]></content>
    
    
    <summary type="html">Kubernetes概览</summary>
    
    
    
    <category term="流程图" scheme="http://cloudsheep.xyz/category/%E6%B5%81%E7%A8%8B%E5%9B%BE/"/>
    
    
    <category term="Kubernetes" scheme="http://cloudsheep.xyz/tag/Kubernetes/"/>
    
    <category term="画图详解" scheme="http://cloudsheep.xyz/tag/%E7%94%BB%E5%9B%BE%E8%AF%A6%E8%A7%A3/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes详解</title>
    <link href="http://cloudsheep.xyz/2023/12/12/Kubernetes%E8%AF%A6%E8%A7%A3/"/>
    <id>http://cloudsheep.xyz/2023/12/12/Kubernetes%E8%AF%A6%E8%A7%A3/</id>
    <published>2023-12-12T06:34:14.000Z</published>
    <updated>2024-02-26T08:19:18.355Z</updated>
    
    <content type="html"><![CDATA[<h1 id="pod"><a href="#pod" class="headerlink" title="pod"></a>pod</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>Pod 是一组（一个或多个）容器的集合（Pod 就像是豌豆荚，而容器就像是豌豆荚中的豌豆）。这些容器共享存储、网络等。</strong></p><h2 id="pod资源清单"><a href="#pod资源清单" class="headerlink" title="pod资源清单"></a>pod资源清单</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1 #api文档版本</span><br><span class="line">kind: Pod #资源对象类型</span><br><span class="line">metadata: #pod相关的元数据</span><br><span class="line">  name: nginx-pod #pod的名称</span><br><span class="line">  labels: #定义Pod的标签</span><br><span class="line">    tybe: app #自定义labe标签，名字tybe,值为app</span><br><span class="line">    test: 1.0.0 #自定义labe标签，tybe版本号</span><br><span class="line">  namespace: &#x27;default&#x27; #命名空间的配置</span><br><span class="line">spec: #期望pod按照这里的配置进行描述</span><br><span class="line">  containers: #对pod中的容器描述</span><br><span class="line">  - name: nginx #容器的名称</span><br><span class="line">    image: &#x27;nginx:1.20.2&#x27; #指定容器的镜像</span><br><span class="line">    imagePullPolicy: IfNotPresent #镜像拉取策略</span><br><span class="line">    startupProbe:  #应用启动探针配置</span><br><span class="line">      exec:</span><br><span class="line">        command:</span><br><span class="line">        - /bin/sh</span><br><span class="line">        - -c</span><br><span class="line">        - &quot;sleep 3;echo success &gt; /inited&quot;</span><br><span class="line">      initialDelaySeconds: 1 #探测延迟，running后指定20秒后才执行探测，默认0秒</span><br><span class="line">      periodSeconds: 5 #执行探测的间隔时间</span><br><span class="line">      failureThreshold: 3 #失败阈值，失败多少次才算是真正失败</span><br><span class="line">      successThreshold: 1 #成功阈值多少次监测成功才算成功</span><br><span class="line">      timeoutSeconds: 5 #请求的超时时间</span><br><span class="line">    readinessProbe: #应用存活探针配置</span><br><span class="line">      httpGet: #探测方式，基于http请求探测</span><br><span class="line">        path: /started.html #http请求路径</span><br><span class="line">     #tcpSocket:</span><br><span class="line">        port: 80 #请求端口</span><br><span class="line">      initialDelaySeconds: 1 #探测延迟，running后指定20秒后才执行探测，默认0秒</span><br><span class="line">      periodSeconds: 5 #执行探测的间隔时间</span><br><span class="line">      failureThreshold: 3 #失败阈值，失败多少次才算是真正失败</span><br><span class="line">      successThreshold: 1 #成功阈值多少次监测成功才算成功</span><br><span class="line">      timeoutSeconds: 5 #请求的超时时间</span><br><span class="line">    command: #指定容器启动时执行的命令</span><br><span class="line">    - nginx</span><br><span class="line">    - -g</span><br><span class="line">    - &#x27;daemon off;&#x27; #nginx -g &#x27;daemon off;&#x27;</span><br><span class="line">    workingDir: /usr/share/nginx/html #定义容器启动后的工作目录</span><br><span class="line">    ports:</span><br><span class="line">    - name: http #端口名称</span><br><span class="line">      containerPort: 80 #描述容器内要暴露什么端口</span><br><span class="line">      protocol: TCP #描述该端口是基于哪种协议通信的</span><br><span class="line">    env: #环境变量</span><br><span class="line">    - name: JVM_OPTS #环境变量名称</span><br><span class="line">      value: &#x27;-Xms128m -Xmx128m&#x27; #环境变量的值</span><br><span class="line">    resources:</span><br><span class="line">      requests: #最少需要多少资源</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 128Mi</span><br><span class="line">      limits: #最多可以使用多少资源</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 256Mi</span><br><span class="line">  restartPolicy: OnFailure #重启策略</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h1><h2 id="deployment"><a href="#deployment" class="headerlink" title="deployment"></a>deployment</h2><p><img src="C:\Users\32625\OneDrive\图片\k8s\24.png"></p><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1 # 版本号 </span><br><span class="line">kind: Deployment # 类型 </span><br><span class="line">metadata: # 元数据 </span><br><span class="line">  name: nginx-deploy # rs名称</span><br><span class="line">  labels: #标签 </span><br><span class="line">    controller: deploy </span><br><span class="line">spec: # 详情描述 </span><br><span class="line">  replicas: 3 # 副本数量 </span><br><span class="line">  revisionHistoryLimit: 5 # 保留历史版本，默认为10 </span><br><span class="line">  paused: false # 暂停部署，默认是false </span><br><span class="line">  progressDeadlineSeconds: 600 # 部署超时时间（s），默认是600 </span><br><span class="line">  strategy: # 策略 </span><br><span class="line">    type: RollingUpdate # 滚动更新策略 </span><br><span class="line">    rollingUpdate: # 滚动更新 </span><br><span class="line">      maxSurge: 30% # 最大额外可以存在的副本数</span><br><span class="line">  selector: # 选择器，通过它指定该控制器管理哪些pod </span><br><span class="line">    matchLabels: # Labels匹配规则 </span><br><span class="line">      app: nginx-pod </span><br><span class="line">    matchExpressions: # Expressions匹配规则 </span><br><span class="line">      - &#123;key: app, operator: In, values: [nginx-pod]&#125; </span><br><span class="line">  template: # 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span><br><span class="line">    metadata: </span><br><span class="line">      labels: </span><br><span class="line">        app: nginx-pod </span><br><span class="line">    spec: </span><br><span class="line">      containers: </span><br><span class="line">      - name: nginx </span><br><span class="line">        image: nginx:1.20.2 </span><br><span class="line">        ports: </span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a>版本回退</h3><ul><li><p>kubetl rollout 参数 deploy xx  # 支持下面的选择</p></li><li><p>status 显示当前升级的状态</p></li><li><p>history 显示升级历史记录</p></li><li><p>pause 暂停版本升级过程</p></li><li><p>resume 继续已经暂停的版本升级过程</p></li><li><p>undo 回滚到上一级版本 （可以使用–to-revision回滚到指定的版本）</p></li></ul><h3 id="滚动更新"><a href="#滚动更新" class="headerlink" title="滚动更新"></a>滚动更新</h3><ul><li>kubectl set image命令</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl set image deployment nginx-deploy nginx=nginx:1.20.2</span><br></pre></td></tr></table></figure><p>直接修改yaml文件</p><h3 id="金丝雀发布"><a href="#金丝雀发布" class="headerlink" title="金丝雀发布"></a>金丝雀发布</h3><p>金丝雀的发布流程如下：</p><ul><li><p>① 将 service 的标签设置为 app&#x3D;nginx ，这就意味着集群中的所有标签是 app&#x3D;nginx 的 Pod 都会加入负载均衡网络。</p></li><li><p>② 使用 Deployment v&#x3D;v1 app&#x3D;nginx 去筛选标签是 app&#x3D;nginx 以及 v&#x3D;v1 的 所有 Pod。</p></li><li><p>③ 同理，使用 Deployment v&#x3D;v2 app&#x3D;nginx 去筛选标签是 app&#x3D;nginx 以及 v&#x3D;v2 的所有 Pod 。</p></li><li><p>④ 逐渐加大 Deployment v&#x3D;v2 app&#x3D;nginx 控制的 Pod 的数量，根据轮询负载均衡网络的特点，必定会使得此 Deployment 控制的 Pod 的流量增大。</p></li><li><p>⑤ 当测试完成后，删除 Deployment v&#x3D;v1 app&#x3D;nginx 即可。</p></li></ul><h2 id="HPA"><a href="#HPA" class="headerlink" title="HPA"></a>HPA</h2><p><img src="C:\Users\32625\OneDrive\图片\k8s\50.png"></p><p>根据cpu使用率或自定义指标(metrics)自动对pod进行扩&#x2F;缩容</p><h3 id="监控cpu使用率"><a href="#监控cpu使用率" class="headerlink" title="监控cpu使用率"></a>监控cpu使用率</h3><h4 id="创建deployment和service"><a href="#创建deployment和service" class="headerlink" title="创建deployment和service"></a>创建deployment和service</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx:1.17.1</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">          resources: # 资源限制</span><br><span class="line">            requests:</span><br><span class="line">              cpu: &quot;100m&quot; # 100m 表示100 milli cpu，即 0.1 个CPU</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80 # svc 的访问端口</span><br><span class="line">      name: nginx</span><br><span class="line">      targetPort: 80 # Pod 的访问端口</span><br><span class="line">      protocol: TCP</span><br><span class="line">      nodePort: 30010 # 在机器上开端口，浏览器访问</span><br></pre></td></tr></table></figure><h4 id="创建HPA"><a href="#创建HPA" class="headerlink" title="创建HPA"></a>创建HPA</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-hpa</span><br><span class="line">spec:</span><br><span class="line">  minReplicas: 1 # 最小 Pod 数量</span><br><span class="line">  maxReplicas: 10 # 最大 Pod 数量</span><br><span class="line">  targetCPUUtilizationPercentage: 3 # CPU 使用率指标，即 CPU 超过 3%（Pod 的 limit 的 cpu ） 就进行扩容</span><br><span class="line">  scaleTargetRef:  # 指定要控制的Nginx的信息</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: nginx-deploy</span><br></pre></td></tr></table></figure><h2 id="扩缩容"><a href="#扩缩容" class="headerlink" title="扩缩容"></a>扩缩容</h2><ul><li>kubectl scale 命令</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx-deploy --replicas=4</span><br></pre></td></tr></table></figure><h2 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h2><table><thead><tr><th align="center">deployment部署方式</th><th>无状态应用：网络可能会变（IP 地址）、存储可能会变（卷）、顺序可能会变（启动的顺序）。应用场景：业务代码，如：使用 SpringBoot 开发的商城应用的业务代码。无状态的：</th></tr></thead><tbody><tr><td align="center">statefulset部署方式</td><td>有状态应用：网络不变、存储不变、顺序不变。应用场景：中间件，如：MySQL 集群、Zookeeper 集群、Redis 集群、MQ 集群。</td></tr></tbody></table><p><img src="C:\Users\32625\OneDrive\图片\k8s\56.png"></p><h3 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: web-nginx</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: ss-nginx</span><br><span class="line">  serviceName: nginx-svc # 服务名称，这个字段需要和 service 的 metadata.name 相同</span><br><span class="line">  replicas: 5 # 副本数</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: ss-nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx:1.20.2</span><br><span class="line">---</span><br><span class="line"># 将 StatefulSet 加入网络</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: ss-nginx</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  clusterIP: None # 不分配 ClusterIP ，形成无头服务，整个集群的 Pod 能直接访问，但是浏览器不可以访问。</span><br><span class="line">  ports:</span><br><span class="line">    - name: nginx</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="分区更新"><a href="#分区更新" class="headerlink" title="分区更新"></a>分区更新</h3><p>● StatefulSet 的更新策略：<br>  ○ OnDelete：删除之后才更新。<br>  ○ RollingUpdate：滚动更新，如果是此更新策略，可以设置更新的索引（默认值）。</p><h4 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  updateStrategy: # 更新策略</span><br><span class="line">    type: RollingUpdate # OnDelete 删除之后才更新；RollingUpdate 滚动更新</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      partition: 0 # 更新索引 &gt;= partition 的 Pod ，默认为 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="管理策略"><a href="#管理策略" class="headerlink" title="管理策略"></a>管理策略</h3><p>StatefulSet 的 Pod 的管理策略（podManagementPolicy）分为：</p><table><thead><tr><th>OrderedReady（有序启动，默认值）</th><th>Parallel（并发一起启动）</th></tr></thead></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  podManagementPolicy: OrderedReady # 控制 Pod 创建、升级以及扩缩容逻辑。Parallel（并发一起启动） 和 </span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="级联删除与非级联删除"><a href="#级联删除与非级联删除" class="headerlink" title="级联删除与非级联删除"></a>级联删除与非级联删除</h3><h4 id="级联删除："><a href="#级联删除：" class="headerlink" title="级联删除："></a>级联删除：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 删除statefulset时同时删除pods</span><br><span class="line">kubectl delete sts sts-nginx</span><br></pre></td></tr></table></figure><h4 id="非级联删除："><a href="#非级联删除：" class="headerlink" title="非级联删除："></a>非级联删除：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 删除statefulset时不会删除pods，sts删除后po依然存在</span><br><span class="line">kubectl delete sts sts-nginx --cascade=false</span><br></pre></td></tr></table></figure><h2 id="DdemoSet"><a href="#DdemoSet" class="headerlink" title="DdemoSet"></a>DdemoSet</h2><p><img src="C:\Users\32625\OneDrive\图片\k8s\54.png"></p><p>● DaemonSet 控制器确保所有（或一部分）的节点都运行了一个指定的 Pod 副本。<br>  ○ 每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上。<br>  ○ 当节点从集群中移除时，Pod 也就被垃圾回收了。<br>  ○ 删除一个 DaemonSet 可以清理所有由其创建的 Pod</p><h3 id="daemonset资源清单"><a href="#daemonset资源清单" class="headerlink" title="daemonset资源清单"></a>daemonset资源清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1 # 版本号</span><br><span class="line">kind: DaemonSet # 类型</span><br><span class="line">metadata: # 元数据</span><br><span class="line">  name: # 名称</span><br><span class="line">  namespace: #命名空间</span><br><span class="line">  labels: #标签</span><br><span class="line">    controller: daemonset</span><br><span class="line">spec: # 详情描述</span><br><span class="line">  revisionHistoryLimit: 3 # 保留历史版本</span><br><span class="line">  updateStrategy: # 更新策略</span><br><span class="line">    type: RollingUpdate # 滚动更新策略</span><br><span class="line">    rollingUpdate: # 滚动更新</span><br><span class="line">      maxUnavailable: 1 # 最大不可用状态的Pod的最大值，可用为百分比，也可以为整数</span><br><span class="line">  selector: # 选择器，通过它指定该控制器管理那些Pod</span><br><span class="line">    matchLabels: # Labels匹配规则 matchLabels 和 matchExpressions 任选其一</span><br><span class="line">      app: nginx-pod</span><br><span class="line">    matchExpressions: # Expressions匹配规则</span><br><span class="line">      - key: app</span><br><span class="line">        operator: In</span><br><span class="line">        values:</span><br><span class="line">          - nginx-pod</span><br><span class="line">  template: # 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span><br><span class="line">     metadata:</span><br><span class="line">       labels:</span><br><span class="line">         app: nginx-pod</span><br><span class="line">     spec:</span><br><span class="line">       containers:</span><br><span class="line">         - name: nginx</span><br><span class="line">           image: nginx:1.17.1</span><br><span class="line">           ports:</span><br><span class="line">             - containerPort: 80</span><br></pre></td></tr></table></figure><h3 id="配置文件-2"><a href="#配置文件-2" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: ds</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: ds</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      # tolerations: # 污点</span><br><span class="line">      # - key: node-role.kubernetes.io/master</span><br><span class="line">      #   effect: NoSchedule</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.20.2</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 200Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: localtime</span><br><span class="line">          mountPath: /etc/localtime</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: localtime</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /usr/share/zoneinfo/Asia/Shanghai</span><br></pre></td></tr></table></figure><h2 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h2><ul><li><p>Job 主要用于负责批量处理短暂的一次性任务。</p></li><li><p>Job 的特点： </p></li><li><ul><li>当 Job 创建的 Pod 执行成功结束时，Job 将记录成功结束的 Pod 数量。</li></ul></li><li><ul><li>当成功结束的 Pod 达到指定的数量时，Job 将完成执行。</li></ul></li><li><ul><li>删除 Job 对象时，将清理掉由 Job 创建的 Pod 。</li></ul></li><li><ul><li>Job 可以保证指定数量的 Pod 执行完成。</li></ul></li></ul><p><img src="C:\Users\32625\OneDrive\图片\k8s\60.png"></p><h3 id="job资源清单"><a href="#job资源清单" class="headerlink" title="job资源清单"></a>job资源清单</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch/v1 # 版本号</span><br><span class="line">kind: Job # 类型</span><br><span class="line">metadata: # 元数据</span><br><span class="line">  name:  # 名称</span><br><span class="line">  namespace:  #命名空间</span><br><span class="line">  labels: # 标签</span><br><span class="line">    controller: job</span><br><span class="line">spec: # 详情描述</span><br><span class="line">  completions: 1 # 指定Job需要成功运行Pod的总次数，默认为1</span><br><span class="line">  parallelism: 1 # 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span><br><span class="line">  activeDeadlineSeconds: 30 # 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span><br><span class="line">  backoffLimit: 6 # 指定Job失败后进行重试的次数，默认为6</span><br><span class="line">  manualSelector: true # 是否可以使用selector选择器选择Pod，默认为false</span><br><span class="line">  ttlSecondsAfterFinished: 0 # 如果是 0 表示执行完Job 时马上删除。如果是 100 ，就是执行完 Job ，等待 100s 后删除。TTL 机制由 TTL 控制器 提供，ttlSecondsAfterFinished 字段可激活该特性。当 TTL 控制器清理 Job 时，TTL 控制器将删除 Job 对象，以及由该 Job 创建的所 有 Pod 对象。</span><br><span class="line">  selector: # 选择器，通过它指定该控制器管理那些Pod，非必须字段</span><br><span class="line">    matchLabels: # Labels匹配规则</span><br><span class="line">      app: counter-pod</span><br><span class="line">    matchExpressions: # Expressions匹配规则</span><br><span class="line">      - key: app</span><br><span class="line">        operator: In</span><br><span class="line">        values:</span><br><span class="line">          - counter-pod</span><br><span class="line">  template: # 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span><br><span class="line">     metadata:</span><br><span class="line">       labels:</span><br><span class="line">         app: counter-pod</span><br><span class="line">     spec:</span><br><span class="line">       restartPolicy: Never # 重启策略只能设置为Never或OnFailure</span><br><span class="line">       containers:</span><br><span class="line">         - name: counter</span><br><span class="line">           image: busybox:1.30</span><br><span class="line">           command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&quot;]</span><br></pre></td></tr></table></figure><p>● 关于模板中的重启策略的说明：<br>  ○  如果设置为OnFailure，则Job会在Pod出现故障的时候重启容器，而不是创建Pod，failed次数不变。<br>  ○  如果设置为Never，则Job会在Pod出现故障的时候创建新的Pod，并且故障Pod不会消失，也不会重启，failed次数+1。<br>  ○  如果指定为Always的话，就意味着一直重启，意味着Pod任务会重复执行，这和Job的定义冲突，所以不能设置为Always。</p><h3 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h3><p><img src="C:\Users\32625\OneDrive\图片\k8s\63.png"></p><ul><li>CronJob 控制器以 Job 控制器为其管控对象，并借助它管理 Pod 资源对象，Job 控制器定义的作业任务在其控制器资源创建之后便会立即执行，但 CronJob 可以以类似 Linux 操作系统的周期性任务作业计划的方式控制器运行时间点及重复运行的方式，换言之，CronJob 可以在特定的时间点反复去执行 Job 任务。</li></ul><h4 id="资源清单"><a href="#资源清单" class="headerlink" title="资源清单"></a>资源清单</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch/v1beta1 # 版本号</span><br><span class="line">kind: CronJob # 类型</span><br><span class="line">metadata: # 元数据</span><br><span class="line">  name:  # 名称</span><br><span class="line">  namespace:  #命名空间</span><br><span class="line">  labels:</span><br><span class="line">    controller: cronjob</span><br><span class="line">spec: # 详情描述</span><br><span class="line">  schedule: # cron格式的作业调度运行时间点，用于控制任务任务时间执行</span><br><span class="line">  concurrencyPolicy: # 并发执行策略</span><br><span class="line">  failedJobsHistoryLimit: # 为失败的任务执行保留的历史记录数，默认为1</span><br><span class="line">  successfulJobsHistoryLimit: # 为成功的任务执行保留的历史记录数，默认为3</span><br><span class="line">  jobTemplate: # job控制器模板，用于为cronjob控制器生成job对象，下面其实就是job的定义</span><br><span class="line">    metadata: &#123;&#125;</span><br><span class="line">    spec:</span><br><span class="line">      completions: 1 # 指定Job需要成功运行Pod的总次数，默认为1</span><br><span class="line">      parallelism: 1 # 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span><br><span class="line">      activeDeadlineSeconds: 30 # 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span><br><span class="line">      backoffLimit: 6 # 指定Job失败后进行重试的次数，默认为6</span><br><span class="line">      template: # 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span><br><span class="line">        spec:</span><br><span class="line">          restartPolicy: Never # 重启策略只能设置为Never或OnFailure</span><br><span class="line">          containers:</span><br><span class="line">            - name: counter</span><br><span class="line">              image: busybox:1.30</span><br><span class="line">              command: [ &quot;/bin/sh&quot;,&quot;-c&quot;,&quot;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&quot; ]</span><br></pre></td></tr></table></figure><p>●  schedule：cron表达式，用于指定任务的执行时间。<br>  ○  *&#x2F;1 * * * <em>：表示分钟  小时  日  月份  星期。<br>  ○  分钟的值从 0 到 59 。<br>  ○  小时的值从 0 到 23 。<br>  ○  日的值从 1 到 31 。<br>  ○  月的值从 1 到 12 。<br>  ○  星期的值从 0 到 6，0 表示星期日。<br>  ○  多个时间可以用逗号隔开，范围可以用连字符给出：</em> 可以作为通配符，&#x2F; 表示每…<br>●  concurrencyPolicy：并发执行策略<br>  ○  Allow：运行 Job 并发运行（默认）。<br>  ○  Forbid：禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行。<br>  ○  Replace：替换，取消当前正在运行的作业并使用新作业替换它。</p><h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h1><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><ul><li><p><strong>在 Kubernetes 中，Pod 是应用程序的载体，我们可以通过 Pod 的 IP 来访问应用程序，但是 Pod 的 IP 地址不是固定的，这就意味着不方便直接采用 Pod 的 IP 对服务进行访问。</strong> </p></li><li><p><strong>为了解决这个问题，Kubernetes 提供了 Service 资源，Service 会对提供同一个服务的多个 Pod 进行聚合，并且提供一个统一的入口地址，通过访问 Service 的入口地址就能访问到后面的 Pod 服务。</strong></p></li></ul><p><img src="C:\Users\32625\OneDrive\图片\k8s\2.png"></p><h3 id="OSI-网络模型和-TCP-IP-协议："><a href="#OSI-网络模型和-TCP-IP-协议：" class="headerlink" title="OSI 网络模型和 TCP&#x2F;IP 协议："></a>OSI 网络模型和 TCP&#x2F;IP 协议：</h3><p>![](C:\Users\32625\OneDrive\图片\k8s\OSI 网络模型和 TCP-IP 协议.png)</p><ul><li><strong>Service 默认使用的协议是 TCP 协议，对应的是 OSI 网络模型中的第四层传输层，所以也有人称 Service 为四层网络负载均衡。</strong></li></ul><h3 id="service资源清单"><a href="#service资源清单" class="headerlink" title="service资源清单"></a>service资源清单</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1 # 版本</span><br><span class="line">kind: Service # 类型</span><br><span class="line">metadata: # 元数据</span><br><span class="line">  name: # 资源名称</span><br><span class="line">  namespace: # 命名空间</span><br><span class="line">spec:</span><br><span class="line">  selector: # 标签选择器，用于确定当前Service代理那些Pod</span><br><span class="line">    app: nginx</span><br><span class="line">  type: NodePort # Service的类型，指定Service的访问方式</span><br><span class="line">  clusterIP: # 虚拟服务的IP地址</span><br><span class="line">  sessionAffinity: # session亲和性，支持ClientIP、None两个选项，默认值为None</span><br><span class="line">  ports: # 端口信息</span><br><span class="line">    - port: 8080 # Service端口</span><br><span class="line">      protocol: TCP # 协议</span><br><span class="line">      targetPort : # Pod端口</span><br><span class="line">      nodePort:  # 主机端口</span><br></pre></td></tr></table></figure><h3 id="配置文件-3"><a href="#配置文件-3" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-svc</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: http # service 端口配置的名称</span><br><span class="line">    protocol: TCP # 端口绑定的协议，支持 TCP、UDP、SCTP，默认为 TCP</span><br><span class="line">    port: 80 # service 自己的端口</span><br><span class="line">    targetPort: 80 # 目标 pod 的端口</span><br><span class="line">  selector: # 选中当前 service 匹配哪些 pod，对哪些 pod 的东西流量进行代理</span><br><span class="line">    app: nginx</span><br><span class="line">  type: NodePort 随机生成端口</span><br></pre></td></tr></table></figure><h4 id="type说明："><a href="#type说明：" class="headerlink" title="type说明："></a>type说明：</h4><ul><li><p>ClusterIP（默认值）：通过集群的内部 IP 暴露服务，选择该值时服务只能够在集群内部访问。</p></li><li><p>NodePort：通过每个节点上的 IP 和静态端口（NodePort）暴露服务。 NodePort 服务会路由到自动创建的 ClusterIP 服务。 通过请求 <code>&lt;节点 IP&gt;:&lt;节点端口&gt;</code>，我们可以从集群的外部访问一个 NodePort 服务。</p></li><li><p>LoadBalancer：使用云提供商的负载均衡器向外部暴露服务。 外部负载均衡器可以将流量路由到自动创建的 NodePort 服务和 ClusterIP 服务上。</p></li><li><p>ExternalName：通过返回 CNAME 和对应值，可以将服务映射到 externalName 字段的内容（如：foo.bar.example.com）。 无需创建任何类型代理。</p></li></ul><h3 id="命令操作："><a href="#命令操作：" class="headerlink" title="命令操作："></a>命令操作：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#使用其他Pod访问创建的svcvice name</span><br><span class="line">kubectl exec -it nginx-pod -- sh #进入创建的pod中去</span><br><span class="line">curl/wegt http://nginx-svc:80</span><br><span class="line">#如果需要跨namespace(命名空间)访问pod，则在service name后面加上&lt;namespec&gt;即可</span><br><span class="line">curl http://nginx-svc.default</span><br></pre></td></tr></table></figure><h3 id="实现外部访问"><a href="#实现外部访问" class="headerlink" title="实现外部访问"></a>实现外部访问</h3><h4 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h4><ul><li><p>编写service配置文件时，不指定selector属性</p></li><li><p>自己创建endpoint(ds)</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80 # 此时的 targetPort 需要和 Endpoints 的subsets.addresses.ports.port 相同  </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc # 此处的 name 需要和 Service 的 metadata 的 name 相同</span><br><span class="line">  namespace: default</span><br><span class="line">subsets:</span><br><span class="line">- addresses:</span><br><span class="line">  - ip: 220.181.38.251 # 百度</span><br><span class="line">  - ip: 221.122.82.30 # 搜狗 </span><br><span class="line">  - ip: 61.129.7.47 # QQ</span><br><span class="line">  ports:</span><br><span class="line">  - name: http # 此处的 name 需要和 Service 的 spec.ports.name 相同</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP域名解析</span><br></pre></td></tr></table></figure><h4 id="域名解析"><a href="#域名解析" class="headerlink" title="域名解析"></a>域名解析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">进入pod使用nslookup查询</span><br><span class="line">kubectl exec -it nginx-svc -- sh</span><br><span class="line"># 安装nslookup</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install dnsutils</span><br><span class="line">#其中 nginx-svc 是 Service 的服务名</span><br><span class="line">nslookup -type=a nginx-svc</span><br></pre></td></tr></table></figure><h4 id="保持会话技术"><a href="#保持会话技术" class="headerlink" title="保持会话技术"></a>保持会话技术</h4><ul><li>基于客户端 IP 地址的会话保持模式，即来自同一个客户端发起的所有请求都尽最大可能转发到固定的一个 Pod 上，只需要在 spec 中添加 <code>sessionAffinity: ClientIP</code> 选项。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  type: ClusterIP </span><br><span class="line">  sessionAffinity: &quot;ClientIP&quot;</span><br><span class="line">  sessionAffinityConfig:</span><br><span class="line">    clientIP: </span><br><span class="line">       timeoutSeconds: 11800 # 30 分钟</span><br><span class="line">  ports:</span><br><span class="line">  - name: nginx</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 80 </span><br><span class="line">    targetPort: 80</span><br><span class="line">   </span><br></pre></td></tr></table></figure><h3 id="网络层次"><a href="#网络层次" class="headerlink" title="网络层次"></a>网络层次</h3><p><img src="C:\Users\32625\OneDrive\图片\k8s\14.png"></p><h3 id="Pod-指定自己的主机名"><a href="#Pod-指定自己的主机名" class="headerlink" title="Pod 指定自己的主机名"></a>Pod 指定自己的主机名</h3><p><strong>Pod 中还可以设置 hostname 和 subdomain 字段，需要注意的是，一旦设置了 hostname ，那么该 Pod 的主机名就被设置为 hostname 的值，而 subdomain  需要和 svc 中的 name 相同。</strong> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: default-subdomain</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  clusterIP: None </span><br><span class="line">  ports:</span><br><span class="line">  - name: foo</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 1234</span><br><span class="line">    targetPort: 1234</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx1</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  hostname: nginx1</span><br><span class="line">  subdomain: default-subdomain # 必须和 svc 的 name 相同，才可以使用 hostname.subdomain.名称空间.svc.cluster.local 访问，否则访问不到指定的 Pod 。</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 250m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  nginx</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  restartPolicy: Always</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx2</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  hostname: nginx2</span><br><span class="line">  subdomain: default-subdomain # 必须和 svc 的 name 相同，才可以使用 hostname.subdomain.名称空间.svc.cluster.local 访问，否则访问不到指定的 Pod 。</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 250m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  nginx</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure><h2 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h2><p><strong>Service 可以使用 NodePort 暴露集群外访问端口，但是性能低、不安全并且端口的范围有限。</strong></p><p><strong>Service 缺少七层（OSI 网络模型）的统一访问入口，负载均衡能力很低，不能做限流、验证非法用户、链路追踪等等。</strong></p><p><strong>Ingress 公开了从集群外部到集群内 <code>服务</code> 的 HTTP 和 HTTPS 路由。流量路由由 Ingress 资源上定义的规则控制。</strong></p><p><strong>我们使用 Ingress 作为整个集群统一的入口，配置 Ingress 规则转发到对应的 Service</strong> 。</p><p><img src="C:\Users\32625\OneDrive\图片\k8s\22.png"></p><h3 id="安装Ingress-nginx"><a href="#安装Ingress-nginx" class="headerlink" title="安装Ingress-nginx"></a>安装Ingress-nginx</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 安装命令：</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.2/deploy/static/provider/baremetal/deploy.yaml</span><br></pre></td></tr></table></figure><h4 id="修改deploy-yaml配置文件"><a href="#修改deploy-yaml配置文件" class="headerlink" title="修改deploy.yaml配置文件"></a>修改deploy.yaml配置文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br></pre></td><td class="code"><pre><span class="line">#GENERATED FOR K8S 1.20</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">automountServiceAccountToken: true</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - pods</span><br><span class="line">  - secrets</span><br><span class="line">  - endpoints</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - services</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses/status</span><br><span class="line">  verbs:</span><br><span class="line">  - update</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingressclasses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resourceNames:</span><br><span class="line">  - ingress-controller-leader</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - update</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - patch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - create</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - endpoints</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - secrets</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - services</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - patch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses/status</span><br><span class="line">  verbs:</span><br><span class="line">  - update</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingressclasses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - admissionregistration.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - validatingwebhookconfigurations</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - update</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  allow-snippet-annotations: &quot;true&quot;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  ipFamilies:</span><br><span class="line">  - IPv4</span><br><span class="line">  ipFamilyPolicy: SingleStack</span><br><span class="line">  ports:</span><br><span class="line">  - appProtocol: http</span><br><span class="line">    name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: http</span><br><span class="line">  - appProtocol: https</span><br><span class="line">    name: https</span><br><span class="line">    port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: https</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  type: ClusterIP # NodePort</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-controller-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - appProtocol: https</span><br><span class="line">    name: https-webhook</span><br><span class="line">    port: 443</span><br><span class="line">    targetPort: webhook</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  type: ClusterIP</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet # Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  minReadySeconds: 0</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/component: controller</span><br><span class="line">      app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">      app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/component: controller</span><br><span class="line">        app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    spec:</span><br><span class="line">      dnsPolicy: ClusterFirstWithHostNet # dns 调整为主机网络 ，原先为 ClusterFirst</span><br><span class="line">      hostNetwork: true # 直接让 nginx 占用本机的 80 和 443 端口，这样就可以使用主机网络</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - /nginx-ingress-controller</span><br><span class="line">        - --election-id=ingress-controller-leader</span><br><span class="line">        - --controller-class=k8s.io/ingress-nginx</span><br><span class="line">        - --ingress-class=nginx</span><br><span class="line">        - --report-node-internal-ip-address=true</span><br><span class="line">        - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller</span><br><span class="line">        - --validating-webhook=:8443</span><br><span class="line">        - --validating-webhook-certificate=/usr/local/certificates/cert</span><br><span class="line">        - --validating-webhook-key=/usr/local/certificates/key</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        - name: LD_PRELOAD</span><br><span class="line">          value: /usr/local/lib/libmimalloc.so</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.1.2 # 修改 k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        lifecycle:</span><br><span class="line">          preStop:</span><br><span class="line">            exec:</span><br><span class="line">              command:</span><br><span class="line">              - /wait-shutdown</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 10254</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        name: controller</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: http</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 443</span><br><span class="line">          name: https</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          name: webhook</span><br><span class="line">          protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 10254</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        resources: # 资源限制</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 90Mi</span><br><span class="line">          limits: </span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 500Mi     </span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: true</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">          runAsUser: 101</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /usr/local/certificates/</span><br><span class="line">          name: webhook-cert</span><br><span class="line">          readOnly: true</span><br><span class="line">      nodeSelector:</span><br><span class="line">        node-role: ingress # 以后只需要给某个 node 打上这个标签就可以部署 ingress-nginx 到这个节点上了</span><br><span class="line">        # kubernetes.io/os: linux</span><br><span class="line">      serviceAccountName: ingress-nginx</span><br><span class="line">      terminationGracePeriodSeconds: 300</span><br><span class="line">      volumes:</span><br><span class="line">      - name: webhook-cert</span><br><span class="line">        secret:</span><br><span class="line">          secretName: ingress-nginx-admission</span><br><span class="line">---</span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: pre-install,pre-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission-create</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/component: admission-webhook</span><br><span class="line">        app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">        app.kubernetes.io/managed-by: Helm</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">        app.kubernetes.io/version: 1.1.2</span><br><span class="line">        helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">      name: ingress-nginx-admission-create</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - create</span><br><span class="line">        - --host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc</span><br><span class="line">        - --namespace=$(POD_NAMESPACE)</span><br><span class="line">        - --secret-name=ingress-nginx-admission</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1 # k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: create</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      restartPolicy: OnFailure</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 2000</span><br><span class="line">        runAsNonRoot: true</span><br><span class="line">        runAsUser: 2000</span><br><span class="line">      serviceAccountName: ingress-nginx-admission</span><br><span class="line">---</span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: post-install,post-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission-patch</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/component: admission-webhook</span><br><span class="line">        app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">        app.kubernetes.io/managed-by: Helm</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">        app.kubernetes.io/version: 1.1.2</span><br><span class="line">        helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">      name: ingress-nginx-admission-patch</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - patch</span><br><span class="line">        - --webhook-name=ingress-nginx-admission</span><br><span class="line">        - --namespace=$(POD_NAMESPACE)</span><br><span class="line">        - --patch-mutating=false</span><br><span class="line">        - --secret-name=ingress-nginx-admission</span><br><span class="line">        - --patch-failure-policy=Fail</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1 # k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: patch</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      restartPolicy: OnFailure</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 2000</span><br><span class="line">        runAsNonRoot: true</span><br><span class="line">        runAsUser: 2000</span><br><span class="line">      serviceAccountName: ingress-nginx-admission</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: IngressClass</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  controller: k8s.io/ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: admissionregistration.k8s.io/v1</span><br><span class="line">kind: ValidatingWebhookConfiguration</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">webhooks:</span><br><span class="line">- admissionReviewVersions:</span><br><span class="line">  - v1</span><br><span class="line">  clientConfig:</span><br><span class="line">    service:</span><br><span class="line">      name: ingress-nginx-controller-admission</span><br><span class="line">      namespace: ingress-nginx</span><br><span class="line">      path: /networking/v1/ingresses</span><br><span class="line">  failurePolicy: Fail</span><br><span class="line">  matchPolicy: Equivalent</span><br><span class="line">  name: validate.nginx.ingress.kubernetes.io</span><br><span class="line">  rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">    - networking.k8s.io</span><br><span class="line">    apiVersions:</span><br><span class="line">    - v1</span><br><span class="line">    operations:</span><br><span class="line">    - CREATE</span><br><span class="line">    - UPDATE</span><br><span class="line">    resources:</span><br><span class="line">    - ingresses</span><br><span class="line">  sideEffects: None</span><br></pre></td></tr></table></figure><h4 id="给node节点打上标签"><a href="#给node节点打上标签" class="headerlink" title="给node节点打上标签"></a>给node节点打上标签</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node &lt;node-name&gt; node-role=ingress</span><br></pre></td></tr></table></figure><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -ntlp | grep 80</span><br><span class="line">netstat -ntlp | grep 443</span><br></pre></td></tr></table></figure><p><img src="C:\Users\32625\OneDrive\图片\k8s\30.png"></p><h3 id="ingress配置文件"><a href="#ingress配置文件" class="headerlink" title="ingress配置文件"></a>ingress配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress # 资源类型为ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-http</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations: </span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTP&quot;  </span><br><span class="line">spec:</span><br><span class="line">  rules: # 规则</span><br><span class="line">  - host: nginx.xudaxian.com # 指定的监听的主机域名，相当于 nginx.conf 的 server &#123; xxx &#125;</span><br><span class="line">    http: # 指定路由规则</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix # 匹配规则，Prefix 前缀匹配 nginx.xudaxian.com/* 都可以匹配到</span><br><span class="line">        backend: # 指定路由的后台服务的 service 名称</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-svc # 服务名</span><br><span class="line">            port:</span><br><span class="line">              number: 80 # 服务的端口</span><br><span class="line">  - host: tomcat.xudaxian.com # 指定的监听的主机域名，相当于 nginx.conf 的 server &#123; xxx &#125;</span><br><span class="line">    http: # 指定路由规则</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix # 匹配规则，Prefix 前缀匹配 tomcat.xudaxian.com/* 都可以匹配到</span><br><span class="line">        backend: # 指定路由的后台服务的 service 名称</span><br><span class="line">          service:</span><br><span class="line">            name: tomcat-svc # 服务名</span><br><span class="line">            port:</span><br><span class="line">              number: 8080 # 服务的端口</span><br></pre></td></tr></table></figure><h4 id="pathType-说明："><a href="#pathType-说明：" class="headerlink" title="pathType 说明："></a><strong><a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress/#path-types">pathType</a> 说明：</strong></h4><ul><li><p>refix：基于以 <code>/</code> 分隔的 URL 路径前缀匹配。匹配区分大小写，并且对路径中的元素逐个完成。 路径元素指的是由 <code>/</code> 分隔符分隔的路径中的标签列表。 如果每个 p 都是请求路径 p 的元素前缀，则请求与路径 p 匹配。</p></li><li><p>Exact：精确匹配 URL 路径，且区分大小写。</p></li><li><p>ImplementationSpecific：对于这种路径类型，匹配方法取决于 IngressClass。 具体实现可以将其作为单独的 pathType 处理或者与 Prefix 或 Exact 类型作相同处理。</p></li></ul><table><thead><tr><th>类型</th><th>路径</th><th>请求路径</th><th>匹配与否？</th></tr></thead><tbody><tr><td>Prefix</td><td><code>/</code></td><td>（所有路径）</td><td>是</td></tr><tr><td>Exact</td><td><code>/foo</code></td><td><code>/foo</code></td><td>是</td></tr><tr><td>Exact</td><td><code>/foo</code></td><td><code>/bar</code></td><td>否</td></tr><tr><td>Exact</td><td><code>/foo</code></td><td><code>/foo/</code></td><td>否</td></tr><tr><td>Exact</td><td><code>/foo/</code></td><td><code>/foo</code></td><td>否</td></tr><tr><td>Prefix</td><td><code>/foo</code></td><td><code>/foo</code>, <code>/foo/</code></td><td>是</td></tr><tr><td>Prefix</td><td><code>/foo/</code></td><td><code>/foo</code>, <code>/foo/</code></td><td>是</td></tr><tr><td>Prefix</td><td><code>/aaa/bb</code></td><td><code>/aaa/bbb</code></td><td>否</td></tr><tr><td>Prefix</td><td><code>/aaa/bbb</code></td><td><code>/aaa/bbb</code></td><td>是</td></tr><tr><td>Prefix</td><td><code>/aaa/bbb/</code></td><td><code>/aaa/bbb</code></td><td>是，忽略尾部斜线</td></tr><tr><td>Prefix</td><td><code>/aaa/bbb</code></td><td><code>/aaa/bbb/</code></td><td>是，匹配尾部斜线</td></tr><tr><td>Prefix</td><td><code>/aaa/bbb</code></td><td><code>/aaa/bbb/ccc</code></td><td>是，匹配子路径</td></tr><tr><td>Prefix</td><td><code>/aaa/bbb</code></td><td><code>/aaa/bbbxyz</code></td><td>否，字符串前缀不匹配</td></tr><tr><td>Prefix</td><td><code>/</code>, <code>/aaa</code></td><td><code>/aaa/ccc</code></td><td>是，匹配 <code>/aaa</code> 前缀</td></tr><tr><td>Prefix</td><td><code>/</code>, <code>/aaa</code>, <code>/aaa/bbb</code></td><td><code>/aaa/bbb</code></td><td>是，匹配 <code>/aaa/bbb</code> 前缀</td></tr><tr><td>Prefix</td><td><code>/</code>, <code>/aaa</code>, <code>/aaa/bbb</code></td><td><code>/ccc</code></td><td>是，匹配 <code>/</code> 前缀</td></tr><tr><td>Prefix</td><td><code>/aaa</code></td><td><code>/ccc</code></td><td>否，使用默认后端</td></tr><tr><td>混合</td><td><code>/foo</code> (Prefix), <code>/foo</code> (Exact)</td><td><code>/foo</code></td><td>是，优选 Exact 类型</td></tr></tbody></table><h3 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h3><h4 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h4><p>在物理机机上验证:</p><ul><li>在 win 中的 hosts（C:\Windows\System32\drivers\etc\hosts） 文件中添加如下的信息：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 用来模拟 DNS ，其中 192.168.10.137 是 ingress 部署的机器，nginx.xudaxian.com 和 tomcat.xudaxian.com 是 ingress 文件中监听的域名</span><br><span class="line">192.168.10.137 nginx.xudaxian.com</span><br><span class="line">192.168.10.137 tomcat.xudaxian.com</span><br></pre></td></tr></table></figure><ul><li>在物理机终端使用curl命令</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl nginx.xudaxian.com</span><br></pre></td></tr></table></figure><h4 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h4><p>新建一台虚拟机（centOS 7)并带有桌面：</p><ul><li>在 hosts （<code>/etc/hosts</code>）文件中添加如下的内容：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 用来模拟 DNS ，其中 192.168.10.137 是 ingress 部署的机器，nginx.xudaxian.com 和 tomcat.xudaxian.com 是 ingress 文件中监听的域名</span><br><span class="line">192.168.10.137 nginx.xudaxian.com</span><br><span class="line">192.168.10.137 tomcat.xudaxian.com</span><br></pre></td></tr></table></figure><p>通过浏览器访问：nginx.xudaxian.com</p><h3 id="默认后端"><a href="#默认后端" class="headerlink" title="默认后端"></a>默认后端</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-http</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations: </span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTP&quot;  </span><br><span class="line">spec:</span><br><span class="line">  defaultBackend: # 指定所有未匹配的默认后端</span><br><span class="line">    service:</span><br><span class="line">      name: nginx-svc</span><br><span class="line">      port:</span><br><span class="line">        number: 80</span><br><span class="line">  rules: </span><br><span class="line">    - host: tomcat.com </span><br><span class="line">      http: </span><br><span class="line">        paths:</span><br><span class="line">          - path: /abc</span><br><span class="line">            pathType: Prefix </span><br><span class="line">            backend: </span><br><span class="line">              service:</span><br><span class="line">                name: tomcat-svc</span><br><span class="line">                port:</span><br><span class="line">                  number: 8080</span><br></pre></td></tr></table></figure><h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: rate-ingress</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations: # https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#rate-limiting</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTP&quot;  </span><br><span class="line">    nginx.ingress.kubernetes.io/limit-rps: &quot;1&quot; # 限流</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure><h3 id="路径重写（用于前后端分离）"><a href="#路径重写（用于前后端分离）" class="headerlink" title="路径重写（用于前后端分离）"></a>路径重写（用于前后端分离）</h3><p><img src="C:\Users\32625\OneDrive\图片\k8s\33.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-rewrite</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">   nginx.ingress.kubernetes.io/rewrite-target: /$2 # 路径重写</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: baidu.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /api(/|$)(.*)</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure><h3 id="基于-Cookie-的会话保持技术"><a href="#基于-Cookie-的会话保持技术" class="headerlink" title="基于 Cookie 的会话保持技术"></a>基于 Cookie 的会话保持技术</h3><ul><li>Service 只能基于 ClientIP，但是 ingress 是七层负载均衡，可以基于 Cookie 实现会话保持。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: rate-ingress</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations: # https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#rate-limiting</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTP&quot;  </span><br><span class="line">    nginx.ingress.kubernetes.io/affinity: &quot;cookie&quot;</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure><h3 id="配置SSL"><a href="#配置SSL" class="headerlink" title="配置SSL"></a>配置SSL</h3><h4 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.cert -subj &quot;/CN=xudaxian.com/O=xudaxian.com&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret tls xudaxian-tls --key tls.key --cert tls.cert</span><br></pre></td></tr></table></figure><p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-05-31 125543.png)</p><h4 id="配置文件-4"><a href="#配置文件-4" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-tls</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations: </span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;  </span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">      - nginx.xudaxian.com # 通过浏览器访问 https://nginx.xudaxian.com</span><br><span class="line">      - tomcat.xudaxian.com # 通过浏览器访问 https://tomcat.xudaxian.com</span><br><span class="line">    secretName: xudaxian-tls</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">  - host: tomcat.xudaxian.com </span><br><span class="line">    http: </span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix </span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: tomcat-svc </span><br><span class="line">            port:</span><br><span class="line">              number: 8080</span><br><span class="line">  #实际开发时，需要购买证书</span><br></pre></td></tr></table></figure><h3 id="ingress金丝雀发布"><a href="#ingress金丝雀发布" class="headerlink" title="ingress金丝雀发布"></a>ingress金丝雀发布</h3><p><strong>缺点：不能灰度自定义</strong></p><p><img src="C:\Users\32625\OneDrive\图片\k8s\36.png"></p><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><h5 id="部署service和deployment"><a href="#部署service和deployment" class="headerlink" title="部署service和deployment"></a>部署service和deployment</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: v1-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: v1-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: v1-pod</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx</span><br><span class="line">      labels:</span><br><span class="line">        app: v1-pod</span><br><span class="line">    spec:</span><br><span class="line">      initContainers:</span><br><span class="line">        - name: alpine</span><br><span class="line">          image: alpine</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;echo v1-pod &gt; /app/index.html;&quot;]</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - mountPath: /app</span><br><span class="line">              name: app    </span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx:1.17.2</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">          resources:</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 100m</span><br><span class="line">              memory: 100Mi</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 250m</span><br><span class="line">              memory: 500Mi </span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: app</span><br><span class="line">              mountPath: /usr/share/nginx/html             </span><br><span class="line">      volumes:</span><br><span class="line">        - name: app</span><br><span class="line">          emptyDir: &#123;&#125;       </span><br><span class="line">      restartPolicy: Always</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: v1-service</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: v1-pod</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - name: nginx</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: v2-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: v2-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: v2-pod</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: v2-pod</span><br><span class="line">      labels:</span><br><span class="line">        app: v2-pod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx:1.17.2</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">          resources:</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 100m</span><br><span class="line">              memory: 100Mi</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 250m</span><br><span class="line">              memory: 500Mi </span><br><span class="line">      restartPolicy: Always</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: v2-service</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: v2-pod</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - name: nginx</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br></pre></td></tr></table></figure><h5 id="部署ingress"><a href="#部署ingress" class="headerlink" title="部署ingress"></a>部署ingress</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-v1</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: &quot;nginx&quot;</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: v1-service</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure><h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;Host: nginx.xudaxian.com&quot; http://192.168.10.135</span><br></pre></td></tr></table></figure><h4 id="流量切分"><a href="#流量切分" class="headerlink" title="流量切分"></a>流量切分</h4><h5 id="基于-Header-的流量切分"><a href="#基于-Header-的流量切分" class="headerlink" title="基于 Header 的流量切分"></a>基于 Header 的流量切分</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-canary</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/canary: &quot;true&quot; # 开启金丝雀 </span><br><span class="line">    nginx.ingress.kubernetes.io/canary-by-header: &quot;Region&quot; # 基于请求头</span><br><span class="line">    # 如果 请求头 Region = always ，就路由到金丝雀版本；如果 Region = never ，就永远不会路由到金丝雀版本。</span><br><span class="line">    nginx.ingress.kubernetes.io/canary-by-header-value: &quot;sz&quot; # 自定义值</span><br><span class="line">    # 如果 请求头 Region = sz ，就路由到金丝雀版本；如果 Region != sz ，就永远不会路由到金丝雀版本。</span><br><span class="line">    # nginx.ingress.kubernetes.io/canary-by-header-pattern: &quot;sh|sz&quot;</span><br><span class="line">    # 如果 请求头 Region = sh 或 Region = sz ，就路由到金丝雀版本；如果 Region != sz 并且 Region != sz ，就永远不会路由到金丝雀版本。</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: &quot;nginx&quot;</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: v2-service</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#测试：</span><br><span class="line"></span><br><span class="line">curl -H &quot;Host: nginx.xudaxian.com&quot; http://192.168.10.135</span><br><span class="line"></span><br><span class="line">curl -H &quot;Host: nginx.xudaxian.com&quot; -H &quot;Region: sz&quot; http://192.10.135</span><br><span class="line"></span><br><span class="line">curl -H &quot;Host: nginx.xudaxian.com&quot; -H &quot;Region: sh&quot; http://192.10.135</span><br></pre></td></tr></table></figure><h5 id="基于-Cookie-的流量切分"><a href="#基于-Cookie-的流量切分" class="headerlink" title="基于 Cookie 的流量切分"></a>基于 Cookie 的流量切分</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-canary</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/canary: &quot;true&quot; # 开启金丝雀 </span><br><span class="line">    nginx.ingress.kubernetes.io/canary-by-cookie: &quot;vip&quot; # 如果 cookie 是 vip = always ，就会路由到到金丝雀版本；如果 cookie 是 vip = never ，就永远不会路由到金丝雀的版本。</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: &quot;nginx&quot;</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: v2-service</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#验证：</span><br><span class="line">curl -H &quot;Host: nginx.xudaxian.com&quot; --cookie &quot;vip=always&quot; http://192.168.10.135</span><br></pre></td></tr></table></figure><h5 id="基于服务权重的流量切分"><a href="#基于服务权重的流量切分" class="headerlink" title="基于服务权重的流量切分"></a>基于服务权重的流量切分</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-canary</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/canary: &quot;true&quot; # 开启金丝雀 </span><br><span class="line">    nginx.ingress.kubernetes.io/canary-weight: &quot;10&quot; # 基于服务权重</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: &quot;nginx&quot;</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: v2-service</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#验证</span><br><span class="line">for i in &#123;1..10&#125;; do curl -H &quot;Host: nginx.xudaxian.com&quot; http://192.168.10.135; done;</span><br></pre></td></tr></table></figure><h2 id="NetworkPolicy（网络策略）"><a href="#NetworkPolicy（网络策略）" class="headerlink" title="NetworkPolicy（网络策略）"></a>NetworkPolicy（网络策略）</h2><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/">网络策略</a>指的是 Pod 间的网络隔离策略，默认情况下是互通的。</p><p>Pod  之间的互通是通过如下三个标识符的组合来辨识的： </p><ul><li><ul><li>① 其他被允许的 Pod（例外：Pod 无法阻塞对自身的访问）。</li></ul></li><li><ul><li>② 被允许的名称空间。</li></ul></li><li><ul><li>③ IP 组块（例外：与 Pod 运行所在的节点的通信总是被允许的， 无论 Pod 或节点的 IP 地址）。</li></ul></li></ul><p><img src="C:\Users\32625\OneDrive\图片\k8s\42.png"></p><h3 id="pod的隔离与非隔离"><a href="#pod的隔离与非隔离" class="headerlink" title="pod的隔离与非隔离"></a>pod的隔离与非隔离</h3><ul><li><p>默认情况下，Pod 都是非隔离的（non-isolated），可以接受来自任何请求方的网络请求。 </p></li><li><p>如果一个 NetworkPolicy 的标签选择器选中了某个 Pod，则该 Pod 将变成隔离的（isolated），并将拒绝任何不被 NetworkPolicy 许可的网络连接。</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: networkpol-01</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  podSelector: # Pod 选择器</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx  # 选中的 Pod 就被隔离起来了</span><br><span class="line">  policyTypes: # 策略类型</span><br><span class="line">  - Ingress # Ingress 入站规则、Egress 出站规则</span><br><span class="line">  - Egress </span><br><span class="line">  ingress: # 入站白名单，什么能访问我</span><br><span class="line">  - from:</span><br><span class="line">    - podSelector: # 选中的 Pod 可以访问 spec.matchLabels 中筛选的 Pod </span><br><span class="line">        matchLabels:</span><br><span class="line">          access: granted</span><br><span class="line">    ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">  egress: # 出站白名单，我能访问什么</span><br><span class="line">    - to:</span><br><span class="line">       - podSelector: # spec.matchLabels 中筛选的 Pod 能访问的 Pod</span><br><span class="line">          matchLabels:</span><br><span class="line">            app: tomcat</span><br><span class="line">       - namespaceSelector: </span><br><span class="line">          matchLabels:</span><br><span class="line">            kubernetes.io/metadata.name: dev # spec.matchLabels 中筛选的 Pod 能访问 dev 命名空间下的所有</span><br><span class="line">      ports:</span><br><span class="line">      - protocol: TCP</span><br><span class="line">        port: 8080</span><br></pre></td></tr></table></figure><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#default-policies">https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#default-policies</a></p><h1 id="配置和存储"><a href="#配置和存储" class="headerlink" title="配置和存储"></a>配置和存储</h1><ul><li><p><strong>容器的生命周期可能很短，会被频繁的创建和销毁。那么容器在销毁的时候，保存在容器中的数据也会被清除。这种结果对用户来说，在某些情况下是不乐意看到的。为了持久化保存容器中的数据，Kubernetes 引入了 Volume 的概念。和 Docker 中的卷管理（匿名卷、具名卷、自定义挂载目录，都是挂载在本机，功能非常有限）不同的是，Kubernetes 天生就是集群，所以为了方便管理，Kubernetes 将 <code>卷</code> 抽取为一个对象资源，这样可以更方便的管理和存储数据。</strong></p></li><li><p><strong>Volume 是 Pod 中能够被多个容器访问的共享目录，它被定义在 Pod 上，然后被一个 Pod 里面的多个容器挂载到具体的文件目录下，Kubernetes 通过 Volume 实现同一个 Pod 中不同容器之间的数据共享以及数据的持久化存储。Volume 的生命周期不和 Pod 中的单个容器的生命周期有关，当容器终止或者重启的时候，Volume 中的数据也不会丢失</strong></p><p><img src="C:\Users\32625\OneDrive\图片\k8s\1.png"></p></li></ul><h2 id="k8s支持的Volume类型"><a href="#k8s支持的Volume类型" class="headerlink" title="k8s支持的Volume类型"></a>k8s支持的Volume类型</h2><h3 id="非持久性存储："><a href="#非持久性存储：" class="headerlink" title="非持久性存储："></a>非持久性存储：</h3><ul><li><ul><li>emptyDir</li></ul></li><li><ul><li>HostPath</li></ul></li></ul><h3 id="网络连接性存储："><a href="#网络连接性存储：" class="headerlink" title="网络连接性存储："></a>网络连接性存储：</h3><ul><li><ul><li>SAN：iSCSI、ScaleIO Volumes、FC (Fibre Channel)</li></ul></li><li><ul><li>NFS：nfs，cfs</li></ul></li></ul><h3 id="分布式存储"><a href="#分布式存储" class="headerlink" title="分布式存储"></a>分布式存储</h3><ul><li><ul><li>Glusterfs</li></ul></li><li><ul><li>RBD (Ceph Block Device)</li></ul></li><li><ul><li>CephFS</li></ul></li><li><ul><li>Portworx Volumes</li></ul></li><li><ul><li>Quobyte Volumes</li></ul></li></ul><h3 id="云端存储"><a href="#云端存储" class="headerlink" title="云端存储"></a>云端存储</h3><ul><li><ul><li>GCEPersistentDisk</li></ul></li><li><ul><li>AWSElasticBlockStore</li></ul></li><li><ul><li>AzureFile</li></ul></li><li><ul><li>AzureDisk</li></ul></li><li><ul><li>Cinder (OpenStack block storage)</li></ul></li><li><ul><li>VsphereVolume</li></ul></li><li><ul><li>StorageOS</li></ul></li></ul><h3 id="自定义存储"><a href="#自定义存储" class="headerlink" title="自定义存储"></a>自定义存储</h3><ul><li><ul><li>FlexVolume</li></ul></li></ul><p>![](C:\Users\32625\OneDrive\图片\k8s\2 (2).png)</p><h2 id="Secrat"><a href="#Secrat" class="headerlink" title="Secrat"></a>Secrat</h2><ul><li>Secret 对象类型用来保存敏感信息，如：密码、OAuth2 令牌以及 SSH 密钥等。将这些信息放到 Secret 中比放在 Pod 的定义或者容器镜像中更加安全和灵活。</li><li>由于创建 Secret 可以独立于使用它们的 Pod， 因此在创建、查看和编辑 Pod 的工作流程中暴露 Secret（及其数据）的风险较小。 Kubernetes 和在集群中运行的应用程序也可以对 Secret 采取额外的预防措施，如：避免将机密数据写入非易失性存储。</li><li>Secret 类似于 <a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMap</a> 但专门用于保存机密数据。</li></ul><p>示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;damin&#x27; | base64 #输出</span><br><span class="line">YWRtaW4K #加密</span><br><span class="line">echo &#x27;YWRtaW4K&#x27; | base64 --decode #解除加密</span><br><span class="line">damin</span><br></pre></td></tr></table></figure><h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><table><thead><tr><th>内置类型</th><th>用法</th></tr></thead><tbody><tr><td><code>Opaque</code></td><td>用户定义的任意数据</td></tr><tr><td><code>kubernetes.io/service-account-token</code></td><td>服务账号令牌</td></tr><tr><td><code>kubernetes.io/dockercfg</code></td><td><code>~/.dockercfg</code> 文件的序列化形式</td></tr><tr><td><code>kubernetes.io/dockerconfigjson</code></td><td><code>~/.docker/config.json</code> 文件的序列化形式</td></tr><tr><td><code>kubernetes.io/basic-auth</code></td><td>用于基本身份认证的凭据</td></tr><tr><td><code>kubernetes.io/ssh-auth</code></td><td>用于 SSH 身份认证的凭据</td></tr><tr><td><code>kubernetes.io/tls</code></td><td>用于 TLS 客户端或者服务器端的数据</td></tr><tr><td><code>bootstrap.kubernetes.io/token</code></td><td>启动引导令牌数据</td></tr></tbody></table><ul><li><p>要使用 Secret，Pod 需要引用 Secret。 Pod 可以用三种方式之一来使用 Secret ： </p></li><li><ul><li>作为挂载到一个或多个容器上的 <a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">卷</a> 中的<a href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets-as-files-from-a-pod">文件</a>。（volume进行挂载）</li></ul></li><li><ul><li>作为<a href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets-as-environment-variables">容器的环境变量</a>（envFrom字段引用）</li></ul></li><li><ul><li>由 <a href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-imagepullsecrets">kubelet 在为 Pod 拉取镜像时使用</a>（此时Secret是docker-registry类型的）</li></ul></li><li><p>Secret 对象的名称必须是合法的 <a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/names#dns-subdomain-names">DNS 子域名</a>。 在为创建 Secret 编写配置文件时，你可以设置 <code>data</code> 与&#x2F;或 <code>stringData</code> 字段。 <code>data</code> 和 <code>stringData</code> 字段都是可选的。<code>data</code> 字段中所有键值都必须是 base64 编码的字符串。如果不希望执行这种 base64 字符串的转换操作，你可以选择设置 <code>stringData</code> 字段，其中可以使用任何字符串作为其取值。</p></li></ul><h3 id="使用命令创建Secret"><a href="#使用命令创建Secret" class="headerlink" title="使用命令创建Secret"></a>使用命令创建Secret</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic secret-1 \</span><br><span class="line">   --from-literal=username=admin \</span><br><span class="line">   --from-literal=password=123456</span><br></pre></td></tr></table></figure><p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-01 164616.png)</p><h3 id="yaml格式创建Secret"><a href="#yaml格式创建Secret" class="headerlink" title="yaml格式创建Secret"></a>yaml格式创建Secret</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: vol-secret</span><br><span class="line">  namespace: default</span><br><span class="line">type:</span><br><span class="line">stringData: #k8s自动加密</span><br><span class="line">      username: admin</span><br><span class="line">      password: &quot;123456&quot;</span><br><span class="line">#如果同时使用deta和stringDta,data会被忽略</span><br></pre></td></tr></table></figure><h4 id="提取"><a href="#提取" class="headerlink" title="提取"></a>提取</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get  secret vol-secret -o yaml</span><br></pre></td></tr></table></figure><p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-01 181508.png)</p><h3 id="环境变量的引用"><a href="#环境变量的引用" class="headerlink" title="环境变量的引用"></a>环境变量的引用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: my-secret</span><br><span class="line">  namespace: default</span><br><span class="line">type: Opaque</span><br><span class="line">stringData: </span><br><span class="line">  username: admin</span><br><span class="line">  password: &quot;1234556&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-secret</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: pod-secret</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: alpine</span><br><span class="line">    image: alpine</span><br><span class="line">    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    env:</span><br><span class="line">    - name: SECRET_USERNAME # 容器中的环境变量名称</span><br><span class="line">      valueFrom:</span><br><span class="line">        secretKeyRef: </span><br><span class="line">          name: my-secret #  指定 secret 的名称</span><br><span class="line">          key: username # secret 中 key 的名称，会自动 base64 解码</span><br><span class="line">    - name: SECRET_PASSWORD # 容器中的环境变量名称</span><br><span class="line">      valueFrom:</span><br><span class="line">        secretKeyRef:</span><br><span class="line">          name: my-secret #  指定 secret 的名称</span><br><span class="line">          key: password # secret 中 key 的名称   </span><br><span class="line">    - name: POD_NAME</span><br><span class="line">      valueFrom: </span><br><span class="line">        fieldRef:  # 属性引用</span><br><span class="line">          fieldPath: metadata.name</span><br><span class="line">    - name: POD_LIMITS_MEMORY</span><br><span class="line">      valueFrom:</span><br><span class="line">        resourceFieldRef:  # 资源限制引用 </span><br><span class="line">          containerName: alpine  </span><br><span class="line">          resource: limits.memory       </span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure><h3 id="挂载卷"><a href="#挂载卷" class="headerlink" title="挂载卷"></a>挂载卷</h3><p>注意：</p><ul><li><p>如果 Secret 以卷挂载的方式，Secret 里面的所有 key 都是文件名，内容就是 key 对应的值。</p></li><li><p>如果 Secret 以卷挂载的方式，Secret 的内容更新，那么容器对应的值也会被更新（subPath 引用除外）。</p></li><li><p>如果 Secret 以卷挂载的方式，默认情况下，挂载出来的文件是只读的。</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: my-secret</span><br><span class="line">  namespace: default</span><br><span class="line">type: Opaque</span><br><span class="line">stringData: </span><br><span class="line">  username: admin</span><br><span class="line">  password: &quot;1234556&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-secret</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: pod-secret</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: alpine</span><br><span class="line">    image: alpine</span><br><span class="line">    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi     </span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: app</span><br><span class="line">      mountPath: /app  </span><br><span class="line">  volumes:</span><br><span class="line">    - name: app</span><br><span class="line">      secret:</span><br><span class="line">        secretName: my-secret # secret 的名称，Secret 中的所有 key 全部挂载出来</span><br><span class="line">        items:</span><br><span class="line">          - key: username # secret 中 key 的名称，Secret 中的 username 的内容挂载出来</span><br><span class="line">            path: username.md # 在容器内挂载出来的文件的路径</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure><h2 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h2><ul><li>ConfigMap与Secret相似，但是Secret会将base 64进行编码和解码，而ConfigMap则不会</li></ul><h3 id="yaml格式创建"><a href="#yaml格式创建" class="headerlink" title="yaml格式创建"></a>yaml格式创建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: cm</span><br><span class="line">  namespace: default</span><br><span class="line">data:</span><br><span class="line">  # 类属性键；每一个键都映射到一个简单的值</span><br><span class="line">  player_initial_lives: &quot;3&quot;</span><br><span class="line">  ui_properties_file_name: &quot;user-interface.properties&quot;</span><br><span class="line">  # 类文件键</span><br><span class="line">  game.properties: |</span><br><span class="line">    enemy.types=aliens,monsters</span><br><span class="line">    player.maximum-lives=5    </span><br><span class="line">  user-interface.properties: |</span><br><span class="line">    color.good=purple</span><br><span class="line">    color.bad=yellow</span><br><span class="line">    allow.textmode=true </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: &quot;pod-cm&quot;</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: &quot;pod-cm&quot;</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: alpine</span><br><span class="line">    image: &quot;alpine&quot;</span><br><span class="line">    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    env:</span><br><span class="line">    - name: PLAYER_INITIAL_LIVES</span><br><span class="line">      valueFrom:</span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: cm</span><br><span class="line">          key: player_initial_lives</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: app</span><br><span class="line">      mountPath: /app  </span><br><span class="line">  volumes:</span><br><span class="line">    - name: app</span><br><span class="line">      configMap:</span><br><span class="line">        name: cm # secret 的名称，Secret 中的所有 key 全部挂载出来</span><br><span class="line">        items:</span><br><span class="line">          - key: ui_properties_file_name # secret 中 key 的名称，Secret 中的 ui_properties_file_name 的内容挂载出来</span><br><span class="line">            path: ui_properties_file_name.md # 在容器内挂载出来的文件的路径</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li><p>ConfigMap 和 Secret 一样，环境变量引用不会热更新，而卷挂载是可以热更新的。</p></li><li><p>最新版本的 ConfigMap 和 Secret 提供了不可更改的功能，即禁止热更新，只需要在 Secret 或 ConfigMap 中设置 <code>immutable = true</code> 。</p></li></ul><h3 id="结合-SpringBoot-做到生产配置无感知"><a href="#结合-SpringBoot-做到生产配置无感知" class="headerlink" title="结合 SpringBoot 做到生产配置无感知"></a>结合 SpringBoot 做到生产配置无感知</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/png/513185/1648538977212-715a4ba9-6e3a-45ba-aecc-dd7541dbf870.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_39,text_6K645aSn5LuZ,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p><h2 id="临时存储"><a href="#临时存储" class="headerlink" title="临时存储"></a>临时存储</h2><ul><li><p>Kubernetes 为了不同的目的，支持几种不同类型的临时卷： </p><ul><li><p><a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#emptydir">emptyDir</a>： Pod 启动时为空，存储空间来自本地的 kubelet 根目录（通常是根磁盘）或内存</p></li><li><p><a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#configmap">configMap</a>、 <a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#downwardapi">downwardAPI</a>、 <a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#secret">secret</a>： 将不同类型的 Kubernetes 数据注入到 Pod 中</p></li><li><p><a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#csi-ephemeral-volumes">CSI 临时卷</a>： 类似于前面的卷类型，但由专门<a href="https://kubernetes-csi.github.io/docs/drivers.html">支持此特性</a> 的指定 <a href="https://github.com/container-storage-interface/spec/blob/master/spec.md">CSI 驱动程序</a>提供</p></li><li><p>通用临时卷](<a href="https://kubernetes.io/zh/docs/concepts/storage/ephemeral-volumes/#generic-ephemeral-volumes)%EF%BC%9A">https://kubernetes.io/zh/docs/concepts/storage/ephemeral-volumes/#generic-ephemeral-volumes)：</a> 它可以由所有支持持久卷的存储驱动程序提供</p></li></ul></li><li><p><code>emptyDir</code>、<code>configMap</code>、<code>downwardAPI</code>、<code>secret</code> 是作为 <a href="https://kubernetes.io/zh/docs/concepts/configuration/manage-resources-containers/#local-ephemeral-storage">本地临时存储</a> 提供的。它们由各个节点上的 kubelet 管理。</p></li><li><p>CSI 临时卷 <code>必须</code> 由第三方 CSI 存储驱动程序提供。</p></li><li><p>通用临时卷 <code>可以</code>  由第三方 CSI 存储驱动程序提供，也可以由支持动态配置的任何其他存储驱动程序提供。 一些专门为 CSI 临时卷编写的 CSI 驱动程序，不支持动态供应：因此这些驱动程序不能用于通用临时卷。</p></li><li><p>使用第三方驱动程序的优势在于，它们可以提供 Kubernetes 本身不支持的功能， 例如，与 kubelet 管理的磁盘具有不同运行特征的存储，或者用来注入不同的数据。</p></li></ul><h3 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h3><ul><li><p><code>emptyDir</code> 的一些用途： </p></li><li><ul><li>临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留。</li></ul></li><li><ul><li>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）。</li></ul></li><li><p><code>emptyDir</code> 卷存储在该节点的磁盘或内存中，如果设置 <code>emptyDir.medium = Memory</code> ，那么就告诉 Kubernetes 将数据保存在内存中，并且在 Pod 被重启或删除前，所写入的所有文件都会计入容器的内存消耗，受到容器内存限制约束</p><p><img src="C:\Users\32625\OneDrive\图片\k8s\17.png"></p></li><li><p><strong>Pod 分派到某个 Node 上时，<code>emptyDir</code> 卷会被创建，并且在 Pod 在该节点上运行期间，卷一直存在。</strong></p></li><li><p><strong>就像其名称表示的那样，卷最初是空的。</strong></p></li><li><p><strong>尽管 Pod 中的容器挂载 <code>emptyDir</code> 卷的路径可能相同也可能不同，这些容器都可以读写 <code>emptyDir</code> 卷中相同的文件。</strong></p></li><li><p><strong>当 Pod 因为某些原因被从节点上删除时，<code>emptyDir</code> 卷中的数据也会被永久删除</strong>。</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-empty-dir</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-empty-dir</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi    </span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: app</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">  - name: alpine</span><br><span class="line">    image: alpine</span><br><span class="line">    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;while true;do sleep 1; date &gt; /app/index.html;done&quot;]</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi    </span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: app</span><br><span class="line">      mountPath: /app     </span><br><span class="line">  volumes:</span><br><span class="line">    - name: app</span><br><span class="line">      emptyDir: &#123;&#125; # emptyDir 临时存储</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure><h3 id="hostPath"><a href="#hostPath" class="headerlink" title="hostPath"></a>hostPath</h3><ul><li><p>emptyDir 中的数据不会被持久化，它会随着 Pod 的结束而销毁，如果想要<code>简单</code>的将数据持久化到主机中，可以选择 hostPath 。</p></li><li><p>hostPath  就是将 Node 主机中的一个实际目录挂载到 Pod 中，以供容器使用，这样的设计就可以保证 Pod 销毁了，但是数据依旧可以保存在 Node 主机上。</p></li></ul><p>注意：hostPath 之所以被归为临时存储，是因为实际开发中，我们一般都是通过 Deployment 部署 Pod 的，一旦 Pod 被 Kubernetes 杀死或重启拉起等，并不一定会部署到原来的 Node 节点中。</p><ul><li>除了必需的 <code>path</code> 属性之外，用户可以选择性地为 <code>hostPath</code> 卷指定 <code>typ</code></li></ul><table><thead><tr><th>取值</th><th>行为</th></tr></thead><tbody><tr><td></td><td>空字符串（默认）用于向后兼容，这意味着在安装 hostPath 卷之前不会执行任何检查。</td></tr><tr><td><code>DirectoryOrCreate</code></td><td>如果在给定路径上什么都不存在，那么将根据需要创建空目录，权限设置为 0755，具有与 kubelet 相同的组和属主信息。</td></tr><tr><td><code>Directory</code></td><td>在给定路径上必须存在的目录。</td></tr><tr><td><code>FileOrCreate</code></td><td>如果在给定路径上什么都不存在，那么将在那里根据需要创建空文件，权限设置为 0644，具有与 kubelet 相同的组和所有权。</td></tr><tr><td><code>File</code></td><td>在给定路径上必须存在的文件。</td></tr><tr><td><code>Socket</code></td><td>在给定路径上必须存在的 UNIX 套接字。</td></tr><tr><td><code>CharDevice</code></td><td>在给定路径上必须存在的字符设备。</td></tr><tr><td><code>BlockDevice</code></td><td>在给定路径上必须存在的块设备。</td></tr><tr><td>注意：hostPath 的典型应用就是时间同步：通常而言，Node 节点的时间是同步的（云厂商提供的云服务器的时间都是同步的），但是，Pod 中的容器的时间就不一定了，有 UTC 、CST 等；同一个 Pod ，如果部署到中国，就必须设置为 CST 了。</td><td></td></tr></tbody></table><h4 id="配置文件-5"><a href="#配置文件-5" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-host-path</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx    </span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath: # hostPath</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure><h2 id="持久化存储"><a href="#持久化存储" class="headerlink" title="持久化存储"></a>持久化存储</h2><h3 id="volume"><a href="#volume" class="headerlink" title="volume"></a>volume</h3><ul><li><p>Kubernetes 支持很多类型的卷。 <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod</a> 可以同时使用任意数目的卷类型。</p></li><li><p>临时卷类型的生命周期与 Pod 相同，但持久卷可以比 Pod 的存活期长。</p></li><li><p>当 Pod 不再存在时，Kubernetes 也会销毁临时卷。</p></li><li><p>Kubernetes 不会销毁 <code>持久卷</code> 。</p></li><li><p>对于给定 Pod 中 <code>任何类型的卷</code> ，在容器重启期间数据都不会丢失。</p></li><li><p>使用卷时, 在 <code>.spec.volumes</code> 字段中设置为 Pod 提供的卷，并在 <code>.spec.containers[*].volumeMounts</code> 字段中声明卷在容器中的挂载位置。</p></li></ul><h3 id="subPath"><a href="#subPath" class="headerlink" title="subPath"></a>subPath</h3><ul><li>有时，在单个 Pod 中共享卷以供多方使用是很有用的。 <code>volumeMounts.subPath</code> 属性可用于指定所引用的卷内的子路径，而不是其根路径。</li></ul><p>​       注意：ConfigMap 和 Secret 使用子路径挂载是无法热更新的。</p><h3 id="安装FNS"><a href="#安装FNS" class="headerlink" title="安装FNS"></a>安装FNS</h3><p>网络文件系统（Network File System <strong>[ NFS ]</strong> )，是由 <a href="https://baike.baidu.com/item/SUN/69463">SUN </a>公司研制的<a href="https://baike.baidu.com/item/UNIX/219943">UNIX</a><a href="https://baike.baidu.com/item/%E8%A1%A8%E7%A4%BA%E5%B1%82/4329716">表示层</a>协议(presentation layer protocol)，能使使用者访问网络上别处的文件就像在使用自己的计算机一样。</p><p><img src="C:\Users\32625\OneDrive\图片\k8s\20.png"></p><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><h5 id="master节点执行的操作"><a href="#master节点执行的操作" class="headerlink" title="master节点执行的操作"></a>master节点执行的操作</h5><p>以 Master （192.168.10.137）节点作为 NFS 服务端：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils</span><br></pre></td></tr></table></figure><p>创建 &#x2F;etc&#x2F;exports 文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># * 表示暴露权限给所有主机；* 也可以使用 192.168.0.0/16 代替，表示暴露给所有主机</span><br><span class="line">echo &quot;/nfs/data/ *(insecure,rw,sync,no_root_squash)&quot; &gt; /etc/exports</span><br></pre></td></tr></table></figure><p>创建 <code>/nfs/data/</code> （共享目录）目录，并设置权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -pv /nfs/data/</span><br><span class="line"></span><br><span class="line">chmod 777 -R /nfs/data/</span><br></pre></td></tr></table></figure><p>启动NFS</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable rpcbind</span><br><span class="line"></span><br><span class="line">systemctl enable nfs-server</span><br><span class="line"></span><br><span class="line">systemctl start rpcbind</span><br><span class="line"></span><br><span class="line">systemctl start nfs-server</span><br></pre></td></tr></table></figure><p>在Master节点上加载配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exportfs -r</span><br></pre></td></tr></table></figure><p>检查配置是否生效</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exportfs</span><br></pre></td></tr></table></figure><p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-04 190202.png)</p><h5 id="node节点上执行的操作"><a href="#node节点上执行的操作" class="headerlink" title="node节点上执行的操作"></a>node节点上执行的操作</h5><p>在node（192.168.10.135 &#x2F; 192.168.10.136)节点上安装nfs-utils</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 服务器端防火墙开放111、662、875、892、2049的 tcp / udp 允许，否则远端客户无法连接。</span><br><span class="line">yum install -y nfs-utils</span><br></pre></td></tr></table></figure><p>执行以下命令检查 nfs 服务器端是否有设置共享目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># showmount -e &lt;nfs服务器的ip&gt;</span><br><span class="line">showmount -e 192.168.10.137</span><br></pre></td></tr></table></figure><p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-04 191711.png)</p><p>执行以下命令挂载 nfs 服务器上的共享目录到本机路径 <code>/root/nd</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /nd</span><br><span class="line"></span><br><span class="line"># mount -t nfs &lt;nfs服务器的IP&gt;:/root/nfs_root /root/nfsmount</span><br><span class="line">mount -t nfs 192.168.10.137:/nfs/data /nd</span><br></pre></td></tr></table></figure><p>在node节点写入一个测试文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;hello nfs server&quot; &gt; /nd/test.txt</span><br></pre></td></tr></table></figure><p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-04 192359.png)</p><p>在master节点验证文件是否写入成功</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /nfs/data/test.txt</span><br></pre></td></tr></table></figure><p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-04 192355.png)</p><h3 id="配置文件-6"><a href="#配置文件-6" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">    - name: html  </span><br><span class="line">      mountPath: /usr/share/nginx/html/ # / 一定是文件夹</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">    - name: html </span><br><span class="line">      nfs: # 使用 nfs 存储驱动</span><br><span class="line">        path: /nfs/data  # nfs 共享的目录</span><br><span class="line">        server:  192.168.65.100  # nfs 服务端的 IP 地址或 hostname </span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure><h1 id="调度原理"><a href="#调度原理" class="headerlink" title="调度原理"></a>调度原理</h1><h2 id="ResourceQuotas（资源配额）"><a href="#ResourceQuotas（资源配额）" class="headerlink" title="ResourceQuotas（资源配额）"></a>ResourceQuotas（资源配额）</h2><ul><li><p>当多个用户或团队共享具有固定节点数目的集群时，人们会担心 <code>有人使用超过其基于公平原则所分配到的资源量</code> 。<br>  资源配额是帮助管理员解决这一问题的工具。 </p></li><li><p>资源配额，通过 <code>ResourceQuota</code> 对象来定义，<code>对每个命名空间的资源消耗总量提供限制</code>。 它可以 <code>限制</code> 命名空间中 <code>某种类型的对象的总数目上限</code>，<code>也可以限制命令空间中的 Pod 可以使用的计算资源的总上限</code>。 </p></li><li><p>资源配额的工作方式如下： </p></li><li><ul><li>不同的团队可以在不同的命名空间下工作，目前这是非约束性的，在未来的版本中可能会通过 ACL (Access Control List 访问控制列表) 来实现强制性约束。</li></ul></li><li><ul><li><code>集群管理员可以为每个命名空间创建一个或多个 ResourceQuota 对象</code>。</li></ul></li><li><ul><li>当用户在命名空间下创建资源（如 Pod、Service 等）时，Kubernetes 的配额系统会跟踪集群的资源使用情况，<code>以确保使用的资源用量不超过 ResourceQuota 中定义的硬性资源限额</code>。</li></ul></li><li><ul><li>如果资源创建或者更新请求违反了配额约束，那么该请求会报错（HTTP 403 FORBIDDEN）， 并在消息中给出有可能违反的约束。</li></ul></li><li><ul><li>如果命名空间下的计算资源 （如 <code>cpu</code> 和 <code>memory</code>）的<code>配额被启用</code>，则<code>用户必须为 这些资源设定请求值（request）和约束值（limit）</code>，否则配额系统将拒绝 Pod 的创建。 提示: 可使用 <code>LimitRanger</code> 准入控制器来为没有设置计算资源需求的 Pod 设置默认值。</li></ul></li></ul><h3 id="计算资源配额"><a href="#计算资源配额" class="headerlink" title="计算资源配额"></a>计算资源配额</h3><ul><li>用户可以对给定命名空间下的可被请求的 <a href="https://kubernetes.io/zh/docs/concepts/configuration/manage-resources-containers/">计算资源</a> 总量进行限制。</li></ul><table><thead><tr><th><code>limits.cpu</code></th><th>所有非终止状态的 Pod，其 CPU 限额总量不能超过该值。</th></tr></thead><tbody><tr><td><code>limits.memory</code></td><td>所有非终止状态的 Pod，其内存限额总量不能超过该值。</td></tr><tr><td><code>requests.cpu</code></td><td>所有非终止状态的 Pod，其 CPU 需求总量不能超过该值。</td></tr><tr><td><code>requests.memory</code></td><td>所有非终止状态的 Pod，其内存需求总量不能超过该值。</td></tr><tr><td><code>hugepages-&lt;size&gt;</code></td><td>对于所有非终止状态的 Pod，针对指定尺寸的巨页请求总数不能超过此值。</td></tr><tr><td><code>cpu</code></td><td>与 <code>requests.cpu</code> 相同。</td></tr><tr><td><code>memory</code></td><td>与 <code>requests.memory</code> 相同。</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ResourceQuota</span><br><span class="line">metadata:</span><br><span class="line">  name: mem-cpu</span><br><span class="line">  namespace: default # 限制 default 名称空间</span><br><span class="line">spec:</span><br><span class="line">  hard:</span><br><span class="line">    requests.cpu: &quot;1&quot;</span><br><span class="line">    requests.memory: 1Gi</span><br><span class="line">    limits.cpu: &quot;2&quot;</span><br><span class="line">    limits.memory: 2Gi</span><br></pre></td></tr></table></figure><h3 id="扩展资源的资源配额"><a href="#扩展资源的资源配额" class="headerlink" title="扩展资源的资源配额"></a>扩展资源的资源配额</h3><p>●除上述资源外，在 Kubernetes 1.10 版本中，还添加了对 <a href="https://kubernetes.io/zh/docs/concepts/configuration/manage-resources-containers/#extended-resources">扩展资源</a> 的支持。<br>●由于扩展资源不可超量分配，因此没有必要在配额中为同一扩展资源同时指定 requests 和 limits。 对于扩展资源而言，目前仅允许使用前缀为 requests. 的配额项。<br>●以 GPU 拓展资源为例，如果资源名称为 nvidia.com&#x2F;gpu，并且要将命名空间中请求的 GPU 资源总数限制为 4，则可以如下定义配额：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requests.nvidia.com/gpu: 4</span><br></pre></td></tr></table></figure><p>**有关更多详细信息，请参阅官方文档<a href="https://kubernetes.io/zh/docs/concepts/policy/resource-quotas/#viewing-and-setting-quotas">查看和设置配额</a>**。</p><h3 id="存储资源配额"><a href="#存储资源配额" class="headerlink" title="存储资源配额"></a>存储资源配额</h3><ul><li><p>用户可以对给定命名空间下的 <a href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/">存储资源</a> 总量进行限制。</p></li><li><p>此外，还可以根据相关的存储类（Storage Class）来限制存储资源的消耗。</p></li></ul><table><thead><tr><th>资源名称</th><th>描述</th></tr></thead><tbody><tr><td><code>requests.storage</code></td><td>所有 PVC，存储资源的需求总量不能超过该值。</td></tr><tr><td><code>persistentvolumeclaims</code></td><td>在该命名空间中所允许的 <a href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">PVC</a> 总量。</td></tr><tr><td><code>&lt;storage-class-name&gt;.storageclass.storage.k8s.io/requests.storage</code></td><td>在所有与 <code>&lt;storage-class-name&gt;</code> 相关的持久卷申领中，存储请求的总和不能超过该值。</td></tr><tr><td><code>&lt;storage-class-name&gt;.storageclass.storage.k8s.io/persistentvolumeclaims</code></td><td>在与 storage-class-name 相关的所有持久卷申领中，命名空间中可以存在的<a href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">持久卷申领</a>总数。</td></tr></tbody></table><ul><li><p>例如，如果一个操作人员针对 <code>gold</code> 存储类型与 <code>bronze</code> 存储类型设置配额， 操作人员可以定义如下配额： </p></li><li><ul><li><code>gold.storageclass.storage.k8s.io/requests.storage: 500Gi</code></li></ul></li><li><ul><li><code>bronze.storageclass.storage.k8s.io/requests.storage: 100Gi</code></li></ul></li><li><p>在 Kubernetes 1.8 版本中，本地临时存储的配额支持已经是 Alpha 功能：</p></li></ul><table><thead><tr><th>资源名称</th><th>描述</th></tr></thead><tbody><tr><td><code>requests.ephemeral-storage</code></td><td>在命名空间的所有 Pod 中，本地临时存储请求的总和不能超过此值。</td></tr><tr><td><code>limits.ephemeral-storage</code></td><td>在命名空间的所有 Pod 中，本地临时存储限制值的总和不能超过此值。</td></tr><tr><td><code>ephemeral-storage</code></td><td>与 <code>requests.ephemeral-storage</code> 相同。</td></tr></tbody></table><p><strong>注意：如果所使用的是 CRI 容器运行时，容器日志会被计入临时存储配额。 这可能会导致存储配额耗尽的 Pods 被意外地驱逐出节点。 参考<a href="https://kubernetes.io/zh/docs/concepts/cluster-administration/logging/">日志架构</a> 了解详细信息。</strong></p><h3 id="对象数量配额"><a href="#对象数量配额" class="headerlink" title="对象数量配额"></a>对象数量配额</h3><ul><li><p>你可以使用以下语法对所有标准的、命名空间域的资源类型进行配额设置： </p></li><li><ul><li><code>count/&lt;resource&gt;.&lt;group&gt;</code>：用于非核心（core）组的资源。</li></ul></li><li><ul><li><code>count/&lt;resource&gt;</code>：用于核心组的资源。</li></ul></li><li><p>这是用户可能希望利用对象计数配额来管理的一组资源示例。 </p></li><li><ul><li><code>count/persistentvolumeclaims</code></li></ul></li><li><ul><li><code>count/services</code></li></ul></li><li><ul><li><code>count/secrets</code></li></ul></li><li><ul><li><code>count/configmaps</code></li></ul></li><li><ul><li><code>count/replicationcontrollers</code></li></ul></li><li><ul><li><code>count/deployments.apps</code></li></ul></li><li><ul><li><code>count/replicasets.apps</code></li></ul></li><li><ul><li><code>count/statefulsets.apps</code></li></ul></li><li><ul><li><code>count/jobs.batch</code></li></ul></li><li><ul><li><code>count/cronjobs.batch</code></li></ul></li><li><p>相同语法也可用于自定义资源。 例如，要对 <code>example.com</code> API 组中的自定义资源 <code>widgets</code> 设置配额，请使用 <code>count/widgets.example.com</code>。 </p></li><li><p>当使用 <code>count/*</code> 资源配额时，如果对象存在于服务器存储中，则会根据配额管理资源。 这些类型的配额有助于防止存储资源耗尽。例如，用户可能想根据服务器的存储能力来对服务器中 Secret 的数量进行配额限制。 集群中存在过多的 Secret 实际上会导致服务器和控制器无法启动。 用户可以选择对 Job 进行配额管理，以防止配置不当的 CronJob 在某命名空间中创建太多 Job 而导致集群拒绝服务。 </p></li><li><p>对有限的一组资源上实施一般性的对象数量配额也是可能的。 此外，还可以进一步按资源的类型设置其配额。</p></li></ul><table><thead><tr><th>资源名称</th><th>描述</th></tr></thead><tbody><tr><td><code>configmaps</code></td><td>在该命名空间中允许存在的 ConfigMap 总数上限。</td></tr><tr><td><code>persistentvolumeclaims</code></td><td>在该命名空间中允许存在的 <a href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">PVC</a> 的总数上限。</td></tr><tr><td><code>pods</code></td><td>在该命名空间中允许存在的非终止状态的 Pod 总数上限。Pod 终止状态等价于 Pod 的 <code>.status.phase in (Failed, Succeeded)</code> 为真。</td></tr><tr><td><code>replicationcontrollers</code></td><td>在该命名空间中允许存在的 ReplicationController 总数上限。</td></tr><tr><td><code>resourcequotas</code></td><td>在该命名空间中允许存在的 ResourceQuota 总数上限。</td></tr><tr><td><code>services</code></td><td>在该命名空间中允许存在的 Service 总数上限。</td></tr><tr><td><code>services.loadbalancers</code></td><td>在该命名空间中允许存在的 LoadBalancer 类型的 Service 总数上限。</td></tr><tr><td><code>services.nodeports</code></td><td>在该命名空间中允许存在的 NodePort 类型的 Service 总数上限。</td></tr><tr><td><code>secrets</code></td><td>在该命名空间中允许存在的 Secret 总数上限。</td></tr></tbody></table><p> <strong>例如，<code>pods</code> 配额统计某个命名空间中所创建的、非终止状态的 <code>Pod</code> 个数并确保其不超过某上限值。 用户可能希望在某命名空间中设置 <code>pods</code> 配额，以避免有用户创建很多小的 Pod， 从而耗尽集群所能提供的 Pod IP 地址。</strong> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ResourceQuota</span><br><span class="line">metadata:</span><br><span class="line">  name: pods-rq</span><br><span class="line">  namespace: default # 限制 default 名称空间</span><br><span class="line">spec:</span><br><span class="line">  hard:</span><br><span class="line">    pods: &quot;3&quot; # 限制 Pod 的数量</span><br></pre></td></tr></table></figure><ul><li><p>Pod 可以创建为特定的<a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/pod-priority-preemption/#pod-priority">优先级</a>。 通过使用配额规约中的 <code>scopeSelector</code> 字段，用户可以根据 Pod 的优先级控制其系统资源消耗。 </p></li><li><p>仅当配额规范中的 <code>scopeSelector</code> 字段选择到某 Pod 时，配额机制才会匹配和计量 Pod 的资源消耗。 </p></li><li><p>如果配额对象通过 <code>scopeSelector</code> 字段设置其作用域为优先级类，则配额对象只能 跟踪以下资源： </p></li><li><ul><li><code>pods</code></li></ul></li><li><ul><li><code>cpu</code></li></ul></li><li><ul><li><code>memory</code></li></ul></li><li><ul><li><code>ephemeral-storage</code></li></ul></li><li><ul><li><code>limits.cpu</code></li></ul></li><li><ul><li><code>limits.memory</code></li></ul></li><li><ul><li><code>limits.ephemeral-storage</code></li></ul></li><li><ul><li><code>requests.cpu</code></li></ul></li><li><ul><li><code>requests.memory</code></li></ul></li><li><ul><li><code>requests.ephemeral-storage</code></li></ul></li></ul><p> <strong>示例：创建一个配额对象，并将其与具有特定优先级的 Pod 进行匹配</strong> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 集群中的 Pod 可取三个优先级类之一，即 &quot;low&quot;、&quot;medium&quot;、&quot;high&quot;</span><br><span class="line"># 为每个优先级创建一个配额对象</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: List</span><br><span class="line">items:</span><br><span class="line">- apiVersion: v1</span><br><span class="line">  kind: ResourceQuota</span><br><span class="line">  metadata:</span><br><span class="line">    name: pods-high</span><br><span class="line">  spec:</span><br><span class="line">    hard:</span><br><span class="line">      cpu: &quot;1000&quot;</span><br><span class="line">      memory: 200Gi</span><br><span class="line">      pods: &quot;10&quot;</span><br><span class="line">    scopeSelector:</span><br><span class="line">      matchExpressions:</span><br><span class="line">      - operator : In</span><br><span class="line">        scopeName: PriorityClass</span><br><span class="line">        values: [&quot;high&quot;]</span><br><span class="line">- apiVersion: v1</span><br><span class="line">  kind: ResourceQuota</span><br><span class="line">  metadata:</span><br><span class="line">    name: pods-medium</span><br><span class="line">  spec:</span><br><span class="line">    hard:</span><br><span class="line">      cpu: &quot;10&quot;</span><br><span class="line">      memory: 20Gi</span><br><span class="line">      pods: &quot;10&quot;</span><br><span class="line">    scopeSelector:</span><br><span class="line">      matchExpressions:</span><br><span class="line">      - operator : In</span><br><span class="line">        scopeName: PriorityClass</span><br><span class="line">        values: [&quot;medium&quot;]</span><br><span class="line">- apiVersion: v1</span><br><span class="line">  kind: ResourceQuota</span><br><span class="line">  metadata:</span><br><span class="line">    name: pods-low</span><br><span class="line">  spec:</span><br><span class="line">    hard:</span><br><span class="line">      cpu: &quot;5&quot;</span><br><span class="line">      memory: 10Gi</span><br><span class="line">      pods: &quot;10&quot;</span><br><span class="line">    scopeSelector:</span><br><span class="line">      matchExpressions:</span><br><span class="line">      - operator : In</span><br><span class="line">        scopeName: PriorityClass</span><br><span class="line">        values: [&quot;low&quot;]</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: high-priority</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: high-priority</span><br><span class="line">    image: ubuntu</span><br><span class="line">    command: [&quot;/bin/sh&quot;]</span><br><span class="line">    args: [&quot;-c&quot;, &quot;while true; do echo hello; sleep 10;done&quot;]</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: &quot;10Gi&quot;</span><br><span class="line">        cpu: &quot;500m&quot;</span><br><span class="line">      limits:</span><br><span class="line">        memory: &quot;10Gi&quot;</span><br><span class="line">        cpu: &quot;500m&quot;</span><br><span class="line">  priorityClassName: high # priorityClassName 指的是什么，就优先使用这个优先级的配额约束。</span><br></pre></td></tr></table></figure><h2 id="LimitRange（限制范围）"><a href="#LimitRange（限制范围）" class="headerlink" title="LimitRange（限制范围）"></a>LimitRange（限制范围）</h2><ul><li><p>默认情况下， Kubernetes 集群上的容器运行使用的<a href="https://kubernetes.io/zh/docs/concepts/configuration/manage-resources-containers/">计算资源</a>没有限制。 </p></li><li><p>使用资源配额，集群管理员可以以<a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/namespaces/">名字空间</a>为单位，限制其资源的使用与创建。 </p></li><li><p>在命名空间中，一个 Pod 或 Container 最多能够使用命名空间的资源配额所定义的 CPU 和内存用量。 </p></li><li><p>有人担心，一个 Pod 或 Container 会垄断所有可用的资源。 LimitRange 是在命名空间内限制资源分配（给多个 Pod 或 Container）的策略对象，例如：资源额度 ResourceQuotas 设置为 requests.cpu 为 1 ，requests.memory 为 1Gi ，但是有人的 Pod 直接设置为 requests.cpu 为 1，requests.memory 为 1Gi，那么其他人就不能再创建 Pod 了，所以需要使用 LimitRange 对资源配额设置区间（最小和最大）。 </p></li><li><p>一个 LimitRange（限制范围） 对象提供的限制能够做到： </p></li><li><ul><li>在一个命名空间中实施对每个 Pod 或 Container 最小和最大的资源使用量的限制。</li></ul></li><li><ul><li>在一个命名空间中实施对每个 PersistentVolumeClaim 能申请的最小和最大的存储空间大小的限制。</li></ul></li><li><ul><li>在一个命名空间中实施对一种资源的申请值和限制值的比值的控制。</li></ul></li><li><ul><li>设置一个命名空间中对计算资源的默认申请&#x2F;限制值，并且自动的在运行时注入到多个 Container 中。</li></ul></li></ul><h4 id="为命名空间配置-CPU-最小和最大约束"><a href="#为命名空间配置-CPU-最小和最大约束" class="headerlink" title="为命名空间配置 CPU 最小和最大约束"></a>为命名空间配置 CPU 最小和最大约束</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: cpu-min-max-demo-lr</span><br><span class="line">  namespace: default # 限制 default 命名空间</span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - max:</span><br><span class="line">      cpu: &quot;800m&quot;</span><br><span class="line">    min:</span><br><span class="line">      cpu: &quot;200m&quot; # Pod 中的容器的 cpu 的范围是 200m~800m</span><br><span class="line">    type: Container</span><br></pre></td></tr></table></figure><h4 id="配置命名空间的最小和最大内存约束"><a href="#配置命名空间的最小和最大内存约束" class="headerlink" title="配置命名空间的最小和最大内存约束"></a>配置命名空间的最小和最大内存约束</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: mem-min-max-demo-lr</span><br><span class="line">  namespace: default # 限制 default 命名空间  </span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - max:</span><br><span class="line">      memory: 1Gi</span><br><span class="line">    min:</span><br><span class="line">      memory: 500Mi # Pod 中的容器的 memory 的范围是 500Mi~1Gi</span><br><span class="line">    type: Container</span><br></pre></td></tr></table></figure><h4 id="为命名空间配置默认的-CPU-请求和限制"><a href="#为命名空间配置默认的-CPU-请求和限制" class="headerlink" title="为命名空间配置默认的 CPU 请求和限制"></a>为命名空间配置默认的 CPU 请求和限制</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: cpu-limit-range</span><br><span class="line">  namespace: default # 限制 default 命名空间    </span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - default:</span><br><span class="line">      cpu: 1</span><br><span class="line">    defaultRequest:</span><br><span class="line">      cpu: 500m # 声明了一个默认的 CPU 请求和一个默认的 CPU 限制</span><br><span class="line">    type: Container</span><br></pre></td></tr></table></figure><h4 id="为命名空间配置默认的内存请求和限制"><a href="#为命名空间配置默认的内存请求和限制" class="headerlink" title="为命名空间配置默认的内存请求和限制"></a>为命名空间配置默认的内存请求和限制</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: mem-limit-range</span><br><span class="line">  namespace: default # 限制 default 命名空间     </span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - default:</span><br><span class="line">      memory: 512Mi</span><br><span class="line">    defaultRequest:</span><br><span class="line">      memory: 256Mi # 为命名空间配置默认的内存请求和限制</span><br><span class="line">    type: Container</span><br></pre></td></tr></table></figure><h4 id="限制存储消耗"><a href="#限制存储消耗" class="headerlink" title="限制存储消耗"></a>限制存储消耗</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: storagelimits</span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - type: PersistentVolumeClaim</span><br><span class="line">    max:</span><br><span class="line">      storage: 2Gi</span><br><span class="line">    min:</span><br><span class="line">      storage: 1Gi</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ResourceQuota</span><br><span class="line">metadata:</span><br><span class="line">  name: storagequota</span><br><span class="line">spec:</span><br><span class="line">  hard:</span><br><span class="line">    persistentvolumeclaims: &quot;5&quot; # 限制 PVC 数目和累计存储容量</span><br><span class="line">    requests.storage: &quot;5Gi&quot;</span><br></pre></td></tr></table></figure><h2 id="调度原理-1"><a href="#调度原理-1" class="headerlink" title="调度原理"></a>调度原理</h2><ul><li><p>在默认情况下，一个 Pod 在哪个 Node 节点上运行，是由 Scheduler 组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足需求，因为很多情况下，我们想控制某些 Pod 到达某些节点上，那么应该怎么做？这就要求了解 Kubernetes 对 Pod 的调度规则，Kubernetes 提供了四大类调度方式： </p></li><li><ul><li>自动调度（默认）：运行在哪个 Node 节点上完全由 Scheduler 经过一系列的算法计算得出。</li></ul></li><li><ul><li>定向调度：NodeName、NodeSelector。</li></ul></li><li><ul><li>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity。</li></ul></li><li><ul><li>污点（容忍）调度：Taints、Toleration。</li></ul></li></ul><h3 id="定向调度"><a href="#定向调度" class="headerlink" title="定向调度"></a>定向调度</h3><ul><li>定向调度，指的是利用在 Pod 上声明的 nodeName 或 nodeSelector ，以此将 Pod 调度到期望的 Node 节点上。</li></ul><p><strong>注意：这里的调度是强制的，这就意味着即使要调度的目标 Node 不存在，也会向上面进行调度，只不过 Pod 运行失败而已。</strong></p><h4 id="nodeName（不建议）"><a href="#nodeName（不建议）" class="headerlink" title="nodeName（不建议）"></a>nodeName（不建议）</h4><ul><li><p><code>nodeName</code> 是节点选择约束的最简单方法，但是由于其自身限制，通常不使用它。 <code>nodeName</code> 是 PodSpec 的一个字段。 如果它不为空，调度器将忽略 Pod，并且给定节点上运行的 kubelet 进程尝试执行该 Pod。 因此，如果 <code>nodeName</code> 在 Pod 的 Spec 中指定了，则它优先于 nodeSelector 。 </p></li><li><p>使用 <code>nodeName</code> 来选择节点的一些限制： </p></li><li><ul><li>如果指定的节点不存在，</li></ul></li><li><ul><li>如果指定的节点没有资源来容纳 Pod，Pod 将会调度失败并且其原因将显示为， 比如 OutOfmemory 或 OutOfcpu。</li></ul></li><li><ul><li>云环境中的节点名称并非总是可预测或稳定的。</li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  nodeName: k8s-node1 # 指定调度到k8s-node1节点上</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure><h4 id="nodeSelector"><a href="#nodeSelector" class="headerlink" title="nodeSelector"></a>nodeSelector</h4><p>●nodeSelector 是节点选择约束的最简单推荐形式。nodeSelector 是 PodSpec 的一个字段。 它包含键值对的映射。为了使 pod 可以在某个节点上运行，该节点的标签中 必须包含这里的每个键值对（它也可以具有其他标签）。 最常见的用法的是一对键值对。</p><p>●除了自己 <a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/assign-pod-node/#step-one-attach-label-to-the-node">添加</a> 的标签外，节点还预制了一组标准标签。 参见这些<a href="https://kubernetes.io/zh/docs/reference/labels-annotations-taints/">常用的标签，注解以及污点</a>： </p><p>○<a href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#kubernetes-io-hostname">kubernetes.io&#x2F;hostname</a></p><p>○<a href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#failure-domainbetakubernetesiozone">failure-domain.beta.kubernetes.io&#x2F;zone</a></p><p>○<a href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#failure-domainbetakubernetesioregion">failure-domain.beta.kubernetes.io&#x2F;region</a></p><p>○<a href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#topologykubernetesiozone">topology.kubernetes.io&#x2F;zone</a></p><p>○<a href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#topologykubernetesiozone">topology.kubernetes.io&#x2F;region</a></p><p>○<a href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#beta-kubernetes-io-instance-type">beta.kubernetes.io&#x2F;instance-type</a></p><p>○<a href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#nodekubernetesioinstance-type">node.kubernetes.io&#x2F;instance-type</a></p><p>○<a href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#kubernetes-io-os">kubernetes.io&#x2F;os</a></p><p>○<a href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#kubernetes-io-arch">kubernetes.io&#x2F;arch</a></p><p>注意：这些标签的值是特定于云供应商的，因此不能保证可靠。 例如，kubernetes.io&#x2F;hostname 的值在某些环境中可能与节点名称相同， 但在其他环境中可能是一个不同的值。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 给 k8s-node2 打上标签</span><br><span class="line">kubectl label node k8s-node2 nodeevn=pro</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  nodeSelector:</span><br><span class="line">    nodeevn: pro # 指定调度到 nodeevn = pro 标签的 Node 节点上</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure><h3 id="亲和性调度"><a href="#亲和性调度" class="headerlink" title="亲和性调度"></a>亲和性调度</h3><ul><li><p>虽然定向调度的两种方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的 Node，那么 Pod 将不会被运行，即使在集群中还有可用的 Node 列表也不行，这就限制了它的使用场景。 </p></li><li><p>基于上面的问题，Kubernetes 还提供了一种亲和性调度（Affinity）。它在 nodeSelector 的基础之上进行了扩展，可以通过配置的形式，实现优先选择满足条件的 Node 进行调度，如果没有，也可以调度到不满足条件的节点上，使得调度更加灵活。 </p></li><li><p><strong>Affinity 主要分为三类：</strong> </p></li><li><ul><li><strong>nodeAffinity（node亲和性）：以 Node 为目标，解决 Pod可 以调度到那些 Node 的问题。</strong></li></ul></li><li><ul><li><strong>podAffinity（pod亲和性）：以 Pod 为目标，解决 Pod 可以和那些已存在的 Pod 部署在同一个拓扑域中的问题。</strong></li></ul></li><li><ul><li><strong>podAntiAffinity（pod反亲和性）：以 Pod 为目标，解决 Pod 不能和那些已经存在的 Pod 部署在同一拓扑域中的问题。</strong></li></ul></li></ul><p><strong>关于亲和性和反亲和性的使用场景的说明：</strong></p><ul><li><p>亲和性：如果两个应用频繁交互，那么就有必要利用亲和性让两个应用尽可能的靠近，这样可以较少因网络通信而带来的性能损耗。 </p></li><li><p>反亲和性：当应用采用多副本部署的时候，那么就有必要利用反亲和性让各个应用实例打散分布在各个 Node 上，这样可以提高服务的高可用性。</p></li></ul><h4 id="nodeAffinity"><a href="#nodeAffinity" class="headerlink" title="nodeAffinity"></a>nodeAffinity</h4><ul><li><p>nodeAffinity 概念上类似于 <code>nodeSelector</code>，它使你可以根据节点上的标签来约束 Pod 可以调度到哪些节点。 </p></li><li><p>和 nodeSelector 的区别： </p></li><li><ul><li>引入了运算符：In、NotIn、Exists、DoesNotExist、 Gt、 Lt。</li></ul></li><li><ul><li>支持 <code>硬性过滤</code> 和 <code>软性评分</code> ：</li></ul></li><li><ul><li><ul><li>硬件过滤支持指定<code>多条件之间的逻辑或运算</code>；</li></ul></li></ul></li><li><ul><li><ul><li>软件评分规则支持<code>设置条件权重</code>。</li></ul></li></ul></li><li><p><strong>nodeAffinity 的可选配置项：</strong></p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pod.spec.affinity.nodeAffinity</span><br><span class="line">  requiredDuringSchedulingIgnoredDuringExecution  # Node节点必须满足指定的所有规则才可以，硬性过滤</span><br><span class="line">    nodeSelectorTerms  # 节点选择列表</span><br><span class="line">      matchFields   # 按节点字段列出的节点选择器要求列表  </span><br><span class="line">      matchExpressions   # 按节点标签列出的节点选择器要求列表(推荐)</span><br><span class="line">        key    # 键</span><br><span class="line">        values # 值</span><br><span class="line">        operator # 关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt</span><br><span class="line">  preferredDuringSchedulingIgnoredDuringExecution # 优先调度到满足指定的规则的Node，软性评分 (倾向)   </span><br><span class="line">    preference   # 一个节点选择器项，与相应的权重相关联</span><br><span class="line">      matchFields # 按节点字段列出的节点选择器要求列表</span><br><span class="line">      matchExpressions   # 按节点标签列出的节点选择器要求列表(推荐)</span><br><span class="line">        key # 键</span><br><span class="line">        values # 值</span><br><span class="line">        operator # 关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt  </span><br><span class="line">    weight # 倾向权重，在范围1-100。</span><br></pre></td></tr></table></figure><p><em>注意：</em><br><em>●如果我们修改或删除 Pod 调度到节点的标签，Pod 不会被删除；换言之，亲和调度只是在 Pod 调度期间有效。</em><br><em>●如果同时定义了 nodeSelector 和 nodeAffinity ，那么必须两个条件都满足，Pod 才能运行在指定的 Node 上。</em><br><em>●如果 nodeAffinity 指定了多个 nodeSelectorTerms ，那么只需要其中一个能够匹配成功即可。</em><br><em>●如果一个 nodeSelectorTerms 中有多个 matchExpressions ，则一个节点必须满足所有的才能匹配成功。</em></p><p><strong>硬性过滤</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 给 k8s-node1 和 k8s-nodes 打上标签</span><br><span class="line">kubectl label node k8s-node1 disktype=ssd</span><br><span class="line">kubectl label node k8s-node2 disktype=hdd</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  affinity: </span><br><span class="line">    nodeAffinity:</span><br><span class="line">      # DuringScheduling（调度期间有效）IgnoredDuringExecution（执行期间忽略，执行期间：Pod 运行期间）</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution: # 硬性过滤：Node 节点必须满足指定的所有规则才可以</span><br><span class="line">        nodeSelectorTerms:</span><br><span class="line">          - matchExpressions: # 所有 matchExpressions 满足条件才行</span><br><span class="line">            - key: disktype</span><br><span class="line">              operator: In # 支持 Exists, DoesNotExist, In, NotIn, Gt, Lt</span><br><span class="line">              values: </span><br><span class="line">                - ssd      </span><br><span class="line">                - hdd</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure><p><strong>软性评分</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 给 k8s-node1 和 k8s-nodes 打上标签</span><br><span class="line"></span><br><span class="line">kubectl label node k8s-node1 disk=50 gpu=1000</span><br><span class="line">kubectl label node k8s-node2 disk=30 gpu=5000</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line"></span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line"></span><br><span class="line">    - containerPort: 80</span><br><span class="line">      name:  http</span><br><span class="line">      volumeMounts:</span><br><span class="line"></span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">      volumes:</span><br><span class="line"></span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">      affinity: </span><br><span class="line">      nodeAffinity:</span><br><span class="line"></span><br><span class="line">      # DuringScheduling（调度期间有效）IgnoredDuringExecution（执行期间忽略，执行期间：Pod 运行期间）</span><br><span class="line"></span><br><span class="line">      preferredDuringSchedulingIgnoredDuringExecution: # 软性评分：优先调度到满足指定的规则的 Node</span><br><span class="line"></span><br><span class="line">        - weight: 90 # 权重</span><br><span class="line">          preference: # 一个节点选择器项，与相应的权重相关联</span><br><span class="line">            matchExpressions:</span><br><span class="line">              - key: disk</span><br><span class="line">                operator: Gt</span><br><span class="line">                values: </span><br><span class="line">                 - &quot;40&quot;</span><br><span class="line">        - weight: 10 # 权重</span><br><span class="line">          preference: # 一个节点选择器项，与相应的权重相关联</span><br><span class="line">            matchExpressions:</span><br><span class="line">             - key: gpu</span><br><span class="line">               operator: Gt</span><br><span class="line">               values: </span><br><span class="line">                - &quot;4000&quot;        </span><br><span class="line">                  restartPolicy: Always</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="podAffinity-和-podAntiAffinity"><a href="#podAffinity-和-podAntiAffinity" class="headerlink" title="podAffinity 和 podAntiAffinity"></a>podAffinity 和 podAntiAffinity</h4><ul><li><p>podAffinity 主要实现以运行的 Pod 为参照，实现让新创建的 Pod 和参照的 Pod 在一个区域的功能。 </p></li><li><p>podAntiAffinity 主要实现以运行的 Pod 为参照，让新创建的 Pod 和参照的 Pod 不在一个区域的功能。 </p></li><li><p>PodAffinity 的可选配置项：</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pod.spec.affinity.podAffinity</span><br><span class="line">  requiredDuringSchedulingIgnoredDuringExecution  硬限制</span><br><span class="line">    namespaces 指定参照pod的namespace</span><br><span class="line">    topologyKey 指定调度作用域</span><br><span class="line">    labelSelector 标签选择器</span><br><span class="line">      matchExpressions  按节点标签列出的节点选择器要求列表(推荐)</span><br><span class="line">        key    键</span><br><span class="line">        values 值</span><br><span class="line">        operator 关系符 支持In, NotIn, Exists, DoesNotExist.</span><br><span class="line">      matchLabels    指多个matchExpressions映射的内容  </span><br><span class="line">  preferredDuringSchedulingIgnoredDuringExecution 软限制    </span><br><span class="line">    podAffinityTerm  选项</span><br><span class="line">      namespaces</span><br><span class="line">      topologyKey</span><br><span class="line">      labelSelector</span><br><span class="line">         matchExpressions </span><br><span class="line">            key    键  </span><br><span class="line">            values 值  </span><br><span class="line">            operator</span><br><span class="line">         matchLabels </span><br><span class="line">    weight 倾向权重，在范围1-1</span><br></pre></td></tr></table></figure><p>注意：topologyKey 用于指定调度的作用域，例如:</p><ul><li><p>如果指定为 kubernetes.io&#x2F;hostname（可以通过 kubectl get node –show-labels 查看），那就是以 Node 节点为区分范围。 </p></li><li><p>如果指定为 kubernetes.io&#x2F;os，则以 Node 节点的操作系统类型来区分。</p></li></ul><p><strong>示例：在一个两节点的集群中，部署一个使用 redis 的 WEB 应用程序，并期望 web-server 尽可能和 redis 在同一个节点上。</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: redis-deploy</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: store</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: store</span><br><span class="line">    spec:</span><br><span class="line">      affinity: # 亲和性配置</span><br><span class="line">        podAntiAffinity: # Pod 反亲和性，符合以下指定条件不会被调度过去</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution: # 硬限制</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions: </span><br><span class="line">                  - key: app</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - store</span><br><span class="line">              topologyKey: kubernetes.io/hostname # 拓扑键，划分逻辑区域。 </span><br><span class="line">              # node 节点以 kubernetes.io/hostname 为拓扑网络，如果 kubernetes.io/hostname 相同，就认为是同一个东西。</span><br><span class="line">              # 亲和就是都放在这个逻辑区域，反亲和就是必须避免放在同一个逻辑区域。</span><br><span class="line">      containers:</span><br><span class="line">      - name: redis-server</span><br><span class="line">        image: redis:5.0.14-alpine</span><br><span class="line">        resources:</span><br><span class="line">           limits:</span><br><span class="line">             memory: 500Mi</span><br><span class="line">             cpu: 1</span><br><span class="line">           requests:</span><br><span class="line">             memory: 250Mi</span><br><span class="line">             cpu: 500m</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 2375</span><br><span class="line">          name: redis</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: localtime</span><br><span class="line">          mountPath: /etc/localtime</span><br><span class="line">      volumes:</span><br><span class="line">        - name: localtime</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name:  nginx-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app:  nginx-deploy</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: web-store</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: web-store</span><br><span class="line">    spec:</span><br><span class="line">      affinity: # 亲和性配置</span><br><span class="line">        podAffinity: # Pod 亲和性，符合以下指定条件会被调度过去</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution: # 硬限制</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions: </span><br><span class="line">                  - key: app</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - store</span><br><span class="line">              topologyKey: kubernetes.io/hostname # 拓扑键，划分逻辑区域。 </span><br><span class="line">              # node 节点以 kubernetes.io/hostname 为拓扑网络，如果 kubernetes.io/hostname 相同，就认为是同一个东西。</span><br><span class="line">              # 亲和就是都放在这个逻辑区域，反亲和就是必须避免放在同一个逻辑区域。</span><br><span class="line">        podAntiAffinity: # Pod 反亲和性，符合以下指定条件不会被调度过去</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution: # 硬限制</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions: </span><br><span class="line">                  - key: app</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - web-store</span><br><span class="line">              topologyKey: kubernetes.io/hostname # 拓扑键，划分逻辑区域。 </span><br><span class="line">              # node 节点以 kubernetes.io/hostname 为拓扑网络，如果 kubernetes.io/hostname 相同，就认为是同一个东西。</span><br><span class="line">              # 亲和就是都放在这个逻辑区域，反亲和就是必须避免放在同一个逻辑区域。              </span><br><span class="line">      containers:</span><br><span class="line">      - name:  nginx</span><br><span class="line">        image:  nginx:1.20.2</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 200m</span><br><span class="line">            memory: 500Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort:  80</span><br><span class="line">          name:  nginx</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: localtime</span><br><span class="line">          mountPath: /etc/localtime</span><br><span class="line">      volumes:</span><br><span class="line">        - name: localtime</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">      restartPolicy: Always</span><br></pre></td></tr></table></figure><h2 id="污点和容忍调度"><a href="#污点和容忍调度" class="headerlink" title="污点和容忍调度"></a>污点和容忍调度</h2><h3 id="污点"><a href="#污点" class="headerlink" title="污点"></a>污点</h3><ul><li><p>面的调度方式都是站在 Pod 的角度上，通过在 Pod 上添加属性，来确定 Pod 是否要调度到指定的 Node 上，其实我们也可以站在 Node 的角度上，通过在 Node 上添加<code>污点属性</code>，来决定是否运行 Pod 调度过来。</p></li><li><p>Node 被设置了污点之后就和 Pod 之间存在了一种相斥的关系，进而拒绝 Pod 调度进来，甚至可以将已经存在的 Pod 驱逐出去。</p></li><li><p>污点的格式为：</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">key=value:effect</span><br><span class="line"># key 和 value 是污点的标签及对应的值</span><br><span class="line"># effect 描述污点的作用</span><br></pre></td></tr></table></figure><ul><li><p>effect 支持如下的三个选项： </p></li><li><ul><li>PreferNoSchedule：Kubernetes 将尽量避免把 Pod 调度到具有该污点的 Node 上，除非没有其他节点可以调度；换言之，尽量不要来，除非没办法。</li></ul></li><li><ul><li>NoSchedule：Kubernets 将不会把 Pod 调度到具有该污点的 Node 上，但是不会影响当前 Node 上已经存在的 Pod ;换言之，新的不要来，在这的就不要动。</li></ul></li><li><ul><li>NoExecute：Kubernets 将不会将 Pod 调度到具有该污点的 Node 上，同时会将 Node 上已经存在的 Pod 驱逐；换言之，新的不要来，这这里的赶紧走。</li></ul></li></ul><p><strong>注意：NoExecute 一般用于实际生产环境中的 Node 节点的上下线。</strong></p><p><strong>设置污点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node xxx key=value:effect</span><br></pre></td></tr></table></figure><p><strong>去除污点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node xxx key:effect-</span><br></pre></td></tr></table></figure><p><strong>去除所有污点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node xxx key-</span><br></pre></td></tr></table></figure><p><strong>查看污点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe node xxx | grep -i taints</span><br></pre></td></tr></table></figure><ul><li><strong>证明：kubeadm 安装的集群上 k8s-master 有污点</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe node k8s-master | grep -i taints</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2022/png/513185/1648692456349-9a4ca09a-e5c4-4473-af6a-8c3a298accfe.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_34,text_6K645aSn5LuZ,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="6.png"></p><ul><li><p>示例：演示污点效果（为了演示效果更为明显，暂时停止 k8s-node2 节点）</p></li><li><p>① 为 k8s-node1 设置污点<code>tag=xudaxian:PreferNoSchedule</code>，然后创建 Pod1 （Pod1 可以运行）</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-node1 tag=xudaxian:PreferNoSchedule</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run pod1 --image=nginx:1.20.2</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2022/gif/513185/1648692464879-6e01bead-ed97-46be-93ef-6cc2cf5c524d.gif" alt="img"></p><ul><li>② 修改 k8s-node1 节点的污点为 <code>tag=xudaxian:NoSchedule</code>，然后创建Pod2（Pod1 可以正常运行，Pod2 失败）。</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取消污点</span></span><br><span class="line">kubectl taint node k8s-node1 tag:PreferNoSchedule-</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置污点</span></span><br><span class="line">kubectl taint node k8s-node1 tag=xudaxian:NoSchedule</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run pod2 --image=nginx:1.20.2</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2022/gif/513185/1648692471659-c922a543-2a3e-47cb-9ded-f1a5a0e05a1d.gif" alt="img"></p><ul><li>③ 修改 k8s-node1 节点的污点为 <code>tag=xudaxian:NoExecute</code>，然后创建 Pod3（Pod1、Pod2、Pod3失败）。</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取消污点</span></span><br><span class="line">kubectl taint node k8s-node1 tag:NoSchedule-</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置污点</span></span><br><span class="line">kubectl taint node k8s-node1 tag=xudaxian:NoExecute</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run pod3 --image=nginx:1.20.2</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2022/gif/513185/1648692476438-b3547fd6-b251-4982-905a-8e91b663ee86.gif" alt="img"></p><h3 id="容忍"><a href="#容忍" class="headerlink" title="容忍"></a>容忍</h3><p>上面介绍了污点的作用，我们可以在 Node上 添加污点用来拒绝 Pod 调度上来，但是如果就是想让一个 Pod 调度到一个有污点的 Node 上去，这时候应该怎么做？这就需要使用到容忍。</p><p><strong>污点就是拒绝，容忍就是忽略，Node 通过污点拒绝 Pod 调度上去，Pod 通过容忍忽略拒绝。</strong></p><p>●容忍的详细配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain pod.spec.tolerations</span><br><span class="line">......</span><br><span class="line">FIELDS:</span><br><span class="line">  key       # 对应着要容忍的污点的键，空意味着匹配所有的键</span><br><span class="line">  value     # 对应着要容忍的污点的值</span><br><span class="line">  operator  # key-value的运算符，支持Equal和Exists（默认）</span><br><span class="line">  effect    # 对应污点的effect，空意味着匹配所有影响</span><br><span class="line">  tolerationSeconds   # 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间</span><br></pre></td></tr></table></figure><ul><li><p>污点和容忍的匹配： </p></li><li><ul><li>当满足如下条件的时候，Kubernetes 认为污点和容忍匹配：</li></ul></li><li><ul><li><ul><li>键（key）相同。</li></ul></li></ul></li><li><ul><li><ul><li>效果（effect）相同。</li></ul></li></ul></li><li><ul><li><ul><li>污点的 operator 为：</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>Exists ，此时污点中不应该指定 value 。</li></ul></li></ul></li></ul></li><li><ul><li><ul><li><ul><li>Equal，此时容忍的 value 应该和污点的 value 相同。</li></ul></li></ul></li></ul></li><li><ul><li>如果不指定 operator ，默认为 Equal 。</li></ul></li><li><p>特殊情况：</p></li><li><ul><li><p>容忍中没有定义 key ，但是定义了 operator 为 Exists ，Kubernetes 则认为此容忍匹配所有的污点，如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tolerations:</span><br><span class="line">- operator: Exists</span><br><span class="line"># 最终，所有有污点的机器我们都能容忍，Pod 都可以调用</span><br></pre></td></tr></table></figure></li><li><p>容忍中没有定义 effect，但是定义了 key，Kubernetes 认为此容忍匹配所有 effect ，如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  tolerations: # 容忍</span><br><span class="line">    - key: &quot;tag&quot; # 要容忍的污点的key</span><br><span class="line">      operator: Exists # 操作符</span><br><span class="line"># 最终，有这个污点的机器我们可以容忍，Pod 都可以调度。</span><br></pre></td></tr></table></figure></li></ul></li></ul><p><strong>示例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 设置污点</span><br><span class="line">kubectl taint node k8s-node1 tag=xudaxian:NoExecute</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-toleration</span><br><span class="line">spec:</span><br><span class="line">  containers: # 容器配置</span><br><span class="line">    - name: nginx</span><br><span class="line">      image: nginx:1.20.2</span><br><span class="line">      imagePullPolicy: IfNotPresent</span><br><span class="line">      ports:</span><br><span class="line">        - name: nginx-port</span><br><span class="line">          containerPort: 80</span><br><span class="line">          protocol: TCP</span><br><span class="line">  tolerations: # 容忍</span><br><span class="line">    - key: &quot;tag&quot; # 要容忍的污点的key</span><br><span class="line">      operator: Equal # 操作符</span><br><span class="line">      value: &quot;xudaxian&quot; # 要容忍的污点的value</span><br><span class="line">      effect: NoExecute # 添加容忍的规则，这里必须和标记的污点规则相同</span><br></pre></td></tr></table></figure><h1 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h1><h2 id="访问控制概述"><a href="#访问控制概述" class="headerlink" title="访问控制概述"></a>访问控制概述</h2><ul><li>用户使用 <code>kubectl</code>、客户端库或构造 REST 请求来访问 <a href="https://kubernetes.io/zh/docs/concepts/overview/kubernetes-api/">Kubernetes API</a>。 人类用户和 <a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-service-account/">Kubernetes 服务账户</a>都可以被鉴权访问 API。 当请求到达 API 时，它会经历多个阶段，如下图所示：</li></ul><p>![](C:\Users\32625\OneDrive\图片\k8s\1 (1).png)</p><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><ul><li><p>在 Kubernetes 集群中，客户端通常由两类： </p></li><li><ul><li>① User Account：一般是独立于 Kubernetes 之外的其他服务管理的用户账号。</li></ul></li><li><ul><li>② Service Account：Kubernetes 管理的账号，用于为Pod的服务进程在访问 Kubernetes 时提供身份标识。</li></ul></li></ul><h3 id="认证、授权和准入控制"><a href="#认证、授权和准入控制" class="headerlink" title="认证、授权和准入控制"></a>认证、授权和准入控制</h3><ul><li><p>api-server 是访问和管理资源对象的唯一入口。任何一个请求访问 api-server，都要经过下面的三个流程： </p></li><li><ul><li>① Authentication（认证）：身份鉴别，只有正确的账号才能通过认证。</li></ul></li><li><ul><li>② Authorization（授权）：判断用户是否有权限对访问的资源执行特定的动作。</li></ul></li><li><ul><li>③ Admission Control（准入控制）：用于补充授权机制以实现更加精细的访问控制功能。</li></ul></li></ul><h3 id="权限流程控制"><a href="#权限流程控制" class="headerlink" title="权限流程控制"></a>权限流程控制</h3><ul><li><p>用户携带令牌或者证书给 Kubernetes 的 api-server 发送请求，要求修改集群资源。</p></li><li><p>Kubernetes 开始认证。</p></li><li><p>Kubernetes 认证通过之后，会查询用户的授权（有哪些权限）。</p></li><li><p>用户执行操作的过程中（操作 CPU、内存、硬盘、网络……），利用准入控制来判断是否可以执行这样的操作。</p></li></ul><h2 id="认证管理"><a href="#认证管理" class="headerlink" title="认证管理"></a>认证管理</h2><h3 id="k8s的客户端认证方式"><a href="#k8s的客户端认证方式" class="headerlink" title="k8s的客户端认证方式"></a>k8s的客户端认证方式</h3><ul><li><p>Kubernetes 集群安全的关键点在于如何识别并认证客户端身份，它提供了 3 种客户端身份认证方式：</p></li><li><p><strong>① HTTP Base 认证：</strong> </p></li><li><ul><li>通过 <code>用户名+密码</code> 的方式进行认证。</li></ul></li><li><ul><li>这种方式是把 <code>用户名:密码</code> 用 BASE64 算法进行编码后的字符串放在 HTTP 请求中的 Header 的 Authorization 域里面发送给服务端。服务端收到后进行解码，获取用户名和密码，然后进行用户身份认证的过程。</li></ul></li><li><p><strong>② HTTP Token 认证：</strong> </p></li><li><ul><li>通过一个 Token 来识别合法用户。</li></ul></li><li><ul><li>这种认证方式是用一个很长的难以被模仿的字符串–Token 来表明客户端身份的一种方式。每个 Token 对应一个用户名，当客户端发起 API 调用请求的时候，需要在 HTTP 的 Header 中放入 Token，API Server 接受到 Token 后会和服务器中保存的 Token 进行比对，然后进行用户身份认证的过程。</li></ul></li><li><p><strong>③ HTTPS 证书认证：</strong> </p></li><li><ul><li>基于 CA 根证书签名的双向数字证书认证方式。</li></ul></li><li><ul><li>这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式。</li></ul></li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>Kubernetes 允许同时配置多种认证方式，只要其中任意一种方式认证通过即可。</strong></p><h2 id="授权管理"><a href="#授权管理" class="headerlink" title="授权管理"></a>授权管理</h2><ul><li><p>授权发生在认证成功之后，通过认证就可以知道请求用户是谁，然后 Kubernetes 会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权。</p></li><li><p>每个发送到 API Server 的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</p></li></ul><h3 id="API-Server目前支持的几种授权策略"><a href="#API-Server目前支持的几种授权策略" class="headerlink" title="API Server目前支持的几种授权策略"></a>API Server目前支持的几种授权策略</h3><ul><li><p><strong>AlwaysDeny</strong>：表示拒绝所有请求，一般用于测试。 </p></li><li><p><strong>AlwaysAllow</strong>：允许接收所有的请求，相当于集群不需要授权流程（Kubernetes 默认的策略）。 </p></li><li><p><strong>ABAC</strong>：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制。 </p></li><li><p><strong>Webhook</strong>：通过调用外部REST服务对用户进行授权。 </p></li><li><p><strong>Node</strong>：是一种专用模式，用于对 kubelet 发出的请求进行访问控制。 </p></li><li><p><strong>RBAC</strong>：基于角色的访问控制（ kubeadm 安装方式下的默认选项）。</p></li></ul><p><strong>证明：kubeadm 安装方式的默认授权策略</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep -i rbac</span><br></pre></td></tr></table></figure><p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-07 125451.png)</p><h3 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h3><ul><li><p><strong>RBAC（Role Based Access Control）：基于角色的访问控制，主要是在描述一件事情：给哪些对象授权了哪些权限。</strong></p></li><li><p><strong>RBAC 模型：</strong></p></li></ul><p>![](C:\Users\32625\OneDrive\图片\k8s\3 (1).png)</p><ul><li><p>Kubernetes 中的 RBAC 也是基于 RBAC 模型扩展的，涉及到如下的概念： </p></li><li><ul><li>对象：User、Group、ServiceAccount。</li></ul></li><li><ul><li>角色：代表一组定义在资源上的可操作的动作（权限）的集合。</li></ul></li><li><ul><li>绑定：将定义好的角色和用户绑定在一起，也可以理解为分配角色。</li></ul></li></ul><p><img src="C:\Users\32625\OneDrive\图片\k8s\4.png"></p><ul><li><p>RBAC 引入了 4 个顶级资源对象： </p></li><li><ul><li>Role：角色，用于指定一组权限，限定名称空间下的权限。</li></ul></li><li><ul><li>ClusterRole：集群角色，用于指定一组权限，限定集群范围下的权限。</li></ul></li><li><ul><li>RoleBinding：角色绑定，用于将角色 Role（权限的集合）赋予给对象（User、Group、ServiceAccount）。</li></ul></li><li><ul><li>ClusterRoleBinding：集群角色绑定，用于将集群角色 Role（权限的集合）赋予给对象（User、Group、ServiceAccount）。</li></ul></li></ul><p><strong>说明：为什么 Kubernetes 要设计 Role 、 ClusterRole ？</strong></p><p><strong>答：</strong>有些资源对象本身就不是 namespace（名称空间）的 ，所以 Kubernetes 增加了 ClusterRole，并且 ClusterRole 也可以管理名称空间下的资源对象。</p><h4 id="Role-和-ClusterRole资源清单文件"><a href="#Role-和-ClusterRole资源清单文件" class="headerlink" title="Role 和 ClusterRole资源清单文件"></a>Role 和 ClusterRole资源清单文件</h4><p>● 一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）。<br>● Role 的资源清单文件： </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 名称空间角色</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-role</span><br><span class="line">  namespace: default # 所属的名称空间</span><br><span class="line">rules: # 当前角色的规则</span><br><span class="line">- apiGroups: [&quot;&quot;] # &quot;&quot; 标明 core API 组，默认留空即可。</span><br><span class="line">  resources: [&quot;pods&quot;] </span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span><br></pre></td></tr></table></figure><ul><li><p>Role  只能对名称空间（namespace）进行授权，所以需要指定名称空间（namespace）。 </p></li><li><p>rules 中的参数说明： </p></li><li><ul><li>apiGroups：<code>[&quot;&quot;]</code>，默认留空即可。</li></ul></li><li><ul><li>resources：支持的资源对象列表，通过 <code>kubectl api-resources</code> 查看</li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl api-resources </span><br></pre></td></tr></table></figure><p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-07 132153.png)</p><ul><li><ul><li>verbs：对资源对象的操作方法列表，通过 <code>kubectl api-resources -o wide</code> 查看。</li></ul></li></ul><p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-07 132407.png)</p><p><strong>ClusterRole 的资源清单文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 集群角色</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-clusterrole</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;] # &quot;&quot; 标明 core API 组，默认留空即可。</span><br><span class="line">  resources: [&quot;namespaces&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  # 注意：ClusterRole  不需要设置 namespace。</span><br></pre></td></tr></table></figure><h4 id="RoleBinding-和-ClusterRoleBinding-资源清单文件"><a href="#RoleBinding-和-ClusterRoleBinding-资源清单文件" class="headerlink" title="RoleBinding 和 ClusterRoleBinding 资源清单文件"></a>RoleBinding 和 ClusterRoleBinding 资源清单文件</h4><ul><li>角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是 User、Group 或者 ServiceAccount 。</li></ul><h5 id="RoleBinding-资源清单文件："><a href="#RoleBinding-资源清单文件：" class="headerlink" title="RoleBinding  资源清单文件："></a>RoleBinding  资源清单文件：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 账号和角色绑定</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-rolebinding</span><br><span class="line">  namespace: default</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: xudaxian # &quot;name&quot; 是区分大小写的</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role</span><br><span class="line">  name: xudaxian-role</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure><h5 id="ClusterRoleBinding-资源清单文件："><a href="#ClusterRoleBinding-资源清单文件：" class="headerlink" title="ClusterRoleBinding 资源清单文件："></a>ClusterRoleBinding 资源清单文件：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 账号和集群角色绑定</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-clusterrolebinding</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: xudaxian # &quot;name&quot; 是区分大小写的</span><br><span class="line">  namespace: default # 如果资源是某个 namespace 下的，那么就需要设置 namespace</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: xudaxian-clusterrole</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure><h4 id="实战（RBAC）"><a href="#实战（RBAC）" class="headerlink" title="实战（RBAC）"></a>实战（RBAC）</h4><p><strong>创建 ServiceAccount 的时候，系统会在底层默认一个含 ServiceAccount 名称的 Secret 。</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"># 名称空间角色</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-role</span><br><span class="line">  namespace: default # 所属的名称空间</span><br><span class="line">rules: # 当前角色的规则</span><br><span class="line">- apiGroups: [&quot;&quot;] # &quot;&quot; 标明 core API 组，默认留空即可。</span><br><span class="line">  resources: [&quot;pods&quot;] # 指定能操作的资源 ，通过 kubectl api-resources 查看即可。</span><br><span class="line">  # resourceNames: [&quot;&quot;] #  指定只能操作某个名字的资源</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;] # 操作动作，通过 kubectl api-resources -o wide 查看即可。 </span><br><span class="line">---</span><br><span class="line"># 集群角色</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-clusterrole</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;] # &quot;&quot; 标明 core API 组，默认留空即可。</span><br><span class="line">  resources: [&quot;namespaces&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span><br><span class="line">---</span><br><span class="line"># ServiceAccount</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian # ServiceAccount 的名称</span><br><span class="line">  namespace: default</span><br><span class="line">---</span><br><span class="line"># 账号和角色绑定</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-rolebinding</span><br><span class="line">  namespace: default</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: xudaxian # &quot;name&quot; 是区分大小写的</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role</span><br><span class="line">  name: xudaxian-role</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span><br><span class="line"># 账号和集群角色绑定</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-clusterrolebinding</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: xudaxian # &quot;name&quot; 是区分大小写的</span><br><span class="line">  namespace: default # 如果资源是某个 namespace 下的，那么就需要设置 namespace</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: xudaxian-clusterrole</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure><p><strong>温馨提示：</strong></p><ul><li><p><strong>① 动态供应（NFS）、DashBoard 等底层都使用了 Role、ClusterRole、RoleBinding、ClusterRoleBinding 。</strong></p></li><li><p><strong>② 我们可以创建一个 ServiceAccount ，并将自定义的 ServiceAccount 绑定 cluster-admin （ClusterRole，Kubernetes 底层提供的），然后通过暴露的 <a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/access-cluster-api/">API</a> 进行 Kubernetes 管理平台的开发（如：Kubersphere 等）。</strong></p></li></ul><h2 id="准入控制"><a href="#准入控制" class="headerlink" title="准入控制"></a>准入控制</h2><ul><li><p>通过了前面的认证和授权之后，还需要经过准入控制通过之后，API Server 才会处理这个请求。</p></li><li><p>准入控制是一个可配置的控制器列表，可以通过在 API Server 上通过命令行设置选择执行哪些注入控制器。</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds</span><br></pre></td></tr></table></figure><ul><li>只有当所有的注入控制器都检查通过之后，API Server 才会执行该请求，否则返回拒绝。</li></ul><h3 id="当前可配置的-Admission-Control"><a href="#当前可配置的-Admission-Control" class="headerlink" title="当前可配置的 Admission Control"></a>当前可配置的 Admission Control</h3><ul><li><p><strong>AlwaysAdmit：允许所有请求。</strong> </p></li><li><p><strong>AlwaysDeny：禁止所有请求，一般用于测试。</strong> </p></li><li><p><strong>AlwaysPullImages：在启动容器之前总去下载镜像。</strong> </p></li><li><p><strong>DenyExecOnPrivileged：它会拦截所有想在 Privileged Container 上执行命令的请求。</strong> </p></li><li><p><strong>ImagePolicyWebhook：这个插件将允许后端的一个 Webhook 程序来完成 admission control 的功能。</strong> </p></li><li><p><strong>Service Account：实现 ServiceAccount 实现了自动化。</strong> </p></li><li><p><strong>SecurityContextDeny：这个插件将使用 SecurityContext 的 Pod 中的定义全部失效。</strong> </p></li><li><p><strong>ResourceQuota：用于资源配额管理目的，观察所有请求，确保在 namespace 上的配额不会超标。</strong> </p></li><li><p><strong>LimitRanger：用于资源限制管理，作用于 namespace 上，确保对 Pod 进行资源限制。</strong> </p></li><li><p><strong>InitialResources：为未设置资源请求与限制的 Pod，根据其镜像的历史资源的使用情况进行设置。</strong> </p></li><li><p><strong>NamespaceLifecycle：如果尝试在一个不存在的 namespace 中创建资源对象，则该创建请求将被拒绝。当删除一个 namespace 时，系统将会删除该 namespace 中所有对象。</strong> </p></li><li><p><strong>DefaultStorageClass：为了实现共享存储的动态供应，为未指定 StorageClass 或 PV 的 PVC 尝试匹配默认 StorageClass，尽可能减少用户在申请 PVC 时所需了解的后端存储细节。</strong> </p></li><li><p><strong>DefaultTolerationSeconds：这个插件为那些没有设置 forgiveness tolerations 并具有 notready:NoExecute 和 unreachable:NoExecute 两种taints的Pod设置默认的<code>容忍</code>时间，为 5min 。</strong> </p></li><li><p><strong>PodSecurityPolicy：这个插件用于在创建或修改 Pod 时决定是否根据 Pod 的 security context 和可用的 PodSecurityPolicy 对 Pod 的安全策略进行控制</strong></p></li></ul>]]></content>
    
    
    <summary type="html">Kubernetes搭建</summary>
    
    
    
    <category term="教程" scheme="http://cloudsheep.xyz/category/%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="Kubernetes" scheme="http://cloudsheep.xyz/tag/Kubernetes/"/>
    
    <category term="运维" scheme="http://cloudsheep.xyz/tag/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack核心项目演变</title>
    <link href="http://cloudsheep.xyz/2023/12/12/OpenStack%E6%A0%B8%E5%BF%83%E9%A1%B9%E7%9B%AE%E6%BC%94%E5%8F%98/"/>
    <id>http://cloudsheep.xyz/2023/12/12/OpenStack%E6%A0%B8%E5%BF%83%E9%A1%B9%E7%9B%AE%E6%BC%94%E5%8F%98/</id>
    <published>2023-12-12T06:22:33.000Z</published>
    <updated>2023-12-13T07:33:05.010Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://www.z4a.net/images/2023/12/12/openstack-map-v20230501.jpg" alt="openstack-map-v20230501.jpg"></p>]]></content>
    
    
    <summary type="html">概览</summary>
    
    
    
    <category term="流程图" scheme="http://cloudsheep.xyz/category/%E6%B5%81%E7%A8%8B%E5%9B%BE/"/>
    
    
    <category term="画图详解" scheme="http://cloudsheep.xyz/tag/%E7%94%BB%E5%9B%BE%E8%AF%A6%E8%A7%A3/"/>
    
    <category term="OpenStack" scheme="http://cloudsheep.xyz/tag/OpenStack/"/>
    
  </entry>
  
  <entry>
    <title>MySQL-基础篇</title>
    <link href="http://cloudsheep.xyz/2023/10/25/MySQL/"/>
    <id>http://cloudsheep.xyz/2023/10/25/MySQL/</id>
    <published>2023-10-25T07:20:55.000Z</published>
    <updated>2023-12-10T06:20:22.437Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安装MySQL"><a href="#安装MySQL" class="headerlink" title="安装MySQL"></a>安装MySQL</h1><h2 id="Linux安装"><a href="#Linux安装" class="headerlink" title="Linux安装"></a>Linux安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#安装前检查系统是否自带mysql数据库</span></span></span><br><span class="line">rpm -qa | grep mysql</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#删除系统安装</span></span></span><br><span class="line">rpm -e mysql  #普通删除模式</span><br><span class="line">rpm -e --nodeps mysql  #强制删除（删除时，提示有依赖文件可使用该命令</span><br></pre></td></tr></table></figure><h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><p><strong>使用yum命令安装mysql，参考<a href="https://dev.mysql.com/downloads/repo/yum/">官网</a></strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#安装命令</span></span></span><br><span class="line">wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">rpm -ivh mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">yum update</span><br><span class="line">yum install mysql-server</span><br><span class="line"></span><br><span class="line">chown -R mysql:mysql /var/lib/mysql/  #权限设置</span><br><span class="line">mysqld --initialize  #初始化</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#启动mysql检查状态</span></span></span><br><span class="line">systemctl start mysqld</span><br><span class="line">systemctl status mysqld</span><br></pre></td></tr></table></figure><p><strong>注意：</strong> </p><p><em>如果我们是第一次启动 mysql 服务，mysql 服务器首先会进行初始化的配置。</em></p><p><em>此外,你也可以使用 MariaDB 代替，MariaDB 数据库管理系统是 MySQL 的一个分支，主要由开源社区在维护，采用 GPL 授权许可。开发这个分支的原因之一是：甲骨文公司收购了 MySQL 后，有将 MySQL 闭源的潜在风险，因此社区采用分支的方式来避开这个风险。</em></p><p><em>MariaDB的目的是完全兼容MySQL，包括API和命令行，使之能轻松成为MySQL的代替品。</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install mariadb-server mariadb </span><br><span class="line"></span><br><span class="line">mariadb数据库的相关命令是：</span><br><span class="line">systemctl start mariadb  #启动MariaDB</span><br><span class="line">systemctl stop mariadb  #停止MariaDB</span><br><span class="line">systemctl restart mariadb  #重启MariaDB</span><br><span class="line">systemctl enable mariadb  #设置开机启动</span><br></pre></td></tr></table></figure><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin --version  #验证</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#该命令将输出以下结果，该结果基于你的系统信息：</span></span></span><br><span class="line">mysqladmin  Ver 8.42 Distrib 5.6.51, for Linux on x86_64</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##如果以上命令执行后未输出任何信息，说明你的mysql未安装成功</span></span></span><br><span class="line"></span><br><span class="line">mysql  #进入mysql</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#执行简单命令(&gt;提示符后面执行SQL命令)</span></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">SHOW DATABASES;</span></span><br><span class="line">+----------+</span><br><span class="line">| Database |</span><br><span class="line">+----------+</span><br><span class="line">| mysql    |</span><br><span class="line">| test     |</span><br><span class="line">+----------+</span><br><span class="line">2 rows in set (0.13 sec)</span><br></pre></td></tr></table></figure><h3 id="创建密码"><a href="#创建密码" class="headerlink" title="创建密码"></a>创建密码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -u root password &quot;000000&quot;  #创建root用户密码，密码为&quot;000000&quot;</span><br><span class="line">mysql -uroot -p000000  #进入数据库</span><br></pre></td></tr></table></figure><p><strong>注，：输入密码时密码不会显示，输入正确即可</strong></p><h1 id="管理MySQL"><a href="#管理MySQL" class="headerlink" title="管理MySQL"></a>管理MySQL</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep mysqld   #检查mysql服务器是否启动</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#启动mysql服务器</span></span></span><br><span class="line">cd /usr/bin</span><br><span class="line">./mysqld_safe &amp;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#关闭运行中的mysql服务器</span></span></span><br><span class="line">cd /usr/bin</span><br><span class="line">./mysqladmin -u root -p shutdown</span><br><span class="line">Enter password:******</span><br></pre></td></tr></table></figure><h2 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h2><p><strong>如果你要添加MySQL用户，你只需要在mysql数据库中的user表添加新用户即可。</strong></p><p><strong>实例</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p000000  #进入mysql数据库</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#输出格式（添加用户）</span></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create user <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;mysql&#x27;</span> identified by<span class="string">&#x27;user01&#x27;</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec) </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#输出格式（删除用户）</span></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">drop user <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;mysql&#x27;</span>;    <span class="comment">#删除后需重新创建&#x27;user01&#x27;用户</span></span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#查看mysql用户</span></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> user,host from mysql.user;  <span class="comment">#查看所有用户</span></span></span><br><span class="line">+--------+-----------+</span><br><span class="line">| user   | host      |</span><br><span class="line">+--------+-----------+</span><br><span class="line">| root   | 127.0.0.1 |</span><br><span class="line">| root   | ::1       |</span><br><span class="line">|        | localhost |</span><br><span class="line">| root   | localhost |</span><br><span class="line">|        | mysql     |</span><br><span class="line">| root   | mysql     |</span><br><span class="line">| user01 | mysql     |</span><br><span class="line">+--------+-----------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> user();  <span class="comment">#查看当前用户</span></span></span><br><span class="line">+----------------+</span><br><span class="line">| user()         |</span><br><span class="line">+----------------+</span><br><span class="line">| root@localhost |</span><br><span class="line">+----------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure><h2 id="管理MySQL常用命令"><a href="#管理MySQL常用命令" class="headerlink" title="管理MySQL常用命令"></a>管理MySQL常用命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">use &lt;数据库名&gt;  #选中需要的数据库，使用该命令后所有Mysql命令都只针对该数据库</span><br><span class="line"></span><br><span class="line">SHOW DATABASES;  #列出mysql中所有数据库</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">SHOW DATABASES;  <span class="comment">#实例</span></span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">+--------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">SHOW TABLES;  #指定所有表，需要配合use命令指定数据库后使用</span><br><span class="line"></span><br><span class="line">实例:</span><br><span class="line">MariaDB [(none)]&gt; use mysql;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MariaDB [mysql]&gt; show tables;</span><br><span class="line">+---------------------------+</span><br><span class="line">| Tables_in_mysql           |</span><br><span class="line">+---------------------------+</span><br><span class="line">| columns_priv              |</span><br><span class="line">| db                        |</span><br><span class="line">| event                     |</span><br><span class="line">| func                      |</span><br><span class="line">| general_log               |</span><br><span class="line">| help_category             |</span><br><span class="line">| help_keyword              |</span><br><span class="line">| help_relation             |</span><br><span class="line">| help_topic                |</span><br><span class="line">| host                      |</span><br><span class="line">| ndb_binlog_index          |</span><br><span class="line">| plugin                    |</span><br><span class="line">| proc                      |</span><br><span class="line">| procs_priv                |</span><br><span class="line">| proxies_priv              |</span><br><span class="line">| servers                   |</span><br><span class="line">| slow_log                  |</span><br><span class="line">| tables_priv               |</span><br><span class="line">| time_zone                 |</span><br><span class="line">| time_zone_leap_second     |</span><br><span class="line">| time_zone_name            |</span><br><span class="line">| time_zone_transition      |</span><br><span class="line">| time_zone_transition_type |</span><br><span class="line">| user                      |</span><br><span class="line">+---------------------------+</span><br><span class="line">24 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">SHOW COLUMNS FROM &lt;数据表名&gt;  #查看数据表属性等信息</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">SHOW COLUMNS FROM db;</span></span><br><span class="line">+-----------------------+---------------+------+-----+---------+-------+</span><br><span class="line">| Field                 | Type          | Null | Key | Default | Extra |</span><br><span class="line">+-----------------------+---------------+------+-----+---------+-------+</span><br><span class="line">| Host                  | char(60)      | NO   | PRI |         |       |</span><br><span class="line">| Db                    | char(64)      | NO   | PRI |         |       |</span><br><span class="line">| User                  | char(16)      | NO   | PRI |         |       |</span><br><span class="line">| Select_priv           | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Insert_priv           | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Update_priv           | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Delete_priv           | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Create_priv           | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Drop_priv             | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Grant_priv            | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| References_priv       | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Index_priv            | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Alter_priv            | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Create_tmp_table_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Lock_tables_priv      | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Create_view_priv      | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Show_view_priv        | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Create_routine_priv   | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Alter_routine_priv    | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Execute_priv          | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Event_priv            | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">| Trigger_priv          | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO   |     | N       |       |</span><br><span class="line">+-----------------------+---------------+------+-----+---------+-------+</span><br><span class="line">22 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">SHOW INDEX FROM &lt;数据表名&gt;； #显示数据表的详细索引信息</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">SHOW INDEX FROM db;  <span class="comment">#实例</span></span></span><br><span class="line">+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |</span><br><span class="line">+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">| db    |          0 | PRIMARY  |            1 | Host        | A         |        NULL |     NULL | NULL   |      | BTREE      |         |               |</span><br><span class="line">| db    |          0 | PRIMARY  |            2 | Db          | A         |        NULL |     NULL | NULL   |      | BTREE      |         |               |</span><br><span class="line">| db    |          0 | PRIMARY  |            3 | User        | A         |           2 |     NULL | NULL   |      | BTREE      |         |               |</span><br><span class="line">| db    |          1 | User     |            1 | User        | A         |           1 |     NULL | NULL   |      | BTREE      |         |               |</span><br><span class="line">+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">SHOW TABLE STATUS  FROM <span class="string">&#x27;xxx&#x27;</span>;   <span class="comment"># 显示数据库 xxx 中所有表的信息</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">SHOW TABLE STATUS from RUNOOB LIKE <span class="string">&#x27;xxx%&#x27;</span>;     <span class="comment"># 表名以xxx开头的表的信息</span></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">SHOW TABLE STATUS from RUNOOB LIKE <span class="string">&#x27;xxx%&#x27;</span>\G;   <span class="comment"># 加上 \G，查询结果按列打印</span></span></span><br></pre></td></tr></table></figure><h1 id="HPH语法"><a href="#HPH语法" class="headerlink" title="HPH语法"></a>HPH语法</h1><p><strong>MySQL可应用于多种用语言，如C，C++，JAVA，PHP等，其中，MySQL在PHP的web开发中应用的最广泛。</strong>(后续案例也基本采用PHP语言)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">MySQL PHP函数格式:</span></span><br><span class="line">mysqli_function(value,value,...);  #语法结束后面一定要有符号结束！！</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">以上格式中 <span class="keyword">function</span>部分描述了mysql函数的功能，如:</span></span><br><span class="line"><span class="meta prompt_">mysqli_connect($</span><span class="language-bash">connect);  <span class="comment">#连接到数据库，其中connect包含了连接所需要的信息,例如主机名、用户名、数据库名和密码等。如果连接成功，该函数将返回一个连接对象，否则返回false。</span></span></span><br><span class="line"><span class="meta prompt_">mysqli_query($</span><span class="language-bash">connect,<span class="string">&quot;SQL 语句&quot;</span>);   <span class="comment">#执行SQL查询或者更新操作</span></span></span><br><span class="line">mysqli_fetch_array()    #从结果集对象中获取一行数据，并以数组的形式返回</span><br><span class="line">mysqli_close()     #关闭MySQL数据库连接，释放资源</span><br></pre></td></tr></table></figure><p><strong>实例</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">retval = mysqli_function(value, [value,...]);</span></span><br><span class="line">if( !$retval )</span><br><span class="line">&#123;</span><br><span class="line">   die ( &quot;相关错误信息&quot; );</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其他 MySQL 或 PHP 语句</span></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h1 id="MySQL连接方式"><a href="#MySQL连接方式" class="headerlink" title="MySQL连接方式"></a>MySQL连接方式</h1><h2 id="二进制连接"><a href="#二进制连接" class="headerlink" title="二进制连接"></a>二进制连接</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p000000</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">登陆成功后，显示结果如下:</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 14</span><br><span class="line">Server version: 5.5.68-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; quit;   #退出MySQL数据库</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure><h2 id="PHP脚本连接"><a href="#PHP脚本连接" class="headerlink" title="PHP脚本连接"></a>PHP脚本连接</h2><p><strong>PHP 提供了 mysqli_connect() 函数来连接数据库。</strong></p><p><strong>该函数有 6 个参数，在成功链接到 MySQL 后返回连接标识，失败返回 FALSE 。</strong></p><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysqli_connect(host, username, password, dbname,port, socket);</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">可以使用 PHP 的 mysqli_close() 函数来断开与 MySQL 数据库的链接</span></span><br><span class="line">bool mysqli_close ( mysqli $link )</span><br></pre></td></tr></table></figure><p><em><strong>提示：通常不需要使用 mysqli_close()，因为已打开的非持久连接会在脚本执行完毕后自动关闭。</strong></em></p><h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>host</td><td>规定主机名或IP地址(可选)</td></tr><tr><td>usernsme</td><td>规定MySQL用户名(可选)</td></tr><tr><td>passwod</td><td>规定MySQL密码(可选)</td></tr><tr><td>dbname</td><td>规定默认使用的数据库(可选)</td></tr><tr><td>port</td><td>规定尝试连接到MySQL服务器的端口号(可选)</td></tr><tr><td>socket</td><td>规定socket或要使用的已命名pipe(可选)</td></tr></tbody></table><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">yum -y install php php-mysql   #安装PHP MySQL扩展</span><br><span class="line">vi mysql01.php  #创建PHP脚本</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">dbhost = <span class="string">&#x27;localhost&#x27;</span>;  // mysql服务器主机地址</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">dbuser = <span class="string">&#x27;root&#x27;</span>;            // mysql用户名</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">dbpass = <span class="string">&#x27;123456&#x27;</span>;          // mysql用户名密码</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">conn = mysqli_connect(<span class="variable">$dbhost</span>, <span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>);</span></span><br><span class="line">if(! $conn )</span><br><span class="line">&#123;</span><br><span class="line">    die(&#x27;Could not connect: &#x27; . mysqli_error());</span><br><span class="line">&#125;</span><br><span class="line">echo &#x27;数据库连接成功！&#x27;;</span><br><span class="line"><span class="meta prompt_">mysqli_close($</span><span class="language-bash">conn);</span></span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">php mysql01.php   #运行PHP脚本</span><br></pre></td></tr></table></figure><h1 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h1><h2 id="MySQL创建"><a href="#MySQL创建" class="headerlink" title="MySQL创建"></a>MySQL创建</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p000000   #进入数据库</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create database runoob;  #创建数据库，数据名runoob</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysqladmin -uroot -p000000 create RUNOOB   #使用mysqladmin创建</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证</span></span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| RUNOOB             |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| runoob             |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="PHP脚本创建数据库"><a href="#PHP脚本创建数据库" class="headerlink" title="PHP脚本创建数据库"></a>PHP脚本创建数据库</h2><p><strong>一般使用mysqli_query函数来创建或者删除MySQL数据库，执行成功返回true否则返回false</strong></p><h3 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqli_query(connecttion,query,resultmode);</span><br></pre></td></tr></table></figure><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>connecttion</td><td>规定要使用的MySQL连接(必需)</td></tr><tr><td>query</td><td>规定查询字符(必需)</td></tr><tr><td>resultmode</td><td>一个常量(可选) , 可以是下列值中的任意一个：                                                                                  ——  MYSQLI_USE_RESULT（如果需要检索大量数据，请使用这个）                                                                                                                   ——  MYSQLI_STORE_RESULT（默认）</td></tr></tbody></table><h3 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vi runoob.php   #创建PHP脚本</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">dbhost = <span class="string">&#x27;localhost&#x27;</span>;  <span class="comment"># mysql服务器主机地址</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">dbuser = <span class="string">&#x27;root&#x27;</span>;            <span class="comment"># mysql用户名</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">dbpass = <span class="string">&#x27;000000&#x27;</span>;          <span class="comment"># mysql用户名密码</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">conn = mysqli_connect(<span class="variable">$dbhost</span>, <span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>);</span></span><br><span class="line">if(! $conn )</span><br><span class="line">&#123;</span><br><span class="line">  die(&#x27;连接错误: &#x27; . mysqli_error($conn));</span><br><span class="line">&#125;</span><br><span class="line">echo &#x27;连接成功&lt;br /&gt;&#x27;;</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">sql = <span class="string">&#x27;CREATE DATABASE RUNOOB&#x27;</span>;</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">retval = mysqli_query(<span class="variable">$conn</span>,<span class="variable">$sql</span> );</span></span><br><span class="line">if(! $retval )</span><br><span class="line">&#123;</span><br><span class="line">    die(&#x27;创建数据库失败: &#x27; . mysqli_error($conn));</span><br><span class="line">&#125;</span><br><span class="line">echo &quot;数据库 RUNOOB 创建成功\n&quot;;</span><br><span class="line"><span class="meta prompt_">mysqli_close($</span><span class="language-bash">conn);</span></span><br><span class="line">?&gt;</span><br><span class="line"> </span><br><span class="line">php runoob.php     #执行脚本</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">MySQL的一些简单用法</summary>
    
    
    
    <category term="教程" scheme="http://cloudsheep.xyz/category/%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="MySQL" scheme="http://cloudsheep.xyz/tag/MySQL/"/>
    
    <category term="快速入门" scheme="http://cloudsheep.xyz/tag/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    
  </entry>
  
  <entry>
    <title>dockerfile</title>
    <link href="http://cloudsheep.xyz/2023/10/20/Dockerfile/"/>
    <id>http://cloudsheep.xyz/2023/10/20/Dockerfile/</id>
    <published>2023-10-20T06:30:34.000Z</published>
    <updated>2023-12-19T07:28:53.793Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><h2 id="什么是dockerfile-dockerfile就是用来构建docker镜像的命令"><a href="#什么是dockerfile-dockerfile就是用来构建docker镜像的命令" class="headerlink" title="什么是dockerfile?dockerfile就是用来构建docker镜像的命令"></a>什么是dockerfile?dockerfile就是用来构建docker镜像的命令</h2><p><strong>一个完整的docker镜像由以下几步构成：</strong></p><p><strong>1.编写一个dockerfile文件</strong></p><p><strong>2.使用docker build命令构建成为一个镜像</strong></p><p><strong>3.使用docker run命令运行构建好的镜像</strong></p><p><strong>4.docker push命令发布镜像 （推荐DockerHub、阿里云镜像仓库）</strong></p><p><em>注：这里参考<a href="https://docs.docker.com/engine/reference/builder/">官方文档</a></em></p><h2 id="Dockerfile构建"><a href="#Dockerfile构建" class="headerlink" title="Dockerfile构建"></a>Dockerfile构建</h2><p><strong>构建dockerfile需要注意以下几点：</strong></p><p><strong>1.每个都要保留关键字（指令）且必须是大写字母！！！</strong></p><p><strong>2.文件的执行顺序是从上到下的</strong></p><p><strong>3.#表示注释（如果vim命令那么在虚拟机上是看不见中文的需要手动安装）</strong></p><p><strong>4.每一个指令都会创建并提交一个新的镜像层，并提交！！</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">注：#vim安装命令</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">centos系统</span></span><br><span class="line">sudo yum install -y vim*</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ubatnu系统</span></span><br><span class="line">sudo apt install -y vim*</span><br></pre></td></tr></table></figure><h2 id="Dockerfile的命令"><a href="#Dockerfile的命令" class="headerlink" title="Dockerfile的命令"></a>Dockerfile的命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FORM              #基础镜像，一切从这里开始</span><br><span class="line">MAINNTATNER       #镜像构建人（姓名+邮箱）</span><br><span class="line">RUN               #镜像构建的时候需要运行的命令</span><br><span class="line">ADD               #步骤：tomcat镜像，这个tomcat压缩包！添加内容</span><br><span class="line">WORKDIR           #镜像的工作目录</span><br><span class="line">VOLUME            #挂载的目录</span><br><span class="line">EXPOSE            #指定暴露的端口号</span><br><span class="line">CMD               #指定这个容器启动的时候要运行的命令，只有最后一个会生效，可被替代</span><br><span class="line">ENTRYOINT         #指定这个容器启动时要运行的命令，可以追加命令</span><br><span class="line">ONBUILD           #当构建一个被继承dockerfile这个时候就会运行ONBUILD的指令。（触发指令）</span><br><span class="line">COPY              #类似ADD，将我们的文件拷贝到镜像中</span><br><span class="line">ENV               #构建的时候设置环境变量</span><br></pre></td></tr></table></figure><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#创建一个自己的centos镜像##</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.编写dockerfile文件</span></span><br><span class="line">vi /home/dockerfile/dockerfile.centos  #打开vi编辑器</span><br><span class="line">FROM centos:7</span><br><span class="line">MAINTAINER cf&lt;kisssheep1557@163.com&gt;</span><br><span class="line"></span><br><span class="line">ENV MYPATH /usr/local/</span><br><span class="line">WORKDIR $MYPATH</span><br><span class="line"></span><br><span class="line">RUN yum -y install vim</span><br><span class="line">RUN yum -y inatall net-tools</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">CMD echo $MYPATH</span><br><span class="line">CMD echo &quot;-----end-----&quot;</span><br><span class="line">CMD /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.通过编写好的文件构建镜像</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#命令：docker build -f /home/dockerfile/dockerfile文件路径 -t 镜像名：[tag]</span></span></span><br><span class="line">docker build -f dockerfile.centos -t mycentos:0.1 .</span><br><span class="line"></span><br><span class="line">Successfully built 285c2064af01</span><br><span class="line">Successfully tagged mycentos:0.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.运行测试</span></span><br></pre></td></tr></table></figure><p><img src="https://www.z4a.net/images/2023/12/08/docker01.png" alt="docker01.png"></p><p><strong>对比</strong></p><p>官方给的基础镜像centos:7</p><p><img src="https://www.z4a.net/images/2023/12/08/docker02.png" alt="docker02.png"></p><p>自己创建的镜像mycentos:0.1</p><p><img src="https://www.z4a.net/images/2023/12/08/docker03.png" alt="docker03.png"></p><p><em>注：一般官方所给出的基础镜像是没有命令的，我们可以在官方给出的基础镜像的基础之上利用dockerfile来进行创建自己所需要的镜像</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#查看本地进行的变更历史</span></span></span><br><span class="line">docker history &lt;镜像ID&gt;</span><br></pre></td></tr></table></figure><p><img src="https://www.z4a.net/images/2023/12/08/docker04.png" alt="docker04.png"></p><h3 id="CMD和ENTRYPOIN的区别"><a href="#CMD和ENTRYPOIN的区别" class="headerlink" title="CMD和ENTRYPOIN的区别"></a>CMD和ENTRYPOIN的区别</h3><table><thead><tr><th>CMD</th><th>指定这个容器启动的时候要运行的命令，只有最后一个会生效，可以被代替</th></tr></thead><tbody><tr><td>ENTRYPOINT</td><td>指定这个容器启动的时候要运行的命令，可以追加命令</td></tr></tbody></table><h4 id="测试CMD"><a href="#测试CMD" class="headerlink" title="测试CMD"></a>测试CMD</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.编写dockerfile文件</span></span><br><span class="line">vi /home/dockerfile/mydockerfile-cmd-test</span><br><span class="line"></span><br><span class="line">cat /home/dockerfile/mydockerfile-cmd-test</span><br><span class="line">FROM centos:7</span><br><span class="line">CMD [&quot;ls&quot;,&quot;-a&quot;]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.构建镜像</span></span><br><span class="line">docker build -f /home/dockerfile/mydockerfile-cmd-test -t myimage:tag .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.run命令运行，发现我们的“<span class="built_in">ls</span> -a<span class="string">&quot;命令生效、执行</span></span></span><br></pre></td></tr></table></figure><p><img src="https://www.z4a.net/images/2023/12/08/docker05.png" alt="docker05.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.追加一个<span class="string">&quot;-l&quot;</span>命令，构成<span class="string">&quot;ls -al&quot;</span>命令，发现报错</span></span><br><span class="line">[root@docker ~]# docker run 06f2cc65ea4a -l</span><br><span class="line">docker: Error response from daemon: failed to create task for container: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: exec: &quot;-l&quot;: executable file not found in $PATH: unknown.</span><br><span class="line">ERRO[0000] error waiting for container:</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#原因:在CMD命令的情况下，&quot;-l&quot;替换了CMD[&quot;ls&quot;,&quot;a&quot;]命令而不是追加在里面，&quot;-l&quot;不是命令，所以报错！</span></span></span><br></pre></td></tr></table></figure><h4 id="测试ENTRYPOINT"><a href="#测试ENTRYPOINT" class="headerlink" title="测试ENTRYPOINT"></a>测试ENTRYPOINT</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.编写dockerfile文件</span></span><br><span class="line">vi /home/dockerfile/mydockerfile-entrypoint-test</span><br><span class="line"></span><br><span class="line">cat /home/dockerfile/mydockerfile-entrypoint-test</span><br><span class="line">FORM centos:7</span><br><span class="line">ENTRYPOINT [&quot;ls&quot;,&quot;-a&quot;]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.利用写好的dockerfile文件构建镜像</span></span><br><span class="line">docker build -f /home/dockerfile/mydockerfile-cmd-test -t myimages:tag .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.run命令运行构建好的镜像，发现写入的<span class="string">&quot;ls -a&quot;</span>命令生效、执行</span></span><br></pre></td></tr></table></figure><p><img src="https://www.z4a.net/images/2023/12/08/docker06.png" alt="docker06.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.追加一个<span class="string">&quot;l&quot;</span>命令，构成<span class="string">&quot;ls -al&quot;</span>命令，发现命令生效并且被成功执行</span></span><br><span class="line">[root@docker ~]# docker run 5184c7d459a0 -l</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x.   1 root root     6 Oct  4 08:30 .</span><br><span class="line">drwxr-xr-x.   1 root root     6 Oct  4 08:30 ..</span><br><span class="line">-rwxr-xr-x.   1 root root     0 Oct  4 08:30 .dockerenv</span><br><span class="line">-rw-r--r--.   1 root root 12114 Nov 13  2020 anaconda-post.log</span><br><span class="line">lrwxrwxrwx.   1 root root     7 Nov 13  2020 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x.   5 root root   340 Oct  4 08:30 dev</span><br><span class="line">drwxr-xr-x.   1 root root    66 Oct  4 08:30 etc</span><br><span class="line">drwxr-xr-x.   2 root root     6 Apr 11  2018 home</span><br><span class="line">lrwxrwxrwx.   1 root root     7 Nov 13  2020 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx.   1 root root     9 Nov 13  2020 lib64 -&gt; usr/lib64</span><br><span class="line">drwxr-xr-x.   2 root root     6 Apr 11  2018 media</span><br><span class="line">drwxr-xr-x.   2 root root     6 Apr 11  2018 mnt</span><br><span class="line">drwxr-xr-x.   2 root root     6 Apr 11  2018 opt</span><br><span class="line">dr-xr-xr-x. 131 root root     0 Oct  4 08:30 proc</span><br><span class="line">dr-xr-x---.   2 root root   114 Nov 13  2020 root</span><br><span class="line">drwxr-xr-x.  11 root root   148 Nov 13  2020 run</span><br><span class="line">lrwxrwxrwx.   1 root root     8 Nov 13  2020 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x.   2 root root     6 Apr 11  2018 srv</span><br><span class="line">dr-xr-xr-x.  13 root root     0 Oct  4 08:13 sys</span><br><span class="line">drwxrwxrwt.   7 root root   132 Nov 13  2020 tmp</span><br><span class="line">drwxr-xr-x.  13 root root   155 Nov 13  2020 usr</span><br><span class="line">drwxr-xr-x.  18 root root   238 Nov 13  2020 var</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#原因：ENTRYPOINT命令的情况下，&quot;-l&quot;追加在ENTRYPOINT [&quot;1s&quot;，&quot;-a&quot;]命令后面，得到&quot;ls -al&quot;的命令，所以命令正常执行！（我们的追加命令，是直接拼接在我们的ENTRYPOINT命令的后面）</span></span></span><br></pre></td></tr></table></figure><h2 id="实战：制作tomcat镜像"><a href="#实战：制作tomcat镜像" class="headerlink" title="实战：制作tomcat镜像"></a>实战：制作tomcat镜像</h2><h3 id="1-准备好centos镜像，tomcat和jdk的压缩包-tomcat和jdk的压缩包安装地址放在下面"><a href="#1-准备好centos镜像，tomcat和jdk的压缩包-tomcat和jdk的压缩包安装地址放在下面" class="headerlink" title="1.准备好centos镜像，tomcat和jdk的压缩包(tomcat和jdk的压缩包安装地址放在下面)"></a>1.准备好centos镜像，tomcat和jdk的压缩包(tomcat和jdk的压缩包安装地址放在下面)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker pull centos:7   #下载centos基础镜像</span><br><span class="line"></span><br><span class="line">cd /home/dockerfile  #上传压缩包至该目录</span><br><span class="line">[root@docker dockerfile]# ls</span><br><span class="line">apache-tomcat-8.5.93.tar.gz  jdk-8u381-linux-x64.tar.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><em>注：<a href="https://tomcat.apache.org/download-80.cgi">tomcat下载地址</a>和 <a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">jdk下载地址</a></em></p><h3 id="2-解压，创建dockerfile文件"><a href="#2-解压，创建dockerfile文件" class="headerlink" title="2.解压，创建dockerfile文件"></a>2.解压，创建dockerfile文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">touch readme.txt   #创建readme.txt文件(可以理解为帮助文档)</span><br><span class="line"></span><br><span class="line">vi Dockerfile   #官方命名,build命令会自动查找该路径,不需要-f来确定路径</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#编写dockerfile文件##</span></span></span><br><span class="line">FROM centos:7</span><br><span class="line">MAINTAINER yqy&lt;kisssheep1557@163.com&gt; #构建人信息</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将刚才创建的readme文件复制到该目录下</span></span><br><span class="line">COPY readme.txt /usr/local/readme.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ADD会自动解压压缩包</span></span><br><span class="line">ADD jdk-8u381-linux-x64.tar.gz /usr/local  </span><br><span class="line">ADD apache-tomcat-8.5.93.tar.gz /usr/local</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行添加命令</span></span><br><span class="line">RUN yum install -y vim</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">工作目录</span></span><br><span class="line">ENV MYPATH /usr/local</span><br><span class="line">WORKDIR $MYPATH</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置tomcat的运行环境</span></span><br><span class="line">ENV JAVA_HOME /usr/local/jdk1.8.0_381</span><br><span class="line">ENV CLASS_PATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">ENV CATALINA_HOME /usr/local/apache-tomcat-8.5.93</span><br><span class="line">ENV CATALINA_BASH /usr/local/apache-tomcat-8.5.93</span><br><span class="line">ENV PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">暴露端口</span></span><br><span class="line">EXPOSE 8080 </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动后监视日志输出</span></span><br><span class="line">CMD /usr/local/apache-tomcat-8.5.93/bin/startup.sh &amp;&amp; tail -F /usr/local/apa</span><br><span class="line">che-tomcat-8.5.93/bin/logs/catalina.out</span><br></pre></td></tr></table></figure><h3 id="3-构建镜像，启动，访问测试"><a href="#3-构建镜像，启动，访问测试" class="headerlink" title="3.构建镜像，启动，访问测试"></a>3.构建镜像，启动，访问测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">构建镜像</span></span><br><span class="line">docker build -t diytomcat .</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动镜像</span></span><br><span class="line">docker run -d -p 9090:8080 --name diytomcat01 diytomcat:latest</span><br><span class="line"></span><br><span class="line">docker run -d -p 3355:8080 --name yqytomcat -v /home/yqy/build/tomcat/test:/usr/local/apache-tomcat-8.5.93/webapps/test -v /home/yqy/build/tomcat/tomcatlog:/usr/local/apache-tomcat-8.5.93/logs diytomcat   #复杂版</span><br></pre></td></tr></table></figure><p><img src="https://www.z4a.net/images/2023/12/08/docker07.png" alt="docker07.png"></p><p><strong>访问成功！！！</strong></p><h3 id="4-发布项目"><a href="#4-发布项目" class="headerlink" title="4.发布项目"></a>4.发布项目</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在使用run命令打开容器时做了挂载卷，所以直接在本地<span class="built_in">test</span>文件下编写项目就可以了</span></span><br><span class="line">mkdir /home/yqy/build/tomcat/test/WEB-INF</span><br><span class="line">vi /home/yqy/build/tomcat/test/WEB-INF/web.xml</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee  http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">version</span>=<span class="string">&quot;2.5&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /home/sywl/build/tomcat/test/index.jsp</span><br></pre></td></tr></table></figure><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span><br><span class="line"> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;hello,sywl&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">Hello World!&lt;br/&gt;</span><br><span class="line">&lt;%</span><br><span class="line">System.out.println(<span class="string">&quot;----my web test----&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Docker——dockerfile</summary>
    
    
    
    <category term="教程" scheme="http://cloudsheep.xyz/category/%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="docker" scheme="http://cloudsheep.xyz/tag/docker/"/>
    
    <category term="进阶" scheme="http://cloudsheep.xyz/tag/%E8%BF%9B%E9%98%B6/"/>
    
  </entry>
  
</feed>
