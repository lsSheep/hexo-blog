<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, shrink-to-fit=no">
    <meta name="referrer" content="origin">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <title>
        
            Kubernetes详解
        
    </title>
    <link rel="shortcut icon" href="#"/>

    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/LongCang.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Monda.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/NotoSansSC.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/NotoSerifSC.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Playball.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/PTMono.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Roboto.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/RobotoSlab.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Rosario.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/UbuntuMono.min.css">

    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/base.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/code.min.css">

    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/jquery-3.4.1.min.js"></script>
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="CloudSheep's Blog" type="application/atom+xml">
</head>
<body>
    <a id="cover"></a>
    <link type="text/css" rel="stylesheet" href="/css/post.css">
<div id="header" class="header">
    <div class="vertical">
        <div class="inner">
            
                <h1 class="header-subtitle">Kubernetes详解</h1>
                <div class="header-subinfo">
                    <p class="article-info-text">
                        <span>
                            <i class="iconfont icon-time"></i> 发表时间：2023-12-12
                        </span>
                        
                            
                                <span>
                                    <i class="iconfont icon-browse"></i> 阅读：<span class="waline-pageview-count" data-path="/2023/12/12/Kubernetes详解/"></span>
                                </span>
                            
                            
                                <span>
                                    <i class="iconfont icon-interactive"></i> 评论：<span class="waline-comment-count" data-path="/2023/12/12/Kubernetes详解/"></span>
                                </span>
                              
                        
                    </p>
                    
                        
                            <span class="category-color">教程</span>
                        
                    
                    
                        
                            <span class="tag-color">Kubernetes</span>
                        
                            <span class="tag-color">运维</span>
                        
                    
                </div>
            
        </div>
    </div>
    
</div>
<div id="container">
    
        <!-- 文章页面 -->
        <div id="article">
            <div class="toc"></div>
            <div class="article-body">
                <h1 id="pod"><a href="#pod" class="headerlink" title="pod"></a>pod</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>Pod 是一组（一个或多个）容器的集合（Pod 就像是豌豆荚，而容器就像是豌豆荚中的豌豆）。这些容器共享存储、网络等。</strong></p>
<h2 id="pod资源清单"><a href="#pod资源清单" class="headerlink" title="pod资源清单"></a>pod资源清单</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1 #api文档版本</span><br><span class="line">kind: Pod #资源对象类型</span><br><span class="line">metadata: #pod相关的元数据</span><br><span class="line">  name: nginx-pod #pod的名称</span><br><span class="line">  labels: #定义Pod的标签</span><br><span class="line">    tybe: app #自定义labe标签，名字tybe,值为app</span><br><span class="line">    test: 1.0.0 #自定义labe标签，tybe版本号</span><br><span class="line">  namespace: &#x27;default&#x27; #命名空间的配置</span><br><span class="line">spec: #期望pod按照这里的配置进行描述</span><br><span class="line">  containers: #对pod中的容器描述</span><br><span class="line">  - name: nginx #容器的名称</span><br><span class="line">    image: &#x27;nginx:1.20.2&#x27; #指定容器的镜像</span><br><span class="line">    imagePullPolicy: IfNotPresent #镜像拉取策略</span><br><span class="line">    startupProbe:  #应用启动探针配置</span><br><span class="line">      exec:</span><br><span class="line">        command:</span><br><span class="line">        - /bin/sh</span><br><span class="line">        - -c</span><br><span class="line">        - &quot;sleep 3;echo success &gt; /inited&quot;</span><br><span class="line">      initialDelaySeconds: 1 #探测延迟，running后指定20秒后才执行探测，默认0秒</span><br><span class="line">      periodSeconds: 5 #执行探测的间隔时间</span><br><span class="line">      failureThreshold: 3 #失败阈值，失败多少次才算是真正失败</span><br><span class="line">      successThreshold: 1 #成功阈值多少次监测成功才算成功</span><br><span class="line">      timeoutSeconds: 5 #请求的超时时间</span><br><span class="line">    readinessProbe: #应用存活探针配置</span><br><span class="line">      httpGet: #探测方式，基于http请求探测</span><br><span class="line">        path: /started.html #http请求路径</span><br><span class="line">     #tcpSocket:</span><br><span class="line">        port: 80 #请求端口</span><br><span class="line">      initialDelaySeconds: 1 #探测延迟，running后指定20秒后才执行探测，默认0秒</span><br><span class="line">      periodSeconds: 5 #执行探测的间隔时间</span><br><span class="line">      failureThreshold: 3 #失败阈值，失败多少次才算是真正失败</span><br><span class="line">      successThreshold: 1 #成功阈值多少次监测成功才算成功</span><br><span class="line">      timeoutSeconds: 5 #请求的超时时间</span><br><span class="line">    command: #指定容器启动时执行的命令</span><br><span class="line">    - nginx</span><br><span class="line">    - -g</span><br><span class="line">    - &#x27;daemon off;&#x27; #nginx -g &#x27;daemon off;&#x27;</span><br><span class="line">    workingDir: /usr/share/nginx/html #定义容器启动后的工作目录</span><br><span class="line">    ports:</span><br><span class="line">    - name: http #端口名称</span><br><span class="line">      containerPort: 80 #描述容器内要暴露什么端口</span><br><span class="line">      protocol: TCP #描述该端口是基于哪种协议通信的</span><br><span class="line">    env: #环境变量</span><br><span class="line">    - name: JVM_OPTS #环境变量名称</span><br><span class="line">      value: &#x27;-Xms128m -Xmx128m&#x27; #环境变量的值</span><br><span class="line">    resources:</span><br><span class="line">      requests: #最少需要多少资源</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 128Mi</span><br><span class="line">      limits: #最多可以使用多少资源</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 256Mi</span><br><span class="line">  restartPolicy: OnFailure #重启策略</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h1><h2 id="deployment"><a href="#deployment" class="headerlink" title="deployment"></a>deployment</h2><p><img src="C:\Users\32625\OneDrive\图片\k8s\24.png"></p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1 # 版本号 </span><br><span class="line">kind: Deployment # 类型 </span><br><span class="line">metadata: # 元数据 </span><br><span class="line">  name: nginx-deploy # rs名称</span><br><span class="line">  labels: #标签 </span><br><span class="line">    controller: deploy </span><br><span class="line">spec: # 详情描述 </span><br><span class="line">  replicas: 3 # 副本数量 </span><br><span class="line">  revisionHistoryLimit: 5 # 保留历史版本，默认为10 </span><br><span class="line">  paused: false # 暂停部署，默认是false </span><br><span class="line">  progressDeadlineSeconds: 600 # 部署超时时间（s），默认是600 </span><br><span class="line">  strategy: # 策略 </span><br><span class="line">    type: RollingUpdate # 滚动更新策略 </span><br><span class="line">    rollingUpdate: # 滚动更新 </span><br><span class="line">      maxSurge: 30% # 最大额外可以存在的副本数</span><br><span class="line">  selector: # 选择器，通过它指定该控制器管理哪些pod </span><br><span class="line">    matchLabels: # Labels匹配规则 </span><br><span class="line">      app: nginx-pod </span><br><span class="line">    matchExpressions: # Expressions匹配规则 </span><br><span class="line">      - &#123;key: app, operator: In, values: [nginx-pod]&#125; </span><br><span class="line">  template: # 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span><br><span class="line">    metadata: </span><br><span class="line">      labels: </span><br><span class="line">        app: nginx-pod </span><br><span class="line">    spec: </span><br><span class="line">      containers: </span><br><span class="line">      - name: nginx </span><br><span class="line">        image: nginx:1.20.2 </span><br><span class="line">        ports: </span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a>版本回退</h3><ul>
<li><p>kubetl rollout 参数 deploy xx  # 支持下面的选择</p>
</li>
<li><p>status 显示当前升级的状态</p>
</li>
<li><p>history 显示升级历史记录</p>
</li>
<li><p>pause 暂停版本升级过程</p>
</li>
<li><p>resume 继续已经暂停的版本升级过程</p>
</li>
<li><p>undo 回滚到上一级版本 （可以使用–to-revision回滚到指定的版本）</p>
</li>
</ul>
<h3 id="滚动更新"><a href="#滚动更新" class="headerlink" title="滚动更新"></a>滚动更新</h3><ul>
<li>kubectl set image命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl set image deployment nginx-deploy nginx=nginx:1.20.2</span><br></pre></td></tr></table></figure>

<p>直接修改yaml文件</p>
<h3 id="金丝雀发布"><a href="#金丝雀发布" class="headerlink" title="金丝雀发布"></a>金丝雀发布</h3><p>金丝雀的发布流程如下：</p>
<ul>
<li><p>① 将 service 的标签设置为 app&#x3D;nginx ，这就意味着集群中的所有标签是 app&#x3D;nginx 的 Pod 都会加入负载均衡网络。</p>
</li>
<li><p>② 使用 Deployment v&#x3D;v1 app&#x3D;nginx 去筛选标签是 app&#x3D;nginx 以及 v&#x3D;v1 的 所有 Pod。</p>
</li>
<li><p>③ 同理，使用 Deployment v&#x3D;v2 app&#x3D;nginx 去筛选标签是 app&#x3D;nginx 以及 v&#x3D;v2 的所有 Pod 。</p>
</li>
<li><p>④ 逐渐加大 Deployment v&#x3D;v2 app&#x3D;nginx 控制的 Pod 的数量，根据轮询负载均衡网络的特点，必定会使得此 Deployment 控制的 Pod 的流量增大。</p>
</li>
<li><p>⑤ 当测试完成后，删除 Deployment v&#x3D;v1 app&#x3D;nginx 即可。</p>
</li>
</ul>
<h2 id="HPA"><a href="#HPA" class="headerlink" title="HPA"></a>HPA</h2><p><img src="C:\Users\32625\OneDrive\图片\k8s\50.png"></p>
<p>根据cpu使用率或自定义指标(metrics)自动对pod进行扩&#x2F;缩容</p>
<h3 id="监控cpu使用率"><a href="#监控cpu使用率" class="headerlink" title="监控cpu使用率"></a>监控cpu使用率</h3><h4 id="创建deployment和service"><a href="#创建deployment和service" class="headerlink" title="创建deployment和service"></a>创建deployment和service</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx:1.17.1</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">          resources: # 资源限制</span><br><span class="line">            requests:</span><br><span class="line">              cpu: &quot;100m&quot; # 100m 表示100 milli cpu，即 0.1 个CPU</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80 # svc 的访问端口</span><br><span class="line">      name: nginx</span><br><span class="line">      targetPort: 80 # Pod 的访问端口</span><br><span class="line">      protocol: TCP</span><br><span class="line">      nodePort: 30010 # 在机器上开端口，浏览器访问</span><br></pre></td></tr></table></figure>

<h4 id="创建HPA"><a href="#创建HPA" class="headerlink" title="创建HPA"></a>创建HPA</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-hpa</span><br><span class="line">spec:</span><br><span class="line">  minReplicas: 1 # 最小 Pod 数量</span><br><span class="line">  maxReplicas: 10 # 最大 Pod 数量</span><br><span class="line">  targetCPUUtilizationPercentage: 3 # CPU 使用率指标，即 CPU 超过 3%（Pod 的 limit 的 cpu ） 就进行扩容</span><br><span class="line">  scaleTargetRef:  # 指定要控制的Nginx的信息</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: nginx-deploy</span><br></pre></td></tr></table></figure>



<h2 id="扩缩容"><a href="#扩缩容" class="headerlink" title="扩缩容"></a>扩缩容</h2><ul>
<li>kubectl scale 命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx-deploy --replicas=4</span><br></pre></td></tr></table></figure>

<h2 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h2><table>
<thead>
<tr>
<th align="center">deployment部署方式</th>
<th>无状态应用：网络可能会变（IP 地址）、存储可能会变（卷）、顺序可能会变（启动的顺序）。应用场景：业务代码，如：使用 SpringBoot 开发的商城应用的业务代码。无状态的：</th>
</tr>
</thead>
<tbody><tr>
<td align="center">statefulset部署方式</td>
<td>有状态应用：网络不变、存储不变、顺序不变。应用场景：中间件，如：MySQL 集群、Zookeeper 集群、Redis 集群、MQ 集群。</td>
</tr>
</tbody></table>
<p><img src="C:\Users\32625\OneDrive\图片\k8s\56.png"></p>
<h3 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: web-nginx</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: ss-nginx</span><br><span class="line">  serviceName: nginx-svc # 服务名称，这个字段需要和 service 的 metadata.name 相同</span><br><span class="line">  replicas: 5 # 副本数</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: ss-nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx:1.20.2</span><br><span class="line">---</span><br><span class="line"># 将 StatefulSet 加入网络</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: ss-nginx</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  clusterIP: None # 不分配 ClusterIP ，形成无头服务，整个集群的 Pod 能直接访问，但是浏览器不可以访问。</span><br><span class="line">  ports:</span><br><span class="line">    - name: nginx</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="分区更新"><a href="#分区更新" class="headerlink" title="分区更新"></a>分区更新</h3><p>● StatefulSet 的更新策略：<br>  ○ OnDelete：删除之后才更新。<br>  ○ RollingUpdate：滚动更新，如果是此更新策略，可以设置更新的索引（默认值）。</p>
<h4 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  updateStrategy: # 更新策略</span><br><span class="line">    type: RollingUpdate # OnDelete 删除之后才更新；RollingUpdate 滚动更新</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      partition: 0 # 更新索引 &gt;= partition 的 Pod ，默认为 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="管理策略"><a href="#管理策略" class="headerlink" title="管理策略"></a>管理策略</h3><p>StatefulSet 的 Pod 的管理策略（podManagementPolicy）分为：</p>
<table>
<thead>
<tr>
<th>OrderedReady（有序启动，默认值）</th>
<th>Parallel（并发一起启动）</th>
</tr>
</thead>
</table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  podManagementPolicy: OrderedReady # 控制 Pod 创建、升级以及扩缩容逻辑。Parallel（并发一起启动） 和 </span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h3 id="级联删除与非级联删除"><a href="#级联删除与非级联删除" class="headerlink" title="级联删除与非级联删除"></a>级联删除与非级联删除</h3><h4 id="级联删除："><a href="#级联删除：" class="headerlink" title="级联删除："></a>级联删除：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 删除statefulset时同时删除pods</span><br><span class="line">kubectl delete sts sts-nginx</span><br></pre></td></tr></table></figure>

<h4 id="非级联删除："><a href="#非级联删除：" class="headerlink" title="非级联删除："></a>非级联删除：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 删除statefulset时不会删除pods，sts删除后po依然存在</span><br><span class="line">kubectl delete sts sts-nginx --cascade=false</span><br></pre></td></tr></table></figure>

<h2 id="DdemoSet"><a href="#DdemoSet" class="headerlink" title="DdemoSet"></a>DdemoSet</h2><p><img src="C:\Users\32625\OneDrive\图片\k8s\54.png"></p>
<p>● DaemonSet 控制器确保所有（或一部分）的节点都运行了一个指定的 Pod 副本。<br>  ○ 每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上。<br>  ○ 当节点从集群中移除时，Pod 也就被垃圾回收了。<br>  ○ 删除一个 DaemonSet 可以清理所有由其创建的 Pod</p>
<h3 id="daemonset资源清单"><a href="#daemonset资源清单" class="headerlink" title="daemonset资源清单"></a>daemonset资源清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1 # 版本号</span><br><span class="line">kind: DaemonSet # 类型</span><br><span class="line">metadata: # 元数据</span><br><span class="line">  name: # 名称</span><br><span class="line">  namespace: #命名空间</span><br><span class="line">  labels: #标签</span><br><span class="line">    controller: daemonset</span><br><span class="line">spec: # 详情描述</span><br><span class="line">  revisionHistoryLimit: 3 # 保留历史版本</span><br><span class="line">  updateStrategy: # 更新策略</span><br><span class="line">    type: RollingUpdate # 滚动更新策略</span><br><span class="line">    rollingUpdate: # 滚动更新</span><br><span class="line">      maxUnavailable: 1 # 最大不可用状态的Pod的最大值，可用为百分比，也可以为整数</span><br><span class="line">  selector: # 选择器，通过它指定该控制器管理那些Pod</span><br><span class="line">    matchLabels: # Labels匹配规则 matchLabels 和 matchExpressions 任选其一</span><br><span class="line">      app: nginx-pod</span><br><span class="line">    matchExpressions: # Expressions匹配规则</span><br><span class="line">      - key: app</span><br><span class="line">        operator: In</span><br><span class="line">        values:</span><br><span class="line">          - nginx-pod</span><br><span class="line">  template: # 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span><br><span class="line">     metadata:</span><br><span class="line">       labels:</span><br><span class="line">         app: nginx-pod</span><br><span class="line">     spec:</span><br><span class="line">       containers:</span><br><span class="line">         - name: nginx</span><br><span class="line">           image: nginx:1.17.1</span><br><span class="line">           ports:</span><br><span class="line">             - containerPort: 80</span><br></pre></td></tr></table></figure>

<h3 id="配置文件-2"><a href="#配置文件-2" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: ds</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: ds</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      # tolerations: # 污点</span><br><span class="line">      # - key: node-role.kubernetes.io/master</span><br><span class="line">      #   effect: NoSchedule</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.20.2</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 200Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: localtime</span><br><span class="line">          mountPath: /etc/localtime</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: localtime</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /usr/share/zoneinfo/Asia/Shanghai</span><br></pre></td></tr></table></figure>

<h2 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h2><ul>
<li><p>Job 主要用于负责批量处理短暂的一次性任务。</p>
</li>
<li><p>Job 的特点： </p>
</li>
<li><ul>
<li>当 Job 创建的 Pod 执行成功结束时，Job 将记录成功结束的 Pod 数量。</li>
</ul>
</li>
<li><ul>
<li>当成功结束的 Pod 达到指定的数量时，Job 将完成执行。</li>
</ul>
</li>
<li><ul>
<li>删除 Job 对象时，将清理掉由 Job 创建的 Pod 。</li>
</ul>
</li>
<li><ul>
<li>Job 可以保证指定数量的 Pod 执行完成。</li>
</ul>
</li>
</ul>
<p><img src="C:\Users\32625\OneDrive\图片\k8s\60.png"></p>
<h3 id="job资源清单"><a href="#job资源清单" class="headerlink" title="job资源清单"></a>job资源清单</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch/v1 # 版本号</span><br><span class="line">kind: Job # 类型</span><br><span class="line">metadata: # 元数据</span><br><span class="line">  name:  # 名称</span><br><span class="line">  namespace:  #命名空间</span><br><span class="line">  labels: # 标签</span><br><span class="line">    controller: job</span><br><span class="line">spec: # 详情描述</span><br><span class="line">  completions: 1 # 指定Job需要成功运行Pod的总次数，默认为1</span><br><span class="line">  parallelism: 1 # 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span><br><span class="line">  activeDeadlineSeconds: 30 # 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span><br><span class="line">  backoffLimit: 6 # 指定Job失败后进行重试的次数，默认为6</span><br><span class="line">  manualSelector: true # 是否可以使用selector选择器选择Pod，默认为false</span><br><span class="line">  ttlSecondsAfterFinished: 0 # 如果是 0 表示执行完Job 时马上删除。如果是 100 ，就是执行完 Job ，等待 100s 后删除。TTL 机制由 TTL 控制器 提供，ttlSecondsAfterFinished 字段可激活该特性。当 TTL 控制器清理 Job 时，TTL 控制器将删除 Job 对象，以及由该 Job 创建的所 有 Pod 对象。</span><br><span class="line">  selector: # 选择器，通过它指定该控制器管理那些Pod，非必须字段</span><br><span class="line">    matchLabels: # Labels匹配规则</span><br><span class="line">      app: counter-pod</span><br><span class="line">    matchExpressions: # Expressions匹配规则</span><br><span class="line">      - key: app</span><br><span class="line">        operator: In</span><br><span class="line">        values:</span><br><span class="line">          - counter-pod</span><br><span class="line">  template: # 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span><br><span class="line">     metadata:</span><br><span class="line">       labels:</span><br><span class="line">         app: counter-pod</span><br><span class="line">     spec:</span><br><span class="line">       restartPolicy: Never # 重启策略只能设置为Never或OnFailure</span><br><span class="line">       containers:</span><br><span class="line">         - name: counter</span><br><span class="line">           image: busybox:1.30</span><br><span class="line">           command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&quot;]</span><br></pre></td></tr></table></figure>

<p>● 关于模板中的重启策略的说明：<br>  ○  如果设置为OnFailure，则Job会在Pod出现故障的时候重启容器，而不是创建Pod，failed次数不变。<br>  ○  如果设置为Never，则Job会在Pod出现故障的时候创建新的Pod，并且故障Pod不会消失，也不会重启，failed次数+1。<br>  ○  如果指定为Always的话，就意味着一直重启，意味着Pod任务会重复执行，这和Job的定义冲突，所以不能设置为Always。</p>
<h3 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h3><p><img src="C:\Users\32625\OneDrive\图片\k8s\63.png"></p>
<ul>
<li>CronJob 控制器以 Job 控制器为其管控对象，并借助它管理 Pod 资源对象，Job 控制器定义的作业任务在其控制器资源创建之后便会立即执行，但 CronJob 可以以类似 Linux 操作系统的周期性任务作业计划的方式控制器运行时间点及重复运行的方式，换言之，CronJob 可以在特定的时间点反复去执行 Job 任务。</li>
</ul>
<h4 id="资源清单"><a href="#资源清单" class="headerlink" title="资源清单"></a>资源清单</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch/v1beta1 # 版本号</span><br><span class="line">kind: CronJob # 类型</span><br><span class="line">metadata: # 元数据</span><br><span class="line">  name:  # 名称</span><br><span class="line">  namespace:  #命名空间</span><br><span class="line">  labels:</span><br><span class="line">    controller: cronjob</span><br><span class="line">spec: # 详情描述</span><br><span class="line">  schedule: # cron格式的作业调度运行时间点，用于控制任务任务时间执行</span><br><span class="line">  concurrencyPolicy: # 并发执行策略</span><br><span class="line">  failedJobsHistoryLimit: # 为失败的任务执行保留的历史记录数，默认为1</span><br><span class="line">  successfulJobsHistoryLimit: # 为成功的任务执行保留的历史记录数，默认为3</span><br><span class="line">  jobTemplate: # job控制器模板，用于为cronjob控制器生成job对象，下面其实就是job的定义</span><br><span class="line">    metadata: &#123;&#125;</span><br><span class="line">    spec:</span><br><span class="line">      completions: 1 # 指定Job需要成功运行Pod的总次数，默认为1</span><br><span class="line">      parallelism: 1 # 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span><br><span class="line">      activeDeadlineSeconds: 30 # 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span><br><span class="line">      backoffLimit: 6 # 指定Job失败后进行重试的次数，默认为6</span><br><span class="line">      template: # 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span><br><span class="line">        spec:</span><br><span class="line">          restartPolicy: Never # 重启策略只能设置为Never或OnFailure</span><br><span class="line">          containers:</span><br><span class="line">            - name: counter</span><br><span class="line">              image: busybox:1.30</span><br><span class="line">              command: [ &quot;/bin/sh&quot;,&quot;-c&quot;,&quot;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&quot; ]</span><br></pre></td></tr></table></figure>

<p>●  schedule：cron表达式，用于指定任务的执行时间。<br>  ○  *&#x2F;1 * * * <em>：表示分钟  小时  日  月份  星期。<br>  ○  分钟的值从 0 到 59 。<br>  ○  小时的值从 0 到 23 。<br>  ○  日的值从 1 到 31 。<br>  ○  月的值从 1 到 12 。<br>  ○  星期的值从 0 到 6，0 表示星期日。<br>  ○  多个时间可以用逗号隔开，范围可以用连字符给出：</em> 可以作为通配符，&#x2F; 表示每…<br>●  concurrencyPolicy：并发执行策略<br>  ○  Allow：运行 Job 并发运行（默认）。<br>  ○  Forbid：禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行。<br>  ○  Replace：替换，取消当前正在运行的作业并使用新作业替换它。</p>
<h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h1><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><ul>
<li><p><strong>在 Kubernetes 中，Pod 是应用程序的载体，我们可以通过 Pod 的 IP 来访问应用程序，但是 Pod 的 IP 地址不是固定的，这就意味着不方便直接采用 Pod 的 IP 对服务进行访问。</strong> </p>
</li>
<li><p><strong>为了解决这个问题，Kubernetes 提供了 Service 资源，Service 会对提供同一个服务的多个 Pod 进行聚合，并且提供一个统一的入口地址，通过访问 Service 的入口地址就能访问到后面的 Pod 服务。</strong></p>
</li>
</ul>
<p><img src="C:\Users\32625\OneDrive\图片\k8s\2.png"></p>
<h3 id="OSI-网络模型和-TCP-IP-协议："><a href="#OSI-网络模型和-TCP-IP-协议：" class="headerlink" title="OSI 网络模型和 TCP&#x2F;IP 协议："></a>OSI 网络模型和 TCP&#x2F;IP 协议：</h3><p>![](C:\Users\32625\OneDrive\图片\k8s\OSI 网络模型和 TCP-IP 协议.png)</p>
<ul>
<li><strong>Service 默认使用的协议是 TCP 协议，对应的是 OSI 网络模型中的第四层传输层，所以也有人称 Service 为四层网络负载均衡。</strong></li>
</ul>
<h3 id="service资源清单"><a href="#service资源清单" class="headerlink" title="service资源清单"></a>service资源清单</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1 # 版本</span><br><span class="line">kind: Service # 类型</span><br><span class="line">metadata: # 元数据</span><br><span class="line">  name: # 资源名称</span><br><span class="line">  namespace: # 命名空间</span><br><span class="line">spec:</span><br><span class="line">  selector: # 标签选择器，用于确定当前Service代理那些Pod</span><br><span class="line">    app: nginx</span><br><span class="line">  type: NodePort # Service的类型，指定Service的访问方式</span><br><span class="line">  clusterIP: # 虚拟服务的IP地址</span><br><span class="line">  sessionAffinity: # session亲和性，支持ClientIP、None两个选项，默认值为None</span><br><span class="line">  ports: # 端口信息</span><br><span class="line">    - port: 8080 # Service端口</span><br><span class="line">      protocol: TCP # 协议</span><br><span class="line">      targetPort : # Pod端口</span><br><span class="line">      nodePort:  # 主机端口</span><br></pre></td></tr></table></figure>

<h3 id="配置文件-3"><a href="#配置文件-3" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-svc</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: http # service 端口配置的名称</span><br><span class="line">    protocol: TCP # 端口绑定的协议，支持 TCP、UDP、SCTP，默认为 TCP</span><br><span class="line">    port: 80 # service 自己的端口</span><br><span class="line">    targetPort: 80 # 目标 pod 的端口</span><br><span class="line">  selector: # 选中当前 service 匹配哪些 pod，对哪些 pod 的东西流量进行代理</span><br><span class="line">    app: nginx</span><br><span class="line">  type: NodePort 随机生成端口</span><br></pre></td></tr></table></figure>

<h4 id="type说明："><a href="#type说明：" class="headerlink" title="type说明："></a>type说明：</h4><ul>
<li><p>ClusterIP（默认值）：通过集群的内部 IP 暴露服务，选择该值时服务只能够在集群内部访问。</p>
</li>
<li><p>NodePort：通过每个节点上的 IP 和静态端口（NodePort）暴露服务。 NodePort 服务会路由到自动创建的 ClusterIP 服务。 通过请求 <code>&lt;节点 IP&gt;:&lt;节点端口&gt;</code>，我们可以从集群的外部访问一个 NodePort 服务。</p>
</li>
<li><p>LoadBalancer：使用云提供商的负载均衡器向外部暴露服务。 外部负载均衡器可以将流量路由到自动创建的 NodePort 服务和 ClusterIP 服务上。</p>
</li>
<li><p>ExternalName：通过返回 CNAME 和对应值，可以将服务映射到 externalName 字段的内容（如：foo.bar.example.com）。 无需创建任何类型代理。</p>
</li>
</ul>
<h3 id="命令操作："><a href="#命令操作：" class="headerlink" title="命令操作："></a>命令操作：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#使用其他Pod访问创建的svcvice name</span><br><span class="line">kubectl exec -it nginx-pod -- sh #进入创建的pod中去</span><br><span class="line">curl/wegt http://nginx-svc:80</span><br><span class="line">#如果需要跨namespace(命名空间)访问pod，则在service name后面加上&lt;namespec&gt;即可</span><br><span class="line">curl http://nginx-svc.default</span><br></pre></td></tr></table></figure>

<h3 id="实现外部访问"><a href="#实现外部访问" class="headerlink" title="实现外部访问"></a>实现外部访问</h3><h4 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h4><ul>
<li><p>编写service配置文件时，不指定selector属性</p>
</li>
<li><p>自己创建endpoint(ds)</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80 # 此时的 targetPort 需要和 Endpoints 的subsets.addresses.ports.port 相同  </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc # 此处的 name 需要和 Service 的 metadata 的 name 相同</span><br><span class="line">  namespace: default</span><br><span class="line">subsets:</span><br><span class="line">- addresses:</span><br><span class="line">  - ip: 220.181.38.251 # 百度</span><br><span class="line">  - ip: 221.122.82.30 # 搜狗 </span><br><span class="line">  - ip: 61.129.7.47 # QQ</span><br><span class="line">  ports:</span><br><span class="line">  - name: http # 此处的 name 需要和 Service 的 spec.ports.name 相同</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP域名解析</span><br></pre></td></tr></table></figure>

<h4 id="域名解析"><a href="#域名解析" class="headerlink" title="域名解析"></a>域名解析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">进入pod使用nslookup查询</span><br><span class="line">kubectl exec -it nginx-svc -- sh</span><br><span class="line"># 安装nslookup</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install dnsutils</span><br><span class="line">#其中 nginx-svc 是 Service 的服务名</span><br><span class="line">nslookup -type=a nginx-svc</span><br></pre></td></tr></table></figure>

<h4 id="保持会话技术"><a href="#保持会话技术" class="headerlink" title="保持会话技术"></a>保持会话技术</h4><ul>
<li>基于客户端 IP 地址的会话保持模式，即来自同一个客户端发起的所有请求都尽最大可能转发到固定的一个 Pod 上，只需要在 spec 中添加 <code>sessionAffinity: ClientIP</code> 选项。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  type: ClusterIP </span><br><span class="line">  sessionAffinity: &quot;ClientIP&quot;</span><br><span class="line">  sessionAffinityConfig:</span><br><span class="line">    clientIP: </span><br><span class="line">       timeoutSeconds: 11800 # 30 分钟</span><br><span class="line">  ports:</span><br><span class="line">  - name: nginx</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 80 </span><br><span class="line">    targetPort: 80</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<h3 id="网络层次"><a href="#网络层次" class="headerlink" title="网络层次"></a>网络层次</h3><p><img src="C:\Users\32625\OneDrive\图片\k8s\14.png"></p>
<h3 id="Pod-指定自己的主机名"><a href="#Pod-指定自己的主机名" class="headerlink" title="Pod 指定自己的主机名"></a>Pod 指定自己的主机名</h3><p><strong>Pod 中还可以设置 hostname 和 subdomain 字段，需要注意的是，一旦设置了 hostname ，那么该 Pod 的主机名就被设置为 hostname 的值，而 subdomain  需要和 svc 中的 name 相同。</strong> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: default-subdomain</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  clusterIP: None </span><br><span class="line">  ports:</span><br><span class="line">  - name: foo</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 1234</span><br><span class="line">    targetPort: 1234</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx1</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  hostname: nginx1</span><br><span class="line">  subdomain: default-subdomain # 必须和 svc 的 name 相同，才可以使用 hostname.subdomain.名称空间.svc.cluster.local 访问，否则访问不到指定的 Pod 。</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 250m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  nginx</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  restartPolicy: Always</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx2</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  hostname: nginx2</span><br><span class="line">  subdomain: default-subdomain # 必须和 svc 的 name 相同，才可以使用 hostname.subdomain.名称空间.svc.cluster.local 访问，否则访问不到指定的 Pod 。</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 250m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  nginx</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure>

<h2 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h2><p><strong>Service 可以使用 NodePort 暴露集群外访问端口，但是性能低、不安全并且端口的范围有限。</strong></p>
<p><strong>Service 缺少七层（OSI 网络模型）的统一访问入口，负载均衡能力很低，不能做限流、验证非法用户、链路追踪等等。</strong></p>
<p><strong>Ingress 公开了从集群外部到集群内 <code>服务</code> 的 HTTP 和 HTTPS 路由。流量路由由 Ingress 资源上定义的规则控制。</strong></p>
<p><strong>我们使用 Ingress 作为整个集群统一的入口，配置 Ingress 规则转发到对应的 Service</strong> 。</p>
<p><img src="C:\Users\32625\OneDrive\图片\k8s\22.png"></p>
<h3 id="安装Ingress-nginx"><a href="#安装Ingress-nginx" class="headerlink" title="安装Ingress-nginx"></a>安装Ingress-nginx</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 安装命令：</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.2/deploy/static/provider/baremetal/deploy.yaml</span><br></pre></td></tr></table></figure>

<h4 id="修改deploy-yaml配置文件"><a href="#修改deploy-yaml配置文件" class="headerlink" title="修改deploy.yaml配置文件"></a>修改deploy.yaml配置文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br></pre></td><td class="code"><pre><span class="line">#GENERATED FOR K8S 1.20</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">automountServiceAccountToken: true</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - pods</span><br><span class="line">  - secrets</span><br><span class="line">  - endpoints</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - services</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses/status</span><br><span class="line">  verbs:</span><br><span class="line">  - update</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingressclasses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resourceNames:</span><br><span class="line">  - ingress-controller-leader</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - update</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - patch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - create</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - endpoints</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - secrets</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - services</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - patch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses/status</span><br><span class="line">  verbs:</span><br><span class="line">  - update</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingressclasses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - admissionregistration.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - validatingwebhookconfigurations</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - update</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  allow-snippet-annotations: &quot;true&quot;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  ipFamilies:</span><br><span class="line">  - IPv4</span><br><span class="line">  ipFamilyPolicy: SingleStack</span><br><span class="line">  ports:</span><br><span class="line">  - appProtocol: http</span><br><span class="line">    name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: http</span><br><span class="line">  - appProtocol: https</span><br><span class="line">    name: https</span><br><span class="line">    port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: https</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  type: ClusterIP # NodePort</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-controller-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - appProtocol: https</span><br><span class="line">    name: https-webhook</span><br><span class="line">    port: 443</span><br><span class="line">    targetPort: webhook</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  type: ClusterIP</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet # Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  minReadySeconds: 0</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/component: controller</span><br><span class="line">      app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">      app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/component: controller</span><br><span class="line">        app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    spec:</span><br><span class="line">      dnsPolicy: ClusterFirstWithHostNet # dns 调整为主机网络 ，原先为 ClusterFirst</span><br><span class="line">      hostNetwork: true # 直接让 nginx 占用本机的 80 和 443 端口，这样就可以使用主机网络</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - /nginx-ingress-controller</span><br><span class="line">        - --election-id=ingress-controller-leader</span><br><span class="line">        - --controller-class=k8s.io/ingress-nginx</span><br><span class="line">        - --ingress-class=nginx</span><br><span class="line">        - --report-node-internal-ip-address=true</span><br><span class="line">        - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller</span><br><span class="line">        - --validating-webhook=:8443</span><br><span class="line">        - --validating-webhook-certificate=/usr/local/certificates/cert</span><br><span class="line">        - --validating-webhook-key=/usr/local/certificates/key</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        - name: LD_PRELOAD</span><br><span class="line">          value: /usr/local/lib/libmimalloc.so</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.1.2 # 修改 k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        lifecycle:</span><br><span class="line">          preStop:</span><br><span class="line">            exec:</span><br><span class="line">              command:</span><br><span class="line">              - /wait-shutdown</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 10254</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        name: controller</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: http</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 443</span><br><span class="line">          name: https</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          name: webhook</span><br><span class="line">          protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 10254</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        resources: # 资源限制</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 90Mi</span><br><span class="line">          limits: </span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 500Mi     </span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: true</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">          runAsUser: 101</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /usr/local/certificates/</span><br><span class="line">          name: webhook-cert</span><br><span class="line">          readOnly: true</span><br><span class="line">      nodeSelector:</span><br><span class="line">        node-role: ingress # 以后只需要给某个 node 打上这个标签就可以部署 ingress-nginx 到这个节点上了</span><br><span class="line">        # kubernetes.io/os: linux</span><br><span class="line">      serviceAccountName: ingress-nginx</span><br><span class="line">      terminationGracePeriodSeconds: 300</span><br><span class="line">      volumes:</span><br><span class="line">      - name: webhook-cert</span><br><span class="line">        secret:</span><br><span class="line">          secretName: ingress-nginx-admission</span><br><span class="line">---</span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: pre-install,pre-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission-create</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/component: admission-webhook</span><br><span class="line">        app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">        app.kubernetes.io/managed-by: Helm</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">        app.kubernetes.io/version: 1.1.2</span><br><span class="line">        helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">      name: ingress-nginx-admission-create</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - create</span><br><span class="line">        - --host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc</span><br><span class="line">        - --namespace=$(POD_NAMESPACE)</span><br><span class="line">        - --secret-name=ingress-nginx-admission</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1 # k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: create</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      restartPolicy: OnFailure</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 2000</span><br><span class="line">        runAsNonRoot: true</span><br><span class="line">        runAsUser: 2000</span><br><span class="line">      serviceAccountName: ingress-nginx-admission</span><br><span class="line">---</span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    helm.sh/hook: post-install,post-upgrade</span><br><span class="line">    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission-patch</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/component: admission-webhook</span><br><span class="line">        app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">        app.kubernetes.io/managed-by: Helm</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">        app.kubernetes.io/version: 1.1.2</span><br><span class="line">        helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">      name: ingress-nginx-admission-patch</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - patch</span><br><span class="line">        - --webhook-name=ingress-nginx-admission</span><br><span class="line">        - --namespace=$(POD_NAMESPACE)</span><br><span class="line">        - --patch-mutating=false</span><br><span class="line">        - --secret-name=ingress-nginx-admission</span><br><span class="line">        - --patch-failure-policy=Fail</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1 # k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: patch</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      restartPolicy: OnFailure</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 2000</span><br><span class="line">        runAsNonRoot: true</span><br><span class="line">        runAsUser: 2000</span><br><span class="line">      serviceAccountName: ingress-nginx-admission</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: IngressClass</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  controller: k8s.io/ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: admissionregistration.k8s.io/v1</span><br><span class="line">kind: ValidatingWebhookConfiguration</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.1.2</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.0.18</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">webhooks:</span><br><span class="line">- admissionReviewVersions:</span><br><span class="line">  - v1</span><br><span class="line">  clientConfig:</span><br><span class="line">    service:</span><br><span class="line">      name: ingress-nginx-controller-admission</span><br><span class="line">      namespace: ingress-nginx</span><br><span class="line">      path: /networking/v1/ingresses</span><br><span class="line">  failurePolicy: Fail</span><br><span class="line">  matchPolicy: Equivalent</span><br><span class="line">  name: validate.nginx.ingress.kubernetes.io</span><br><span class="line">  rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">    - networking.k8s.io</span><br><span class="line">    apiVersions:</span><br><span class="line">    - v1</span><br><span class="line">    operations:</span><br><span class="line">    - CREATE</span><br><span class="line">    - UPDATE</span><br><span class="line">    resources:</span><br><span class="line">    - ingresses</span><br><span class="line">  sideEffects: None</span><br></pre></td></tr></table></figure>

<h4 id="给node节点打上标签"><a href="#给node节点打上标签" class="headerlink" title="给node节点打上标签"></a>给node节点打上标签</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node &lt;node-name&gt; node-role=ingress</span><br></pre></td></tr></table></figure>

<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -ntlp | grep 80</span><br><span class="line">netstat -ntlp | grep 443</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\32625\OneDrive\图片\k8s\30.png"></p>
<h3 id="ingress配置文件"><a href="#ingress配置文件" class="headerlink" title="ingress配置文件"></a>ingress配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress # 资源类型为ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-http</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations: </span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTP&quot;  </span><br><span class="line">spec:</span><br><span class="line">  rules: # 规则</span><br><span class="line">  - host: nginx.xudaxian.com # 指定的监听的主机域名，相当于 nginx.conf 的 server &#123; xxx &#125;</span><br><span class="line">    http: # 指定路由规则</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix # 匹配规则，Prefix 前缀匹配 nginx.xudaxian.com/* 都可以匹配到</span><br><span class="line">        backend: # 指定路由的后台服务的 service 名称</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-svc # 服务名</span><br><span class="line">            port:</span><br><span class="line">              number: 80 # 服务的端口</span><br><span class="line">  - host: tomcat.xudaxian.com # 指定的监听的主机域名，相当于 nginx.conf 的 server &#123; xxx &#125;</span><br><span class="line">    http: # 指定路由规则</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix # 匹配规则，Prefix 前缀匹配 tomcat.xudaxian.com/* 都可以匹配到</span><br><span class="line">        backend: # 指定路由的后台服务的 service 名称</span><br><span class="line">          service:</span><br><span class="line">            name: tomcat-svc # 服务名</span><br><span class="line">            port:</span><br><span class="line">              number: 8080 # 服务的端口</span><br></pre></td></tr></table></figure>

<h4 id="pathType-说明："><a href="#pathType-说明：" class="headerlink" title="pathType 说明："></a><strong><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress/#path-types">pathType</a> 说明：</strong></h4><ul>
<li><p>refix：基于以 <code>/</code> 分隔的 URL 路径前缀匹配。匹配区分大小写，并且对路径中的元素逐个完成。 路径元素指的是由 <code>/</code> 分隔符分隔的路径中的标签列表。 如果每个 p 都是请求路径 p 的元素前缀，则请求与路径 p 匹配。</p>
</li>
<li><p>Exact：精确匹配 URL 路径，且区分大小写。</p>
</li>
<li><p>ImplementationSpecific：对于这种路径类型，匹配方法取决于 IngressClass。 具体实现可以将其作为单独的 pathType 处理或者与 Prefix 或 Exact 类型作相同处理。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>路径</th>
<th>请求路径</th>
<th>匹配与否？</th>
</tr>
</thead>
<tbody><tr>
<td>Prefix</td>
<td><code>/</code></td>
<td>（所有路径）</td>
<td>是</td>
</tr>
<tr>
<td>Exact</td>
<td><code>/foo</code></td>
<td><code>/foo</code></td>
<td>是</td>
</tr>
<tr>
<td>Exact</td>
<td><code>/foo</code></td>
<td><code>/bar</code></td>
<td>否</td>
</tr>
<tr>
<td>Exact</td>
<td><code>/foo</code></td>
<td><code>/foo/</code></td>
<td>否</td>
</tr>
<tr>
<td>Exact</td>
<td><code>/foo/</code></td>
<td><code>/foo</code></td>
<td>否</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/foo</code></td>
<td><code>/foo</code>, <code>/foo/</code></td>
<td>是</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/foo/</code></td>
<td><code>/foo</code>, <code>/foo/</code></td>
<td>是</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa/bb</code></td>
<td><code>/aaa/bbb</code></td>
<td>否</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa/bbb</code></td>
<td><code>/aaa/bbb</code></td>
<td>是</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa/bbb/</code></td>
<td><code>/aaa/bbb</code></td>
<td>是，忽略尾部斜线</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa/bbb</code></td>
<td><code>/aaa/bbb/</code></td>
<td>是，匹配尾部斜线</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa/bbb</code></td>
<td><code>/aaa/bbb/ccc</code></td>
<td>是，匹配子路径</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa/bbb</code></td>
<td><code>/aaa/bbbxyz</code></td>
<td>否，字符串前缀不匹配</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/</code>, <code>/aaa</code></td>
<td><code>/aaa/ccc</code></td>
<td>是，匹配 <code>/aaa</code> 前缀</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/</code>, <code>/aaa</code>, <code>/aaa/bbb</code></td>
<td><code>/aaa/bbb</code></td>
<td>是，匹配 <code>/aaa/bbb</code> 前缀</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/</code>, <code>/aaa</code>, <code>/aaa/bbb</code></td>
<td><code>/ccc</code></td>
<td>是，匹配 <code>/</code> 前缀</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa</code></td>
<td><code>/ccc</code></td>
<td>否，使用默认后端</td>
</tr>
<tr>
<td>混合</td>
<td><code>/foo</code> (Prefix), <code>/foo</code> (Exact)</td>
<td><code>/foo</code></td>
<td>是，优选 Exact 类型</td>
</tr>
</tbody></table>
<h3 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h3><h4 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h4><p>在物理机机上验证:</p>
<ul>
<li>在 win 中的 hosts（C:\Windows\System32\drivers\etc\hosts） 文件中添加如下的信息：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 用来模拟 DNS ，其中 192.168.10.137 是 ingress 部署的机器，nginx.xudaxian.com 和 tomcat.xudaxian.com 是 ingress 文件中监听的域名</span><br><span class="line">192.168.10.137 nginx.xudaxian.com</span><br><span class="line">192.168.10.137 tomcat.xudaxian.com</span><br></pre></td></tr></table></figure>

<ul>
<li>在物理机终端使用curl命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl nginx.xudaxian.com</span><br></pre></td></tr></table></figure>

<h4 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h4><p>新建一台虚拟机（centOS 7)并带有桌面：</p>
<ul>
<li>在 hosts （<code>/etc/hosts</code>）文件中添加如下的内容：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 用来模拟 DNS ，其中 192.168.10.137 是 ingress 部署的机器，nginx.xudaxian.com 和 tomcat.xudaxian.com 是 ingress 文件中监听的域名</span><br><span class="line">192.168.10.137 nginx.xudaxian.com</span><br><span class="line">192.168.10.137 tomcat.xudaxian.com</span><br></pre></td></tr></table></figure>

<p>通过浏览器访问：nginx.xudaxian.com</p>
<h3 id="默认后端"><a href="#默认后端" class="headerlink" title="默认后端"></a>默认后端</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-http</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations: </span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTP&quot;  </span><br><span class="line">spec:</span><br><span class="line">  defaultBackend: # 指定所有未匹配的默认后端</span><br><span class="line">    service:</span><br><span class="line">      name: nginx-svc</span><br><span class="line">      port:</span><br><span class="line">        number: 80</span><br><span class="line">  rules: </span><br><span class="line">    - host: tomcat.com </span><br><span class="line">      http: </span><br><span class="line">        paths:</span><br><span class="line">          - path: /abc</span><br><span class="line">            pathType: Prefix </span><br><span class="line">            backend: </span><br><span class="line">              service:</span><br><span class="line">                name: tomcat-svc</span><br><span class="line">                port:</span><br><span class="line">                  number: 8080</span><br></pre></td></tr></table></figure>

<h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: rate-ingress</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations: # https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#rate-limiting</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTP&quot;  </span><br><span class="line">    nginx.ingress.kubernetes.io/limit-rps: &quot;1&quot; # 限流</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<h3 id="路径重写（用于前后端分离）"><a href="#路径重写（用于前后端分离）" class="headerlink" title="路径重写（用于前后端分离）"></a>路径重写（用于前后端分离）</h3><p><img src="C:\Users\32625\OneDrive\图片\k8s\33.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-rewrite</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">   nginx.ingress.kubernetes.io/rewrite-target: /$2 # 路径重写</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: baidu.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /api(/|$)(.*)</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<h3 id="基于-Cookie-的会话保持技术"><a href="#基于-Cookie-的会话保持技术" class="headerlink" title="基于 Cookie 的会话保持技术"></a>基于 Cookie 的会话保持技术</h3><ul>
<li>Service 只能基于 ClientIP，但是 ingress 是七层负载均衡，可以基于 Cookie 实现会话保持。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: rate-ingress</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations: # https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#rate-limiting</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTP&quot;  </span><br><span class="line">    nginx.ingress.kubernetes.io/affinity: &quot;cookie&quot;</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<h3 id="配置SSL"><a href="#配置SSL" class="headerlink" title="配置SSL"></a>配置SSL</h3><h4 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.cert -subj &quot;/CN=xudaxian.com/O=xudaxian.com&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret tls xudaxian-tls --key tls.key --cert tls.cert</span><br></pre></td></tr></table></figure>

<p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-05-31 125543.png)</p>
<h4 id="配置文件-4"><a href="#配置文件-4" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-tls</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations: </span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;  </span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">      - nginx.xudaxian.com # 通过浏览器访问 https://nginx.xudaxian.com</span><br><span class="line">      - tomcat.xudaxian.com # 通过浏览器访问 https://tomcat.xudaxian.com</span><br><span class="line">    secretName: xudaxian-tls</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">  - host: tomcat.xudaxian.com </span><br><span class="line">    http: </span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix </span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: tomcat-svc </span><br><span class="line">            port:</span><br><span class="line">              number: 8080</span><br><span class="line">  #实际开发时，需要购买证书</span><br></pre></td></tr></table></figure>

<h3 id="ingress金丝雀发布"><a href="#ingress金丝雀发布" class="headerlink" title="ingress金丝雀发布"></a>ingress金丝雀发布</h3><p><strong>缺点：不能灰度自定义</strong></p>
<p><img src="C:\Users\32625\OneDrive\图片\k8s\36.png"></p>
<h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><h5 id="部署service和deployment"><a href="#部署service和deployment" class="headerlink" title="部署service和deployment"></a>部署service和deployment</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: v1-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: v1-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: v1-pod</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx</span><br><span class="line">      labels:</span><br><span class="line">        app: v1-pod</span><br><span class="line">    spec:</span><br><span class="line">      initContainers:</span><br><span class="line">        - name: alpine</span><br><span class="line">          image: alpine</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;echo v1-pod &gt; /app/index.html;&quot;]</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - mountPath: /app</span><br><span class="line">              name: app    </span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx:1.17.2</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">          resources:</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 100m</span><br><span class="line">              memory: 100Mi</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 250m</span><br><span class="line">              memory: 500Mi </span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: app</span><br><span class="line">              mountPath: /usr/share/nginx/html             </span><br><span class="line">      volumes:</span><br><span class="line">        - name: app</span><br><span class="line">          emptyDir: &#123;&#125;       </span><br><span class="line">      restartPolicy: Always</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: v1-service</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: v1-pod</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - name: nginx</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: v2-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: v2-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: v2-pod</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: v2-pod</span><br><span class="line">      labels:</span><br><span class="line">        app: v2-pod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx:1.17.2</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">          resources:</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 100m</span><br><span class="line">              memory: 100Mi</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 250m</span><br><span class="line">              memory: 500Mi </span><br><span class="line">      restartPolicy: Always</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: v2-service</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: v2-pod</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - name: nginx</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br></pre></td></tr></table></figure>

<h5 id="部署ingress"><a href="#部署ingress" class="headerlink" title="部署ingress"></a>部署ingress</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-v1</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: &quot;nginx&quot;</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: v1-service</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;Host: nginx.xudaxian.com&quot; http://192.168.10.135</span><br></pre></td></tr></table></figure>

<h4 id="流量切分"><a href="#流量切分" class="headerlink" title="流量切分"></a>流量切分</h4><h5 id="基于-Header-的流量切分"><a href="#基于-Header-的流量切分" class="headerlink" title="基于 Header 的流量切分"></a>基于 Header 的流量切分</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-canary</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/canary: &quot;true&quot; # 开启金丝雀 </span><br><span class="line">    nginx.ingress.kubernetes.io/canary-by-header: &quot;Region&quot; # 基于请求头</span><br><span class="line">    # 如果 请求头 Region = always ，就路由到金丝雀版本；如果 Region = never ，就永远不会路由到金丝雀版本。</span><br><span class="line">    nginx.ingress.kubernetes.io/canary-by-header-value: &quot;sz&quot; # 自定义值</span><br><span class="line">    # 如果 请求头 Region = sz ，就路由到金丝雀版本；如果 Region != sz ，就永远不会路由到金丝雀版本。</span><br><span class="line">    # nginx.ingress.kubernetes.io/canary-by-header-pattern: &quot;sh|sz&quot;</span><br><span class="line">    # 如果 请求头 Region = sh 或 Region = sz ，就路由到金丝雀版本；如果 Region != sz 并且 Region != sz ，就永远不会路由到金丝雀版本。</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: &quot;nginx&quot;</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: v2-service</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#测试：</span><br><span class="line"></span><br><span class="line">curl -H &quot;Host: nginx.xudaxian.com&quot; http://192.168.10.135</span><br><span class="line"></span><br><span class="line">curl -H &quot;Host: nginx.xudaxian.com&quot; -H &quot;Region: sz&quot; http://192.10.135</span><br><span class="line"></span><br><span class="line">curl -H &quot;Host: nginx.xudaxian.com&quot; -H &quot;Region: sh&quot; http://192.10.135</span><br></pre></td></tr></table></figure>

<h5 id="基于-Cookie-的流量切分"><a href="#基于-Cookie-的流量切分" class="headerlink" title="基于 Cookie 的流量切分"></a>基于 Cookie 的流量切分</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-canary</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/canary: &quot;true&quot; # 开启金丝雀 </span><br><span class="line">    nginx.ingress.kubernetes.io/canary-by-cookie: &quot;vip&quot; # 如果 cookie 是 vip = always ，就会路由到到金丝雀版本；如果 cookie 是 vip = never ，就永远不会路由到金丝雀的版本。</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: &quot;nginx&quot;</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: v2-service</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#验证：</span><br><span class="line">curl -H &quot;Host: nginx.xudaxian.com&quot; --cookie &quot;vip=always&quot; http://192.168.10.135</span><br></pre></td></tr></table></figure>



<h5 id="基于服务权重的流量切分"><a href="#基于服务权重的流量切分" class="headerlink" title="基于服务权重的流量切分"></a>基于服务权重的流量切分</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-canary</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/canary: &quot;true&quot; # 开启金丝雀 </span><br><span class="line">    nginx.ingress.kubernetes.io/canary-weight: &quot;10&quot; # 基于服务权重</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: &quot;nginx&quot;</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xudaxian.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: v2-service</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#验证</span><br><span class="line">for i in &#123;1..10&#125;; do curl -H &quot;Host: nginx.xudaxian.com&quot; http://192.168.10.135; done;</span><br></pre></td></tr></table></figure>

<h2 id="NetworkPolicy（网络策略）"><a href="#NetworkPolicy（网络策略）" class="headerlink" title="NetworkPolicy（网络策略）"></a>NetworkPolicy（网络策略）</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/">网络策略</a>指的是 Pod 间的网络隔离策略，默认情况下是互通的。</p>
<p>Pod  之间的互通是通过如下三个标识符的组合来辨识的： </p>
<ul>
<li><ul>
<li>① 其他被允许的 Pod（例外：Pod 无法阻塞对自身的访问）。</li>
</ul>
</li>
<li><ul>
<li>② 被允许的名称空间。</li>
</ul>
</li>
<li><ul>
<li>③ IP 组块（例外：与 Pod 运行所在的节点的通信总是被允许的， 无论 Pod 或节点的 IP 地址）。</li>
</ul>
</li>
</ul>
<p><img src="C:\Users\32625\OneDrive\图片\k8s\42.png"></p>
<h3 id="pod的隔离与非隔离"><a href="#pod的隔离与非隔离" class="headerlink" title="pod的隔离与非隔离"></a>pod的隔离与非隔离</h3><ul>
<li><p>默认情况下，Pod 都是非隔离的（non-isolated），可以接受来自任何请求方的网络请求。 </p>
</li>
<li><p>如果一个 NetworkPolicy 的标签选择器选中了某个 Pod，则该 Pod 将变成隔离的（isolated），并将拒绝任何不被 NetworkPolicy 许可的网络连接。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: networkpol-01</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  podSelector: # Pod 选择器</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx  # 选中的 Pod 就被隔离起来了</span><br><span class="line">  policyTypes: # 策略类型</span><br><span class="line">  - Ingress # Ingress 入站规则、Egress 出站规则</span><br><span class="line">  - Egress </span><br><span class="line">  ingress: # 入站白名单，什么能访问我</span><br><span class="line">  - from:</span><br><span class="line">    - podSelector: # 选中的 Pod 可以访问 spec.matchLabels 中筛选的 Pod </span><br><span class="line">        matchLabels:</span><br><span class="line">          access: granted</span><br><span class="line">    ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">  egress: # 出站白名单，我能访问什么</span><br><span class="line">    - to:</span><br><span class="line">       - podSelector: # spec.matchLabels 中筛选的 Pod 能访问的 Pod</span><br><span class="line">          matchLabels:</span><br><span class="line">            app: tomcat</span><br><span class="line">       - namespaceSelector: </span><br><span class="line">          matchLabels:</span><br><span class="line">            kubernetes.io/metadata.name: dev # spec.matchLabels 中筛选的 Pod 能访问 dev 命名空间下的所有</span><br><span class="line">      ports:</span><br><span class="line">      - protocol: TCP</span><br><span class="line">        port: 8080</span><br></pre></td></tr></table></figure>



<h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#default-policies">https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#default-policies</a></p>
<h1 id="配置和存储"><a href="#配置和存储" class="headerlink" title="配置和存储"></a>配置和存储</h1><ul>
<li><p><strong>容器的生命周期可能很短，会被频繁的创建和销毁。那么容器在销毁的时候，保存在容器中的数据也会被清除。这种结果对用户来说，在某些情况下是不乐意看到的。为了持久化保存容器中的数据，Kubernetes 引入了 Volume 的概念。和 Docker 中的卷管理（匿名卷、具名卷、自定义挂载目录，都是挂载在本机，功能非常有限）不同的是，Kubernetes 天生就是集群，所以为了方便管理，Kubernetes 将 <code>卷</code> 抽取为一个对象资源，这样可以更方便的管理和存储数据。</strong></p>
</li>
<li><p><strong>Volume 是 Pod 中能够被多个容器访问的共享目录，它被定义在 Pod 上，然后被一个 Pod 里面的多个容器挂载到具体的文件目录下，Kubernetes 通过 Volume 实现同一个 Pod 中不同容器之间的数据共享以及数据的持久化存储。Volume 的生命周期不和 Pod 中的单个容器的生命周期有关，当容器终止或者重启的时候，Volume 中的数据也不会丢失</strong></p>
<p><img src="C:\Users\32625\OneDrive\图片\k8s\1.png"></p>
</li>
</ul>
<h2 id="k8s支持的Volume类型"><a href="#k8s支持的Volume类型" class="headerlink" title="k8s支持的Volume类型"></a>k8s支持的Volume类型</h2><h3 id="非持久性存储："><a href="#非持久性存储：" class="headerlink" title="非持久性存储："></a>非持久性存储：</h3><ul>
<li><ul>
<li>emptyDir</li>
</ul>
</li>
<li><ul>
<li>HostPath</li>
</ul>
</li>
</ul>
<h3 id="网络连接性存储："><a href="#网络连接性存储：" class="headerlink" title="网络连接性存储："></a>网络连接性存储：</h3><ul>
<li><ul>
<li>SAN：iSCSI、ScaleIO Volumes、FC (Fibre Channel)</li>
</ul>
</li>
<li><ul>
<li>NFS：nfs，cfs</li>
</ul>
</li>
</ul>
<h3 id="分布式存储"><a href="#分布式存储" class="headerlink" title="分布式存储"></a>分布式存储</h3><ul>
<li><ul>
<li>Glusterfs</li>
</ul>
</li>
<li><ul>
<li>RBD (Ceph Block Device)</li>
</ul>
</li>
<li><ul>
<li>CephFS</li>
</ul>
</li>
<li><ul>
<li>Portworx Volumes</li>
</ul>
</li>
<li><ul>
<li>Quobyte Volumes</li>
</ul>
</li>
</ul>
<h3 id="云端存储"><a href="#云端存储" class="headerlink" title="云端存储"></a>云端存储</h3><ul>
<li><ul>
<li>GCEPersistentDisk</li>
</ul>
</li>
<li><ul>
<li>AWSElasticBlockStore</li>
</ul>
</li>
<li><ul>
<li>AzureFile</li>
</ul>
</li>
<li><ul>
<li>AzureDisk</li>
</ul>
</li>
<li><ul>
<li>Cinder (OpenStack block storage)</li>
</ul>
</li>
<li><ul>
<li>VsphereVolume</li>
</ul>
</li>
<li><ul>
<li>StorageOS</li>
</ul>
</li>
</ul>
<h3 id="自定义存储"><a href="#自定义存储" class="headerlink" title="自定义存储"></a>自定义存储</h3><ul>
<li><ul>
<li>FlexVolume</li>
</ul>
</li>
</ul>
<p>![](C:\Users\32625\OneDrive\图片\k8s\2 (2).png)</p>
<h2 id="Secrat"><a href="#Secrat" class="headerlink" title="Secrat"></a>Secrat</h2><ul>
<li>Secret 对象类型用来保存敏感信息，如：密码、OAuth2 令牌以及 SSH 密钥等。将这些信息放到 Secret 中比放在 Pod 的定义或者容器镜像中更加安全和灵活。</li>
<li>由于创建 Secret 可以独立于使用它们的 Pod， 因此在创建、查看和编辑 Pod 的工作流程中暴露 Secret（及其数据）的风险较小。 Kubernetes 和在集群中运行的应用程序也可以对 Secret 采取额外的预防措施，如：避免将机密数据写入非易失性存储。</li>
<li>Secret 类似于 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMap</a> 但专门用于保存机密数据。</li>
</ul>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;damin&#x27; | base64 #输出</span><br><span class="line">YWRtaW4K #加密</span><br><span class="line">echo &#x27;YWRtaW4K&#x27; | base64 --decode #解除加密</span><br><span class="line">damin</span><br></pre></td></tr></table></figure>

<h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><table>
<thead>
<tr>
<th>内置类型</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td><code>Opaque</code></td>
<td>用户定义的任意数据</td>
</tr>
<tr>
<td><code>kubernetes.io/service-account-token</code></td>
<td>服务账号令牌</td>
</tr>
<tr>
<td><code>kubernetes.io/dockercfg</code></td>
<td><code>~/.dockercfg</code> 文件的序列化形式</td>
</tr>
<tr>
<td><code>kubernetes.io/dockerconfigjson</code></td>
<td><code>~/.docker/config.json</code> 文件的序列化形式</td>
</tr>
<tr>
<td><code>kubernetes.io/basic-auth</code></td>
<td>用于基本身份认证的凭据</td>
</tr>
<tr>
<td><code>kubernetes.io/ssh-auth</code></td>
<td>用于 SSH 身份认证的凭据</td>
</tr>
<tr>
<td><code>kubernetes.io/tls</code></td>
<td>用于 TLS 客户端或者服务器端的数据</td>
</tr>
<tr>
<td><code>bootstrap.kubernetes.io/token</code></td>
<td>启动引导令牌数据</td>
</tr>
</tbody></table>
<ul>
<li><p>要使用 Secret，Pod 需要引用 Secret。 Pod 可以用三种方式之一来使用 Secret ： </p>
</li>
<li><ul>
<li>作为挂载到一个或多个容器上的 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">卷</a> 中的<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets-as-files-from-a-pod">文件</a>。（volume进行挂载）</li>
</ul>
</li>
<li><ul>
<li>作为<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets-as-environment-variables">容器的环境变量</a>（envFrom字段引用）</li>
</ul>
</li>
<li><ul>
<li>由 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-imagepullsecrets">kubelet 在为 Pod 拉取镜像时使用</a>（此时Secret是docker-registry类型的）</li>
</ul>
</li>
<li><p>Secret 对象的名称必须是合法的 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/names#dns-subdomain-names">DNS 子域名</a>。 在为创建 Secret 编写配置文件时，你可以设置 <code>data</code> 与&#x2F;或 <code>stringData</code> 字段。 <code>data</code> 和 <code>stringData</code> 字段都是可选的。<code>data</code> 字段中所有键值都必须是 base64 编码的字符串。如果不希望执行这种 base64 字符串的转换操作，你可以选择设置 <code>stringData</code> 字段，其中可以使用任何字符串作为其取值。</p>
</li>
</ul>
<h3 id="使用命令创建Secret"><a href="#使用命令创建Secret" class="headerlink" title="使用命令创建Secret"></a>使用命令创建Secret</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic secret-1 \</span><br><span class="line">   --from-literal=username=admin \</span><br><span class="line">   --from-literal=password=123456</span><br></pre></td></tr></table></figure>

<p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-01 164616.png)</p>
<h3 id="yaml格式创建Secret"><a href="#yaml格式创建Secret" class="headerlink" title="yaml格式创建Secret"></a>yaml格式创建Secret</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: vol-secret</span><br><span class="line">  namespace: default</span><br><span class="line">type:</span><br><span class="line">stringData: #k8s自动加密</span><br><span class="line">      username: admin</span><br><span class="line">      password: &quot;123456&quot;</span><br><span class="line">#如果同时使用deta和stringDta,data会被忽略</span><br></pre></td></tr></table></figure>

<h4 id="提取"><a href="#提取" class="headerlink" title="提取"></a>提取</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get  secret vol-secret -o yaml</span><br></pre></td></tr></table></figure>

<p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-01 181508.png)</p>
<h3 id="环境变量的引用"><a href="#环境变量的引用" class="headerlink" title="环境变量的引用"></a>环境变量的引用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: my-secret</span><br><span class="line">  namespace: default</span><br><span class="line">type: Opaque</span><br><span class="line">stringData: </span><br><span class="line">  username: admin</span><br><span class="line">  password: &quot;1234556&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-secret</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: pod-secret</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: alpine</span><br><span class="line">    image: alpine</span><br><span class="line">    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    env:</span><br><span class="line">    - name: SECRET_USERNAME # 容器中的环境变量名称</span><br><span class="line">      valueFrom:</span><br><span class="line">        secretKeyRef: </span><br><span class="line">          name: my-secret #  指定 secret 的名称</span><br><span class="line">          key: username # secret 中 key 的名称，会自动 base64 解码</span><br><span class="line">    - name: SECRET_PASSWORD # 容器中的环境变量名称</span><br><span class="line">      valueFrom:</span><br><span class="line">        secretKeyRef:</span><br><span class="line">          name: my-secret #  指定 secret 的名称</span><br><span class="line">          key: password # secret 中 key 的名称   </span><br><span class="line">    - name: POD_NAME</span><br><span class="line">      valueFrom: </span><br><span class="line">        fieldRef:  # 属性引用</span><br><span class="line">          fieldPath: metadata.name</span><br><span class="line">    - name: POD_LIMITS_MEMORY</span><br><span class="line">      valueFrom:</span><br><span class="line">        resourceFieldRef:  # 资源限制引用 </span><br><span class="line">          containerName: alpine  </span><br><span class="line">          resource: limits.memory       </span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure>

<h3 id="挂载卷"><a href="#挂载卷" class="headerlink" title="挂载卷"></a>挂载卷</h3><p>注意：</p>
<ul>
<li><p>如果 Secret 以卷挂载的方式，Secret 里面的所有 key 都是文件名，内容就是 key 对应的值。</p>
</li>
<li><p>如果 Secret 以卷挂载的方式，Secret 的内容更新，那么容器对应的值也会被更新（subPath 引用除外）。</p>
</li>
<li><p>如果 Secret 以卷挂载的方式，默认情况下，挂载出来的文件是只读的。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: my-secret</span><br><span class="line">  namespace: default</span><br><span class="line">type: Opaque</span><br><span class="line">stringData: </span><br><span class="line">  username: admin</span><br><span class="line">  password: &quot;1234556&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-secret</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: pod-secret</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: alpine</span><br><span class="line">    image: alpine</span><br><span class="line">    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi     </span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: app</span><br><span class="line">      mountPath: /app  </span><br><span class="line">  volumes:</span><br><span class="line">    - name: app</span><br><span class="line">      secret:</span><br><span class="line">        secretName: my-secret # secret 的名称，Secret 中的所有 key 全部挂载出来</span><br><span class="line">        items:</span><br><span class="line">          - key: username # secret 中 key 的名称，Secret 中的 username 的内容挂载出来</span><br><span class="line">            path: username.md # 在容器内挂载出来的文件的路径</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure>

<h2 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h2><ul>
<li>ConfigMap与Secret相似，但是Secret会将base 64进行编码和解码，而ConfigMap则不会</li>
</ul>
<h3 id="yaml格式创建"><a href="#yaml格式创建" class="headerlink" title="yaml格式创建"></a>yaml格式创建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: cm</span><br><span class="line">  namespace: default</span><br><span class="line">data:</span><br><span class="line">  # 类属性键；每一个键都映射到一个简单的值</span><br><span class="line">  player_initial_lives: &quot;3&quot;</span><br><span class="line">  ui_properties_file_name: &quot;user-interface.properties&quot;</span><br><span class="line">  # 类文件键</span><br><span class="line">  game.properties: |</span><br><span class="line">    enemy.types=aliens,monsters</span><br><span class="line">    player.maximum-lives=5    </span><br><span class="line">  user-interface.properties: |</span><br><span class="line">    color.good=purple</span><br><span class="line">    color.bad=yellow</span><br><span class="line">    allow.textmode=true </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: &quot;pod-cm&quot;</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: &quot;pod-cm&quot;</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: alpine</span><br><span class="line">    image: &quot;alpine&quot;</span><br><span class="line">    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    env:</span><br><span class="line">    - name: PLAYER_INITIAL_LIVES</span><br><span class="line">      valueFrom:</span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: cm</span><br><span class="line">          key: player_initial_lives</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: app</span><br><span class="line">      mountPath: /app  </span><br><span class="line">  volumes:</span><br><span class="line">    - name: app</span><br><span class="line">      configMap:</span><br><span class="line">        name: cm # secret 的名称，Secret 中的所有 key 全部挂载出来</span><br><span class="line">        items:</span><br><span class="line">          - key: ui_properties_file_name # secret 中 key 的名称，Secret 中的 ui_properties_file_name 的内容挂载出来</span><br><span class="line">            path: ui_properties_file_name.md # 在容器内挂载出来的文件的路径</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li><p>ConfigMap 和 Secret 一样，环境变量引用不会热更新，而卷挂载是可以热更新的。</p>
</li>
<li><p>最新版本的 ConfigMap 和 Secret 提供了不可更改的功能，即禁止热更新，只需要在 Secret 或 ConfigMap 中设置 <code>immutable = true</code> 。</p>
</li>
</ul>
<h3 id="结合-SpringBoot-做到生产配置无感知"><a href="#结合-SpringBoot-做到生产配置无感知" class="headerlink" title="结合 SpringBoot 做到生产配置无感知"></a>结合 SpringBoot 做到生产配置无感知</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/png/513185/1648538977212-715a4ba9-6e3a-45ba-aecc-dd7541dbf870.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_39,text_6K645aSn5LuZ,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h2 id="临时存储"><a href="#临时存储" class="headerlink" title="临时存储"></a>临时存储</h2><ul>
<li><p>Kubernetes 为了不同的目的，支持几种不同类型的临时卷： </p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#emptydir">emptyDir</a>： Pod 启动时为空，存储空间来自本地的 kubelet 根目录（通常是根磁盘）或内存</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#configmap">configMap</a>、 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#downwardapi">downwardAPI</a>、 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#secret">secret</a>： 将不同类型的 Kubernetes 数据注入到 Pod 中</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#csi-ephemeral-volumes">CSI 临时卷</a>： 类似于前面的卷类型，但由专门<a target="_blank" rel="noopener" href="https://kubernetes-csi.github.io/docs/drivers.html">支持此特性</a> 的指定 <a target="_blank" rel="noopener" href="https://github.com/container-storage-interface/spec/blob/master/spec.md">CSI 驱动程序</a>提供</p>
</li>
<li><p>通用临时卷](<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/ephemeral-volumes/#generic-ephemeral-volumes)%EF%BC%9A">https://kubernetes.io/zh/docs/concepts/storage/ephemeral-volumes/#generic-ephemeral-volumes)：</a> 它可以由所有支持持久卷的存储驱动程序提供</p>
</li>
</ul>
</li>
<li><p><code>emptyDir</code>、<code>configMap</code>、<code>downwardAPI</code>、<code>secret</code> 是作为 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/manage-resources-containers/#local-ephemeral-storage">本地临时存储</a> 提供的。它们由各个节点上的 kubelet 管理。</p>
</li>
<li><p>CSI 临时卷 <code>必须</code> 由第三方 CSI 存储驱动程序提供。</p>
</li>
<li><p>通用临时卷 <code>可以</code>  由第三方 CSI 存储驱动程序提供，也可以由支持动态配置的任何其他存储驱动程序提供。 一些专门为 CSI 临时卷编写的 CSI 驱动程序，不支持动态供应：因此这些驱动程序不能用于通用临时卷。</p>
</li>
<li><p>使用第三方驱动程序的优势在于，它们可以提供 Kubernetes 本身不支持的功能， 例如，与 kubelet 管理的磁盘具有不同运行特征的存储，或者用来注入不同的数据。</p>
</li>
</ul>
<h3 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h3><ul>
<li><p><code>emptyDir</code> 的一些用途： </p>
</li>
<li><ul>
<li>临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留。</li>
</ul>
</li>
<li><ul>
<li>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）。</li>
</ul>
</li>
<li><p><code>emptyDir</code> 卷存储在该节点的磁盘或内存中，如果设置 <code>emptyDir.medium = Memory</code> ，那么就告诉 Kubernetes 将数据保存在内存中，并且在 Pod 被重启或删除前，所写入的所有文件都会计入容器的内存消耗，受到容器内存限制约束</p>
<p><img src="C:\Users\32625\OneDrive\图片\k8s\17.png"></p>
</li>
<li><p><strong>Pod 分派到某个 Node 上时，<code>emptyDir</code> 卷会被创建，并且在 Pod 在该节点上运行期间，卷一直存在。</strong></p>
</li>
<li><p><strong>就像其名称表示的那样，卷最初是空的。</strong></p>
</li>
<li><p><strong>尽管 Pod 中的容器挂载 <code>emptyDir</code> 卷的路径可能相同也可能不同，这些容器都可以读写 <code>emptyDir</code> 卷中相同的文件。</strong></p>
</li>
<li><p><strong>当 Pod 因为某些原因被从节点上删除时，<code>emptyDir</code> 卷中的数据也会被永久删除</strong>。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-empty-dir</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-empty-dir</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi    </span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: app</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">  - name: alpine</span><br><span class="line">    image: alpine</span><br><span class="line">    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;while true;do sleep 1; date &gt; /app/index.html;done&quot;]</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi    </span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: app</span><br><span class="line">      mountPath: /app     </span><br><span class="line">  volumes:</span><br><span class="line">    - name: app</span><br><span class="line">      emptyDir: &#123;&#125; # emptyDir 临时存储</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure>

<h3 id="hostPath"><a href="#hostPath" class="headerlink" title="hostPath"></a>hostPath</h3><ul>
<li><p>emptyDir 中的数据不会被持久化，它会随着 Pod 的结束而销毁，如果想要<code>简单</code>的将数据持久化到主机中，可以选择 hostPath 。</p>
</li>
<li><p>hostPath  就是将 Node 主机中的一个实际目录挂载到 Pod 中，以供容器使用，这样的设计就可以保证 Pod 销毁了，但是数据依旧可以保存在 Node 主机上。</p>
</li>
</ul>
<p>注意：hostPath 之所以被归为临时存储，是因为实际开发中，我们一般都是通过 Deployment 部署 Pod 的，一旦 Pod 被 Kubernetes 杀死或重启拉起等，并不一定会部署到原来的 Node 节点中。</p>
<ul>
<li>除了必需的 <code>path</code> 属性之外，用户可以选择性地为 <code>hostPath</code> 卷指定 <code>typ</code></li>
</ul>
<table>
<thead>
<tr>
<th>取值</th>
<th>行为</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>空字符串（默认）用于向后兼容，这意味着在安装 hostPath 卷之前不会执行任何检查。</td>
</tr>
<tr>
<td><code>DirectoryOrCreate</code></td>
<td>如果在给定路径上什么都不存在，那么将根据需要创建空目录，权限设置为 0755，具有与 kubelet 相同的组和属主信息。</td>
</tr>
<tr>
<td><code>Directory</code></td>
<td>在给定路径上必须存在的目录。</td>
</tr>
<tr>
<td><code>FileOrCreate</code></td>
<td>如果在给定路径上什么都不存在，那么将在那里根据需要创建空文件，权限设置为 0644，具有与 kubelet 相同的组和所有权。</td>
</tr>
<tr>
<td><code>File</code></td>
<td>在给定路径上必须存在的文件。</td>
</tr>
<tr>
<td><code>Socket</code></td>
<td>在给定路径上必须存在的 UNIX 套接字。</td>
</tr>
<tr>
<td><code>CharDevice</code></td>
<td>在给定路径上必须存在的字符设备。</td>
</tr>
<tr>
<td><code>BlockDevice</code></td>
<td>在给定路径上必须存在的块设备。</td>
</tr>
<tr>
<td>注意：hostPath 的典型应用就是时间同步：通常而言，Node 节点的时间是同步的（云厂商提供的云服务器的时间都是同步的），但是，Pod 中的容器的时间就不一定了，有 UTC 、CST 等；同一个 Pod ，如果部署到中国，就必须设置为 CST 了。</td>
<td></td>
</tr>
</tbody></table>
<h4 id="配置文件-5"><a href="#配置文件-5" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-host-path</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx    </span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath: # hostPath</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure>

<h2 id="持久化存储"><a href="#持久化存储" class="headerlink" title="持久化存储"></a>持久化存储</h2><h3 id="volume"><a href="#volume" class="headerlink" title="volume"></a>volume</h3><ul>
<li><p>Kubernetes 支持很多类型的卷。 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod</a> 可以同时使用任意数目的卷类型。</p>
</li>
<li><p>临时卷类型的生命周期与 Pod 相同，但持久卷可以比 Pod 的存活期长。</p>
</li>
<li><p>当 Pod 不再存在时，Kubernetes 也会销毁临时卷。</p>
</li>
<li><p>Kubernetes 不会销毁 <code>持久卷</code> 。</p>
</li>
<li><p>对于给定 Pod 中 <code>任何类型的卷</code> ，在容器重启期间数据都不会丢失。</p>
</li>
<li><p>使用卷时, 在 <code>.spec.volumes</code> 字段中设置为 Pod 提供的卷，并在 <code>.spec.containers[*].volumeMounts</code> 字段中声明卷在容器中的挂载位置。</p>
</li>
</ul>
<h3 id="subPath"><a href="#subPath" class="headerlink" title="subPath"></a>subPath</h3><ul>
<li>有时，在单个 Pod 中共享卷以供多方使用是很有用的。 <code>volumeMounts.subPath</code> 属性可用于指定所引用的卷内的子路径，而不是其根路径。</li>
</ul>
<p>​       注意：ConfigMap 和 Secret 使用子路径挂载是无法热更新的。</p>
<h3 id="安装FNS"><a href="#安装FNS" class="headerlink" title="安装FNS"></a>安装FNS</h3><p>网络文件系统（Network File System <strong>[ NFS ]</strong> )，是由 <a target="_blank" rel="noopener" href="https://baike.baidu.com/item/SUN/69463">SUN </a>公司研制的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/UNIX/219943">UNIX</a><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%A1%A8%E7%A4%BA%E5%B1%82/4329716">表示层</a>协议(presentation layer protocol)，能使使用者访问网络上别处的文件就像在使用自己的计算机一样。</p>
<p><img src="C:\Users\32625\OneDrive\图片\k8s\20.png"></p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><h5 id="master节点执行的操作"><a href="#master节点执行的操作" class="headerlink" title="master节点执行的操作"></a>master节点执行的操作</h5><p>以 Master （192.168.10.137）节点作为 NFS 服务端：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils</span><br></pre></td></tr></table></figure>

<p>创建 &#x2F;etc&#x2F;exports 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># * 表示暴露权限给所有主机；* 也可以使用 192.168.0.0/16 代替，表示暴露给所有主机</span><br><span class="line">echo &quot;/nfs/data/ *(insecure,rw,sync,no_root_squash)&quot; &gt; /etc/exports</span><br></pre></td></tr></table></figure>

<p>创建 <code>/nfs/data/</code> （共享目录）目录，并设置权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -pv /nfs/data/</span><br><span class="line"></span><br><span class="line">chmod 777 -R /nfs/data/</span><br></pre></td></tr></table></figure>

<p>启动NFS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable rpcbind</span><br><span class="line"></span><br><span class="line">systemctl enable nfs-server</span><br><span class="line"></span><br><span class="line">systemctl start rpcbind</span><br><span class="line"></span><br><span class="line">systemctl start nfs-server</span><br></pre></td></tr></table></figure>

<p>在Master节点上加载配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exportfs -r</span><br></pre></td></tr></table></figure>

<p>检查配置是否生效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exportfs</span><br></pre></td></tr></table></figure>

<p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-04 190202.png)</p>
<h5 id="node节点上执行的操作"><a href="#node节点上执行的操作" class="headerlink" title="node节点上执行的操作"></a>node节点上执行的操作</h5><p>在node（192.168.10.135 &#x2F; 192.168.10.136)节点上安装nfs-utils</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 服务器端防火墙开放111、662、875、892、2049的 tcp / udp 允许，否则远端客户无法连接。</span><br><span class="line">yum install -y nfs-utils</span><br></pre></td></tr></table></figure>

<p>执行以下命令检查 nfs 服务器端是否有设置共享目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># showmount -e &lt;nfs服务器的ip&gt;</span><br><span class="line">showmount -e 192.168.10.137</span><br></pre></td></tr></table></figure>

<p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-04 191711.png)</p>
<p>执行以下命令挂载 nfs 服务器上的共享目录到本机路径 <code>/root/nd</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /nd</span><br><span class="line"></span><br><span class="line"># mount -t nfs &lt;nfs服务器的IP&gt;:/root/nfs_root /root/nfsmount</span><br><span class="line">mount -t nfs 192.168.10.137:/nfs/data /nd</span><br></pre></td></tr></table></figure>

<p>在node节点写入一个测试文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;hello nfs server&quot; &gt; /nd/test.txt</span><br></pre></td></tr></table></figure>

<p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-04 192359.png)</p>
<p>在master节点验证文件是否写入成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /nfs/data/test.txt</span><br></pre></td></tr></table></figure>

<p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-04 192355.png)</p>
<h3 id="配置文件-6"><a href="#配置文件-6" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">    - name: html  </span><br><span class="line">      mountPath: /usr/share/nginx/html/ # / 一定是文件夹</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">    - name: html </span><br><span class="line">      nfs: # 使用 nfs 存储驱动</span><br><span class="line">        path: /nfs/data  # nfs 共享的目录</span><br><span class="line">        server:  192.168.65.100  # nfs 服务端的 IP 地址或 hostname </span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure>

<h1 id="调度原理"><a href="#调度原理" class="headerlink" title="调度原理"></a>调度原理</h1><h2 id="ResourceQuotas（资源配额）"><a href="#ResourceQuotas（资源配额）" class="headerlink" title="ResourceQuotas（资源配额）"></a>ResourceQuotas（资源配额）</h2><ul>
<li><p>当多个用户或团队共享具有固定节点数目的集群时，人们会担心 <code>有人使用超过其基于公平原则所分配到的资源量</code> 。<br>  资源配额是帮助管理员解决这一问题的工具。 </p>
</li>
<li><p>资源配额，通过 <code>ResourceQuota</code> 对象来定义，<code>对每个命名空间的资源消耗总量提供限制</code>。 它可以 <code>限制</code> 命名空间中 <code>某种类型的对象的总数目上限</code>，<code>也可以限制命令空间中的 Pod 可以使用的计算资源的总上限</code>。 </p>
</li>
<li><p>资源配额的工作方式如下： </p>
</li>
<li><ul>
<li>不同的团队可以在不同的命名空间下工作，目前这是非约束性的，在未来的版本中可能会通过 ACL (Access Control List 访问控制列表) 来实现强制性约束。</li>
</ul>
</li>
<li><ul>
<li><code>集群管理员可以为每个命名空间创建一个或多个 ResourceQuota 对象</code>。</li>
</ul>
</li>
<li><ul>
<li>当用户在命名空间下创建资源（如 Pod、Service 等）时，Kubernetes 的配额系统会跟踪集群的资源使用情况，<code>以确保使用的资源用量不超过 ResourceQuota 中定义的硬性资源限额</code>。</li>
</ul>
</li>
<li><ul>
<li>如果资源创建或者更新请求违反了配额约束，那么该请求会报错（HTTP 403 FORBIDDEN）， 并在消息中给出有可能违反的约束。</li>
</ul>
</li>
<li><ul>
<li>如果命名空间下的计算资源 （如 <code>cpu</code> 和 <code>memory</code>）的<code>配额被启用</code>，则<code>用户必须为 这些资源设定请求值（request）和约束值（limit）</code>，否则配额系统将拒绝 Pod 的创建。 提示: 可使用 <code>LimitRanger</code> 准入控制器来为没有设置计算资源需求的 Pod 设置默认值。</li>
</ul>
</li>
</ul>
<h3 id="计算资源配额"><a href="#计算资源配额" class="headerlink" title="计算资源配额"></a>计算资源配额</h3><ul>
<li>用户可以对给定命名空间下的可被请求的 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/manage-resources-containers/">计算资源</a> 总量进行限制。</li>
</ul>
<table>
<thead>
<tr>
<th><code>limits.cpu</code></th>
<th>所有非终止状态的 Pod，其 CPU 限额总量不能超过该值。</th>
</tr>
</thead>
<tbody><tr>
<td><code>limits.memory</code></td>
<td>所有非终止状态的 Pod，其内存限额总量不能超过该值。</td>
</tr>
<tr>
<td><code>requests.cpu</code></td>
<td>所有非终止状态的 Pod，其 CPU 需求总量不能超过该值。</td>
</tr>
<tr>
<td><code>requests.memory</code></td>
<td>所有非终止状态的 Pod，其内存需求总量不能超过该值。</td>
</tr>
<tr>
<td><code>hugepages-&lt;size&gt;</code></td>
<td>对于所有非终止状态的 Pod，针对指定尺寸的巨页请求总数不能超过此值。</td>
</tr>
<tr>
<td><code>cpu</code></td>
<td>与 <code>requests.cpu</code> 相同。</td>
</tr>
<tr>
<td><code>memory</code></td>
<td>与 <code>requests.memory</code> 相同。</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ResourceQuota</span><br><span class="line">metadata:</span><br><span class="line">  name: mem-cpu</span><br><span class="line">  namespace: default # 限制 default 名称空间</span><br><span class="line">spec:</span><br><span class="line">  hard:</span><br><span class="line">    requests.cpu: &quot;1&quot;</span><br><span class="line">    requests.memory: 1Gi</span><br><span class="line">    limits.cpu: &quot;2&quot;</span><br><span class="line">    limits.memory: 2Gi</span><br></pre></td></tr></table></figure>

<h3 id="扩展资源的资源配额"><a href="#扩展资源的资源配额" class="headerlink" title="扩展资源的资源配额"></a>扩展资源的资源配额</h3><p>●除上述资源外，在 Kubernetes 1.10 版本中，还添加了对 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/manage-resources-containers/#extended-resources">扩展资源</a> 的支持。<br>●由于扩展资源不可超量分配，因此没有必要在配额中为同一扩展资源同时指定 requests 和 limits。 对于扩展资源而言，目前仅允许使用前缀为 requests. 的配额项。<br>●以 GPU 拓展资源为例，如果资源名称为 nvidia.com&#x2F;gpu，并且要将命名空间中请求的 GPU 资源总数限制为 4，则可以如下定义配额：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requests.nvidia.com/gpu: 4</span><br></pre></td></tr></table></figure>

<p>**有关更多详细信息，请参阅官方文档<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/policy/resource-quotas/#viewing-and-setting-quotas">查看和设置配额</a>**。</p>
<h3 id="存储资源配额"><a href="#存储资源配额" class="headerlink" title="存储资源配额"></a>存储资源配额</h3><ul>
<li><p>用户可以对给定命名空间下的 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/">存储资源</a> 总量进行限制。</p>
</li>
<li><p>此外，还可以根据相关的存储类（Storage Class）来限制存储资源的消耗。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>资源名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>requests.storage</code></td>
<td>所有 PVC，存储资源的需求总量不能超过该值。</td>
</tr>
<tr>
<td><code>persistentvolumeclaims</code></td>
<td>在该命名空间中所允许的 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">PVC</a> 总量。</td>
</tr>
<tr>
<td><code>&lt;storage-class-name&gt;.storageclass.storage.k8s.io/requests.storage</code></td>
<td>在所有与 <code>&lt;storage-class-name&gt;</code> 相关的持久卷申领中，存储请求的总和不能超过该值。</td>
</tr>
<tr>
<td><code>&lt;storage-class-name&gt;.storageclass.storage.k8s.io/persistentvolumeclaims</code></td>
<td>在与 storage-class-name 相关的所有持久卷申领中，命名空间中可以存在的<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">持久卷申领</a>总数。</td>
</tr>
</tbody></table>
<ul>
<li><p>例如，如果一个操作人员针对 <code>gold</code> 存储类型与 <code>bronze</code> 存储类型设置配额， 操作人员可以定义如下配额： </p>
</li>
<li><ul>
<li><code>gold.storageclass.storage.k8s.io/requests.storage: 500Gi</code></li>
</ul>
</li>
<li><ul>
<li><code>bronze.storageclass.storage.k8s.io/requests.storage: 100Gi</code></li>
</ul>
</li>
<li><p>在 Kubernetes 1.8 版本中，本地临时存储的配额支持已经是 Alpha 功能：</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>资源名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>requests.ephemeral-storage</code></td>
<td>在命名空间的所有 Pod 中，本地临时存储请求的总和不能超过此值。</td>
</tr>
<tr>
<td><code>limits.ephemeral-storage</code></td>
<td>在命名空间的所有 Pod 中，本地临时存储限制值的总和不能超过此值。</td>
</tr>
<tr>
<td><code>ephemeral-storage</code></td>
<td>与 <code>requests.ephemeral-storage</code> 相同。</td>
</tr>
</tbody></table>
<p><strong>注意：如果所使用的是 CRI 容器运行时，容器日志会被计入临时存储配额。 这可能会导致存储配额耗尽的 Pods 被意外地驱逐出节点。 参考<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/cluster-administration/logging/">日志架构</a> 了解详细信息。</strong></p>
<h3 id="对象数量配额"><a href="#对象数量配额" class="headerlink" title="对象数量配额"></a>对象数量配额</h3><ul>
<li><p>你可以使用以下语法对所有标准的、命名空间域的资源类型进行配额设置： </p>
</li>
<li><ul>
<li><code>count/&lt;resource&gt;.&lt;group&gt;</code>：用于非核心（core）组的资源。</li>
</ul>
</li>
<li><ul>
<li><code>count/&lt;resource&gt;</code>：用于核心组的资源。</li>
</ul>
</li>
<li><p>这是用户可能希望利用对象计数配额来管理的一组资源示例。 </p>
</li>
<li><ul>
<li><code>count/persistentvolumeclaims</code></li>
</ul>
</li>
<li><ul>
<li><code>count/services</code></li>
</ul>
</li>
<li><ul>
<li><code>count/secrets</code></li>
</ul>
</li>
<li><ul>
<li><code>count/configmaps</code></li>
</ul>
</li>
<li><ul>
<li><code>count/replicationcontrollers</code></li>
</ul>
</li>
<li><ul>
<li><code>count/deployments.apps</code></li>
</ul>
</li>
<li><ul>
<li><code>count/replicasets.apps</code></li>
</ul>
</li>
<li><ul>
<li><code>count/statefulsets.apps</code></li>
</ul>
</li>
<li><ul>
<li><code>count/jobs.batch</code></li>
</ul>
</li>
<li><ul>
<li><code>count/cronjobs.batch</code></li>
</ul>
</li>
<li><p>相同语法也可用于自定义资源。 例如，要对 <code>example.com</code> API 组中的自定义资源 <code>widgets</code> 设置配额，请使用 <code>count/widgets.example.com</code>。 </p>
</li>
<li><p>当使用 <code>count/*</code> 资源配额时，如果对象存在于服务器存储中，则会根据配额管理资源。 这些类型的配额有助于防止存储资源耗尽。例如，用户可能想根据服务器的存储能力来对服务器中 Secret 的数量进行配额限制。 集群中存在过多的 Secret 实际上会导致服务器和控制器无法启动。 用户可以选择对 Job 进行配额管理，以防止配置不当的 CronJob 在某命名空间中创建太多 Job 而导致集群拒绝服务。 </p>
</li>
<li><p>对有限的一组资源上实施一般性的对象数量配额也是可能的。 此外，还可以进一步按资源的类型设置其配额。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>资源名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>configmaps</code></td>
<td>在该命名空间中允许存在的 ConfigMap 总数上限。</td>
</tr>
<tr>
<td><code>persistentvolumeclaims</code></td>
<td>在该命名空间中允许存在的 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">PVC</a> 的总数上限。</td>
</tr>
<tr>
<td><code>pods</code></td>
<td>在该命名空间中允许存在的非终止状态的 Pod 总数上限。Pod 终止状态等价于 Pod 的 <code>.status.phase in (Failed, Succeeded)</code> 为真。</td>
</tr>
<tr>
<td><code>replicationcontrollers</code></td>
<td>在该命名空间中允许存在的 ReplicationController 总数上限。</td>
</tr>
<tr>
<td><code>resourcequotas</code></td>
<td>在该命名空间中允许存在的 ResourceQuota 总数上限。</td>
</tr>
<tr>
<td><code>services</code></td>
<td>在该命名空间中允许存在的 Service 总数上限。</td>
</tr>
<tr>
<td><code>services.loadbalancers</code></td>
<td>在该命名空间中允许存在的 LoadBalancer 类型的 Service 总数上限。</td>
</tr>
<tr>
<td><code>services.nodeports</code></td>
<td>在该命名空间中允许存在的 NodePort 类型的 Service 总数上限。</td>
</tr>
<tr>
<td><code>secrets</code></td>
<td>在该命名空间中允许存在的 Secret 总数上限。</td>
</tr>
</tbody></table>
<p> <strong>例如，<code>pods</code> 配额统计某个命名空间中所创建的、非终止状态的 <code>Pod</code> 个数并确保其不超过某上限值。 用户可能希望在某命名空间中设置 <code>pods</code> 配额，以避免有用户创建很多小的 Pod， 从而耗尽集群所能提供的 Pod IP 地址。</strong> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ResourceQuota</span><br><span class="line">metadata:</span><br><span class="line">  name: pods-rq</span><br><span class="line">  namespace: default # 限制 default 名称空间</span><br><span class="line">spec:</span><br><span class="line">  hard:</span><br><span class="line">    pods: &quot;3&quot; # 限制 Pod 的数量</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Pod 可以创建为特定的<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/pod-priority-preemption/#pod-priority">优先级</a>。 通过使用配额规约中的 <code>scopeSelector</code> 字段，用户可以根据 Pod 的优先级控制其系统资源消耗。 </p>
</li>
<li><p>仅当配额规范中的 <code>scopeSelector</code> 字段选择到某 Pod 时，配额机制才会匹配和计量 Pod 的资源消耗。 </p>
</li>
<li><p>如果配额对象通过 <code>scopeSelector</code> 字段设置其作用域为优先级类，则配额对象只能 跟踪以下资源： </p>
</li>
<li><ul>
<li><code>pods</code></li>
</ul>
</li>
<li><ul>
<li><code>cpu</code></li>
</ul>
</li>
<li><ul>
<li><code>memory</code></li>
</ul>
</li>
<li><ul>
<li><code>ephemeral-storage</code></li>
</ul>
</li>
<li><ul>
<li><code>limits.cpu</code></li>
</ul>
</li>
<li><ul>
<li><code>limits.memory</code></li>
</ul>
</li>
<li><ul>
<li><code>limits.ephemeral-storage</code></li>
</ul>
</li>
<li><ul>
<li><code>requests.cpu</code></li>
</ul>
</li>
<li><ul>
<li><code>requests.memory</code></li>
</ul>
</li>
<li><ul>
<li><code>requests.ephemeral-storage</code></li>
</ul>
</li>
</ul>
<p> <strong>示例：创建一个配额对象，并将其与具有特定优先级的 Pod 进行匹配</strong> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 集群中的 Pod 可取三个优先级类之一，即 &quot;low&quot;、&quot;medium&quot;、&quot;high&quot;</span><br><span class="line"># 为每个优先级创建一个配额对象</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: List</span><br><span class="line">items:</span><br><span class="line">- apiVersion: v1</span><br><span class="line">  kind: ResourceQuota</span><br><span class="line">  metadata:</span><br><span class="line">    name: pods-high</span><br><span class="line">  spec:</span><br><span class="line">    hard:</span><br><span class="line">      cpu: &quot;1000&quot;</span><br><span class="line">      memory: 200Gi</span><br><span class="line">      pods: &quot;10&quot;</span><br><span class="line">    scopeSelector:</span><br><span class="line">      matchExpressions:</span><br><span class="line">      - operator : In</span><br><span class="line">        scopeName: PriorityClass</span><br><span class="line">        values: [&quot;high&quot;]</span><br><span class="line">- apiVersion: v1</span><br><span class="line">  kind: ResourceQuota</span><br><span class="line">  metadata:</span><br><span class="line">    name: pods-medium</span><br><span class="line">  spec:</span><br><span class="line">    hard:</span><br><span class="line">      cpu: &quot;10&quot;</span><br><span class="line">      memory: 20Gi</span><br><span class="line">      pods: &quot;10&quot;</span><br><span class="line">    scopeSelector:</span><br><span class="line">      matchExpressions:</span><br><span class="line">      - operator : In</span><br><span class="line">        scopeName: PriorityClass</span><br><span class="line">        values: [&quot;medium&quot;]</span><br><span class="line">- apiVersion: v1</span><br><span class="line">  kind: ResourceQuota</span><br><span class="line">  metadata:</span><br><span class="line">    name: pods-low</span><br><span class="line">  spec:</span><br><span class="line">    hard:</span><br><span class="line">      cpu: &quot;5&quot;</span><br><span class="line">      memory: 10Gi</span><br><span class="line">      pods: &quot;10&quot;</span><br><span class="line">    scopeSelector:</span><br><span class="line">      matchExpressions:</span><br><span class="line">      - operator : In</span><br><span class="line">        scopeName: PriorityClass</span><br><span class="line">        values: [&quot;low&quot;]</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: high-priority</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: high-priority</span><br><span class="line">    image: ubuntu</span><br><span class="line">    command: [&quot;/bin/sh&quot;]</span><br><span class="line">    args: [&quot;-c&quot;, &quot;while true; do echo hello; sleep 10;done&quot;]</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: &quot;10Gi&quot;</span><br><span class="line">        cpu: &quot;500m&quot;</span><br><span class="line">      limits:</span><br><span class="line">        memory: &quot;10Gi&quot;</span><br><span class="line">        cpu: &quot;500m&quot;</span><br><span class="line">  priorityClassName: high # priorityClassName 指的是什么，就优先使用这个优先级的配额约束。</span><br></pre></td></tr></table></figure>

<h2 id="LimitRange（限制范围）"><a href="#LimitRange（限制范围）" class="headerlink" title="LimitRange（限制范围）"></a>LimitRange（限制范围）</h2><ul>
<li><p>默认情况下， Kubernetes 集群上的容器运行使用的<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/manage-resources-containers/">计算资源</a>没有限制。 </p>
</li>
<li><p>使用资源配额，集群管理员可以以<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/namespaces/">名字空间</a>为单位，限制其资源的使用与创建。 </p>
</li>
<li><p>在命名空间中，一个 Pod 或 Container 最多能够使用命名空间的资源配额所定义的 CPU 和内存用量。 </p>
</li>
<li><p>有人担心，一个 Pod 或 Container 会垄断所有可用的资源。 LimitRange 是在命名空间内限制资源分配（给多个 Pod 或 Container）的策略对象，例如：资源额度 ResourceQuotas 设置为 requests.cpu 为 1 ，requests.memory 为 1Gi ，但是有人的 Pod 直接设置为 requests.cpu 为 1，requests.memory 为 1Gi，那么其他人就不能再创建 Pod 了，所以需要使用 LimitRange 对资源配额设置区间（最小和最大）。 </p>
</li>
<li><p>一个 LimitRange（限制范围） 对象提供的限制能够做到： </p>
</li>
<li><ul>
<li>在一个命名空间中实施对每个 Pod 或 Container 最小和最大的资源使用量的限制。</li>
</ul>
</li>
<li><ul>
<li>在一个命名空间中实施对每个 PersistentVolumeClaim 能申请的最小和最大的存储空间大小的限制。</li>
</ul>
</li>
<li><ul>
<li>在一个命名空间中实施对一种资源的申请值和限制值的比值的控制。</li>
</ul>
</li>
<li><ul>
<li>设置一个命名空间中对计算资源的默认申请&#x2F;限制值，并且自动的在运行时注入到多个 Container 中。</li>
</ul>
</li>
</ul>
<h4 id="为命名空间配置-CPU-最小和最大约束"><a href="#为命名空间配置-CPU-最小和最大约束" class="headerlink" title="为命名空间配置 CPU 最小和最大约束"></a>为命名空间配置 CPU 最小和最大约束</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: cpu-min-max-demo-lr</span><br><span class="line">  namespace: default # 限制 default 命名空间</span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - max:</span><br><span class="line">      cpu: &quot;800m&quot;</span><br><span class="line">    min:</span><br><span class="line">      cpu: &quot;200m&quot; # Pod 中的容器的 cpu 的范围是 200m~800m</span><br><span class="line">    type: Container</span><br></pre></td></tr></table></figure>

<h4 id="配置命名空间的最小和最大内存约束"><a href="#配置命名空间的最小和最大内存约束" class="headerlink" title="配置命名空间的最小和最大内存约束"></a>配置命名空间的最小和最大内存约束</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: mem-min-max-demo-lr</span><br><span class="line">  namespace: default # 限制 default 命名空间  </span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - max:</span><br><span class="line">      memory: 1Gi</span><br><span class="line">    min:</span><br><span class="line">      memory: 500Mi # Pod 中的容器的 memory 的范围是 500Mi~1Gi</span><br><span class="line">    type: Container</span><br></pre></td></tr></table></figure>

<h4 id="为命名空间配置默认的-CPU-请求和限制"><a href="#为命名空间配置默认的-CPU-请求和限制" class="headerlink" title="为命名空间配置默认的 CPU 请求和限制"></a>为命名空间配置默认的 CPU 请求和限制</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: cpu-limit-range</span><br><span class="line">  namespace: default # 限制 default 命名空间    </span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - default:</span><br><span class="line">      cpu: 1</span><br><span class="line">    defaultRequest:</span><br><span class="line">      cpu: 500m # 声明了一个默认的 CPU 请求和一个默认的 CPU 限制</span><br><span class="line">    type: Container</span><br></pre></td></tr></table></figure>

<h4 id="为命名空间配置默认的内存请求和限制"><a href="#为命名空间配置默认的内存请求和限制" class="headerlink" title="为命名空间配置默认的内存请求和限制"></a>为命名空间配置默认的内存请求和限制</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: mem-limit-range</span><br><span class="line">  namespace: default # 限制 default 命名空间     </span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - default:</span><br><span class="line">      memory: 512Mi</span><br><span class="line">    defaultRequest:</span><br><span class="line">      memory: 256Mi # 为命名空间配置默认的内存请求和限制</span><br><span class="line">    type: Container</span><br></pre></td></tr></table></figure>

<h4 id="限制存储消耗"><a href="#限制存储消耗" class="headerlink" title="限制存储消耗"></a>限制存储消耗</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: storagelimits</span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - type: PersistentVolumeClaim</span><br><span class="line">    max:</span><br><span class="line">      storage: 2Gi</span><br><span class="line">    min:</span><br><span class="line">      storage: 1Gi</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ResourceQuota</span><br><span class="line">metadata:</span><br><span class="line">  name: storagequota</span><br><span class="line">spec:</span><br><span class="line">  hard:</span><br><span class="line">    persistentvolumeclaims: &quot;5&quot; # 限制 PVC 数目和累计存储容量</span><br><span class="line">    requests.storage: &quot;5Gi&quot;</span><br></pre></td></tr></table></figure>

<h2 id="调度原理-1"><a href="#调度原理-1" class="headerlink" title="调度原理"></a>调度原理</h2><ul>
<li><p>在默认情况下，一个 Pod 在哪个 Node 节点上运行，是由 Scheduler 组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足需求，因为很多情况下，我们想控制某些 Pod 到达某些节点上，那么应该怎么做？这就要求了解 Kubernetes 对 Pod 的调度规则，Kubernetes 提供了四大类调度方式： </p>
</li>
<li><ul>
<li>自动调度（默认）：运行在哪个 Node 节点上完全由 Scheduler 经过一系列的算法计算得出。</li>
</ul>
</li>
<li><ul>
<li>定向调度：NodeName、NodeSelector。</li>
</ul>
</li>
<li><ul>
<li>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity。</li>
</ul>
</li>
<li><ul>
<li>污点（容忍）调度：Taints、Toleration。</li>
</ul>
</li>
</ul>
<h3 id="定向调度"><a href="#定向调度" class="headerlink" title="定向调度"></a>定向调度</h3><ul>
<li>定向调度，指的是利用在 Pod 上声明的 nodeName 或 nodeSelector ，以此将 Pod 调度到期望的 Node 节点上。</li>
</ul>
<p><strong>注意：这里的调度是强制的，这就意味着即使要调度的目标 Node 不存在，也会向上面进行调度，只不过 Pod 运行失败而已。</strong></p>
<h4 id="nodeName（不建议）"><a href="#nodeName（不建议）" class="headerlink" title="nodeName（不建议）"></a>nodeName（不建议）</h4><ul>
<li><p><code>nodeName</code> 是节点选择约束的最简单方法，但是由于其自身限制，通常不使用它。 <code>nodeName</code> 是 PodSpec 的一个字段。 如果它不为空，调度器将忽略 Pod，并且给定节点上运行的 kubelet 进程尝试执行该 Pod。 因此，如果 <code>nodeName</code> 在 Pod 的 Spec 中指定了，则它优先于 nodeSelector 。 </p>
</li>
<li><p>使用 <code>nodeName</code> 来选择节点的一些限制： </p>
</li>
<li><ul>
<li>如果指定的节点不存在，</li>
</ul>
</li>
<li><ul>
<li>如果指定的节点没有资源来容纳 Pod，Pod 将会调度失败并且其原因将显示为， 比如 OutOfmemory 或 OutOfcpu。</li>
</ul>
</li>
<li><ul>
<li>云环境中的节点名称并非总是可预测或稳定的。</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  nodeName: k8s-node1 # 指定调度到k8s-node1节点上</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort:  80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure>

<h4 id="nodeSelector"><a href="#nodeSelector" class="headerlink" title="nodeSelector"></a>nodeSelector</h4><p>●nodeSelector 是节点选择约束的最简单推荐形式。nodeSelector 是 PodSpec 的一个字段。 它包含键值对的映射。为了使 pod 可以在某个节点上运行，该节点的标签中 必须包含这里的每个键值对（它也可以具有其他标签）。 最常见的用法的是一对键值对。</p>
<p>●除了自己 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/assign-pod-node/#step-one-attach-label-to-the-node">添加</a> 的标签外，节点还预制了一组标准标签。 参见这些<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/labels-annotations-taints/">常用的标签，注解以及污点</a>： </p>
<p>○<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#kubernetes-io-hostname">kubernetes.io&#x2F;hostname</a></p>
<p>○<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#failure-domainbetakubernetesiozone">failure-domain.beta.kubernetes.io&#x2F;zone</a></p>
<p>○<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#failure-domainbetakubernetesioregion">failure-domain.beta.kubernetes.io&#x2F;region</a></p>
<p>○<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#topologykubernetesiozone">topology.kubernetes.io&#x2F;zone</a></p>
<p>○<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#topologykubernetesiozone">topology.kubernetes.io&#x2F;region</a></p>
<p>○<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#beta-kubernetes-io-instance-type">beta.kubernetes.io&#x2F;instance-type</a></p>
<p>○<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#nodekubernetesioinstance-type">node.kubernetes.io&#x2F;instance-type</a></p>
<p>○<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#kubernetes-io-os">kubernetes.io&#x2F;os</a></p>
<p>○<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubernetes-api/labels-annotations-taints/#kubernetes-io-arch">kubernetes.io&#x2F;arch</a></p>
<p>注意：这些标签的值是特定于云供应商的，因此不能保证可靠。 例如，kubernetes.io&#x2F;hostname 的值在某些环境中可能与节点名称相同， 但在其他环境中可能是一个不同的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 给 k8s-node2 打上标签</span><br><span class="line">kubectl label node k8s-node2 nodeevn=pro</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  nodeSelector:</span><br><span class="line">    nodeevn: pro # 指定调度到 nodeevn = pro 标签的 Node 节点上</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure>

<h3 id="亲和性调度"><a href="#亲和性调度" class="headerlink" title="亲和性调度"></a>亲和性调度</h3><ul>
<li><p>虽然定向调度的两种方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的 Node，那么 Pod 将不会被运行，即使在集群中还有可用的 Node 列表也不行，这就限制了它的使用场景。 </p>
</li>
<li><p>基于上面的问题，Kubernetes 还提供了一种亲和性调度（Affinity）。它在 nodeSelector 的基础之上进行了扩展，可以通过配置的形式，实现优先选择满足条件的 Node 进行调度，如果没有，也可以调度到不满足条件的节点上，使得调度更加灵活。 </p>
</li>
<li><p><strong>Affinity 主要分为三类：</strong> </p>
</li>
<li><ul>
<li><strong>nodeAffinity（node亲和性）：以 Node 为目标，解决 Pod可 以调度到那些 Node 的问题。</strong></li>
</ul>
</li>
<li><ul>
<li><strong>podAffinity（pod亲和性）：以 Pod 为目标，解决 Pod 可以和那些已存在的 Pod 部署在同一个拓扑域中的问题。</strong></li>
</ul>
</li>
<li><ul>
<li><strong>podAntiAffinity（pod反亲和性）：以 Pod 为目标，解决 Pod 不能和那些已经存在的 Pod 部署在同一拓扑域中的问题。</strong></li>
</ul>
</li>
</ul>
<p><strong>关于亲和性和反亲和性的使用场景的说明：</strong></p>
<ul>
<li><p>亲和性：如果两个应用频繁交互，那么就有必要利用亲和性让两个应用尽可能的靠近，这样可以较少因网络通信而带来的性能损耗。 </p>
</li>
<li><p>反亲和性：当应用采用多副本部署的时候，那么就有必要利用反亲和性让各个应用实例打散分布在各个 Node 上，这样可以提高服务的高可用性。</p>
</li>
</ul>
<h4 id="nodeAffinity"><a href="#nodeAffinity" class="headerlink" title="nodeAffinity"></a>nodeAffinity</h4><ul>
<li><p>nodeAffinity 概念上类似于 <code>nodeSelector</code>，它使你可以根据节点上的标签来约束 Pod 可以调度到哪些节点。 </p>
</li>
<li><p>和 nodeSelector 的区别： </p>
</li>
<li><ul>
<li>引入了运算符：In、NotIn、Exists、DoesNotExist、 Gt、 Lt。</li>
</ul>
</li>
<li><ul>
<li>支持 <code>硬性过滤</code> 和 <code>软性评分</code> ：</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>硬件过滤支持指定<code>多条件之间的逻辑或运算</code>；</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>软件评分规则支持<code>设置条件权重</code>。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>nodeAffinity 的可选配置项：</strong></p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pod.spec.affinity.nodeAffinity</span><br><span class="line">  requiredDuringSchedulingIgnoredDuringExecution  # Node节点必须满足指定的所有规则才可以，硬性过滤</span><br><span class="line">    nodeSelectorTerms  # 节点选择列表</span><br><span class="line">      matchFields   # 按节点字段列出的节点选择器要求列表  </span><br><span class="line">      matchExpressions   # 按节点标签列出的节点选择器要求列表(推荐)</span><br><span class="line">        key    # 键</span><br><span class="line">        values # 值</span><br><span class="line">        operator # 关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt</span><br><span class="line">  preferredDuringSchedulingIgnoredDuringExecution # 优先调度到满足指定的规则的Node，软性评分 (倾向)   </span><br><span class="line">    preference   # 一个节点选择器项，与相应的权重相关联</span><br><span class="line">      matchFields # 按节点字段列出的节点选择器要求列表</span><br><span class="line">      matchExpressions   # 按节点标签列出的节点选择器要求列表(推荐)</span><br><span class="line">        key # 键</span><br><span class="line">        values # 值</span><br><span class="line">        operator # 关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt  </span><br><span class="line">    weight # 倾向权重，在范围1-100。</span><br></pre></td></tr></table></figure>

<p><em>注意：</em><br><em>●如果我们修改或删除 Pod 调度到节点的标签，Pod 不会被删除；换言之，亲和调度只是在 Pod 调度期间有效。</em><br><em>●如果同时定义了 nodeSelector 和 nodeAffinity ，那么必须两个条件都满足，Pod 才能运行在指定的 Node 上。</em><br><em>●如果 nodeAffinity 指定了多个 nodeSelectorTerms ，那么只需要其中一个能够匹配成功即可。</em><br><em>●如果一个 nodeSelectorTerms 中有多个 matchExpressions ，则一个节点必须满足所有的才能匹配成功。</em></p>
<p><strong>硬性过滤</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 给 k8s-node1 和 k8s-nodes 打上标签</span><br><span class="line">kubectl label node k8s-node1 disktype=ssd</span><br><span class="line">kubectl label node k8s-node2 disktype=hdd</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      name:  http</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">  volumes:</span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">  affinity: </span><br><span class="line">    nodeAffinity:</span><br><span class="line">      # DuringScheduling（调度期间有效）IgnoredDuringExecution（执行期间忽略，执行期间：Pod 运行期间）</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution: # 硬性过滤：Node 节点必须满足指定的所有规则才可以</span><br><span class="line">        nodeSelectorTerms:</span><br><span class="line">          - matchExpressions: # 所有 matchExpressions 满足条件才行</span><br><span class="line">            - key: disktype</span><br><span class="line">              operator: In # 支持 Exists, DoesNotExist, In, NotIn, Gt, Lt</span><br><span class="line">              values: </span><br><span class="line">                - ssd      </span><br><span class="line">                - hdd</span><br><span class="line">  restartPolicy: Always</span><br></pre></td></tr></table></figure>

<p><strong>软性评分</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 给 k8s-node1 和 k8s-nodes 打上标签</span><br><span class="line"></span><br><span class="line">kubectl label node k8s-node1 disk=50 gpu=1000</span><br><span class="line">kubectl label node k8s-node2 disk=30 gpu=5000</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line"></span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.20.2</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">        memory: 200Mi</span><br><span class="line">    ports:</span><br><span class="line"></span><br><span class="line">    - containerPort: 80</span><br><span class="line">      name:  http</span><br><span class="line">      volumeMounts:</span><br><span class="line"></span><br><span class="line">    - name: localtime</span><br><span class="line">      mountPath: /etc/localtime</span><br><span class="line">      volumes:</span><br><span class="line"></span><br><span class="line">    - name: localtime</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">      affinity: </span><br><span class="line">      nodeAffinity:</span><br><span class="line"></span><br><span class="line">      # DuringScheduling（调度期间有效）IgnoredDuringExecution（执行期间忽略，执行期间：Pod 运行期间）</span><br><span class="line"></span><br><span class="line">      preferredDuringSchedulingIgnoredDuringExecution: # 软性评分：优先调度到满足指定的规则的 Node</span><br><span class="line"></span><br><span class="line">        - weight: 90 # 权重</span><br><span class="line">          preference: # 一个节点选择器项，与相应的权重相关联</span><br><span class="line">            matchExpressions:</span><br><span class="line">              - key: disk</span><br><span class="line">                operator: Gt</span><br><span class="line">                values: </span><br><span class="line">                 - &quot;40&quot;</span><br><span class="line">        - weight: 10 # 权重</span><br><span class="line">          preference: # 一个节点选择器项，与相应的权重相关联</span><br><span class="line">            matchExpressions:</span><br><span class="line">             - key: gpu</span><br><span class="line">               operator: Gt</span><br><span class="line">               values: </span><br><span class="line">                - &quot;4000&quot;        </span><br><span class="line">                  restartPolicy: Always</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="podAffinity-和-podAntiAffinity"><a href="#podAffinity-和-podAntiAffinity" class="headerlink" title="podAffinity 和 podAntiAffinity"></a>podAffinity 和 podAntiAffinity</h4><ul>
<li><p>podAffinity 主要实现以运行的 Pod 为参照，实现让新创建的 Pod 和参照的 Pod 在一个区域的功能。 </p>
</li>
<li><p>podAntiAffinity 主要实现以运行的 Pod 为参照，让新创建的 Pod 和参照的 Pod 不在一个区域的功能。 </p>
</li>
<li><p>PodAffinity 的可选配置项：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pod.spec.affinity.podAffinity</span><br><span class="line">  requiredDuringSchedulingIgnoredDuringExecution  硬限制</span><br><span class="line">    namespaces 指定参照pod的namespace</span><br><span class="line">    topologyKey 指定调度作用域</span><br><span class="line">    labelSelector 标签选择器</span><br><span class="line">      matchExpressions  按节点标签列出的节点选择器要求列表(推荐)</span><br><span class="line">        key    键</span><br><span class="line">        values 值</span><br><span class="line">        operator 关系符 支持In, NotIn, Exists, DoesNotExist.</span><br><span class="line">      matchLabels    指多个matchExpressions映射的内容  </span><br><span class="line">  preferredDuringSchedulingIgnoredDuringExecution 软限制    </span><br><span class="line">    podAffinityTerm  选项</span><br><span class="line">      namespaces</span><br><span class="line">      topologyKey</span><br><span class="line">      labelSelector</span><br><span class="line">         matchExpressions </span><br><span class="line">            key    键  </span><br><span class="line">            values 值  </span><br><span class="line">            operator</span><br><span class="line">         matchLabels </span><br><span class="line">    weight 倾向权重，在范围1-1</span><br></pre></td></tr></table></figure>

<p>注意：topologyKey 用于指定调度的作用域，例如:</p>
<ul>
<li><p>如果指定为 kubernetes.io&#x2F;hostname（可以通过 kubectl get node –show-labels 查看），那就是以 Node 节点为区分范围。 </p>
</li>
<li><p>如果指定为 kubernetes.io&#x2F;os，则以 Node 节点的操作系统类型来区分。</p>
</li>
</ul>
<p><strong>示例：在一个两节点的集群中，部署一个使用 redis 的 WEB 应用程序，并期望 web-server 尽可能和 redis 在同一个节点上。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: redis-deploy</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: store</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: store</span><br><span class="line">    spec:</span><br><span class="line">      affinity: # 亲和性配置</span><br><span class="line">        podAntiAffinity: # Pod 反亲和性，符合以下指定条件不会被调度过去</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution: # 硬限制</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions: </span><br><span class="line">                  - key: app</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - store</span><br><span class="line">              topologyKey: kubernetes.io/hostname # 拓扑键，划分逻辑区域。 </span><br><span class="line">              # node 节点以 kubernetes.io/hostname 为拓扑网络，如果 kubernetes.io/hostname 相同，就认为是同一个东西。</span><br><span class="line">              # 亲和就是都放在这个逻辑区域，反亲和就是必须避免放在同一个逻辑区域。</span><br><span class="line">      containers:</span><br><span class="line">      - name: redis-server</span><br><span class="line">        image: redis:5.0.14-alpine</span><br><span class="line">        resources:</span><br><span class="line">           limits:</span><br><span class="line">             memory: 500Mi</span><br><span class="line">             cpu: 1</span><br><span class="line">           requests:</span><br><span class="line">             memory: 250Mi</span><br><span class="line">             cpu: 500m</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 2375</span><br><span class="line">          name: redis</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: localtime</span><br><span class="line">          mountPath: /etc/localtime</span><br><span class="line">      volumes:</span><br><span class="line">        - name: localtime</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name:  nginx-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app:  nginx-deploy</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: web-store</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: web-store</span><br><span class="line">    spec:</span><br><span class="line">      affinity: # 亲和性配置</span><br><span class="line">        podAffinity: # Pod 亲和性，符合以下指定条件会被调度过去</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution: # 硬限制</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions: </span><br><span class="line">                  - key: app</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - store</span><br><span class="line">              topologyKey: kubernetes.io/hostname # 拓扑键，划分逻辑区域。 </span><br><span class="line">              # node 节点以 kubernetes.io/hostname 为拓扑网络，如果 kubernetes.io/hostname 相同，就认为是同一个东西。</span><br><span class="line">              # 亲和就是都放在这个逻辑区域，反亲和就是必须避免放在同一个逻辑区域。</span><br><span class="line">        podAntiAffinity: # Pod 反亲和性，符合以下指定条件不会被调度过去</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution: # 硬限制</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions: </span><br><span class="line">                  - key: app</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - web-store</span><br><span class="line">              topologyKey: kubernetes.io/hostname # 拓扑键，划分逻辑区域。 </span><br><span class="line">              # node 节点以 kubernetes.io/hostname 为拓扑网络，如果 kubernetes.io/hostname 相同，就认为是同一个东西。</span><br><span class="line">              # 亲和就是都放在这个逻辑区域，反亲和就是必须避免放在同一个逻辑区域。              </span><br><span class="line">      containers:</span><br><span class="line">      - name:  nginx</span><br><span class="line">        image:  nginx:1.20.2</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 200m</span><br><span class="line">            memory: 500Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort:  80</span><br><span class="line">          name:  nginx</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: localtime</span><br><span class="line">          mountPath: /etc/localtime</span><br><span class="line">      volumes:</span><br><span class="line">        - name: localtime</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">      restartPolicy: Always</span><br></pre></td></tr></table></figure>

<h2 id="污点和容忍调度"><a href="#污点和容忍调度" class="headerlink" title="污点和容忍调度"></a>污点和容忍调度</h2><h3 id="污点"><a href="#污点" class="headerlink" title="污点"></a>污点</h3><ul>
<li><p>面的调度方式都是站在 Pod 的角度上，通过在 Pod 上添加属性，来确定 Pod 是否要调度到指定的 Node 上，其实我们也可以站在 Node 的角度上，通过在 Node 上添加<code>污点属性</code>，来决定是否运行 Pod 调度过来。</p>
</li>
<li><p>Node 被设置了污点之后就和 Pod 之间存在了一种相斥的关系，进而拒绝 Pod 调度进来，甚至可以将已经存在的 Pod 驱逐出去。</p>
</li>
<li><p>污点的格式为：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">key=value:effect</span><br><span class="line"># key 和 value 是污点的标签及对应的值</span><br><span class="line"># effect 描述污点的作用</span><br></pre></td></tr></table></figure>

<ul>
<li><p>effect 支持如下的三个选项： </p>
</li>
<li><ul>
<li>PreferNoSchedule：Kubernetes 将尽量避免把 Pod 调度到具有该污点的 Node 上，除非没有其他节点可以调度；换言之，尽量不要来，除非没办法。</li>
</ul>
</li>
<li><ul>
<li>NoSchedule：Kubernets 将不会把 Pod 调度到具有该污点的 Node 上，但是不会影响当前 Node 上已经存在的 Pod ;换言之，新的不要来，在这的就不要动。</li>
</ul>
</li>
<li><ul>
<li>NoExecute：Kubernets 将不会将 Pod 调度到具有该污点的 Node 上，同时会将 Node 上已经存在的 Pod 驱逐；换言之，新的不要来，这这里的赶紧走。</li>
</ul>
</li>
</ul>
<p><strong>注意：NoExecute 一般用于实际生产环境中的 Node 节点的上下线。</strong></p>
<p><strong>设置污点</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node xxx key=value:effect</span><br></pre></td></tr></table></figure>

<p><strong>去除污点</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node xxx key:effect-</span><br></pre></td></tr></table></figure>

<p><strong>去除所有污点</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node xxx key-</span><br></pre></td></tr></table></figure>

<p><strong>查看污点</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe node xxx | grep -i taints</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>证明：kubeadm 安装的集群上 k8s-master 有污点</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe node k8s-master | grep -i taints</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2022/png/513185/1648692456349-9a4ca09a-e5c4-4473-af6a-8c3a298accfe.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_34,text_6K645aSn5LuZ,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="6.png"></p>
<ul>
<li><p>示例：演示污点效果（为了演示效果更为明显，暂时停止 k8s-node2 节点）</p>
</li>
<li><p>① 为 k8s-node1 设置污点<code>tag=xudaxian:PreferNoSchedule</code>，然后创建 Pod1 （Pod1 可以运行）</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-node1 tag=xudaxian:PreferNoSchedule</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run pod1 --image=nginx:1.20.2</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/513185/1648692464879-6e01bead-ed97-46be-93ef-6cc2cf5c524d.gif" alt="img"></p>
<ul>
<li>② 修改 k8s-node1 节点的污点为 <code>tag=xudaxian:NoSchedule</code>，然后创建Pod2（Pod1 可以正常运行，Pod2 失败）。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取消污点</span></span><br><span class="line">kubectl taint node k8s-node1 tag:PreferNoSchedule-</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置污点</span></span><br><span class="line">kubectl taint node k8s-node1 tag=xudaxian:NoSchedule</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run pod2 --image=nginx:1.20.2</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/513185/1648692471659-c922a543-2a3e-47cb-9ded-f1a5a0e05a1d.gif" alt="img"></p>
<ul>
<li>③ 修改 k8s-node1 节点的污点为 <code>tag=xudaxian:NoExecute</code>，然后创建 Pod3（Pod1、Pod2、Pod3失败）。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取消污点</span></span><br><span class="line">kubectl taint node k8s-node1 tag:NoSchedule-</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置污点</span></span><br><span class="line">kubectl taint node k8s-node1 tag=xudaxian:NoExecute</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run pod3 --image=nginx:1.20.2</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/513185/1648692476438-b3547fd6-b251-4982-905a-8e91b663ee86.gif" alt="img"></p>
<h3 id="容忍"><a href="#容忍" class="headerlink" title="容忍"></a>容忍</h3><p>上面介绍了污点的作用，我们可以在 Node上 添加污点用来拒绝 Pod 调度上来，但是如果就是想让一个 Pod 调度到一个有污点的 Node 上去，这时候应该怎么做？这就需要使用到容忍。</p>
<p><strong>污点就是拒绝，容忍就是忽略，Node 通过污点拒绝 Pod 调度上去，Pod 通过容忍忽略拒绝。</strong></p>
<p>●容忍的详细配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain pod.spec.tolerations</span><br><span class="line">......</span><br><span class="line">FIELDS:</span><br><span class="line">  key       # 对应着要容忍的污点的键，空意味着匹配所有的键</span><br><span class="line">  value     # 对应着要容忍的污点的值</span><br><span class="line">  operator  # key-value的运算符，支持Equal和Exists（默认）</span><br><span class="line">  effect    # 对应污点的effect，空意味着匹配所有影响</span><br><span class="line">  tolerationSeconds   # 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间</span><br></pre></td></tr></table></figure>

<ul>
<li><p>污点和容忍的匹配： </p>
</li>
<li><ul>
<li>当满足如下条件的时候，Kubernetes 认为污点和容忍匹配：</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>键（key）相同。</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>效果（effect）相同。</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>污点的 operator 为：</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>Exists ，此时污点中不应该指定 value 。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>Equal，此时容忍的 value 应该和污点的 value 相同。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>如果不指定 operator ，默认为 Equal 。</li>
</ul>
</li>
<li><p>特殊情况：</p>
</li>
<li><ul>
<li><p>容忍中没有定义 key ，但是定义了 operator 为 Exists ，Kubernetes 则认为此容忍匹配所有的污点，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tolerations:</span><br><span class="line">- operator: Exists</span><br><span class="line"># 最终，所有有污点的机器我们都能容忍，Pod 都可以调用</span><br></pre></td></tr></table></figure>
</li>
<li><p>容忍中没有定义 effect，但是定义了 key，Kubernetes 认为此容忍匹配所有 effect ，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  tolerations: # 容忍</span><br><span class="line">    - key: &quot;tag&quot; # 要容忍的污点的key</span><br><span class="line">      operator: Exists # 操作符</span><br><span class="line"># 最终，有这个污点的机器我们可以容忍，Pod 都可以调度。</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p><strong>示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 设置污点</span><br><span class="line">kubectl taint node k8s-node1 tag=xudaxian:NoExecute</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-toleration</span><br><span class="line">spec:</span><br><span class="line">  containers: # 容器配置</span><br><span class="line">    - name: nginx</span><br><span class="line">      image: nginx:1.20.2</span><br><span class="line">      imagePullPolicy: IfNotPresent</span><br><span class="line">      ports:</span><br><span class="line">        - name: nginx-port</span><br><span class="line">          containerPort: 80</span><br><span class="line">          protocol: TCP</span><br><span class="line">  tolerations: # 容忍</span><br><span class="line">    - key: &quot;tag&quot; # 要容忍的污点的key</span><br><span class="line">      operator: Equal # 操作符</span><br><span class="line">      value: &quot;xudaxian&quot; # 要容忍的污点的value</span><br><span class="line">      effect: NoExecute # 添加容忍的规则，这里必须和标记的污点规则相同</span><br></pre></td></tr></table></figure>

<h1 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h1><h2 id="访问控制概述"><a href="#访问控制概述" class="headerlink" title="访问控制概述"></a>访问控制概述</h2><ul>
<li>用户使用 <code>kubectl</code>、客户端库或构造 REST 请求来访问 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/overview/kubernetes-api/">Kubernetes API</a>。 人类用户和 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-service-account/">Kubernetes 服务账户</a>都可以被鉴权访问 API。 当请求到达 API 时，它会经历多个阶段，如下图所示：</li>
</ul>
<p>![](C:\Users\32625\OneDrive\图片\k8s\1 (1).png)</p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><ul>
<li><p>在 Kubernetes 集群中，客户端通常由两类： </p>
</li>
<li><ul>
<li>① User Account：一般是独立于 Kubernetes 之外的其他服务管理的用户账号。</li>
</ul>
</li>
<li><ul>
<li>② Service Account：Kubernetes 管理的账号，用于为Pod的服务进程在访问 Kubernetes 时提供身份标识。</li>
</ul>
</li>
</ul>
<h3 id="认证、授权和准入控制"><a href="#认证、授权和准入控制" class="headerlink" title="认证、授权和准入控制"></a>认证、授权和准入控制</h3><ul>
<li><p>api-server 是访问和管理资源对象的唯一入口。任何一个请求访问 api-server，都要经过下面的三个流程： </p>
</li>
<li><ul>
<li>① Authentication（认证）：身份鉴别，只有正确的账号才能通过认证。</li>
</ul>
</li>
<li><ul>
<li>② Authorization（授权）：判断用户是否有权限对访问的资源执行特定的动作。</li>
</ul>
</li>
<li><ul>
<li>③ Admission Control（准入控制）：用于补充授权机制以实现更加精细的访问控制功能。</li>
</ul>
</li>
</ul>
<h3 id="权限流程控制"><a href="#权限流程控制" class="headerlink" title="权限流程控制"></a>权限流程控制</h3><ul>
<li><p>用户携带令牌或者证书给 Kubernetes 的 api-server 发送请求，要求修改集群资源。</p>
</li>
<li><p>Kubernetes 开始认证。</p>
</li>
<li><p>Kubernetes 认证通过之后，会查询用户的授权（有哪些权限）。</p>
</li>
<li><p>用户执行操作的过程中（操作 CPU、内存、硬盘、网络……），利用准入控制来判断是否可以执行这样的操作。</p>
</li>
</ul>
<h2 id="认证管理"><a href="#认证管理" class="headerlink" title="认证管理"></a>认证管理</h2><h3 id="k8s的客户端认证方式"><a href="#k8s的客户端认证方式" class="headerlink" title="k8s的客户端认证方式"></a>k8s的客户端认证方式</h3><ul>
<li><p>Kubernetes 集群安全的关键点在于如何识别并认证客户端身份，它提供了 3 种客户端身份认证方式：</p>
</li>
<li><p><strong>① HTTP Base 认证：</strong> </p>
</li>
<li><ul>
<li>通过 <code>用户名+密码</code> 的方式进行认证。</li>
</ul>
</li>
<li><ul>
<li>这种方式是把 <code>用户名:密码</code> 用 BASE64 算法进行编码后的字符串放在 HTTP 请求中的 Header 的 Authorization 域里面发送给服务端。服务端收到后进行解码，获取用户名和密码，然后进行用户身份认证的过程。</li>
</ul>
</li>
<li><p><strong>② HTTP Token 认证：</strong> </p>
</li>
<li><ul>
<li>通过一个 Token 来识别合法用户。</li>
</ul>
</li>
<li><ul>
<li>这种认证方式是用一个很长的难以被模仿的字符串–Token 来表明客户端身份的一种方式。每个 Token 对应一个用户名，当客户端发起 API 调用请求的时候，需要在 HTTP 的 Header 中放入 Token，API Server 接受到 Token 后会和服务器中保存的 Token 进行比对，然后进行用户身份认证的过程。</li>
</ul>
</li>
<li><p><strong>③ HTTPS 证书认证：</strong> </p>
</li>
<li><ul>
<li>基于 CA 根证书签名的双向数字证书认证方式。</li>
</ul>
</li>
<li><ul>
<li>这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式。</li>
</ul>
</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>Kubernetes 允许同时配置多种认证方式，只要其中任意一种方式认证通过即可。</strong></p>
<h2 id="授权管理"><a href="#授权管理" class="headerlink" title="授权管理"></a>授权管理</h2><ul>
<li><p>授权发生在认证成功之后，通过认证就可以知道请求用户是谁，然后 Kubernetes 会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权。</p>
</li>
<li><p>每个发送到 API Server 的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</p>
</li>
</ul>
<h3 id="API-Server目前支持的几种授权策略"><a href="#API-Server目前支持的几种授权策略" class="headerlink" title="API Server目前支持的几种授权策略"></a>API Server目前支持的几种授权策略</h3><ul>
<li><p><strong>AlwaysDeny</strong>：表示拒绝所有请求，一般用于测试。 </p>
</li>
<li><p><strong>AlwaysAllow</strong>：允许接收所有的请求，相当于集群不需要授权流程（Kubernetes 默认的策略）。 </p>
</li>
<li><p><strong>ABAC</strong>：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制。 </p>
</li>
<li><p><strong>Webhook</strong>：通过调用外部REST服务对用户进行授权。 </p>
</li>
<li><p><strong>Node</strong>：是一种专用模式，用于对 kubelet 发出的请求进行访问控制。 </p>
</li>
<li><p><strong>RBAC</strong>：基于角色的访问控制（ kubeadm 安装方式下的默认选项）。</p>
</li>
</ul>
<p><strong>证明：kubeadm 安装方式的默认授权策略</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep -i rbac</span><br></pre></td></tr></table></figure>

<p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-07 125451.png)</p>
<h3 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h3><ul>
<li><p><strong>RBAC（Role Based Access Control）：基于角色的访问控制，主要是在描述一件事情：给哪些对象授权了哪些权限。</strong></p>
</li>
<li><p><strong>RBAC 模型：</strong></p>
</li>
</ul>
<p>![](C:\Users\32625\OneDrive\图片\k8s\3 (1).png)</p>
<ul>
<li><p>Kubernetes 中的 RBAC 也是基于 RBAC 模型扩展的，涉及到如下的概念： </p>
</li>
<li><ul>
<li>对象：User、Group、ServiceAccount。</li>
</ul>
</li>
<li><ul>
<li>角色：代表一组定义在资源上的可操作的动作（权限）的集合。</li>
</ul>
</li>
<li><ul>
<li>绑定：将定义好的角色和用户绑定在一起，也可以理解为分配角色。</li>
</ul>
</li>
</ul>
<p><img src="C:\Users\32625\OneDrive\图片\k8s\4.png"></p>
<ul>
<li><p>RBAC 引入了 4 个顶级资源对象： </p>
</li>
<li><ul>
<li>Role：角色，用于指定一组权限，限定名称空间下的权限。</li>
</ul>
</li>
<li><ul>
<li>ClusterRole：集群角色，用于指定一组权限，限定集群范围下的权限。</li>
</ul>
</li>
<li><ul>
<li>RoleBinding：角色绑定，用于将角色 Role（权限的集合）赋予给对象（User、Group、ServiceAccount）。</li>
</ul>
</li>
<li><ul>
<li>ClusterRoleBinding：集群角色绑定，用于将集群角色 Role（权限的集合）赋予给对象（User、Group、ServiceAccount）。</li>
</ul>
</li>
</ul>
<p><strong>说明：为什么 Kubernetes 要设计 Role 、 ClusterRole ？</strong></p>
<p><strong>答：</strong>有些资源对象本身就不是 namespace（名称空间）的 ，所以 Kubernetes 增加了 ClusterRole，并且 ClusterRole 也可以管理名称空间下的资源对象。</p>
<h4 id="Role-和-ClusterRole资源清单文件"><a href="#Role-和-ClusterRole资源清单文件" class="headerlink" title="Role 和 ClusterRole资源清单文件"></a>Role 和 ClusterRole资源清单文件</h4><p>● 一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）。<br>● Role 的资源清单文件： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 名称空间角色</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-role</span><br><span class="line">  namespace: default # 所属的名称空间</span><br><span class="line">rules: # 当前角色的规则</span><br><span class="line">- apiGroups: [&quot;&quot;] # &quot;&quot; 标明 core API 组，默认留空即可。</span><br><span class="line">  resources: [&quot;pods&quot;] </span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Role  只能对名称空间（namespace）进行授权，所以需要指定名称空间（namespace）。 </p>
</li>
<li><p>rules 中的参数说明： </p>
</li>
<li><ul>
<li>apiGroups：<code>[&quot;&quot;]</code>，默认留空即可。</li>
</ul>
</li>
<li><ul>
<li>resources：支持的资源对象列表，通过 <code>kubectl api-resources</code> 查看</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl api-resources </span><br></pre></td></tr></table></figure>

<p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-07 132153.png)</p>
<ul>
<li><ul>
<li>verbs：对资源对象的操作方法列表，通过 <code>kubectl api-resources -o wide</code> 查看。</li>
</ul>
</li>
</ul>
<p>![](C:\Users\32625\OneDrive\图片\屏幕快照\屏幕截图 2023-06-07 132407.png)</p>
<p><strong>ClusterRole 的资源清单文件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 集群角色</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-clusterrole</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;] # &quot;&quot; 标明 core API 组，默认留空即可。</span><br><span class="line">  resources: [&quot;namespaces&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  # 注意：ClusterRole  不需要设置 namespace。</span><br></pre></td></tr></table></figure>

<h4 id="RoleBinding-和-ClusterRoleBinding-资源清单文件"><a href="#RoleBinding-和-ClusterRoleBinding-资源清单文件" class="headerlink" title="RoleBinding 和 ClusterRoleBinding 资源清单文件"></a>RoleBinding 和 ClusterRoleBinding 资源清单文件</h4><ul>
<li>角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是 User、Group 或者 ServiceAccount 。</li>
</ul>
<h5 id="RoleBinding-资源清单文件："><a href="#RoleBinding-资源清单文件：" class="headerlink" title="RoleBinding  资源清单文件："></a>RoleBinding  资源清单文件：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 账号和角色绑定</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-rolebinding</span><br><span class="line">  namespace: default</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: xudaxian # &quot;name&quot; 是区分大小写的</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role</span><br><span class="line">  name: xudaxian-role</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>

<h5 id="ClusterRoleBinding-资源清单文件："><a href="#ClusterRoleBinding-资源清单文件：" class="headerlink" title="ClusterRoleBinding 资源清单文件："></a>ClusterRoleBinding 资源清单文件：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 账号和集群角色绑定</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-clusterrolebinding</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: xudaxian # &quot;name&quot; 是区分大小写的</span><br><span class="line">  namespace: default # 如果资源是某个 namespace 下的，那么就需要设置 namespace</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: xudaxian-clusterrole</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>

<h4 id="实战（RBAC）"><a href="#实战（RBAC）" class="headerlink" title="实战（RBAC）"></a>实战（RBAC）</h4><p><strong>创建 ServiceAccount 的时候，系统会在底层默认一个含 ServiceAccount 名称的 Secret 。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"># 名称空间角色</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-role</span><br><span class="line">  namespace: default # 所属的名称空间</span><br><span class="line">rules: # 当前角色的规则</span><br><span class="line">- apiGroups: [&quot;&quot;] # &quot;&quot; 标明 core API 组，默认留空即可。</span><br><span class="line">  resources: [&quot;pods&quot;] # 指定能操作的资源 ，通过 kubectl api-resources 查看即可。</span><br><span class="line">  # resourceNames: [&quot;&quot;] #  指定只能操作某个名字的资源</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;] # 操作动作，通过 kubectl api-resources -o wide 查看即可。 </span><br><span class="line">---</span><br><span class="line"># 集群角色</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-clusterrole</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;] # &quot;&quot; 标明 core API 组，默认留空即可。</span><br><span class="line">  resources: [&quot;namespaces&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span><br><span class="line">---</span><br><span class="line"># ServiceAccount</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian # ServiceAccount 的名称</span><br><span class="line">  namespace: default</span><br><span class="line">---</span><br><span class="line"># 账号和角色绑定</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-rolebinding</span><br><span class="line">  namespace: default</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: xudaxian # &quot;name&quot; 是区分大小写的</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role</span><br><span class="line">  name: xudaxian-role</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span><br><span class="line"># 账号和集群角色绑定</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: xudaxian-clusterrolebinding</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: xudaxian # &quot;name&quot; 是区分大小写的</span><br><span class="line">  namespace: default # 如果资源是某个 namespace 下的，那么就需要设置 namespace</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: xudaxian-clusterrole</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>

<p><strong>温馨提示：</strong></p>
<ul>
<li><p><strong>① 动态供应（NFS）、DashBoard 等底层都使用了 Role、ClusterRole、RoleBinding、ClusterRoleBinding 。</strong></p>
</li>
<li><p><strong>② 我们可以创建一个 ServiceAccount ，并将自定义的 ServiceAccount 绑定 cluster-admin （ClusterRole，Kubernetes 底层提供的），然后通过暴露的 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/access-cluster-api/">API</a> 进行 Kubernetes 管理平台的开发（如：Kubersphere 等）。</strong></p>
</li>
</ul>
<h2 id="准入控制"><a href="#准入控制" class="headerlink" title="准入控制"></a>准入控制</h2><ul>
<li><p>通过了前面的认证和授权之后，还需要经过准入控制通过之后，API Server 才会处理这个请求。</p>
</li>
<li><p>准入控制是一个可配置的控制器列表，可以通过在 API Server 上通过命令行设置选择执行哪些注入控制器。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds</span><br></pre></td></tr></table></figure>

<ul>
<li>只有当所有的注入控制器都检查通过之后，API Server 才会执行该请求，否则返回拒绝。</li>
</ul>
<h3 id="当前可配置的-Admission-Control"><a href="#当前可配置的-Admission-Control" class="headerlink" title="当前可配置的 Admission Control"></a>当前可配置的 Admission Control</h3><ul>
<li><p><strong>AlwaysAdmit：允许所有请求。</strong> </p>
</li>
<li><p><strong>AlwaysDeny：禁止所有请求，一般用于测试。</strong> </p>
</li>
<li><p><strong>AlwaysPullImages：在启动容器之前总去下载镜像。</strong> </p>
</li>
<li><p><strong>DenyExecOnPrivileged：它会拦截所有想在 Privileged Container 上执行命令的请求。</strong> </p>
</li>
<li><p><strong>ImagePolicyWebhook：这个插件将允许后端的一个 Webhook 程序来完成 admission control 的功能。</strong> </p>
</li>
<li><p><strong>Service Account：实现 ServiceAccount 实现了自动化。</strong> </p>
</li>
<li><p><strong>SecurityContextDeny：这个插件将使用 SecurityContext 的 Pod 中的定义全部失效。</strong> </p>
</li>
<li><p><strong>ResourceQuota：用于资源配额管理目的，观察所有请求，确保在 namespace 上的配额不会超标。</strong> </p>
</li>
<li><p><strong>LimitRanger：用于资源限制管理，作用于 namespace 上，确保对 Pod 进行资源限制。</strong> </p>
</li>
<li><p><strong>InitialResources：为未设置资源请求与限制的 Pod，根据其镜像的历史资源的使用情况进行设置。</strong> </p>
</li>
<li><p><strong>NamespaceLifecycle：如果尝试在一个不存在的 namespace 中创建资源对象，则该创建请求将被拒绝。当删除一个 namespace 时，系统将会删除该 namespace 中所有对象。</strong> </p>
</li>
<li><p><strong>DefaultStorageClass：为了实现共享存储的动态供应，为未指定 StorageClass 或 PV 的 PVC 尝试匹配默认 StorageClass，尽可能减少用户在申请 PVC 时所需了解的后端存储细节。</strong> </p>
</li>
<li><p><strong>DefaultTolerationSeconds：这个插件为那些没有设置 forgiveness tolerations 并具有 notready:NoExecute 和 unreachable:NoExecute 两种taints的Pod设置默认的<code>容忍</code>时间，为 5min 。</strong> </p>
</li>
<li><p><strong>PodSecurityPolicy：这个插件用于在创建或修改 Pod 时决定是否根据 Pod 的 security context 和可用的 PodSecurityPolicy 对 Pod 的安全策略进行控制</strong></p>
</li>
</ul>

                
                <p class="end">__END__</p>
            </div>
            <div class="article-footer">
                <div class="suffix-box">
    <div class="suffix-box-left">
        <img src="/images/User/vavtarsheep.jpg" alt="CloudSheep">
    </div>
    <div class="suffix-box-right">
        <span class="suffix-box-title">文章作者：</span>CloudSheep
        <br>
        <span class="suffix-box-title">文章出处：</span><a href="/2023/12/12/Kubernetes%E8%AF%A6%E8%A7%A3/" target="_blank">Kubernetes详解</a>
        <br>
        <span class="suffix-box-title">作者签名：</span>不啻微芒，造炬成阳
        <br>
        <span class="suffix-box-title">关于主题：</span><a href="https://github.com/lsSheep/hexo-blog.git" target="_blank">hexo-blog</a>
        <br>
        <span class="suffix-box-title">版权声明：</span>文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" title="BY-NC-SA" target="_blank">BY-NC-SA</a> 许可协议，转载请注明出处
        <br>
    </div>
    <div style="clear: both;"></div>
</div>
                
                    <div class="category">
                        分类：
                        
                            <a href="/category/%E6%95%99%E7%A8%8B/">教程</a>
                        
                    </div>
                
                
                    <div class="tag">
                        标签：
                        
                            <a href="/tag/Kubernetes/">Kubernetes</a>
                        
                            <a href="/tag/%E8%BF%90%E7%BB%B4/">运维</a>
                        
                    </div>
                
                <div class="article-prev-next">
                    
                        <a href="/2023/12/12/Kubernetes%E6%B5%81%E7%A8%8B%E5%9B%BE/" class="prev-prefix">« </a> 上一篇：    <a href="/2023/12/12/Kubernetes%E6%B5%81%E7%A8%8B%E5%9B%BE/" title="发布于 2023-12-12 02:34">Kubernetes流程图</a>
                        <br>
                    
                    
                        <a href="/2023/12/12/OpenStack%E6%A0%B8%E5%BF%83%E9%A1%B9%E7%9B%AE%E6%BC%94%E5%8F%98/" class="next-prefix">» </a> 下一篇：    <a href="/2023/12/12/OpenStack%E6%A0%B8%E5%BF%83%E9%A1%B9%E7%9B%AE%E6%BC%94%E5%8F%98/" title="发布于 2023-12-12 02:22">OpenStack核心项目演变</a>
                    
                </div>
            </div>
            
    <div class="article-comments">
        
            <div class="comments-title">
                评论列表
            </div>
        
        <div class="comments-content"></div>
    </div>
    
        <!-- 样式文件 -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/waline.css"/>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/waline-custom.css"/>
        <!-- 脚本文件 -->
        <script type="module">
            import { init } from "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/waline.mjs";

            const WalineInstance = init({
                el              : ".comments-content",
                serverURL       : "https://waline.lssheepcloud.cn/",
                path            : window.location.pathname,
                meta            : ['nick', 'mail', 'link'],
                requiredMeta    : ['nick', 'mail'],
                pageSize        : 10,
                lang            : "zh-cn",
                locale: {
                    admin       : "博主",
                    anonymous   : "匿名用户",
                    sofa        : "快来做第一个评论的人吧 ~",
                    placeholder : "I'm proud of myself...",
                },
                dark            : "html[color-scheme='dark']",
                search          : false,
                pageview        : true,
                comment         : true,
                copyright       : false,
            });

            // Waline 输入框选中动画
            $(document).on("focus", ".wl-header-item .wl-input", function() {
                $(this).parent().css("border-bottom-color", "var(--input-border-color-focus)");
            });

            $(document).on("blur", ".wl-header-item .wl-input", function() {
                $(this).parent().css("border-bottom-color", "var(--input-border-color)");
            });
        </script>
    
 
        </div>
    
</div>
    <div id="footer">
    <div><span class='face'>ღゝ◡╹)ノ♡</span></div><div>【生活枯燥无味<span><i class='iconfont icon-like-fill'></i></span>早八谋杀人类】</div><div>&copy; 2023-2023 CLOUDSHEEP, All Rights Reserved.</div>
</div>
    <div id="sidebar">
    <div class="menu-wrap" style="display:none;">
        
            <div class="menu-notice">
                <span class="iconfont icon-notice"></span>
                <div class="notice">
                    <span>快也很好，慢也很好各按其时，成为美好</span>
                </div>
            </div>
        
        <nav class="menu">
            <div class="menu-introduce"> 
                <div class="introduce-avatar">
                    <img src="/images/User/vavtarsheep.jpg">
                </div> 
                <div class="introduce-info"> 
                    <div class="introduce-user">
                        
                            <a href="https://lssheepcloud.cn" target="_blank"><span>CloudSheep</span></a>
                        
                    </div>
                </div> 
            </div> 
            <div class="menu-list">
                <ul>
                    
                        <li class=""><a href="/" class="" target="_self"><span class="iconfont icon-home-fill"></span>首页</a></li>
                    
                        <li class=""><a href="/category" class="" target="_self"><span class="iconfont icon-folder-fill"></span>分类</a></li>
                    
                        <li class=""><a href="/tag" class="" target="_self"><span class="iconfont icon-discount-fill"></span>标签</a></li>
                    
                        <li class=""><a href="/archive" class="" target="_self"><span class="iconfont icon-calendar-fill"></span>归档</a></li>
                    
                        <li class=""><a href="/about" class="" target="_self"><span class="iconfont icon-about-fill"></span>关于</a></li>
                    
                        <li class=""><a href="/atom.xml" class="" target="_blank"><span class="iconfont icon-rss"></span>订阅</a></li>
                    
                        <li class=""><a href="javascript:;" class="search" target="_self"><span class="iconfont icon-search-menu"></span>搜索</a></li>
                    
                        <li class=""><a href="/comment" class="" target="_self"><span class="iconfont icon-comments-fill"></span>留言板</a></li>
                    
                        <li class=""><a href="/friend" class="" target="_self"><span class="iconfont icon-link"></span>友情链接</a></li>
                    
                </ul> 
            </div> 
            <div class="menu-link">
                <div class="box">
                    <div class="image-box"></div>
                </div>
                
                    <a name="知乎" href="https://www.zhihu.com/creator" class="" target="_blank" data=""><span class="iconfont icon-zhihu"></span></a>
                
                    <a name="QQ" href="javascript:;" class="image" target="_self" data="/images/qq.jpg"><span class="iconfont icon-qq"></span></a>
                
                    <a name="微信" href="javascript:;" class="" target="_self" data=""><span class="iconfont icon-wechat"></span></a>
                
                    <a name="GitHub" href="https://github.com/lsSheep" class="" target="_blank" data=""><span class="iconfont icon-github"></span></a>
                
            </div> 
        </nav>
        <button class="menu-button-close"></button>
        <div class="morph-shape" id="morph-shape" data-morph-open="M-7.312,0H15c0,0,66,113.339,66,399.5C81,664.006,15,800,15,800H-7.312V0z;M-7.312,0H100c0,0,0,113.839,0,400c0,264.506,0,400,0,400H-7.312V0z">
            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 800" preserveAspectRatio="none">
                <path d="M-7.312,0H0c0,0,0,113.839,0,400c0,264.506,0,400,0,400h-7.312V0z"/>
            </svg>
        </div>
    </div>
    <button class="menu-button-open">MENU</button>
    <div class="menu-cover"></div>
</div>
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/search.min.css">
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/iscroll.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/instantsearch.min.js"></script>
<div class="search-window">
    <div class="search-content">
        <div class="search-content-icon">
            <i class="iconfont icon-search"></i>
        </div>
        <div id="search-input" class="search-input"></div>
    </div>

    <div class="search-scroll">
        <div class="search-result">
            <div id="search-stats" class="search-stats"></div>
            <div id="search-hits"></div>
            <div id="search-pagination" class="search-pagination"></div>
        </div>
    </div>

    <span class="search-close-icon">
        <i class="iconfont icon-close"></i>
    </span>
</div>
    <div id="tools">
    <div class="progressbar-top"></div>
    
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/APlayer.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/APlayer.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/Meting.min.js"></script>
    <script>
        var meting_api = 'https://api.i-meto.com/meting/api?server=:server&type=:type&id=:id&auth=:auth&r=:r';
    </script>
    <meting-js id="2133323240" lrcshow="false" server="netease" type="playlist" fixed="true" autoplay="false" loop="all" order="random" preload="auto" volume="0.67" mutex="true"></meting-js>

    <div class="wrap-right">
    <div class="wrap-right-hide">
         <div class="wrap-right-button favorites">
            <div class="iconbox" switch="false">
                <span class="iconfont icon-favorites"></span>
            </div>
            <span class="icontext">关注</span>
         </div>
        <div class="wrap-right-button search">
            <div class="iconbox">
                <span class="iconfont icon-search-menu"></span>
            </div>
            <span class="icontext">搜索</span>
        </div>
        <div class="wrap-right-button menu-button">
            <div class="iconbox">
                <span class="iconfont icon-menu"></span>
            </div>
            <span class="icontext">菜单</span>
        </div>
        <div class="wrap-right-button mode">
            <div class="light">
                <div class="iconbox">
                    <span class="iconfont icon-daymode"></span>
                </div>
                <span class="icontext">浅色模式</span>
            </div>
            <div class="dark">
                <div class="iconbox">
                    <span class="iconfont icon-nightmode-fill"></span>
                </div>
                <span class="icontext">深色模式</span>
            </div>
        </div>
        <div class="wrap-right-button bottom">
            <div class="iconbox">
                <span class="iconfont icon-top"></span>
            </div>
            <span class="icontext">跳至底部</span>
        </div>
    </div>
    <div class="wrap-right-show">
        <div class="wrap-right-button set">
            <div class="iconbox">
                <span class="iconfont icon-setting"></span>
            </div>
            <span class="icontext">设置</span>
        </div>
        <div class="wrap-right-button top">
            <div class="iconbox">
                <span class="iconfont icon-top"></span>
            </div>
            <span class="icontext">返回顶部</span>
        </div>
    </div>
</div>
    <div class="loading"></div>
</div>
    <script>
    window.config = {
        GitHubUserName     : "lsSheep",
        GitHubRepositories : "hexo-blog",

        User             : "CloudSheep",
        UserAvatar       : "/images/User/vavtarsheep.jpg",
        WebsiteStartDate : "2023-10-17",
        Home             : "https://lssheepcloud.cn",

        WebsiteTitleBlur         : "(◍´꒳`◍) Hi, Sheep",
        WebsiteTitleBlurTimeOut  : 500,
        WebsiteTitleFocus        : "(*´∇｀*) 欢迎回来!",
        WebsiteTitleFocusTimeOut : 1000,
        WebsiteFavicon           : {
            light : "/image/website/logo/svgrepo.png",
            dark  : "/image/website/logo/svgrepo.png"
        },

        ProgressBar : {
            id       : "topProgressBar",
            color    : "#77B6FF",
            height   : "2px",
            duration : 0.2
        },

        Loading: {
            rebound : {
                tension  : 16,
                friction : 5
            },
            spinner : {
                id     : "spinner",
                radius : 90,
                sides  : 3,
                depth  : 4,
                colors : {
                    background : "#F0F0F0",
                    stroke     : "#272633",
                    base       : "",
                    child      : "#272633"
                },
                alwaysForward : true,
                restAt        : 0.5,
                renderBase    : false
            }
        },

        HomeHeaderAnimationRendered : true,
        HomeHeaderAnimation         : {
            radius      : 15,
            density     : 0.2,
            color       : "rgba(255, 255, 255, .2)",
            clearOffset : 0.3
        },

        BackAnimationRendered          : true,
        IEBrowserBackAnimationRendered : false,
        BackAnimation                  : {
            colorSaturation  : "60%",
            colorBrightness  : "50%",
            colorAlpha       : 0.5,
            colorCycleSpeed  : 5,
            verticalPosition : "random",
            horizontalSpeed  : 200,
            ribbonCount      : 3,
            strokeSize       : 0,
            parallaxAmount   : -0.2,
            animateSections  : true
        },

        HomeHeaderImage : [
            
                "/images/Lycoris-Recoil-a/01.jpg",
            
                "/images/Lycoris-Recoil-a/02.jpg",
            
                "/images/Lycoris-Recoil-a/03.jpg",
            
                "/images/Lycoris-Recoil-a/04.jpg",
            
                "/images/Lycoris-Recoil-a/05.jpg",
            
                "/images/Lycoris-Recoil-a/06.jpg",
            
                "/images/Lycoris-Recoil-a/07.jpg",
            
                "/images/Lycoris-Recoil-a/08.jpg",
            
                "/images/Lycoris-Recoil-a/09.jpg",
            
                "/images/Lycoris-Recoil-a/10.jpg",
            
                "/images/Lycoris-Recoil-a/11.jpg",
            
        ],
        HomeBannerText  : "",

        ArticleHeaderImage : [
            
                "/images/Mecha/mecha I.jpg",
            
                "/images/Mecha/mecha II.jpg",
            
                "/images/Mecha/mecha III.jpg",
            
                "/images/Mecha/mecha V.jpg",
            
                "/images/Mecha/mecha VI.jpg",
            
        ],

        OtherBannerText : "",

        Error : {
            icon    : "icon-swimming",
            title   : "PAGE NOT FOUND",
            content : [
                
                    "很抱歉，您访问的页面不存在！",
                
                    "可能是输入地址有误或该地址已变更。",
                
            ],
            buttons : [
                
                    {
                        icon  : "icon-home",
                        text  : "返回首页",
                        href  : "/",
                        class : ""
                    },
                
            ]
        },

        MenuNotice : {
            enable : true,
            notice : "快也很好，慢也很好各按其时，成为美好",
            speed  : 20
        },
        MenuList : [
            
                {
                    name   : "首页",
                    icon   : "icon-home-fill",
                    href   : "/",
                    type   : "index",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "分类",
                    icon   : "icon-folder-fill",
                    href   : "/category",
                    type   : "category",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "标签",
                    icon   : "icon-discount-fill",
                    href   : "/tag",
                    type   : "tag",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "归档",
                    icon   : "icon-calendar-fill",
                    href   : "/archive",
                    type   : "archive",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "关于",
                    icon   : "icon-about-fill",
                    href   : "/about",
                    type   : "about",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "订阅",
                    icon   : "icon-rss",
                    href   : "/atom.xml",
                    type   : "",
                    class  : "",
                    target : "_blank"
                },
            
                {
                    name   : "搜索",
                    icon   : "icon-search-menu",
                    href   : "javascript:;",
                    type   : "",
                    class  : "search",
                    target : "_self"
                },
            
                {
                    name   : "留言板",
                    icon   : "icon-comments-fill",
                    href   : "/comment",
                    type   : "comment",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "友情链接",
                    icon   : "icon-link",
                    href   : "/friend",
                    type   : "friend",
                    class  : "",
                    target : "_self"
                },
            
        ],
        MenuLink : [
            
                
                    {
                        name   : "知乎",
                        icon   : "icon-zhihu",
                        href   : "https://www.zhihu.com/creator",
                        class  : "",
                        target : "_blank",
                        image  : ""
                    },
                
                    {
                        name   : "QQ",
                        icon   : "icon-qq",
                        href   : "javascript:;",
                        class  : "image",
                        target : "_self",
                        image  : "/images/qq.jpg"
                    },
                
                    {
                        name   : "微信",
                        icon   : "icon-wechat",
                        href   : "javascript:;",
                        class  : "",
                        target : "_self",
                        image  : ""
                    },
                
                    {
                        name   : "GitHub",
                        icon   : "icon-github",
                        href   : "https://github.com/lsSheep",
                        class  : "",
                        target : "_blank",
                        image  : ""
                    },
                
            
        ],

        FooterStyle : 2,
        BottomText  : "<div><span class='face'>ღゝ◡╹)ノ♡</span></div><div>【生活枯燥无味<span><i class='iconfont icon-like-fill'></i></span>早八谋杀人类】</div><div>&copy; 2023-2023 CLOUDSHEEP, All Rights Reserved.</div>",

        ConsoleList : [
            
                
                    [
                        
                            
                                "Based on cnblogs theme SimpleMemory.",
                            
                                "",
                            
                        
                    ],
                
                    [
                        
                            
                                "SimpleMemory Author:",
                            
                                "BNDong",
                            
                        
                    ],
                
                    [
                        
                            
                                "Theme:",
                            
                                "LiveForCode",
                            
                        
                    ],
                
            
        ],

        FontIconExtend : "",

        Donate : {
            paypal  : "",
            bitcoin : "",
            alipay  : "/image/donate/alipay.png",
            wechat  : "/image/donate/wechat.png"
        },

        Search : {
            applicationID : "OH8J0H088W",
            apiKey        : "dad0cf0e12bc55f1e5f75d52430f6901",
            indexName     : "dev_hexo-algolia",
            hits          : {
                page : 10
            },
            labels        : {
                placeholder : "搜索",
                empty       : "未发现与 「${query}」 相关的内容",
                stats       : "${hits} 条相关条目，使用了 ${time} 毫秒",
            }
        }, 

        Comment : {
            switch : true,
            type   : "Waline",
        },

        Waline : {
            el              : ".comments-content",
            serverURL       : "https://waline.lssheepcloud.cn/",
            path            : window.location.pathname,
            meta            : "['nick', 'mail', 'link']",
            requiredMeta    : "['nick', 'mail']",
            pageSize        : 10,
            lang            : "zh-cn",
            locale: {
                admin       : "博主",
                anonymous   : "匿名用户",
                sofa        : "快来做第一个评论的人吧 ~",
                placeholder : "I'm proud of myself...",
            },
            dark            : "html[color-scheme='dark']",
            search          : false,
            pageview        : true,
            comment         : true,
            copyright       : false,
        },

        Valine : {
            el             : ".comments-content",
            appId          : "srhKtvWPQTWYKh3qX8G8M7v0-gzGzoHsz",
            appKey         : "8uVSP1q6UlALVC5igYfIfv2h",
            serverURLs     : "",
            placeholder    : "你是我一生只会遇见一次的惊喜...",
            avatar         : "mm",
            meta           : "nick,mail,link",
            requiredFields : "nick,mail,link",
            pageSize       : 5,
            lang           : "zh-cn",
            visitor        : true,
            enableQQ       : true
        },

        Tocbot : {
            switch                : true,
            tocSelector           : ".toc",
            contentSelector       : ".article-body",
            headingSelector       : "h1, h2, h3, h4, h5",
            headingsOffset        : 0,
            scrollSmooth          : true,
            scrollSmoothOffset    : -5,
            positionFixedSelector : ".toc",
            positionFixedClass    : "toc-fixed",
            fixedSidebarOffset    : "",
        },

        Require : {
            baseUrl     : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/",
            waitSeconds : 100
        },

        Music : {
            type : "Meting"
        },
        APlayer : {
            container : ".aplayer",
            fixed     : true,
            autoplay  : false,
            loop      : "all",
            order     : "random",
            preload   : "auto",
            volume    : 0.67,
            mutex     : true,
            lrcType   : 3,
            audio     : [
                
                    {
                        name   : "Endless Tears",
                        artist : "CLIFF EDGE",
                        cover  : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/music/cover/Endless Tears.jpg",
                        url    : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/music/song/Endless Tears.mp3",
                        lrc    : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/music/lrc/Endless Tears.lrc"
                    },
                
            ]
        },
        Meting : {
            api      : "https://api.i-meto.com/meting/api",
            id       : "2133323240", 
            lrcshow  : false, 
            server   : "netease", 
            type     : "playlist", 
            fixed    : true, 
            autoplay : false, 
            loop     : "all", 
            order    : "random", 
            preload  : "auto", 
            volume   : 0.67, 
            mutex    : true
        },

        Mouse : {
            enable  : true,
            options : {
                size  : 6,
                sizeF : 24
            }
        },

        LazyLoad : {
            default : "/image/website/lazyload.svg"
        },
  
        Style : {
            aplayer          : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/APlayer.min.css",
            archive          : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/archive.min.css",
            base             : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/base.min.css",
            clipboard        : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/clipboard.min.css",
            code             : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/code.min.css",
            donate           : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/donate.min.css",
            fancybox         : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/jquery.fancybox.min.css",
            footer           : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/footer.min.css",
            iconfont         : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/iconfont/iconfont.min.css",
            index            : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/index.min.css",
            menuBubble       : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/menu-bubble.min.css",
            mouse            : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/mouse.min.css",
            page             : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/page.min.css",
            post             : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/post.min.css",
            search           : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/search.min.css",
            tocbot           : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/tocbot.min.css",
            valine           : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/valine.min.css",
            waline           : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/waline.css",
            walineCustom     : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/waline-custom.css"
        },

        Script: {
            aplayer          : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/APlayer.min.js",
            config           : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/require.config.min.js",
            index            : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/index.min.js",
            instantSearch    : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/instantsearch.min.js",
            iscroll          : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/iscroll.min.js",
            jQuery           : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/jquery-3.4.1.min.js",
            loading          : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/loading.min.js",
            meting           : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/Meting.min.js",
            require          : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/require.min.js",
            waline           : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/waline.mjs",
            pageview         : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/pageview.mjs",
            comment          : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/comment.mjs",
        },

        Font: {
            LongCang    : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/LongCang.min.css",
            Monda       : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Monda.min.css",
            NotoSansSC  : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/NotoSansSC.min.css",
            NotoSerifSC : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/NotoSerifSC.min.css",
            Playball    : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Playball.min.css",
            PTMono      : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/PTMono.min.css",
            Roboto      : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Roboto.min.css",
            RobotoSlab  : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/RobotoSlab.min.css",
            Rosario     : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Rosario.min.css",
            UbuntuMono  : "https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/UbuntuMono.min.css"
        },

        Suffix : {
            about : "不啻微芒，造炬成阳"
        },
            
        Theme : {
            url  : "https://github.com/lsSheep/hexo-blog.git",
            name : "hexo-blog"
        }  
    };
</script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/index.min.js"></script>
</body>
</html>